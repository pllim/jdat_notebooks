<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Spectral Cube Modeling â€” STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html" rel="next" title="MRS Pipeline"/>
  <link href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html" rel="prev" title="Specviz Simple Demo"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/cube_fitting/cube_fitting.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/cube_fitting/cube_fitting.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imports">
           Imports
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#definitions-of-functions">
           Definitions of functions
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#scrolling">
             Scrolling
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#model-functions">
             Model Functions
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#model-parameters">
           Model Parameters
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
             Line Flux from Model Parameters
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
             Extract and plot 1D spectrum and model components
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#input-data">
           Input data
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#model-parameter-starting-values">
           Model Parameter Starting Values
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
           Fit a Representative Spaxel
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-the-entire-cube">
           Fit the Entire Cube
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
             Total flux and Reduced Chi^2 Maps
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
             Line and PAH feature flux maps.
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
               Functions to extract line and PAH maps from model parameter cube
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
               H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
           Extract and model cube sub-regions
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#make-spectral-region-masks">
             Make spectral region masks
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
             Extract spectra from mask regions
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#save-spectra-to-files">
             Save spectra to files
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-spectra-of-regions">
             Fit spectra of regions
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#generic-model-components">
               Generic model components
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
               Spiral arm spectral fit
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
               H2-strongest region spectral fit
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#nucleus-spectral-fit">
               Nucleus spectral fit
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#summary-plot">
           Summary Plot
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Spectral Cube Modeling
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#definitions-of-functions">
              Definitions of functions
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#scrolling">
                Scrolling
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#model-functions">
                Model Functions
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#model-parameters">
              Model Parameters
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#line-flux-from-model-parameters">
                Line Flux from Model Parameters
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#extract-and-plot-1d-spectrum-and-model-components">
                Extract and plot 1D spectrum and model components
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#input-data">
              Input data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#model-parameter-starting-values">
              Model Parameter Starting Values
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-a-representative-spaxel">
              Fit a Representative Spaxel
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-the-entire-cube">
              Fit the Entire Cube
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#total-flux-and-reduced-chi-2-maps">
                Total flux and Reduced Chi^2 Maps
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#line-and-pah-feature-flux-maps">
                Line and PAH feature flux maps.
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
                  Functions to extract line and PAH maps from model parameter cube
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
                  H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-and-model-cube-sub-regions">
              Extract and model cube sub-regions
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#make-spectral-region-masks">
                Make spectral region masks
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#extract-spectra-from-mask-regions">
                Extract spectra from mask regions
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#save-spectra-to-files">
                Save spectra to files
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-spectra-of-regions">
                Fit spectra of regions
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#generic-model-components">
                  Generic model components
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#spiral-arm-spectral-fit">
                  Spiral arm spectral fit
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#h2-strongest-region-spectral-fit">
                  H2-strongest region spectral fit
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#nucleus-spectral-fit">
                  Nucleus spectral fit
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#summary-plot">
              Summary Plot
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="spectral-cube-modeling">
          <h1>
           Spectral Cube Modeling
           <a class="headerlink" href="#spectral-cube-modeling" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Extracting spatial-spectral features of interest from the cube of data and measuring their
attributes.  Create line and PAH maps from the model parameters map.
           <br/>
           <strong>
            Data:
           </strong>
           SL1 and SL2 spectral cubes generated using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby galaxy Messier 58.
           <br/>
           <strong>
            Tools:
           </strong>
           astropy, specutils, dust-extinction, matplotlib.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec, MIRI.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScIâ€™s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Analysis of JWST spectral cubes requires extracting spatial-spectral features of interest and measuring their
attributes. Here, we demonstrate 1-D spectral modeling applied to an individual spaxel, 900 spaxels in a cube, and spectra summed over spatial regions. Analysis of large JWST spectral data cubes can be computationally expensive, depending on number of spaxels modeled and number of free model parameters. This task can be made manageable by focusing on spatial sub-regions of interest or by minimizing model complexity.  Sub-regions in the cube are selected by location and line ratios. The spaxels in these regions are then summed and modeled with a combination of continuum, emission line, polycyclic aromatic hydrocarbon (PAH), and silicate dust features. Best-fitting model spectra are fit using the lmfit package, utilizing a Levenberg-Marquardt least-squares method.
           </p>
          </section>
          <section id="imports">
           <h2>
            Imports
            <a class="headerlink" href="#imports" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              <em>
               time
              </em>
              for timing
             </p>
            </li>
            <li>
             <p>
              <em>
               multiprocessing.Pool
              </em>
              for parallel processing on cube spaxels
             </p>
            </li>
            <li>
             <p>
              <em>
               pickle
              </em>
              for pickling and unpickling IO to multiprocessing pools
             </p>
            </li>
            <li>
             <p>
              <em>
               numpy
              </em>
              for array processing and math
             </p>
            </li>
            <li>
             <p>
              <em>
               matplotlib.pyplot
              </em>
              for plotting images and spectra
             </p>
            </li>
            <li>
             <p>
              <em>
               <a class="reference external" href="http://astropy.io">
                astropy.io
               </a>
              </em>
              for reading and writing FITS cubes and images
             </p>
            </li>
            <li>
             <p>
              <em>
               astropy.visualization
              </em>
              to construct RGB images
             </p>
            </li>
            <li>
             <p>
              <em>
               lmfit
              </em>
              Levenberg-Marquart fitting package for model-fitting
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">multiprocess</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">from</span> <span class="nn">multiprocess</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">loadtxt</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">interp</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> 
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">make_lupton_rgb</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>

<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Minimizer</span><span class="p">,</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">lmfit.model</span> <span class="kn">import</span> <span class="n">save_modelresult</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="definitions-of-functions">
           <h2>
            Definitions of functions
            <a class="headerlink" href="#definitions-of-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="scrolling">
            <h3>
             Scrolling
             <a class="headerlink" href="#scrolling" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Limit scrolling in cell output.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="o">%%javascript</span>
<span class="nx">IPython</span><span class="p">.</span><span class="nx">OutputArea</span><span class="p">.</span><span class="nx">auto_scroll_threshold</span><span class="o">=</span><span class="mf">70</span><span class="p">;</span><span class="w"></span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <script type="application/javascript">
               IPython.OutputArea.auto_scroll_threshold=70;
              </script>
             </div>
            </div>
           </section>
           <section id="model-functions">
            <h3>
             Model Functions
             <a class="headerlink" href="#model-functions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             A variety of emission line, continuum and extinction models for spectral fitting.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">Modelcero</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">"""Simple model of 0 to initialize some models"""</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">*</span><span class="n">x</span>

<span class="c1">#powerlaw, zblackbody, gaussian and drude functions wrap existing astropy models.</span>
<span class="c1">#lmfit requires wavelength (x) to be passed as function parameter.</span>

<span class="k">def</span> <span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
    <span class="sd">"""power law function (c1*nu^c2) normalized at 1 micron, with positive index convention"""</span>
    <span class="n">x0</span><span class="o">=</span><span class="mf">1.0</span>  <span class="c1">#Normalize at  1 micron</span>
    <span class="n">c2</span><span class="o">=-</span><span class="n">c2</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">PowerLaw1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">c2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">zblackbody</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="sd">"""black body function"""</span>
    <span class="n">xs</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="o">/</span><span class="n">OnePlusZ</span>
    <span class="n">bb</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">BlackBody</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bb</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">std</span><span class="p">):</span>
    <span class="sd">"""1-d gaussian"""</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>   

<span class="k">def</span> <span class="nf">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">):</span>
    <span class="sd">"""dust emission"""</span>
    <span class="n">FWHM</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">frac_FWHM</span>
    <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">Drude1D</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="n">FWHM</span><span class="p">)</span>

<span class="c1">#pahdust and sidust functions do not exist in astropy</span>

<span class="k">def</span> <span class="nf">pahdust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">):</span>
    <span class="sd">"""PAH dust emission"""</span>
    
    <span class="c1">#Ionized PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">=</span>     <span class="p">[</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">5.70</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">6.69</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.034</span><span class="p">,</span><span class="mf">0.035</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">0.053</span><span class="p">,</span><span class="mf">0.050</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.8</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">PAH_amplitude</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_76</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
 
    <span class="c1">#Neutral PAH features</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">10.68</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span><span class="mf">11.33</span><span class="p">]</span>
    <span class="n">PAH_peakx</span><span class="o">+=</span>    <span class="p">[</span><span class="mf">11.99</span><span class="p">,</span><span class="mf">12.62</span><span class="p">,</span><span class="mf">12.69</span><span class="p">,</span><span class="mf">13.48</span><span class="p">,</span><span class="mf">14.04</span><span class="p">,</span><span class="mf">14.19</span><span class="p">,</span><span class="mf">15.90</span><span class="p">,</span> <span class="mf">16.45</span><span class="p">,</span><span class="mf">17.04</span><span class="p">,</span><span class="mf">17.375</span><span class="p">,</span><span class="mf">17.87</span><span class="p">,</span><span class="mf">18.92</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.020</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="mf">0.022</span><span class="p">]</span>
    <span class="n">PAH_frac_FWHM</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.045</span><span class="p">,</span><span class="mf">0.042</span><span class="p">,</span> <span class="mf">0.013</span><span class="p">,</span><span class="mf">0.040</span><span class="p">,</span><span class="mf">0.016</span><span class="p">,</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.020</span><span class="p">,</span><span class="mf">0.014</span><span class="p">,</span><span class="mf">0.065</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="mf">0.019</span><span class="p">]</span>   
    <span class="n">PAH_rel_amplitude</span><span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">PAH_rel_amplitude</span><span class="o">+=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span>  <span class="mf">0.3</span><span class="p">,</span>   <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.1</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>  <span class="mf">0.0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="n">PAH_rel_amplitude</span><span class="p">:</span> <span class="n">PAH_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_113</span><span class="o">*</span><span class="p">(</span><span class="n">ampl</span><span class="o">/</span><span class="n">PAH_rel_amplitude</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    
    <span class="n">pahflux</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">ampl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">PAH_peakx</span><span class="p">,</span><span class="n">PAH_frac_FWHM</span><span class="p">,</span><span class="n">PAH_amplitude</span><span class="p">):</span>
        <span class="n">pahflux</span><span class="o">=</span><span class="n">pahflux</span><span class="o">+</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ampl</span><span class="p">,</span><span class="n">peakx</span><span class="o">*</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pahflux</span>    <span class="c1">#Amplitude unit</span>

<span class="k">def</span> <span class="nf">sidust</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">):</span>
    <span class="sd">"""Silicate dust emission"""</span>
    
    <span class="c1">#Custom extinction curve built from weighted sum of three components: </span>
    <span class="c1">#two Drude functions and an exponent 1.7 power-law.</span>
    <span class="n">d1</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.80</span><span class="p">,</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">d2</span><span class="o">=</span><span class="n">drude</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">11.1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="c1">#d3=drude(x,0.40,17.0,0.40)  #Outside of wavelength range.</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">d1</span><span class="o">+</span><span class="n">d2</span>  <span class="c1">#+d3</span>

    <span class="c1"># Form linear combination of modified silicate and powerlaw.</span>
    <span class="n">beta</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="n">ext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="mf">9.7</span><span class="o">/</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mf">1.7</span>
    <span class="n">si_em</span><span class="o">=</span><span class="n">amplitude</span><span class="o">*</span><span class="mf">1.0E-6</span><span class="o">*</span><span class="mf">3.97289E13</span><span class="o">/</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.4387752E4</span><span class="o">/</span><span class="n">x</span><span class="o">/</span><span class="n">T</span><span class="p">)</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">ext</span>
    
    <span class="k">return</span> <span class="n">si_em</span>

<span class="c1"># Enable tabulated extinction functions. Existing options in dust_extinction are insufficient</span>
<span class="c1"># at mid-IR wavelengths</span>

<span class="k">def</span> <span class="nf">extinction_a</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
    <span class="sd">"""Extinction from table data"""</span>
    <span class="n">ext</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>      
    <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">ext</span><span class="p">)</span>

<span class="c1">#Read extinction data from Chiar &amp; Tielens (2005)</span>
<span class="c1">#Note, this is normalized to extinction in the K-band (1.004 at 2.14 um)</span>
<span class="c1">#agal is for Galactic Center, alocal is for local ISM extinction</span>

<span class="n">Boxdata</span><span class="o">=</span><span class="s2">"https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/"</span>
<span class="n">wave</span><span class="p">,</span> <span class="n">agal</span><span class="p">,</span> <span class="n">alocal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">Boxdata</span><span class="o">+</span><span class="s1">'chiar+tielens_2005.dat'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Compare to dust_extinction</span>
<span class="c1">#P92 is the only model that extends over the mid-IR range, but it is crude</span>
<span class="c1">#Normalized to extinction in the V-band</span>

<span class="kn">from</span> <span class="nn">dust_extinction.parameter_averages</span> <span class="kn">import</span> <span class="n">F99</span>
<span class="kn">from</span> <span class="nn">dust_extinction.shapes</span> <span class="kn">import</span> <span class="n">P92</span>
<span class="n">a92</span> <span class="o">=</span> <span class="n">P92</span><span class="p">()</span>

<span class="c1">#Extinction Comparison</span>
<span class="n">tau</span><span class="o">=</span><span class="mf">1.</span>
<span class="n">xa</span><span class="o">=</span><span class="n">arange</span><span class="p">(</span><span class="mf">5.</span><span class="p">,</span><span class="mf">15.</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">extin1</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">alocal</span><span class="p">)</span>
<span class="n">extin2</span><span class="o">=</span><span class="n">extinction_a</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">agal</span><span class="p">)</span>
<span class="n">lam</span><span class="o">=</span><span class="n">xa</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span>
<span class="n">scale</span><span class="o">=</span><span class="mf">21.9</span>             <span class="c1">#Empirical scaling to adjust P2 curve to match Chiar &amp; Tielens Local ISM curve</span>
<span class="n">aa92</span><span class="o">=</span><span class="n">scale</span><span class="o">*</span><span class="n">a92</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>
<span class="n">extin3</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="n">aa92</span><span class="p">)</span>

<span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'CT+05 Local ISM'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'CT+05 Gal. Cen.'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">extin3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'P92 scaled'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">pl1</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">(</span><span class="n">xa</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/cube_fitting_9_0.png" src="../../_images/cube_fitting_9_0.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="model-parameters">
           <h2>
            Model Parameters
            <a class="headerlink" href="#model-parameters" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Declare the parameters of model functions. Parameters are frozen by setting vary=â€™Falseâ€™
in the lmfit setpar command.  For now we are just fitting amplitudes of emission features.
Fits with more variable parameters take longer.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">def</span> <span class="nf">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">vary</span><span class="p">,</span> <span class="n">minus</span><span class="p">):</span>
    <span class="sd">"""Set any parameter"""</span>
    <span class="n">pars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">gaussian_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">"""set the parameters for a gaussian"""</span>
    <span class="n">std</span><span class="o">=</span><span class="n">stddev</span>
    <span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">xcen</span><span class="o">=</span><span class="n">mean</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_std'</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+'_std',std,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_xcen'</span><span class="p">,</span><span class="n">xcen</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_amplitude'</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+'_std'].set(std,vary=False),pars[name+'_xcen'].set(xcen,vary=False),pars[name+'_amplitude'].set(amplitude)</span>

<span class="k">def</span> <span class="nf">drude_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">peakx</span><span class="p">,</span> <span class="n">frac_FWHM</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">"""set the parameters for a drude"""</span>
    <span class="n">peakx</span><span class="o">=</span><span class="n">peakx</span><span class="o">*</span><span class="n">OneZ</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_frac_FWHM'</span><span class="p">,</span><span class="n">frac_FWHM</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1">#setpar(pars,name+'_frac_FWHM',frac_FWHM,True,0)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_peakx'</span><span class="p">,</span><span class="n">peakx</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_amplitude'</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>    
    <span class="k">return</span> <span class="c1">#pars[name+'_frac_FWHM'].set(frac_FWHM,vary=False),pars[name+'_peakx'].set(peakx,vary=False),pars[name+'_amplitude'].set(amplitude)</span>

<span class="k">def</span> <span class="nf">pahdust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">OnePlusZ</span><span class="p">,</span> <span class="n">amplitude_76</span><span class="p">,</span> <span class="n">amplitude_113</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="sd">"""set the parameters for pdr dust"""</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_amplitude_76'</span><span class="p">,</span><span class="n">amplitude_76</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_amplitude_113'</span><span class="p">,</span><span class="n">amplitude_113</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_OnePlusZ'</span><span class="p">,</span><span class="n">OnePlusZ</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="c1">#pars[name+'_frac_FWHM'].set(frac_FWHM,vary=False),pars[name+'_peakx'].set(peakx,vary=False),pars[name+'_amplitude'].set(amplitude)</span>

<span class="k">def</span> <span class="nf">sidust_defpar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">amplitude</span><span class="p">,</span> <span class="n">pars</span><span class="p">):</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_amplitude'</span><span class="p">,</span><span class="n">amplitude</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">setpar</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">'_T'</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">"""extract the parameters for a gaussian"""</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'amplitude'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cen</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'xcen'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'std'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span>

<span class="k">def</span> <span class="nf">drude_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">"""extract the parameters for a drude"""</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'amplitude'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'peakx'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>         
    <span class="n">frac</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'frac_FWHM'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">frac</span>

<span class="k">def</span> <span class="nf">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">"""extract the parameters for pahdust model"""</span>
    <span class="n">ampl_76</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'amplitude_76'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'amplitude_113'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span>  

<span class="k">def</span> <span class="nf">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="sd">"""extract the parameters for pahdust model"""</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'T'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">ampl</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="s1">'amplitude'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">return</span> <span class="n">T</span><span class="p">,</span><span class="n">ampl</span> 
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="line-flux-from-model-parameters">
            <h3>
             Line Flux from Model Parameters
             <a class="headerlink" href="#line-flux-from-model-parameters" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Helper functions to calculate the fluxes and widths of emission features from model parameters.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1">#NOTE that these are ANALYTIC estimates of line fluxes,</span>
<span class="c1">#NOT available in astropy modeling or specutils</span>

<span class="k">def</span> <span class="nf">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">):</span>
    <span class="sd">"""calculate the integrated flux for a gaussian line"""</span>
    <span class="c1">#Units= amp:Jy cen:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">gaussianfactor</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">amp</span><span class="o">*</span><span class="n">gaussianfactor</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">std</span><span class="o">/</span><span class="p">(</span><span class="n">cen</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>      <span class="c1">#erg s^{-1} cm^{-2}</span>

<span class="k">def</span> <span class="nf">drudeline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">frac</span><span class="p">,</span><span class="n">peak</span><span class="p">):</span>
    <span class="sd">"""calculate the integrate flux for a drude line"""</span>
    <span class="c1">#Units= amp:Jy peak:microns</span>
    <span class="n">c</span><span class="o">=</span> <span class="mf">29979.2458</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">10</span> <span class="c1">#c in microns/s</span>
    <span class="n">drudefactor</span><span class="o">=</span><span class="n">pi</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="o">*</span><span class="n">frac</span><span class="o">*</span><span class="n">drudefactor</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">peak</span><span class="p">)))</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span>   <span class="c1">#erg s^{-1} cm^{-2}</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="extract-and-plot-1d-spectrum-and-model-components">
            <h3>
             Extract and plot 1D spectrum and model components
             <a class="headerlink" href="#extract-and-plot-1d-spectrum-and-model-components" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">"""extract spec and errors from a,b coordinates"""</span>
    <span class="n">spec_pix</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="n">err_pix</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spec_pix</span><span class="p">,</span> <span class="n">err_pix</span>

<span class="k">def</span> <span class="nf">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">):</span>
    <span class="sd">"""Evaluate model components"""</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">eval_components</span><span class="p">()</span>
    <span class="n">plcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">h2comp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pahcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sidustcomp</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1">#print(comps.keys())</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">comps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
        <span class="n">keyl</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">'pwl'</span><span class="p">:</span> <span class="n">plcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">'h'</span><span class="p">:</span> <span class="n">h2comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">'pah'</span><span class="p">:</span> <span class="n">pahcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyl</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="s1">'sid'</span><span class="p">:</span> <span class="n">sidustcomp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
       
    <span class="n">plaw_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">h2_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">ion_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">pah_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="n">sidust_model</span><span class="o">=</span><span class="n">x</span><span class="o">-</span><span class="n">x</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">plcomp</span><span class="p">:</span> <span class="n">plaw_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">h2comp</span><span class="p">:</span> <span class="n">h2_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">pahcomp</span><span class="p">:</span> <span class="n">pah_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">sidustcomp</span><span class="p">:</span> <span class="n">sidust_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">'ArII'</span><span class="p">,</span><span class="s1">'SIV'</span><span class="p">,</span><span class="s1">'NeII'</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
        <span class="n">ion_model</span><span class="o">+=</span><span class="n">comps</span><span class="p">[</span><span class="n">comp</span><span class="o">+</span><span class="s1">'_'</span><span class="p">]</span>
        
    <span class="k">return</span><span class="p">([</span><span class="n">plaw_model</span><span class="p">,</span><span class="n">h2_model</span><span class="p">,</span><span class="n">ion_model</span><span class="p">,</span><span class="n">pah_model</span><span class="p">,</span><span class="n">sidust_model</span><span class="p">],[</span><span class="s1">'PL'</span><span class="p">,</span><span class="s1">'H2'</span><span class="p">,</span><span class="s1">'Ions'</span><span class="p">,</span><span class="s1">'PAHs'</span><span class="p">,</span><span class="s1">'Si Dust'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">model_result</span><span class="p">):</span>
    <span class="sd">"""plot spectrum, model components, and residual"""</span>

    <span class="c1">#Model Results</span>
    <span class="n">fit_model</span> <span class="o">=</span> <span class="n">model_result</span><span class="o">.</span><span class="n">best_fit</span> 
    <span class="n">fit_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">fit_model</span>

    <span class="c1">#Evaluate model components</span>
    <span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">model_result</span><span class="p">)</span>
        
    <span class="c1">#Spec-1D object</span>
    <span class="n">spec1</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">x</span><span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">spec</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">specerr</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">quantity_support</span><span class="p">():</span>    
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  
        <span class="c1">#ax.step, ax.plot, ax.scatter all work, but ax.scatter doesn't autscale correctly</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'Data'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
        <span class="c1">#ax.set_xlabel(r"$Wavelength\ (\mu m)$")</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">)</span>
        <span class="c1">#plt.errorbar only works on unitless data</span>
        <span class="c1">#ax.errorbar(spec1.spectral_axis, spec1.flux, yerr=specerr,label='Data', color='k')</span>
        <span class="c1">#ax.plot(spec1.spectral_axis, spec1.flux, yerr=specerr,label='Data', color='k')</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>   

    <span class="c1">#Plot results</span>
    <span class="n">fig1</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span> <span class="mi">150</span><span class="p">)</span>
    
    <span class="n">frame1</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.3</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.6</span><span class="p">))</span>
    <span class="n">frame1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"$Flux\ (Jy)$"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'Data'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fit_model</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">'Model'</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
    <span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">'brown'</span><span class="p">,</span><span class="s1">'g'</span><span class="p">,</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'magenta'</span><span class="p">,</span><span class="s1">'orange'</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">mlabel</span><span class="p">,</span> <span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mod_comps</span><span class="p">,</span><span class="n">mod_labels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mcomp</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">mlabel</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>        
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">frame2</span><span class="o">=</span><span class="n">fig1</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.2</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">0.</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">'r'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"$Wavelength\ (\mu m)$"</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">':'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fit_residual</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">specerr</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>     
    <span class="k">return</span> 
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="input-data">
           <h2>
            Input data
            <a class="headerlink" href="#input-data" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            With the present lack of JWST flight data, we utilize the SL1 and SL2 spectral cubes generated
using CUBISM, from Spitzer IRS spectral mapping observations of the center of nearby
galaxy Messier 58. This galaxy has a radio-loud Seyfert nucleus that is exciting strong
H2 emission via shocks.  There is also significant star-formation, revealed by PAH emission
features.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Spitzer IRS (CUBISM) cube loader does not exist in specutils</span>

<span class="c1">#Target </span>
<span class="n">targname</span><span class="o">=</span><span class="s1">'M58'</span>

<span class="c1">#Redshift</span>
<span class="n">z</span><span class="o">=</span><span class="mf">0.005060</span>
<span class="n">OneZ</span><span class="o">=</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span>

<span class="c1">#Download and open the data cubes and their uncertainties</span>
<span class="n">BoxPath</span><span class="o">=</span><span class="s2">"https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/cube_fitting/"</span>
<span class="n">cubeSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">'_SL1_cube.fits'</span><span class="p">)</span> 
<span class="n">errorsSL1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">'_SL1_cube_unc.fits'</span><span class="p">)</span>
<span class="n">cubeSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">'_SL2_cube.fits'</span><span class="p">)</span> 
<span class="n">errorsSL2</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BoxPath</span><span class="o">+</span><span class="n">targname</span><span class="o">+</span><span class="s1">'_SL2_cube_unc.fits'</span><span class="p">)</span>

<span class="c1">#Cube Info and Headers</span>
<span class="n">cubeSL1</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">cubeSL2</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
<span class="n">hdr1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                        
<span class="n">er_hdr1</span><span class="o">=</span><span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="n">hdr2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>                               
<span class="n">er_hdr2</span><span class="o">=</span><span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
<span class="c1">#print(repr(hdr1))</span>

<span class="c1">#Flux Data</span>
<span class="n">data_cube1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube1</span> <span class="o">=</span> <span class="n">errorsSL1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">data_cube2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">error_cube2</span> <span class="o">=</span> <span class="n">errorsSL2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1">#Wavelength Data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">cubeSL1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave1</span> <span class="o">=</span> <span class="n">xwave1</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">cubeSL2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">xwave2</span> <span class="o">=</span> <span class="n">xwave2</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave2</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xwave1</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Change the units from MJy/sr to Jy/pix</span>
<span class="n">correct_unit1</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">'CDELT1'</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr1</span><span class="p">[</span><span class="s1">'CDELT2'</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube1</span><span class="o">=</span><span class="n">data_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">error_cube1</span><span class="o">=</span><span class="n">error_cube1</span><span class="o">*</span><span class="n">correct_unit1</span>
<span class="n">correct_unit2</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">'CDELT1'</span><span class="p">])</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">hdr2</span><span class="p">[</span><span class="s1">'CDELT2'</span><span class="p">])</span><span class="o">*</span><span class="mf">0.0003046118</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>    
<span class="n">data_cube2</span><span class="o">=</span><span class="n">data_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>
<span class="n">error_cube2</span><span class="o">=</span><span class="n">error_cube2</span><span class="o">*</span><span class="n">correct_unit2</span>

<span class="c1">#Concatenate SL1 and SL2</span>
<span class="n">data_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_cube2</span><span class="p">,</span><span class="n">data_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">error_cube</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">error_cube2</span><span class="p">,</span><span class="n">error_cube1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Reorder x and data_cube</span>
<span class="n">xcor</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
<span class="n">data_cube</span> <span class="o">=</span> <span class="n">data_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">error_cube</span> <span class="o">=</span> <span class="n">error_cube</span><span class="p">[</span><span class="n">xcor</span><span class="p">]</span>
<span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1">#Cube dimensions and trimming </span>
<span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span> <span class="o">=</span> <span class="n">data_cube</span><span class="o">.</span><span class="n">shape</span>
<span class="n">ytrim</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">ysize</span><span class="o">=</span><span class="n">ysize</span><span class="o">-</span><span class="n">ytrim</span>
<span class="n">ztrim</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span> <span class="n">zsize</span><span class="o">=</span><span class="n">zsize</span><span class="o">-</span><span class="n">ztrim</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Trimmed cube dimensions:'</span><span class="p">,</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">)</span>

<span class="c1">#Collapsed 2D image</span>
<span class="n">cube_2dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Collapsed 1D spectrum</span>
<span class="n">cube_1dflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">cube_1dflux</span><span class="o">=</span><span class="n">cube_1dflux</span><span class="o">+</span><span class="n">spec_pix</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'log Flux (Sum over Wavelength)'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_2dflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Flux (Sum over Spaxels)'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">cube_1dflux</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"Wavelength $(\mu m)$"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flux (Jy)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Filename: /home/runner/.astropy/cache/download/url/06853bf85036af1a6d55c1fb3a08260f/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 117)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [117E]   
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Filename: /home/runner/.astropy/cache/download/url/bec801dcb9ee22f478e4a56b91820bd4/contents
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU     286   (35, 30, 77)   float32   
  1  WCS-TAB       1 BinTableHDU     13   1R x 1C   [77E]   
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Trimmed cube dimensions: 194 30 32
</pre>
              </div>
             </div>
             <img alt="../../_images/cube_fitting_17_3.png" src="../../_images/cube_fitting_17_3.png"/>
            </div>
           </div>
          </section>
          <section id="model-parameter-starting-values">
           <h2>
            Model Parameter Starting Values
            <a class="headerlink" href="#model-parameter-starting-values" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Set starting parameters for spectral model components. Use a PAH dust model with only two free parameters (7.6 and 11.3 micron PAH flux).  The rest of the PAH ratios are fixed by this â€˜pahdustâ€™ model, so that fitting the whole cube does not take so long.   Later, we will fit summed region spectra with all PAH amplitudes free.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">'pwl_'</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c1'</span><span class="p">,</span><span class="mf">0.0002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c2'</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#PAH dust model with fixed PAH feature ratios</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">'pahdust1_'</span>
<span class="n">pahs</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">pahdust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pahs</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">pahdust_defpar</span><span class="p">(</span><span class="s1">'pahdust1'</span><span class="p">,</span><span class="mf">1.00506</span><span class="p">,</span><span class="mf">0.003</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">'sidust1_'</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">'sidust1'</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with wavelengths from Smith et al 2007</span>
<span class="c1">#H2 pure-rotational lines</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">'55'</span><span class="p">,</span><span class="s1">'61'</span><span class="p">,</span><span class="s1">'69'</span><span class="p">,</span><span class="s1">'80'</span><span class="p">,</span><span class="s1">'96'</span><span class="p">,</span><span class="s1">'122'</span><span class="p">]</span>
<span class="n">h2wavel</span><span class="o">=</span><span class="p">[</span><span class="mf">5.511</span><span class="p">,</span><span class="mf">6.109</span><span class="p">,</span><span class="mf">6.909</span><span class="p">,</span><span class="mf">8.026</span><span class="p">,</span><span class="mf">9.665</span><span class="p">,</span><span class="mf">12.278</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.04</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">'h'</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">h2lin</span><span class="p">,</span> <span class="n">h2w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2lines</span><span class="p">,</span><span class="n">h2wavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h'</span><span class="o">+</span><span class="n">h2lin</span><span class="p">,</span> <span class="n">amp_guess</span><span class="p">,</span> <span class="n">h2w</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">'ArII'</span><span class="p">,</span><span class="s1">'SIV'</span><span class="p">,</span><span class="s1">'NeII'</span><span class="p">]</span>
<span class="n">atomicwavel</span><span class="o">=</span><span class="p">[</span><span class="mf">6.985</span><span class="p">,</span><span class="mf">10.511</span><span class="p">,</span><span class="mf">12.813</span><span class="p">]</span>
<span class="n">amp_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">std_guess</span><span class="o">=</span><span class="mf">0.05</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="k">for</span> <span class="n">atlin</span><span class="p">,</span> <span class="n">atw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atomiclines</span><span class="p">,</span><span class="n">atomicwavel</span><span class="p">):</span>
    <span class="n">gaussian_defpar</span><span class="p">(</span><span class="n">atlin</span><span class="p">,</span><span class="n">amp_guess</span><span class="p">,</span> <span class="n">atw</span><span class="p">,</span> <span class="n">std_guess</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="fit-a-representative-spaxel">
           <h2>
            Fit a Representative Spaxel
            <a class="headerlink" href="#fit-a-representative-spaxel" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Fit a single spaxel in the cube and use the fit parameters to adjust the generic model starting parameters.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1">#Select spaxel</span>
<span class="n">spec</span><span class="o">=</span><span class="n">data_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">error_cube</span><span class="p">[:,</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span><span class="p">]</span>

<span class="c1">#Composite model (powerlaw + PAHs + H2 + Atomic lines, no extinction)</span>
<span class="n">generic_mod</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">pahs</span> <span class="o">+</span> <span class="n">gaussH2</span>  <span class="o">+</span> <span class="n">gaussAt</span>

<span class="nb">print</span><span class="p">(</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>

<span class="c1">#Fit and plot</span>
<span class="n">spax_result</span> <span class="o">=</span> <span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">spax_result</span><span class="p">)</span>

<span class="c1">#Save results</span>
<span class="n">save_modelresult</span><span class="p">(</span><span class="n">spax_result</span><span class="p">,</span> <span class="s1">'OnePointResult.sav'</span><span class="p">)</span>

<span class="c1">#Update generic model starting parameters</span>
<span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
    <span class="n">value</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">vary</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">vary</span>
    <span class="n">minus</span><span class="o">=</span><span class="n">spax_result</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">min</span>
    <span class="k">if</span> <span class="n">minus</span><span class="o">==</span><span class="nb">float</span><span class="p">(</span><span class="s2">"-inf"</span><span class="p">):</span>
        <span class="n">minus</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">generic_pars</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">vary</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">minus</span><span class="p">)</span>
    
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>['pwl_c1', 'pwl_c2', 'sidust1_T', 'sidust1_amplitude', 'pahdust1_OnePlusZ', 'pahdust1_amplitude_76', 'pahdust1_amplitude_113', 'h55_amplitude', 'h55_xcen', 'h55_std', 'h61_amplitude', 'h61_xcen', 'h61_std', 'h69_amplitude', 'h69_xcen', 'h69_std', 'h80_amplitude', 'h80_xcen', 'h80_std', 'h96_amplitude', 'h96_xcen', 'h96_std', 'h122_amplitude', 'h122_xcen', 'h122_std', 'ArII_amplitude', 'ArII_xcen', 'ArII_std', 'SIV_amplitude', 'SIV_xcen', 'SIV_std', 'NeII_amplitude', 'NeII_xcen', 'NeII_std']
</pre>
              </div>
             </div>
             <img alt="../../_images/cube_fitting_21_1.png" src="../../_images/cube_fitting_21_1.png"/>
             <img alt="../../_images/cube_fitting_21_2.png" src="../../_images/cube_fitting_21_2.png"/>
            </div>
           </div>
           <p>
            Plot of observed flux density (black), model fit (red), and residuals (bottom panel).  This spaxel has strong H2 emission at 9.6 microns and 8 micron PAH and [Ne II] 12.8 micron emission from star-forming regions.
           </p>
          </section>
          <section id="fit-the-entire-cube">
           <h2>
            Fit the Entire Cube
            <a class="headerlink" href="#fit-the-entire-cube" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Identify NaNs, then create list of models (based on generic model), one entry per NaN-free spaxel. Next launch the multiprocessing Pool, limited to number of available cores minus one. Fitting the entire cube (900 spaxels) takes about 2 minutes to fit with 7 processes running in parallel.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>

<span class="c1">#The fit method is redefined as a top-level function to make it pickle-able for multiprocessing.Pool</span>
<span class="k">def</span> <span class="nf">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">modf</span><span class="o">=</span><span class="n">generic_mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">modf</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span>

<span class="c1">#Helper to either assign a NaN result or fit a single non-NaN spaxel</span>
<span class="k">def</span> <span class="nf">fit_point</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span> <span class="o">=</span> <span class="n">args</span>
        <span class="c1"># print(a, b, len(spaxel), mp.current_process().name)</span>
        <span class="k">if</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">res_point</span><span class="o">=</span><span class="n">modfit</span><span class="p">(</span><span class="n">spaxel</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">spaxerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="n">res_point</span> 
        <span class="k">elif</span> <span class="n">nancheck</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cube_res</span><span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
        <span class="k">return</span> 

<span class="c1">#Extraction region dimensions (trimmed cube)</span>
<span class="n">astart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">aend</span><span class="o">=</span><span class="n">ysize</span>
<span class="n">bstart</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">bend</span><span class="o">=</span><span class="n">zsize</span>

<span class="c1">#Check for NaNs, select data, and set model start parameters for each spaxel</span>
<span class="n">pooldata</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">astart</span><span class="p">,</span><span class="n">aend</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bstart</span><span class="p">,</span><span class="n">bend</span><span class="p">):</span>        
        <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">point</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nancheck</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1">#Copy spaxel data vectors</span>
        <span class="n">spaxel</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">spaxerr</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">error_cube</span><span class="p">[:,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span>
        <span class="n">wavelen</span><span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="n">pooldata</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">spaxel</span><span class="p">,</span><span class="n">spaxerr</span><span class="p">,</span><span class="n">wavelen</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">,</span><span class="n">nancheck</span><span class="p">])</span>


<span class="c1">#Launch Multiprocessing Pool</span>
<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">fit_point</span><span class="p">,</span><span class="n">pooldata</span><span class="p">)</span>    

<span class="nb">print</span><span class="p">(</span><span class="s1">'Time count'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"--- </span><span class="si">%s</span><span class="s2"> seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="c1">#Save model fit</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'MPF_cube_result_model.sav'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">fp</span><span class="p">)</span>

<span class="c1">#Load model fit to full cube</span>
<span class="n">cube_res</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
<span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="s1">'MPF_cube_result_model.sav'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">restore_cube</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">restore_cube</span><span class="p">:</span>
    <span class="n">pos</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time count
--- 440.72736144065857 seconds ---
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="total-flux-and-reduced-chi-2-maps">
            <h3>
             Total flux and Reduced Chi^2 Maps
             <a class="headerlink" href="#total-flux-and-reduced-chi-2-maps" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Display total flux image (observed flux cube collapsed along wavelength direction) and reduced Chi^2 image for model fit in square sub-region.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1">#Sum observed flux in each spaxel</span>
<span class="n">cube_tflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">ysize</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">zsize</span><span class="p">]</span>

<span class="c1">#Sum model flux in each spaxel</span>
<span class="n">tcube_chi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">tcube_modflux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ysize</span><span class="p">,</span> <span class="n">zsize</span><span class="p">))</span>
<span class="n">funcdefs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">modres</span><span class="o">=</span><span class="n">spax_result</span>
<span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1">#for pos, dumpval in cube_res:</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">'nan'</span><span class="p">:</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
        <span class="n">tcube_modflux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">)</span>
        <span class="n">tcube_chi</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">redchi</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'log Observed Flux'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'log Model Flux'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Reduced Chi Square'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_tflux</span><span class="o">-</span><span class="n">tcube_modflux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'hot'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_5008/2033466933.py:12: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  tcube_modflux[pos]=np.float('nan')
/tmp/ipykernel_5008/2033466933.py:13: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  tcube_chi[pos]=np.float('nan')
</pre>
               </div>
              </div>
              <img alt="../../_images/cube_fitting_26_1.png" src="../../_images/cube_fitting_26_1.png"/>
             </div>
            </div>
            <p>
             Collapsed cube maps, showing observed flux, model flux, and Chi^2/DF.  White regions with NaNs in the input data cube also have NaNs in the output model cube along the left and top edges and in column 26.  Residuals in the nucleus may either be the result of inadequate PSF sampling or mis-fit AGN model.
            </p>
           </section>
           <section id="line-and-pah-feature-flux-maps">
            <h3>
             Line and PAH feature flux maps.
             <a class="headerlink" href="#line-and-pah-feature-flux-maps" title="Permalink to this headline">
              #
             </a>
            </h3>
            <section id="functions-to-extract-line-and-pah-maps-from-model-parameter-cube">
             <h4>
              Functions to extract line and PAH maps from model parameter cube
              <a class="headerlink" href="#functions-to-extract-line-and-pah-maps-from-model-parameter-cube" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="k">def</span> <span class="nf">line_map</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">"""Create total emission line flux map for Gaussian emission line model component"""</span>
    
    <span class="n">line_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">'nan'</span><span class="p">:</span>
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>
            <span class="n">amp</span><span class="p">,</span> <span class="n">cen</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">gaussian_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>               
            <span class="n">line_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">gaussianline_flux</span><span class="p">(</span><span class="n">amp</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">cen</span><span class="p">)</span>                      

    <span class="k">return</span> <span class="n">line_flux</span>

<span class="k">def</span> <span class="nf">pahdust_maps</span><span class="p">(</span><span class="n">pahdust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">"""Create total emission line flux map for Gaussian emission line model component"""</span>
    
    <span class="n">pah_ion_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="n">pah_neutral_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">'nan'</span><span class="p">:</span>
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">pahdust_comp</span><span class="o">+</span><span class="s1">'_'</span>
            <span class="n">ampl_76</span><span class="p">,</span> <span class="n">ampl_113</span> <span class="o">=</span> <span class="n">pahdust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>  
            <span class="n">pah_76_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_76</span><span class="p">,</span><span class="mf">0.044</span><span class="p">,</span><span class="mf">7.60</span><span class="p">)</span>
            <span class="n">pah_113_flux</span> <span class="o">=</span> <span class="n">drudeline_flux</span><span class="p">(</span><span class="n">ampl_113</span><span class="p">,</span><span class="mf">0.032</span><span class="p">,</span><span class="mf">11.33</span><span class="p">)</span>                      
            <span class="n">pah_ion_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_76_flux</span>
            <span class="n">pah_neutral_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">pah_113_flux</span>

    <span class="k">return</span> <span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span>

<span class="k">def</span> <span class="nf">sidust_map</span><span class="p">(</span><span class="n">sidust_comp</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">):</span>
    <span class="sd">"""Create silicate dust emission map"""</span>
    <span class="n">sidust_flux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">dumpval</span> <span class="ow">in</span> <span class="n">cube_res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cube_res</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span><span class="o">==</span><span class="s1">'nan'</span><span class="p">:</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="s1">'nan'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">modres</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dumpval</span><span class="p">,</span> <span class="n">funcdefs</span><span class="o">=</span><span class="n">funcdefs</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">sidust_comp</span><span class="o">+</span><span class="s1">'_'</span>
            <span class="n">t</span><span class="p">,</span><span class="n">si_ampl</span> <span class="o">=</span> <span class="n">sidust_extractpars</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="n">si_norm</span><span class="o">=</span><span class="mf">1.0</span>
            <span class="n">sidust_flux</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">si_ampl</span><span class="o">*</span><span class="n">si_norm</span>
            
    <span class="k">return</span> <span class="n">sidust_flux</span>
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
            <section id="h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model">
             <h4>
              H2 9.6 micron, [Ne II] 12.8 micron, PAH 7.6, PAH 11.3, and silicate dust emission maps from model
              <a class="headerlink" href="#h2-9-6-micron-ne-ii-12-8-micron-pah-7-6-pah-11-3-and-silicate-dust-emission-maps-from-model" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="n">h2_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">'h96'</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">ne_flux</span><span class="o">=</span><span class="n">line_map</span><span class="p">(</span><span class="s1">'NeII'</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span> <span class="o">=</span> <span class="n">pahdust_maps</span><span class="p">(</span><span class="s1">'pahdust1'</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>
<span class="n">sidust_flux</span><span class="o">=</span><span class="n">sidust_map</span><span class="p">(</span><span class="s1">'sidust1'</span><span class="p">,</span> <span class="n">cube_res</span><span class="p">,</span> <span class="n">modres</span><span class="p">)</span>

<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'[Ne II] 12.8 um'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2 9.6 um'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'PAH 7.6 um'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'PAH 11.3 um'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Si dust em.'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sidust_flux</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>           
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">#Make RGB images</span>
<span class="n">stretch1</span><span class="o">=</span><span class="mf">0.000000000000004</span>
<span class="n">stretch2</span><span class="o">=</span><span class="mf">0.000000000000005</span>
<span class="n">m58_neii_pah0_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">ne_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch1</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"m58_NeII_H96_PAH113.png"</span><span class="p">)</span>
<span class="n">m58_pah_h2</span> <span class="o">=</span> <span class="n">make_lupton_rgb</span><span class="p">(</span><span class="n">pah_neutral_flux</span><span class="p">,</span> <span class="n">h2_flux</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">pah_ion_flux</span><span class="p">,</span> <span class="n">minimum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="n">stretch2</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">"m58_PAH113_H96_PAH76.png"</span><span class="p">)</span>

<span class="c1">#Two-panel figure</span>
<span class="n">f</span><span class="p">,(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">)</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_neii_pah0_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_pah_h2</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <img alt="../../_images/cube_fitting_32_0.png" src="../../_images/cube_fitting_32_0.png"/>
               <img alt="../../_images/cube_fitting_32_1.png" src="../../_images/cube_fitting_32_1.png"/>
              </div>
             </div>
             <p>
              3-color RGB images. Top: individual feature maps. Bottom left: r = [Ne II] 12.8 micron, g = H2 S(3) 9.6 micron, b = PAH 11.3 micron. Ionized atomic gas in the active galactic nucleus shows up as red, shocked regions are green, and dust emission is blue. Bottom right: r = PAH 11.3 micron, g = H2 S(3) 9.6 micron, b = PAH 7.6 micron. Neutral PAH emission shows up as red, ionized PAH emission from PDRs in star-forming regions is blue, and shocked regions are green.
             </p>
            </section>
           </section>
          </section>
          <section id="extract-and-model-cube-sub-regions">
           <h2>
            Extract and model cube sub-regions
            <a class="headerlink" href="#extract-and-model-cube-sub-regions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="make-spectral-region-masks">
            <h3>
             Make spectral region masks
             <a class="headerlink" href="#make-spectral-region-masks" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Define spectral extraction regions based on spatial location, line flux, and line or feature ratios.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1">#Nucleus extraction region, defined by 5x5 square</span>
<span class="n">nuc_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">nuc_mask</span><span class="p">[</span><span class="mi">14</span><span class="o">-</span><span class="n">a</span><span class="p">,</span><span class="mi">17</span><span class="o">-</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Spiral arm extraction region</span>
<span class="n">arm_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">pah_ion_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Inner disk extraction region        </span>
<span class="n">pah_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">pah_neutral_flux</span><span class="o">&gt;=</span><span class="mf">0.155e-14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">h2_flux</span><span class="o">&lt;</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">arm_mask</span>
<span class="n">pah_mask</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#Trim edges of cube</span>
<span class="n">pah_mask</span><span class="p">[</span><span class="mi">28</span><span class="p">:,:]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#Regions of strongest H2 emission</span>
<span class="n">h2s_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">h2_flux</span><span class="o">/</span><span class="n">pah_neutral_flux</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">#H2 extraction region</span>
<span class="n">h2_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">h2_flux</span><span class="o">&gt;=</span><span class="mf">1e-15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nuc_mask</span><span class="o">==</span><span class="mi">0</span><span class="p">)),</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">h2s_mask</span>

<span class="c1">#M58 combined central regions mask (excluding spiral arm)</span>
<span class="n">m58_mask</span><span class="o">=</span><span class="n">nuc_mask</span> <span class="o">+</span> <span class="n">h2_mask</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">h2s_mask</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">pah_mask</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span><span class="n">arm_mask</span><span class="o">*</span><span class="mi">5</span>

<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Nucleus'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">nuc_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Spiral Arm'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">arm_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Inner Disk'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pah_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2-strongest'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">h2s_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'All regions'</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_5008/486002270.py:8: RuntimeWarning: invalid value encountered in divide
  arm_mask=np.where(((pah_neutral_flux&gt;=0.155e-14) &amp;((pah_ion_flux/pah_neutral_flux)&gt;0.8) &amp; (nuc_mask==0)),1,0)
/tmp/ipykernel_5008/486002270.py:16: RuntimeWarning: invalid value encountered in divide
  h2s_mask=np.where(((h2_flux&gt;=1e-15)&amp;((h2_flux/pah_neutral_flux)&gt;0.7) &amp; (nuc_mask==0)),1,0)
</pre>
               </div>
              </div>
              <img alt="../../_images/cube_fitting_35_1.png" src="../../_images/cube_fitting_35_1.png"/>
             </div>
            </div>
            <p>
             Extraction region masks based on spatial and emission line or PAH feature strengths.
            </p>
           </section>
           <section id="extract-spectra-from-mask-regions">
            <h3>
             Extract spectra from mask regions
             <a class="headerlink" href="#extract-spectra-from-mask-regions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Spectra summed over five different regions: Spiral Arm, Nucleus, PAH, H2, and Strongest H2
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">nuc_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">nuc_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_spec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xsize</span><span class="p">,)</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ysize</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">zsize</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nuc_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">nuc_spec</span><span class="o">=</span><span class="n">nuc_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">nuc_err</span><span class="o">=</span><span class="n">nuc_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">pah_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">pah_spec</span><span class="o">=</span><span class="n">pah_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">pah_err</span><span class="o">=</span><span class="n">pah_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2_spec</span><span class="o">=</span><span class="n">h2_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2_err</span><span class="o">=</span><span class="n">h2_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">arm_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">arm_spec</span><span class="o">=</span><span class="n">arm_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">arm_err</span><span class="o">=</span><span class="n">arm_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">h2s_mask</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spec_pix</span><span class="p">,</span><span class="n">err_pix</span><span class="o">=</span><span class="n">extract_spec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">h2s_spec</span><span class="o">=</span><span class="n">h2s_spec</span><span class="o">+</span><span class="n">spec_pix</span>
            <span class="n">h2s_err</span><span class="o">=</span><span class="n">h2s_err</span><span class="o">+</span><span class="n">err_pix</span><span class="o">**</span><span class="mi">2</span>

<span class="n">nuc_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nuc_err</span><span class="p">)</span>
<span class="n">pah_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pah_err</span><span class="p">)</span>
<span class="n">h2_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2_err</span><span class="p">)</span>
<span class="n">arm_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arm_err</span><span class="p">)</span>
<span class="n">h2s_err</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h2s_err</span><span class="p">)</span>
<span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Spiral Arm'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'gold'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flux (Jy)'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Nucleus'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Inner Disk'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'limegreen'</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"Wavelength $(\mu m)$"</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flux (Jy)'</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'All regions'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Pixel'</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2-Strongest'</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">'teal'</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"Wavelength $(\mu m)$"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/cube_fitting_39_0.png" src="../../_images/cube_fitting_39_0.png"/>
             </div>
            </div>
           </section>
           <section id="save-spectra-to-files">
            <h3>
             Save spectra to files
             <a class="headerlink" href="#save-spectra-to-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1">#np.savetxt(targname+'_spec_nuc.dat', np.column_stack((x, nuc_spec, nuc_err)),header='Wavelength[microns]     Flux_Nucleus[Jy]      Err_Flux_Nucleus')</span>
<span class="c1">#np.savetxt(targname+'_spec_h2.dat', np.column_stack((x, h2_spec, h2_err)), header='Wavelength[microns]     Flux_H2[Jy]      Err_H2')</span>
<span class="c1">#np.savetxt(targname+'_spec_h2s.dat', np.column_stack((x, h2_spec, h2_err)), header='Wavelength[microns]     Flux_H2s[Jy]      Err_H2s')</span>
<span class="c1">#np.savetxt(targname+'_spec_pah.dat', np.column_stack((x, pah_spec, pah_err)), header='Wavelength[microns]     Flux_PAH[Jy]      Err_PAH')</span>
<span class="c1">#np.savetxt(targname+'_spec_arm.dat', np.column_stack((x, arm_spec, arm_err)), header='Wavelength[microns]     Flux_Arm[Jy]      Err_Arm')</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="fit-spectra-of-regions">
            <h3>
             Fit spectra of regions
             <a class="headerlink" href="#fit-spectra-of-regions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <section id="generic-model-components">
             <h4>
              Generic model components
              <a class="headerlink" href="#generic-model-components" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              Model 14 individual PAH components with all amplitudes free. It would be computationally expensive to do this
for the full cube, but only takes a couple of seconds for the summed region spectra.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="c1">#Power Law</span>
<span class="n">p_law</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">powerlaw</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s1">'pwl_'</span><span class="p">)</span>
<span class="n">generic_pars</span> <span class="o">=</span> <span class="n">p_law</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>      <span class="c1">#Generate the parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c1'</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c2'</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Individual PAHs</span>
<span class="n">drudes</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="n">allpahlines</span><span class="o">=</span><span class="p">[</span><span class="s1">'52'</span><span class="p">,</span><span class="s1">'62'</span><span class="p">,</span><span class="s1">'74'</span><span class="p">,</span><span class="s1">'76'</span><span class="p">,</span><span class="s1">'78'</span><span class="p">,</span><span class="s1">'83'</span><span class="p">,</span><span class="s1">'86'</span><span class="p">,</span><span class="s1">'112'</span><span class="p">,</span><span class="s1">'113'</span><span class="p">,</span><span class="s1">'119'</span><span class="p">,</span><span class="s1">'126'</span><span class="p">,</span><span class="s1">'134'</span><span class="p">,</span><span class="s1">'140'</span><span class="p">,</span><span class="s1">'141'</span><span class="p">]</span> 
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">allpahlines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">'PAH'</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>  
    <span class="n">drudes</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">drude</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>  
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">drudes</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>

<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH52'</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.27</span><span class="p">,</span> <span class="mf">0.034</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH62'</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.22</span><span class="p">,</span> <span class="mf">0.030</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH74'</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.42</span><span class="p">,</span> <span class="mf">0.126</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH76'</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">7.60</span><span class="p">,</span> <span class="mf">0.044</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH78'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">7.85</span><span class="p">,</span> <span class="mf">0.053</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH83'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.33</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH86'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">8.61</span><span class="p">,</span> <span class="mf">0.039</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH112'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.23</span><span class="p">,</span> <span class="mf">0.012</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH113'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.33</span><span class="p">,</span> <span class="mf">0.032</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH119'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">11.99</span><span class="p">,</span> <span class="mf">0.045</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH126'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">12.62</span><span class="p">,</span> <span class="mf">0.042</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH134'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">13.48</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH140'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.04</span><span class="p">,</span> <span class="mf">0.016</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">drude_defpar</span><span class="p">(</span><span class="s1">'PAH141'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">14.19</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Silicate dust emission</span>
<span class="n">prefix</span><span class="o">=</span><span class="s1">'sidust1_'</span>
<span class="n">silicate</span><span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">sidust</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">silicate</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">'sidust1'</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">1.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Gaussians with FWHM and X central from Smith et al 2007</span>
<span class="c1">#H2 molecular</span>
<span class="n">h2lines</span><span class="o">=</span><span class="p">[</span><span class="s1">'55'</span><span class="p">,</span><span class="s1">'61'</span><span class="p">,</span><span class="s1">'69'</span><span class="p">,</span><span class="s1">'80'</span><span class="p">,</span><span class="s1">'96'</span><span class="p">,</span><span class="s1">'122'</span><span class="p">]</span>
<span class="n">gaussH2</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">h2lines</span><span class="p">:</span>
    <span class="n">prefix</span><span class="o">=</span><span class="s1">'h'</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>
    <span class="n">gaussH2</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussH2</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h55'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">5.511</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h61'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.109</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h69'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.909</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h80'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">8.026</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h96'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">9.665</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'h122'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.278</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Atomic lines</span>
<span class="n">atomiclines</span><span class="o">=</span><span class="p">[</span><span class="s1">'ArII'</span><span class="p">,</span><span class="s1">'SIV'</span><span class="p">,</span><span class="s1">'NeII'</span><span class="p">]</span>
<span class="n">gaussAt</span><span class="o">=</span><span class="n">Model</span><span class="p">(</span><span class="n">Modelcero</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomiclines</span><span class="p">:</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">line</span><span class="o">+</span><span class="s1">'_'</span>
    <span class="n">gaussAt</span><span class="o">+=</span><span class="n">Model</span><span class="p">(</span><span class="n">gaussian</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
<span class="n">generic_pars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gaussAt</span><span class="o">.</span><span class="n">make_params</span><span class="p">())</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'ArII'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">6.985</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'SIV'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">10.511</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
<span class="n">gaussian_defpar</span><span class="p">(</span><span class="s1">'NeII'</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">12.813</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
            <section id="spiral-arm-spectral-fit">
             <h4>
              Spiral arm spectral fit
              <a class="headerlink" href="#spiral-arm-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="c1">#Spiral arm spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">arm_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">arm_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c1'</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c2'</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">arm_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">arm_model</span> <span class="o">=</span> <span class="n">arm_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">arm_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">arm_model</span>
<span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">arm_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, arm_result)</span>
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Model fit to integrated spectrum of spiral arm region.
             </p>
            </section>
            <section id="h2-strongest-region-spectral-fit">
             <h4>
              H2-strongest region spectral fit
              <a class="headerlink" href="#h2-strongest-region-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="c1">#H2 region spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">h2s_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">h2s_err</span>

<span class="c1">#Model (powerlaw + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussAt</span> <span class="o">+</span> <span class="n">gaussH2</span>

<span class="c1">#Adjust power law starting parameters </span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c1'</span><span class="p">,</span><span class="mf">0.002</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c2'</span><span class="p">,</span><span class="mf">0.0015</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">h2s_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">h2s_model</span> <span class="o">=</span> <span class="n">h2s_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">h2s_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">h2s_model</span>
<span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">h2s_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">h2s_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="c1">#plot_fit(x, spec, specerr, h2s_result)</span>
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              Model fit to integrated spectrum of H2-strongest region.
             </p>
            </section>
            <section id="nucleus-spectral-fit">
             <h4>
              Nucleus spectral fit
              <a class="headerlink" href="#nucleus-spectral-fit" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="c1">#Nucleus spectrum</span>
<span class="n">spec</span><span class="o">=</span><span class="n">nuc_spec</span>
<span class="n">specerr</span><span class="o">=</span><span class="n">nuc_err</span>

<span class="c1">#Model (powerlaw + AGN silicate emission + individual PAHs + H2 and Atomic lines, no extinction)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">p_law</span> <span class="o">+</span> <span class="n">silicate</span> <span class="o">+</span> <span class="n">drudes</span> <span class="o">+</span> <span class="n">gaussH2</span> <span class="o">+</span> <span class="n">gaussAt</span>

<span class="c1">#Adjust power law and silicate dust starting parameters</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c1'</span><span class="p">,</span><span class="mf">0.005</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">setpar</span><span class="p">(</span><span class="n">generic_pars</span><span class="p">,</span><span class="s1">'pwl_c2'</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
<span class="n">sidust_defpar</span><span class="p">(</span><span class="s1">'sidust1'</span><span class="p">,</span> <span class="mf">190.</span><span class="p">,</span><span class="mf">2.E-4</span><span class="p">,</span><span class="n">generic_pars</span><span class="p">)</span>

<span class="c1">#Model Results</span>
<span class="n">nuc_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">generic_pars</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">specerr</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="n">nuc_model</span> <span class="o">=</span> <span class="n">nuc_result</span><span class="o">.</span><span class="n">best_fit</span> 
<span class="n">nuc_residual</span> <span class="o">=</span> <span class="n">spec</span> <span class="o">-</span> <span class="n">nuc_model</span>
<span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="o">=</span><span class="n">model_comps</span><span class="p">(</span><span class="n">nuc_result</span><span class="p">)</span>

<span class="c1">#Plot</span>
<span class="n">plot_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">specerr</span><span class="p">,</span> <span class="n">nuc_result</span><span class="p">)</span>
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <img alt="../../_images/cube_fitting_52_0.png" src="../../_images/cube_fitting_52_0.png"/>
               <img alt="../../_images/cube_fitting_52_1.png" src="../../_images/cube_fitting_52_1.png"/>
              </div>
             </div>
             <p>
              Model fit to nucleus, including fixed-temperature AGN silicate emission.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span><span class="n">nuc_result</span>
<span class="c1">#result.fit_report(show_correl=False)</span>
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output text_html">
                <h2>
                 Model
                </h2>
                ((((Model(powerlaw, prefix='pwl_') + Model(sidust, prefix='sidust1_')) + ((((((((((((((Model(Modelcero) + Model(drude, prefix='PAH52_')) + Model(drude, prefix='PAH62_')) + Model(drude, prefix='PAH74_')) + Model(drude, prefix='PAH76_')) + Model(drude, prefix='PAH78_')) + Model(drude, prefix='PAH83_')) + Model(drude, prefix='PAH86_')) + Model(drude, prefix='PAH112_')) + Model(drude, prefix='PAH113_')) + Model(drude, prefix='PAH119_')) + Model(drude, prefix='PAH126_')) + Model(drude, prefix='PAH134_')) + Model(drude, prefix='PAH140_')) + Model(drude, prefix='PAH141_'))) + ((((((Model(Modelcero) + Model(gaussian, prefix='h55_')) + Model(gaussian, prefix='h61_')) + Model(gaussian, prefix='h69_')) + Model(gaussian, prefix='h80_')) + Model(gaussian, prefix='h96_')) + Model(gaussian, prefix='h122_'))) + (((Model(Modelcero) + Model(gaussian, prefix='ArII_')) + Model(gaussian, prefix='SIV_')) + Model(gaussian, prefix='NeII_')))
                <h2>
                 Fit Statistics
                </h2>
                <table>
                 <tr>
                  <td>
                   fitting method
                  </td>
                  <td>
                   leastsq
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   # function evals
                  </td>
                  <td>
                   437
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   # data points
                  </td>
                  <td>
                   194
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   # variables
                  </td>
                  <td>
                   26
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   chi-square
                  </td>
                  <td>
                   7693.84415
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   reduced chi-square
                  </td>
                  <td>
                   45.7966914
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   Akaike info crit.
                  </td>
                  <td>
                   765.981628
                  </td>
                  <td>
                  </td>
                 </tr>
                 <tr>
                  <td>
                   Bayesian info crit.
                  </td>
                  <td>
                   850.945940
                  </td>
                  <td>
                  </td>
                 </tr>
                </table>
                <h2>
                 Variables
                </h2>
                <table>
                 <tr>
                  <th>
                   name
                  </th>
                  <th>
                   value
                  </th>
                  <th>
                   standard error
                  </th>
                  <th>
                   relative error
                  </th>
                  <th>
                   initial value
                  </th>
                  <th>
                   min
                  </th>
                  <th>
                   max
                  </th>
                  <th>
                   vary
                  </th>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   0.09323626
                  </td>
                  <td>
                   0.00988870
                  </td>
                  <td>
                   (10.61%)
                  </td>
                  <td>
                   0.005
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   -0.40070134
                  </td>
                  <td>
                   0.05813546
                  </td>
                  <td>
                   (14.51%)
                  </td>
                  <td>
                   0.01
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   0.00153020
                  </td>
                  <td>
                   0.00171568
                  </td>
                  <td>
                   (112.12%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_peakx
                  </td>
                  <td>
                   5.29666620
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   5.2966662
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_frac_FWHM
                  </td>
                  <td>
                   0.03400000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.034
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   0.00969676
                  </td>
                  <td>
                   0.00130534
                  </td>
                  <td>
                   (13.46%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_peakx
                  </td>
                  <td>
                   6.25147320
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   6.2514732
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_frac_FWHM
                  </td>
                  <td>
                   0.03000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.03
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   0.00387555
                  </td>
                  <td>
                   0.00178380
                  </td>
                  <td>
                   (46.03%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_peakx
                  </td>
                  <td>
                   7.45754520
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   7.4575452
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_frac_FWHM
                  </td>
                  <td>
                   0.12600000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.126
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   0.00815708
                  </td>
                  <td>
                   0.00241382
                  </td>
                  <td>
                   (29.59%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_peakx
                  </td>
                  <td>
                   7.63845600
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   7.638456
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_frac_FWHM
                  </td>
                  <td>
                   0.04400000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.044
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   0.01091009
                  </td>
                  <td>
                   0.00163270
                  </td>
                  <td>
                   (14.97%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_peakx
                  </td>
                  <td>
                   7.88972100
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   7.889721
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_frac_FWHM
                  </td>
                  <td>
                   0.05300000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.053
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   7.5373e-04
                  </td>
                  <td>
                   0.00114876
                  </td>
                  <td>
                   (152.41%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_peakx
                  </td>
                  <td>
                   8.37214980
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   8.3721498
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_frac_FWHM
                  </td>
                  <td>
                   0.05000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   0.00579103
                  </td>
                  <td>
                   0.00124851
                  </td>
                  <td>
                   (21.56%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_peakx
                  </td>
                  <td>
                   8.65356660
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   8.6535666
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_frac_FWHM
                  </td>
                  <td>
                   0.03900000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.039
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH112_amplitude
                  </td>
                  <td>
                   0.02791784
                  </td>
                  <td>
                   0.00249672
                  </td>
                  <td>
                   (8.94%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH112_peakx
                  </td>
                  <td>
                   11.2868238
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   11.2868238
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH112_frac_FWHM
                  </td>
                  <td>
                   0.01200000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.012
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_amplitude
                  </td>
                  <td>
                   0.02507602
                  </td>
                  <td>
                   0.00171113
                  </td>
                  <td>
                   (6.82%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_peakx
                  </td>
                  <td>
                   11.3873298
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   11.387329800000002
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_frac_FWHM
                  </td>
                  <td>
                   0.03200000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.032
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   0.00753090
                  </td>
                  <td>
                   0.00125444
                  </td>
                  <td>
                   (16.66%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_peakx
                  </td>
                  <td>
                   12.0506694
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   12.0506694
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_frac_FWHM
                  </td>
                  <td>
                   0.04500000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.045
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.01570182
                  </td>
                  <td>
                   0.00113758
                  </td>
                  <td>
                   (7.24%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_peakx
                  </td>
                  <td>
                   12.6838572
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   12.6838572
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_frac_FWHM
                  </td>
                  <td>
                   0.04200000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.042
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.00532541
                  </td>
                  <td>
                   0.00149159
                  </td>
                  <td>
                   (28.01%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_peakx
                  </td>
                  <td>
                   13.5482088
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   13.548208800000001
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_frac_FWHM
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH140_amplitude
                  </td>
                  <td>
                   0.00612965
                  </td>
                  <td>
                   0.00231252
                  </td>
                  <td>
                   (37.73%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH140_peakx
                  </td>
                  <td>
                   14.1110424
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   14.1110424
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH140_frac_FWHM
                  </td>
                  <td>
                   0.01600000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.016
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.00106661
                  </td>
                  <td>
                   0.00205049
                  </td>
                  <td>
                   (192.24%)
                  </td>
                  <td>
                   0.5
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH141_peakx
                  </td>
                  <td>
                   14.2618014
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   14.261801400000001
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH141_frac_FWHM
                  </td>
                  <td>
                   0.02500000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.025
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   sidust1_T
                  </td>
                  <td>
                   190.000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   190.0
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.00147028
                  </td>
                  <td>
                   6.3970e-05
                  </td>
                  <td>
                   (4.35%)
                  </td>
                  <td>
                   0.0002
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   0.00807689
                  </td>
                  <td>
                   0.00208745
                  </td>
                  <td>
                   (25.84%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h55_xcen
                  </td>
                  <td>
                   5.53888566
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   5.53888566
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h55_std
                  </td>
                  <td>
                   0.02000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.02
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h61_amplitude
                  </td>
                  <td>
                   0.00570437
                  </td>
                  <td>
                   0.00234816
                  </td>
                  <td>
                   (41.16%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h61_xcen
                  </td>
                  <td>
                   6.13991154
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   6.13991154
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h61_std
                  </td>
                  <td>
                   0.02000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.02
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h69_amplitude
                  </td>
                  <td>
                   0.03374199
                  </td>
                  <td>
                   0.00392861
                  </td>
                  <td>
                   (11.64%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h69_xcen
                  </td>
                  <td>
                   6.94395954
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   6.94395954
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h69_std
                  </td>
                  <td>
                   0.02000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.02
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h80_amplitude
                  </td>
                  <td>
                   0.00788398
                  </td>
                  <td>
                   0.00224407
                  </td>
                  <td>
                   (28.46%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h80_xcen
                  </td>
                  <td>
                   8.06661156
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   8.06661156
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h80_std
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h96_amplitude
                  </td>
                  <td>
                   0.04421750
                  </td>
                  <td>
                   0.00185183
                  </td>
                  <td>
                   (4.19%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h96_xcen
                  </td>
                  <td>
                   9.71390490
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   9.7139049
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h96_std
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h122_amplitude
                  </td>
                  <td>
                   0.02237824
                  </td>
                  <td>
                   0.00242101
                  </td>
                  <td>
                   (10.82%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h122_xcen
                  </td>
                  <td>
                   12.3401267
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   12.340126680000001
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   h122_std
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ArII_amplitude
                  </td>
                  <td>
                   0.01904380
                  </td>
                  <td>
                   0.00277182
                  </td>
                  <td>
                   (14.55%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ArII_xcen
                  </td>
                  <td>
                   7.02034410
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   7.020344100000001
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ArII_std
                  </td>
                  <td>
                   0.02000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.02
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   SIV_amplitude
                  </td>
                  <td>
                   8.4793e-04
                  </td>
                  <td>
                   0.00222140
                  </td>
                  <td>
                   (261.98%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   SIV_xcen
                  </td>
                  <td>
                   10.5641857
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   10.56418566
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   SIV_std
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   NeII_amplitude
                  </td>
                  <td>
                   0.05889577
                  </td>
                  <td>
                   0.00237347
                  </td>
                  <td>
                   (4.03%)
                  </td>
                  <td>
                   0.05
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   True
                  </td>
                 </tr>
                 <tr>
                  <td>
                   NeII_xcen
                  </td>
                  <td>
                   12.8778338
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   12.877833780000001
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                 <tr>
                  <td>
                   NeII_std
                  </td>
                  <td>
                   0.04000000
                  </td>
                  <td>
                   0.00000000
                  </td>
                  <td>
                   (0.00%)
                  </td>
                  <td>
                   0.04
                  </td>
                  <td>
                   -inf
                  </td>
                  <td>
                   inf
                  </td>
                  <td>
                   False
                  </td>
                 </tr>
                </table>
                <h2>
                 Correlations (unreported correlations are &lt; 0.100)
                </h2>
                <table>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   -0.9932
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   -0.8837
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.8382
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH112_amplitude
                  </td>
                  <td>
                   PAH113_amplitude
                  </td>
                  <td>
                   -0.7136
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   -0.7006
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   -0.6250
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.6103
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH140_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   -0.5920
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   -0.5673
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.5537
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.5146
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.4884
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   -0.4291
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.4203
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   -0.4172
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.4037
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   h80_amplitude
                  </td>
                  <td>
                   -0.3960
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   -0.3889
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   -0.3786
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   -0.3743
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.3685
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   0.3591
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.3490
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   0.3466
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.3178
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.2766
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.2751
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.2726
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   -0.2725
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   NeII_amplitude
                  </td>
                  <td>
                   -0.2719
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   -0.2643
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   0.2594
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   -0.2544
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   0.2478
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.2448
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.2337
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   ArII_amplitude
                  </td>
                  <td>
                   -0.2282
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   h122_amplitude
                  </td>
                  <td>
                   -0.2128
                  </td>
                 </tr>
                 <tr>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   SIV_amplitude
                  </td>
                  <td>
                   -0.2103
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.2100
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   0.2050
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.1987
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   h80_amplitude
                  </td>
                  <td>
                   0.1944
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   -0.1932
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   -0.1919
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   ArII_amplitude
                  </td>
                  <td>
                   0.1847
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   h61_amplitude
                  </td>
                  <td>
                   -0.1818
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_amplitude
                  </td>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   -0.1787
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.1785
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   -0.1783
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   0.1771
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.1666
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.1653
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   0.1637
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.1632
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   -0.1629
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.1617
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   -0.1605
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   0.1604
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.1601
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   -0.1596
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   0.1589
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   0.1582
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   0.1580
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   0.1562
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   0.1528
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH112_amplitude
                  </td>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   0.1525
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   0.1515
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   -0.1465
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   0.1446
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   -0.1394
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   h69_amplitude
                  </td>
                  <td>
                   -0.1334
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   -0.1282
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH119_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.1267
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   sidust1_amplitude
                  </td>
                  <td>
                   -0.1256
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH83_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.1222
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c2
                  </td>
                  <td>
                   SIV_amplitude
                  </td>
                  <td>
                   0.1200
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH76_amplitude
                  </td>
                  <td>
                   h69_amplitude
                  </td>
                  <td>
                   0.1175
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH52_amplitude
                  </td>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   0.1163
                  </td>
                 </tr>
                 <tr>
                  <td>
                   pwl_c1
                  </td>
                  <td>
                   SIV_amplitude
                  </td>
                  <td>
                   -0.1131
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH62_amplitude
                  </td>
                  <td>
                   PAH86_amplitude
                  </td>
                  <td>
                   0.1124
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   0.1120
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH134_amplitude
                  </td>
                  <td>
                   PAH140_amplitude
                  </td>
                  <td>
                   -0.1112
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH113_amplitude
                  </td>
                  <td>
                   PAH126_amplitude
                  </td>
                  <td>
                   0.1044
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH74_amplitude
                  </td>
                  <td>
                   h55_amplitude
                  </td>
                  <td>
                   0.1028
                  </td>
                 </tr>
                 <tr>
                  <td>
                   PAH78_amplitude
                  </td>
                  <td>
                   PAH141_amplitude
                  </td>
                  <td>
                   0.1009
                  </td>
                 </tr>
                </table>
               </div>
              </div>
             </div>
             <p>
              Fit parameters for spectrum of nucleus
             </p>
            </section>
           </section>
          </section>
          <section id="summary-plot">
           <h2>
            Summary Plot
            <a class="headerlink" href="#summary-plot" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">f</span><span class="p">,((</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">),(</span><span class="n">ax4</span><span class="p">,</span><span class="n">ax5</span><span class="p">,</span><span class="n">ax6</span><span class="p">))</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Spiral Arm'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flux (Jy)'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">arm_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">arm_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'gold'</span><span class="p">)</span>
<span class="n">mod_colors</span><span class="o">=</span><span class="p">[</span><span class="s1">'brown'</span><span class="p">,</span><span class="s1">'g'</span><span class="p">,</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'magenta'</span><span class="p">,</span><span class="s1">'orange'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arm_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Nucleus'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">nuc_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">nuc_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">)</span>
<span class="c1">#ax2.plot(x, fit_model,label='Model',c='red')</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nuc_modelcomps</span><span class="p">,</span><span class="n">nuc_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Inner Disk'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pah_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">pah_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'limegreen'</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"Wavelength $(\mu m)$"</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flux (Jy)'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2_err</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'steelblue'</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'All regions'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Pixel'</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m58_mask</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">'lower'</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'H2-Strongest'</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">"Wavelength $(\mu m)$"</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">h2s_spec</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">h2s_err</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">'teal'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">mcomp</span><span class="p">,</span><span class="n">mlabl</span><span class="p">,</span><span class="n">mcolr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">h2s_modelcomps</span><span class="p">,</span><span class="n">arm_modlabels</span><span class="p">,</span><span class="n">mod_colors</span><span class="p">):</span>
    <span class="n">ax6</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">mcomp</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">mlabl</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">mcolr</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/cube_fitting_57_0.png" src="../../_images/cube_fitting_57_0.png"/>
            </div>
           </div>
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
           <p>
            Notebook created by Patrick Ogle and Ivan Lopez.
           </p>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/cube_fitting"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            Specviz Simple Demo
           </p>
          </div>
         </a>
         <a class="right-next" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            MRS Pipeline
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        Â© Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>