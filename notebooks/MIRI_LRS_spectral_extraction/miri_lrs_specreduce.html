

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>MIRI LRS Optimal Spectral Extraction &#8212; STScI JDAT Notebooks</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/MIRI_LRS_spectral_extraction/miri_lrs_specreduce';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/stsci_logo2.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">General</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebook_development_workflow.html">Notebook Development Workflow</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/submitting_notebooks.html">Submitting Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/requirements.html">Requirements file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/notebooks.html">Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/data_files.html">Data Files</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">GitHub Guidelines</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_setup.html">GitHub Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_workflow.html">GitHub Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/github_pr.html">GitHub PR</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Cross-Instrument</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../asdf_example/asdf_example.html">ASDF Example</a></li>

<li class="toctree-l1"><a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">Complex 2D Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">Composite Model Spectral Fitting</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">MAST Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">RGB images with Imviz</a></li>
<li class="toctree-l1"><a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">Specviz Simple Demo</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">MIRI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">MRS Mstar - Run Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">MRS Detector Based Extraction</a></li>




<li class="toctree-l1"><a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">MRS Mstar - Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">IFU of YSOs in LMC</a></li>
<li class="toctree-l1"><a class="reference internal" href="miri_lrs_spectral_extraction.html">LRS Optimal Spectral Extraction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRCam</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">Point Source Aperture Photometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">Extended Aperture Photometry</a></li>


<li class="toctree-l1"><a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">Cross-Filter PSF Matching</a></li>
<li class="toctree-l1"><a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">PSF Photometry</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRISS</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">WFSS Spectra - Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">WFSS Spectra - Combine and Normalize 1D Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">WFSS Spectra - Cross-Correlation Template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">WFSS Spectra - Emission Line Map</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">NIRSpec</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">IFU Cube Fitting</a></li>

<li class="toctree-l1"><a class="reference internal" href="../ifu_optimal/ifu_optimal.html">IFU Optimal Spectral Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">MOS Optimal Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">MOS Spectroscopy of Extragalactic Field</a></li>

<li class="toctree-l1"><a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">BOTS Time Series Observations</a></li>








</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/MIRI_LRS_spectral_extraction/miri_lrs_specreduce.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/MIRI_LRS_spectral_extraction/miri_lrs_specreduce.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>MIRI LRS Optimal Spectral Extraction</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">MIRI LRS Optimal Spectral Extraction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-ask-karl-exactly-how-these-functions-work-seems-like-all-weights-are-equal">Developer note: Ask Karl exactly how these functions work? Seems like all weights are equal?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#devloper-notes">Devloper notes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-files">Download Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#file-information">File information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-the-2d-spectrum-in-imviz-and-get-the-center-of-the-cross-dispersion">View the 2D Spectrum in Imviz and get the center of the cross-dispersion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-the-jwst-pipeline-1d-extraction-in-specviz">View the JWST pipeline 1D extraction in Specviz</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#boxcar-extraction">Boxcar Extraction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-allow-for-a-bad-pixel-mask">Developer note: Allow for a bad pixel mask</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fixed-width-boxcar">Fixed width boxcar</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#develepor-note-place-trace-back-into-specviz2d-imviz-etc">Develepor Note: Place trace back into Specviz2d/Imviz/Etc</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtraction">Background Subtraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-trace">Advanced Trace</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-old-vs-new-trace">Plot old vs new trace</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract">Extract</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wavelength-scaled-width-boxcar">Wavelength scaled width boxcar</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-not-currently-possible-allow-for-wavelength-scaled-width-in-the-boxcar">Developer note:  Not currently possible. Allow for wavelength scaled width in the boxcar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-based-extraction">PSF based Extraction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-in-the-jdat-notebook-guide-on-optimal-extraction">Steps in the JDAT Notebook guide on optimal extraction:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-in-the-original-horne-1986-paper">Steps in the original Horne (1986) paper:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-weighted-extaction">PSF weighted extaction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-psf-profile-as-a-function-of-wavelength">Generate the PSF profile as a function of wavelength</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-spectrum-using-wavelength-dependent-psf-profiles-using-the-same-traces-as-defined-above">Extract spectrum using wavelength dependent PSF profiles using the same traces as defined above</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-in-rayleigh-jeans-units">Plotting in Rayleigh-Jeans units</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this notebook</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="miri-lrs-optimal-spectral-extraction">
<h1>MIRI LRS Optimal Spectral Extraction<a class="headerlink" href="#miri-lrs-optimal-spectral-extraction" title="Permalink to this heading">#</a></h1>
<p><font color="red">This notebook currently fails to execute, use as reference only</font></p>
<p><strong>Use case:</strong> Extract spectra with different locations, extraction apertures, and techniques.<br>
<strong>Data:</strong> Simulated MIRI LRS spectrum.<br>
<strong>Tools:</strong> jwst, gwcs, matplotlib, astropy.<br>
<strong>Cross-intrument:</strong> NIRSpec, MIRI.<br>
<strong>Documentation:</strong> This notebook is part of a STScI’s larger <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">post-pipeline Data Analysis Tools Ecosystem</a>.<br></p>
</section>
<section id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h1>
<p>This notebook extracts a 1D spectra from a 2D MIRI LRS spectral observation (single image).  The goal is to provide the ability to extract spectra with different locations, extraction apertures, and techniques than are done in the JWST pipeline using the <a class="reference external" href="https://github.com/astropy/specreduce">Astropy Specreduce package</a>.</p>
<p>The simpliest spectral extraction is “boxcar” where all the pixels within some fixed width centered on the source position are summed at each wavelength.  Background subtraction can be done using regions offset from the source center. You can also see the Specreduce <a class="reference external" href="https://github.com/astropy/specreduce/blob/main/notebook_sandbox/jwst_boxcar/boxcar_extraction.ipynb">generic Sample Notebook</a>.</p>
<p>For spectra taken with a diffraction limited telescope like JWST, a modification boxcar extraction is to vary the extraction width linearly with wavelength.  Such a scaled boxcar extraction keeps the fraction of the source flux within the extraction region approximately constant with wavelength.</p>
<p>For point sources, a PSF-weighted spectral extraction can be done.  Using the PSF to weight the extraction uses the actual PSF as a function of wavelength to optimize the extraction to the pixels with the greatest signal.  PSF-weighted extractions show the largest differences with boxcar extractions at lower S/N values.</p>
<p><strong>Note:</strong> Corrections for the finite aperture used in all the extractions have not been applied.  Thus, the physical flux densities of all the extracted spectra are lower than the actual values.</p>
</section>
<section id="imports">
<h1>Imports<a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h1>
<ul class="simple">
<li><p><em>matplotlib.pyplot</em> for plotting data</p></li>
<li><p><em>numpy</em> to handle array functions</p></li>
<li><p><em>astropy.io fits</em> for accessing FITS files</p></li>
<li><p><em>astropy.visualization</em> for scaling image for display</p></li>
<li><p><em>astropy.table Table</em> for reading the pipeline 1d extractions</p></li>
<li><p><em>jwst datamodels</em> for reading/access the jwst data</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">gwcs.wcstools</span> <span class="kn">import</span> <span class="n">grid_from_bounding_box</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span>

<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">datamodels</span>

<span class="kn">from</span> <span class="nn">specreduce.extract</span> <span class="kn">import</span> <span class="n">BoxcarExtract</span><span class="p">,</span> <span class="n">OptimalExtract</span><span class="p">,</span> <span class="n">HorneExtract</span>
<span class="kn">from</span> <span class="nn">specreduce.tracing</span> <span class="kn">import</span> <span class="n">FlatTrace</span><span class="p">,</span> <span class="n">KosmosTrace</span>
<span class="kn">from</span> <span class="nn">specreduce.background</span> <span class="kn">import</span> <span class="n">Background</span>

<span class="kn">from</span> <span class="nn">jdaviz</span> <span class="kn">import</span> <span class="n">Imviz</span>
<span class="kn">from</span> <span class="nn">jdaviz</span> <span class="kn">import</span> <span class="n">Specviz</span>

<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
</pre></div>
</div>
</div>
</div>
<section id="developer-note-ask-karl-exactly-how-these-functions-work-seems-like-all-weights-are-equal">
<h2>Developer note: Ask Karl exactly how these functions work? Seems like all weights are equal?<a class="headerlink" href="#developer-note-ask-karl-exactly-how-these-functions-work-seems-like-all-weights-are-equal" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># useful functions</span>
<span class="k">def</span> <span class="nf">get_boxcar_weights</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">,</span> <span class="n">npix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the weights given an aperture center, half widths, and number of pixels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">))</span>
    <span class="c1"># pixels with full weight</span>
    <span class="n">fullpixels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">hwidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="n">hwidth</span><span class="p">),</span> <span class="n">npix</span><span class="p">)]</span>
    <span class="n">weights</span><span class="p">[</span><span class="n">fullpixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">fullpixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="c1"># pixels at the edges of the boxcar with partial weight</span>
    <span class="k">if</span> <span class="n">fullpixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">fullpixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hwidth</span> <span class="o">-</span> <span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">fullpixels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">fullpixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">npix</span><span class="p">:</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">fullpixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hwidth</span> <span class="o">-</span> <span class="p">(</span><span class="n">fullpixels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weights</span>


<span class="k">def</span> <span class="nf">ap_weight_images</span><span class="p">(</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">bkg_offset</span><span class="p">,</span> <span class="n">bkg_width</span><span class="p">,</span> <span class="n">image_size</span><span class="p">,</span> <span class="n">waves</span><span class="p">,</span> <span class="n">wavescale</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a weight image that defines the desired extraction aperture</span>
<span class="sd">    and the weight image for the requested background regions</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    center : float</span>
<span class="sd">        center of aperture in pixels</span>
<span class="sd">    width : float</span>
<span class="sd">        width of apeture in pixels</span>
<span class="sd">    bkg_offset : float</span>
<span class="sd">        offset from the extaction edge for the background</span>
<span class="sd">        never scaled for wavelength</span>
<span class="sd">    bkg_width : float</span>
<span class="sd">        width of background region</span>
<span class="sd">        never scaled with wavelength</span>
<span class="sd">    image_size : tuple with 2 elements</span>
<span class="sd">        size of image</span>
<span class="sd">    waves : array</span>
<span class="sd">        wavelegth values</span>
<span class="sd">    wavescale : float</span>
<span class="sd">        scale the width with wavelength (default=None)</span>
<span class="sd">        wavescale gives the reference wavelenth for the width value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wimage, bkg_wimage : (2D image, 2D image)</span>
<span class="sd">        wimage is the weight image defining the aperature</span>
<span class="sd">        bkg_image is the weight image defining the background regions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span>
    <span class="n">bkg_wimage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span>
    <span class="n">hwidth</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span>
    <span class="c1"># loop in dispersion direction and compute weights</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">wavescale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hwidth</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">waves</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">wavescale</span><span class="p">)</span>

        <span class="n">wimage</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_boxcar_weights</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">hwidth</span><span class="p">,</span> <span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># bkg regions</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bkg_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bkg_offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">bkg_wimage</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_boxcar_weights</span><span class="p">(</span>
                <span class="n">center</span> <span class="o">-</span> <span class="n">hwidth</span> <span class="o">-</span> <span class="n">bkg_offset</span><span class="p">,</span> <span class="n">bkg_width</span><span class="p">,</span> <span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">bkg_wimage</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">get_boxcar_weights</span><span class="p">(</span>
                <span class="n">center</span> <span class="o">+</span> <span class="n">hwidth</span> <span class="o">+</span> <span class="n">bkg_offset</span><span class="p">,</span> <span class="n">bkg_width</span><span class="p">,</span> <span class="n">image_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bkg_wimage</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wimage</span><span class="p">,</span> <span class="n">bkg_wimage</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="devloper-notes">
<h2>Devloper notes<a class="headerlink" href="#devloper-notes" title="Permalink to this heading">#</a></h2>
<p>The difference between the pipeline (x1d) and the extractions done in this notebook are quite large.  Help in understanding the origin of these differences is needed.</p>
<p>Not clear how to use the JWST pipeline <code class="docutils literal notranslate"><span class="pre">extract_1d</span></code> (quite complex) code.
Help to determine how to use the JWST pipeline code instead of the custom code for boxcar is needed.</p>
<p>Applying aperture corrections for the finite extraction widths is needed.  Help in how to get the needed informatinom for different (user set) extraction widths is needed.</p>
</section>
<section id="download-files">
<h2>Download Files<a class="headerlink" href="#download-files" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">calfilename</span> <span class="o">=</span> <span class="s2">&quot;det_image_seq5_MIRIMAGE_P750Lexp1_cal.fits&quot;</span>
<span class="n">s2dfilename</span> <span class="o">=</span> <span class="s2">&quot;det_image_seq5_MIRIMAGE_P750Lexp1_s2d.fits&quot;</span>
<span class="n">x1dfilename</span> <span class="o">=</span> <span class="s2">&quot;det_image_seq5_MIRIMAGE_P750Lexp1_x1d.fits&quot;</span>
<span class="n">spatialprofilefilename</span> <span class="o">=</span> <span class="s2">&quot;det_image_seq1_MIRIMAGE_P750Lexp1_s2d.fits&quot;</span>
<span class="n">mainurl</span> <span class="o">=</span> <span class="s2">&quot;https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/MIRI_LRS_notebook/&quot;</span>

<span class="n">calfile_dld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">mainurl</span> <span class="o">+</span> <span class="n">calfilename</span><span class="p">)</span>
<span class="n">s2dfile_dld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">mainurl</span> <span class="o">+</span> <span class="n">s2dfilename</span><span class="p">)</span>
<span class="n">x1dfile_dld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">mainurl</span> <span class="o">+</span> <span class="n">x1dfilename</span><span class="p">)</span>
<span class="n">spatialprofilefile_dld</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">mainurl</span> <span class="o">+</span> <span class="n">spatialprofilefilename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># rename files so that they have the right extensions</span>
<span class="c1"># required for the jwst datamodels to work</span>
<span class="n">calfile</span> <span class="o">=</span> <span class="n">calfile_dld</span> <span class="o">+</span> <span class="s1">&#39;_cal.fits&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">calfile_dld</span><span class="p">,</span> <span class="n">calfile</span><span class="p">)</span>
<span class="n">s2dfile</span> <span class="o">=</span> <span class="n">s2dfile_dld</span> <span class="o">+</span> <span class="s1">&#39;_s2d.fits&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">s2dfile_dld</span><span class="p">,</span> <span class="n">s2dfile</span><span class="p">)</span>
<span class="n">x1dfile</span> <span class="o">=</span> <span class="n">x1dfile_dld</span> <span class="o">+</span> <span class="s1">&#39;_x1d.fits&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">x1dfile_dld</span><span class="p">,</span> <span class="n">x1dfile</span><span class="p">)</span>
<span class="n">spatialprofilefile</span> <span class="o">=</span> <span class="n">spatialprofilefile_dld</span> <span class="o">+</span> <span class="s1">&#39;_s2d.fits&#39;</span>
<span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">spatialprofilefile_dld</span><span class="p">,</span> <span class="n">spatialprofilefile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="file-information">
<h2>File information<a class="headerlink" href="#file-information" title="Permalink to this heading">#</a></h2>
<p>The data used is a simulation of a LRS slit observation for a blackbody with a similar flux density to the star BD+60d1753, a flux calibration star.  This simulation was created with MIRISim.
The simulated exposure was reduced using the JWST pipeline (v0.16.1) through the Detector1 and Spec2 stages.</p>
<p>The cal file is one of the Spec2 products and is the calibration full frame image. It contains:</p>
<ol class="arabic simple">
<li><p>(Primary): This HDU contains meta-data related to the observation and data reduction.</p></li>
<li><p>(SCI): The calibrated image. Units are MJy/sr.</p></li>
<li><p>(ERR): Uncertainty image.  Units are MJy/sr.</p></li>
<li><p>(DQ): Data quality image.</p></li>
<li><p>(VAR_POISSON): Unc. component 1: Poisson uncertainty image.  Units are (MJy/sr)^2.</p></li>
<li><p>(VAR_RNOISE): Unc. component 2: Read Noise uncertainty image.  Units are (MJy/sr)^2.</p></li>
<li><p>(VAR_FLAT): Unc. component 3: Flat Field uncertainty image.  Units are (MJy/sr)^2.</p></li>
<li><p>(ASDF_METADATA): Metadata.</p></li>
</ol>
<p>The s2d file is one of the Spec2 products and containes the calibrated rectified cutout of the LRS Slit region.  It has:</p>
<ol class="arabic simple">
<li><p>(Primary): This HDU contains meta-data related to the observation and data reduction.</p></li>
<li><p>(WGT): Weight.</p></li>
<li><p>(CON): ??</p></li>
<li><p>(ASDF_METADATA): Metadata.</p></li>
</ol>
</section>
<section id="loading-data">
<h2>Loading data<a class="headerlink" href="#loading-data" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use a jwst datamodel to provide a good interface to the data and wcs info</span>
<span class="n">cal</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">calfile</span><span class="p">)</span>
<span class="n">s2d</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">s2dfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Basic information about the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cal image&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;s2d image&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cal image
(1024, 1032)
9.826068
-1199.9769 64995.82
s2d image
(387, 44)
603.8127
-942.0139 63358.58
</pre></div>
</div>
</div>
</div>
<p>Display the full 2D image</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">norm_data</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The full image from the MIRI IMAGER detector&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;The full image from the MIRI IMAGER detector&#39;)
</pre></div>
</div>
<img alt="../../_images/8e87f99c5a39ca33ca4b13d86c5104b5248e2ba922a718491e6d2819a51be408.png" src="../../_images/8e87f99c5a39ca33ca4b13d86c5104b5248e2ba922a718491e6d2819a51be408.png" />
</div>
</div>
<p>Display the LRS Slit region only (use s2d)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># transpose to make it display better</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The LRS region&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;The LRS region&#39;)
</pre></div>
</div>
<img alt="../../_images/6cdf1afbede8b4af317606d5e4df0c8036e5a75b1f145ac9ac07e18e6e7b0d07.png" src="../../_images/6cdf1afbede8b4af317606d5e4df0c8036e5a75b1f145ac9ac07e18e6e7b0d07.png" />
</div>
</div>
<section id="view-the-2d-spectrum-in-imviz-and-get-the-center-of-the-cross-dispersion">
<h3>View the 2D Spectrum in Imviz and get the center of the cross-dispersion<a class="headerlink" href="#view-the-2d-spectrum-in-imviz-and-get-the-center-of-the-cross-dispersion" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imviz</span> <span class="o">=</span> <span class="n">Imviz</span><span class="p">()</span>
<span class="n">imviz</span><span class="o">.</span><span class="n">app</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "6e3919a9df66421fba7521510904e1a3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">viewer</span> <span class="o">=</span> <span class="n">imviz</span><span class="o">.</span><span class="n">default_viewer</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">cuts</span> <span class="o">=</span> <span class="s1">&#39;95%&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="view-the-jwst-pipeline-1d-extraction-in-specviz">
<h3>View the JWST pipeline 1D extraction in Specviz<a class="headerlink" href="#view-the-jwst-pipeline-1d-extraction-in-specviz" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a spectrum1d</span>
<span class="n">jpipe_x1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">x1dfile</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-08 17:22:12,817 - stpipe - WARNING - /Users/ofox/miniconda3/envs/lrssn/lib/python3.9/site-packages/specutils/io/default_loaders/jwst_reader.py:338: UserWarning: SRCTYPE is missing or UNKNOWN in JWST x1d loader. Defaulting to srctype=&quot;POINT&quot;.
  warnings.warn(&#39;SRCTYPE is missing or UNKNOWN in JWST x1d loader. &#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">specviz</span> <span class="o">=</span> <span class="n">Specviz</span><span class="p">()</span>
<span class="n">specviz</span><span class="o">.</span><span class="n">app</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "b74568107bad4d348815ad5a79f9608e", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">specviz</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">jpipe_x1d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="boxcar-extraction">
<h1>Boxcar Extraction<a class="headerlink" href="#boxcar-extraction" title="Permalink to this heading">#</a></h1>
<p>Extract a 1D spectrum using a simple boxcar.  Basically collapse the spectrum in the cross-dispersion direction over a specified number of pixels.</p>
<section id="developer-note-allow-for-a-bad-pixel-mask">
<h2>Developer note: Allow for a bad pixel mask<a class="headerlink" href="#developer-note-allow-for-a-bad-pixel-mask" title="Permalink to this heading">#</a></h2>
</section>
<section id="fixed-width-boxcar">
<h2>Fixed width boxcar<a class="headerlink" href="#fixed-width-boxcar" title="Permalink to this heading">#</a></h2>
<p>Define extraction parameters based on interaction in Imviz window above</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext_center</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">ext_width</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">bkg_sep</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">bkg_width</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>Plot cross-disperion cut showing the extraction parameters</p>
<section id="develepor-note-place-trace-back-into-specviz2d-imviz-etc">
<h3>Develepor Note: Place trace back into Specviz2d/Imviz/Etc<a class="headerlink" href="#develepor-note-place-trace-back-into-specviz2d-imviz-etc" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot along cross-disperion cut showing the extraction parameters</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">image</span><span class="p">[:,</span><span class="mi">300</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">mm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ext_center</span><span class="p">,</span> <span class="n">ext_center</span><span class="p">])</span>
<span class="n">mm_y</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

<span class="c1"># extraction region</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ext_center</span> <span class="o">-</span> <span class="n">ext_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ext_center</span> <span class="o">+</span> <span class="n">ext_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;b--&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">-</span> <span class="n">ext_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;g:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">+</span> <span class="n">ext_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;g:&#39;</span><span class="p">)</span>

<span class="c1"># background region, symmetric on both sides of extraction region</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ext_center</span> <span class="o">-</span> <span class="n">bkg_sep</span> <span class="o">-</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ext_center</span> <span class="o">-</span> <span class="n">bkg_sep</span> <span class="o">+</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">-</span> <span class="n">bkg_sep</span> <span class="o">-</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">-</span> <span class="n">bkg_sep</span> <span class="o">+</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ext_center</span> <span class="o">+</span> <span class="n">bkg_sep</span> <span class="o">-</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ext_center</span> <span class="o">+</span> <span class="n">bkg_sep</span> <span class="o">+</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">+</span> <span class="n">bkg_sep</span> <span class="o">-</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mm</span> <span class="o">+</span> <span class="n">bkg_sep</span> <span class="o">+</span> <span class="n">bkg_width</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">mm_y</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cross-dispersion Cut at Pixel=300&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Cross-dispersion Cut at Pixel=300&#39;)
</pre></div>
</div>
<img alt="../../_images/795a548f5afe5451621fadc304f8cc8e5fd91d7add1394de87df8dab7ea647c8.png" src="../../_images/795a548f5afe5451621fadc304f8cc8e5fd91d7add1394de87df8dab7ea647c8.png" />
</div>
</div>
</section>
</section>
<section id="background-subtraction">
<h2>Background Subtraction<a class="headerlink" href="#background-subtraction" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract the background using custom individual traces</span>
<span class="n">trace</span> <span class="o">=</span> <span class="n">FlatTrace</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ext_center</span><span class="p">)</span>
<span class="n">bg</span> <span class="o">=</span> <span class="n">Background</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="n">trace</span><span class="o">-</span><span class="n">bkg_sep</span><span class="p">,</span> <span class="n">trace</span><span class="o">+</span><span class="n">bkg_sep</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">bkg_width</span><span class="p">)</span>

<span class="c1"># alternatively, call two_sided class, which does the same as above </span>
<span class="c1">#bg = Background.two_sided(image, trace, bkg_sep, width=bkg_width)</span>
<span class="c1"># or in the place of any trace, an int/float can be passed which resolves to a FlatTrace</span>
<span class="c1">#bg = Background.two_sided(image, ext_center, bkg_sep, width=bkg_width)</span>

<span class="c1"># or for single sided:</span>
<span class="c1"># bg = Background.one_sided(image, trace, bkg_sep, width=bkg_width)</span>
<span class="c1"># bg = Background.one_sided(image, trace, -bkg_sep, width=bkg_width)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view the background weighted image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">bkg_wimage</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slit[0] slice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;slit[0] slice&#39;)
</pre></div>
</div>
<img alt="../../_images/a5f56cac7224fb48a9f6d3c8fdd77266c159dd0f53b35afa42094fde8405c484.png" src="../../_images/a5f56cac7224fb48a9f6d3c8fdd77266c159dd0f53b35afa42094fde8405c484.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view the background image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">bkg_image</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slit[0] slice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;slit[0] slice&#39;)
</pre></div>
</div>
<img alt="../../_images/86897a4b4bc68d83252bef9c2e76e6b9755a5829fe94e05796fced21a8101ff5.png" src="../../_images/86897a4b4bc68d83252bef9c2e76e6b9755a5829fe94e05796fced21a8101ff5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view the background-subtracted image</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">sub_image</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slit[0] slice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;slit[0] slice&#39;)
</pre></div>
</div>
<img alt="../../_images/c4a4422cd9625659fe38415741a456abd4f10dc0cd588c027b007119cd07a7fc.png" src="../../_images/c4a4422cd9625659fe38415741a456abd4f10dc0cd588c027b007119cd07a7fc.png" />
</div>
</div>
<p>Note that when using median, partial pixel weights are not supported:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bg_med</span> <span class="o">=</span> <span class="n">Background</span><span class="o">.</span><span class="n">two_sided</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ext_center</span><span class="p">,</span> <span class="n">bkg_sep</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bkg_width</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">bg_med</span><span class="o">.</span><span class="n">bkg_wimage</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;slit[0] slice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;slit[0] slice&#39;)
</pre></div>
</div>
<img alt="../../_images/cf3c375cbd48541936d418d73afee1111ac23e263279b95500cb01ba4f4600ca.png" src="../../_images/cf3c375cbd48541936d418d73afee1111ac23e263279b95500cb01ba4f4600ca.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># transpose to make it display better</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">-</span><span class="n">bg</span><span class="o">.</span><span class="n">sub_image</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The LRS region&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;The LRS region&#39;)
</pre></div>
</div>
<img alt="../../_images/a0a6682b979faf92fdb3ad1fade2a390d3c60b0013629c3f917c94f38505b83d.png" src="../../_images/a0a6682b979faf92fdb3ad1fade2a390d3c60b0013629c3f917c94f38505b83d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">image</span><span class="o">-</span><span class="n">bg</span><span class="o">.</span><span class="n">sub_image</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bg</span><span class="o">.</span><span class="n">bkg_image</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>123.91720867156982
</pre></div>
</div>
</div>
</div>
</section>
<section id="advanced-trace">
<h2>Advanced Trace<a class="headerlink" href="#advanced-trace" title="Permalink to this heading">#</a></h2>
<p>Optional: we could now refine the initial flat trace by running an automated KosmosTrace on the subtracted image. This process could be iterated as necessary (recreating the subtracted image with the refined trace, etc).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">auto_trace</span> <span class="o">=</span> <span class="n">KosmosTrace</span><span class="p">(</span><span class="n">image</span><span class="o">-</span><span class="n">bg</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="n">ext_center</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="plot-old-vs-new-trace">
<h3>Plot old vs new trace<a class="headerlink" href="#plot-old-vs-new-trace" title="Permalink to this heading">#</a></h3>
</section>
</section>
<section id="extract">
<h2>Extract<a class="headerlink" href="#extract" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">boxcar</span> <span class="o">=</span> <span class="n">BoxcarExtract</span><span class="p">()</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">boxcar</span><span class="p">(</span><span class="n">image</span><span class="o">-</span><span class="n">bg</span><span class="p">,</span> <span class="n">auto_trace</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">ext_width</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jpipe_x1d</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Boxcar 1D extracted spectrum&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pixel&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux Density [Jy]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a5102ccefe524e0e3c959b27eaefedbba4ff9eb587d94ac63c9d2d334b7970fc.png" src="../../_images/a5102ccefe524e0e3c959b27eaefedbba4ff9eb587d94ac63c9d2d334b7970fc.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gwcs.wcstools</span> <span class="kn">import</span> <span class="n">grid_from_bounding_box</span>

<span class="c1">#image = np.transpose(s2d.data)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">grid_from_bounding_box</span><span class="p">(</span><span class="n">s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">bounding_box</span><span class="p">)</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">lam</span> <span class="o">=</span> <span class="n">s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="o">*</span><span class="n">grid</span><span class="p">)</span>
<span class="n">lam_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">lam</span><span class="p">)</span>

<span class="c1"># compute a &quot;rough&quot; wavelength scale to allow for aperture to scale with wavelength</span>
<span class="n">rough_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">lam_image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># images to use for extraction</span>
<span class="n">wimage</span><span class="p">,</span> <span class="n">bkg_wimage</span> <span class="o">=</span> <span class="n">ap_weight_images</span><span class="p">(</span>
    <span class="n">ext_center</span><span class="p">,</span>
    <span class="n">ext_width</span><span class="p">,</span>
    <span class="n">bkg_width</span><span class="p">,</span>
    <span class="n">bkg_sep</span><span class="p">,</span>
    <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
    <span class="n">rough_waves</span><span class="p">,</span>
    <span class="n">wavescale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">boxcar</span> <span class="o">=</span> <span class="n">BoxcarExtract</span><span class="p">()</span>

<span class="c1"># without background subtraction</span>
<span class="n">image_wg</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">wimage</span>
<span class="n">ext1d_boxcar</span> <span class="o">=</span> <span class="n">boxcar</span><span class="p">(</span><span class="n">image_wg</span><span class="p">,</span> <span class="n">auto_trace</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">ext_width</span><span class="p">)</span>
<span class="n">ext1d_boxcar</span> <span class="o">=</span> <span class="n">ext1d_boxcar</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>
<span class="c1"># convert from MJy/sr to Jy</span>
<span class="n">ext1d_boxcar</span> <span class="o">*=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>

<span class="c1"># with background subtraction</span>
<span class="n">image_bg</span> <span class="o">=</span> <span class="n">bg</span><span class="o">.</span><span class="n">sub_image</span><span class="p">()</span>
<span class="n">image_wg</span> <span class="o">=</span> <span class="n">image_bg</span> <span class="o">*</span> <span class="n">wimage</span>
<span class="n">ext1d_boxcar_bkgsub</span> <span class="o">=</span> <span class="n">boxcar</span><span class="p">(</span><span class="n">image_wg</span><span class="p">,</span> <span class="n">auto_trace</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">ext_width</span><span class="p">)</span>
<span class="n">ext1d_boxcar_bkgsub</span> <span class="o">=</span> <span class="n">ext1d_boxcar_bkgsub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>

<span class="c1"># convert from MJy/sr to Jy</span>
<span class="n">ext1d_boxcar_bkgsub</span> <span class="o">*=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>

<span class="c1"># compute the average wavelength for each column using the weight image</span>
<span class="c1"># this should correspond directly with the extracted spectrum</span>
<span class="c1"># wavelengths account for any tiled spectra this way</span>
<span class="n">waves_boxcar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">lam_image</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">wimage</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">waves_boxcar_bkgsub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">lam_image</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">wimage</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_boxcar_bkgsub</span> <span class="o">&gt;</span> <span class="mf">0.</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_boxcar</span> <span class="o">&gt;</span> <span class="mf">0.</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="n">ext1d_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;boxcar&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="n">ext1d_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;boxcar (bkgsub)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jpipe_x1d</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">jpipe_x1d</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;jpipe_x1d&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Fixed boxcar 1D extracted spectrum&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wavelength [$\mu$m]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux Density [Jy]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f89292e0640&gt;
</pre></div>
</div>
<img alt="../../_images/cbc4d9412db9d3601eedfd5bc7308800a356fc3a060cfa5b4615d6cfdc6f25d6.png" src="../../_images/cbc4d9412db9d3601eedfd5bc7308800a356fc3a060cfa5b4615d6cfdc6f25d6.png" />
</div>
</div>
<section id="wavelength-scaled-width-boxcar">
<h3>Wavelength scaled width boxcar<a class="headerlink" href="#wavelength-scaled-width-boxcar" title="Permalink to this heading">#</a></h3>
<p>The LRS spatial profile changes as a function of wavelength as JWST is diffraction limited at these wavelengths.  Nominally this means that the FWHM is changing linearly with wavelength.  Scaling the width of the extraction aperture with wavelength accounts for the changing diffraction limit with wavelength to first order.</p>
<section id="developer-note-not-currently-possible-allow-for-wavelength-scaled-width-in-the-boxcar">
<h4>Developer note:  Not currently possible. Allow for wavelength scaled width in the boxcar<a class="headerlink" href="#developer-note-not-currently-possible-allow-for-wavelength-scaled-width-in-the-boxcar" title="Permalink to this heading">#</a></h4>
</section>
</section>
</section>
<section id="psf-based-extraction">
<h2>PSF based Extraction<a class="headerlink" href="#psf-based-extraction" title="Permalink to this heading">#</a></h2>
<p>While to first order the PSF FHWM changes linearly with wavelength, this is an approximation.  It is better to use the measured spatial profile as a function of wavelength to extract the spectrum.  This tracks the actual variation with wavelength and optimizes the extraction to the higher S/N measurements.  In general, PSF based extractions show the most improvements over boxcar extractions at lower the S/N.</p>
<p>There are two PSF based extraction methods.</p>
<ol class="arabic simple">
<li><p>PSF weighted: the spatial profile at each wavelength is used to weight the extraction.</p></li>
<li><p>PSF fitting: the spatial profile is fit at each wavelength with the scale parameter versus wavelength giving the spectrum.</p></li>
</ol>
<p>Only the PSF weighted technique is currently part of this notebook.</p>
<p>Note 1: calibration reference file for the specific LRS slit position should be used.</p>
<p>Note 2: Small shifts in the centering of the source in the slit should be investigated to see if they impact the PSF based extractions.</p>
<p>Limitation: currently it is assumed there are no bad pixels.</p>
<p>There are notes [in brackets] on how each step is handled in the proposed HorneExtract/OptimalExtract classes to make it easier to see what the class does and what the user must do themselves.</p>
<section id="steps-in-the-jdat-notebook-guide-on-optimal-extraction">
<h3>Steps in the JDAT Notebook guide on optimal extraction:<a class="headerlink" href="#steps-in-the-jdat-notebook-guide-on-optimal-extraction" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Define extraction region [user’s responsibility to provide an appropriate image]</p></li>
<li><p>Pick a slice [should not be necessary? can use the whole image as the aperture with good results]</p></li>
<li><p>Define extraction kernel</p></li>
</ol>
<ul class="simple">
<li><p>Select PSF template [assumed to be Gaussian for now. support for Moffat, others?]</p></li>
<li><p>Choose a polynomial for background fitting [user provides as an argument]</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>Fit extraction kernel to initial slice [all columns are coadded to perform the fit]</p></li>
<li><p>Fit geometric distortion [not currently done]</p></li>
</ol>
<ul class="simple">
<li><p>Determine cross-dispersion bins for trace fitting</p></li>
<li><p>Fit a kernel to each bin to find trace center [user provides this as a specreduce.tracing.Trace object]</p></li>
<li><p>Polynomial fit of trace centers</p></li>
</ul>
<ol class="arabic simple" start="6">
<li><p>Combine composite model with 2D image to create output 1D spectrum</p></li>
</ol>
<ul class="simple">
<li><p>Create variance image [user provides this as an argument]</p></li>
<li><p>Generate 1D spectrum</p></li>
</ul>
<ol class="arabic simple" start="7">
<li><p>Compare with reference 1D spectrum</p></li>
</ol>
</section>
<section id="steps-in-the-original-horne-1986-paper">
<h3>Steps in the original Horne (1986) paper:<a class="headerlink" href="#steps-in-the-original-horne-1986-paper" title="Permalink to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Bias subtraction [assumed to be done in earlier block]</p></li>
<li><p>Initial variance estimate [user provides this as an argument]</p></li>
<li><p>Fit sky background [assumed to be done in earlier block]</p></li>
</ol>
<ul class="simple">
<li><p>“We therefore generally perform a least-squares polynomial fit to the sky data at each wavelength. Individual sky pixels are given weights inversely proportional to their variances as estimated in Step 2” [overlaps with notebook guide’s 3b]</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p>Extract standard spectrum and its variance</p></li>
</ol>
<ul class="simple">
<li><p>Subtract the sky background found in Step 3 from the image. [sky background calculation is planned as a separate, earlier step of the specreduce workflow]</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p>Construct spatial profile</p></li>
<li><p>Revise variance estimates [not currently done]</p></li>
<li><p>Mask cosmic ray hits [not currently done]</p></li>
<li><p>Extract optimal spectrum and its variance [currently only extract the spectum, not a variance]</p></li>
<li><p>Iterate Steps 5-8</p></li>
</ol>
<p>The first four steps as the standard procedure and the last five as add-ons that help squeeze out extra signal-to-noise.</p>
</section>
<section id="psf-weighted-extaction">
<h3>PSF weighted extaction<a class="headerlink" href="#psf-weighted-extaction" title="Permalink to this heading">#</a></h3>
<section id="generate-the-psf-profile-as-a-function-of-wavelength">
<h4>Generate the PSF profile as a function of wavelength<a class="headerlink" href="#generate-the-psf-profile-as-a-function-of-wavelength" title="Permalink to this heading">#</a></h4>
<p>For MIRI LRS slit observations, observations are made at two nod position in the slit after target acquisition.  This means that the location of the sources in the slit is very well known.  Hence, spatial profile (PSF) as a function of wavelength for the two nod positions is straightforward to measure using observations of a bright source.</p>
<p>The next few steps generate the needed information for the nod position for which we are extracting spectra based on a simulation of a bright source at the same nod position.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># lrs spatial profile (PSF) as a function of wavelength</span>
<span class="c1"># currently, this is just a &quot;high&quot; S/N observation of a flat spectrum source at the same slit position</span>
<span class="n">psf</span> <span class="o">=</span> <span class="n">datamodels</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">spatialprofilefile</span><span class="p">)</span>
<span class="c1"># transpose to make it display better</span>
<span class="n">lrspsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">lrspsf</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">lrspsf</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The LRS Spatial Profile (PSF) Observation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;The LRS Spatial Profile (PSF) Observation&#39;)
</pre></div>
</div>
<img alt="../../_images/fdfebeb002c43903d19ce993e1fa66cad0a6a78d178a39444ba5cfa9030c9a46.png" src="../../_images/fdfebeb002c43903d19ce993e1fa66cad0a6a78d178a39444ba5cfa9030c9a46.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mock a LRS spectral profile reference file</span>
<span class="c1"># Sum along the spatial direction and normalize to 1</span>
<span class="c1"># assume there is no background (none was included in the MIRISim for the flat spectrum source observation)</span>
<span class="c1"># ignore regions far from the source using a scaled boxcar weight image</span>
<span class="c1"># the aperture (psf_width) used in the scaled boxcar weight image could be varied</span>
<span class="n">psf_width</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="p">(</span><span class="n">wimage_scaledboxcar</span><span class="p">,</span> <span class="n">tmpvar</span><span class="p">)</span> <span class="o">=</span> <span class="n">ap_weight_images</span><span class="p">(</span><span class="n">ext_center</span><span class="p">,</span> <span class="n">psf_width</span><span class="p">,</span> <span class="n">bkg_sep</span><span class="p">,</span> 
                                                 <span class="n">bkg_width</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">waves_boxcar</span><span class="p">,</span> <span class="n">wavescale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="n">psf_weightimage</span> <span class="o">=</span> <span class="n">lrspsf</span><span class="o">*</span><span class="n">wimage_scaledboxcar</span>

<span class="c1"># generate a 2D image of the column sums for division</span>
<span class="n">max_psf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psf_weightimage</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">div_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">max_psf</span><span class="p">,</span> <span class="p">(</span><span class="n">psf_weightimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">div_image</span><span class="p">[</span><span class="n">div_image</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># avoid divide by zero issues</span>

<span class="c1"># normalize </span>
<span class="n">psf_weightimage</span> <span class="o">/=</span> <span class="n">div_image</span>

<span class="c1"># display</span>
<span class="n">norm_data</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">psf_weightimage</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf_weightimage</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_data</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The LRS Spatial Profile Reference Image (Normalized)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;The LRS Spatial Profile Reference Image (Normalized)&#39;)
</pre></div>
</div>
<img alt="../../_images/b7b291fc34e13f8d8a2e01ba6cf1a01530f3a7a09c6db78a31d69e8ac1c77f81.png" src="../../_images/b7b291fc34e13f8d8a2e01ba6cf1a01530f3a7a09c6db78a31d69e8ac1c77f81.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">psf_weightimage</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">psf_weightimage</span><span class="p">[:,</span><span class="mi">150</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pixel=150&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">psf_weightimage</span><span class="p">[:,</span><span class="mi">225</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pixel=225&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">psf_weightimage</span><span class="p">[:,</span><span class="mi">300</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pixel=300&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">psf_weightimage</span><span class="p">[:,</span><span class="mi">370</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pixel=370&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Cross-dispersion Cuts&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">ext_center</span><span class="o">-</span><span class="n">psf_width</span><span class="p">,</span> <span class="n">ext_center</span><span class="o">+</span><span class="n">psf_width</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f88e1800fa0&gt;
</pre></div>
</div>
<img alt="../../_images/411d2eff56e1b558f4ea42c22bd5f5d158c15c324cdc4b52e00661fa70ec3ff9.png" src="../../_images/411d2eff56e1b558f4ea42c22bd5f5d158c15c324cdc4b52e00661fa70ec3ff9.png" />
</div>
</div>
<p>Note that the spatial profile becomes narrower as the pixel values increases as this corresponds to the wavelength decreasing.</p>
</section>
<section id="extract-spectrum-using-wavelength-dependent-psf-profiles-using-the-same-traces-as-defined-above">
<h4>Extract spectrum using wavelength dependent PSF profiles using the same traces as defined above<a class="headerlink" href="#extract-spectrum-using-wavelength-dependent-psf-profiles-using-the-same-traces-as-defined-above" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span><span class="p">,</span> <span class="n">VarianceUncertainty</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">NDData</span>

<span class="c1">#mask = err*0.#+1.</span>
<span class="c1">#err = err*0</span>
<span class="n">errinput</span> <span class="o">=</span> <span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">err</span><span class="o">*</span><span class="mf">0.</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">inarr</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">image_wg</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">errinput</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimal</span> <span class="o">=</span> <span class="n">OptimalExtract</span><span class="p">()</span>
<span class="c1">#ext1d_psfweight = optimal(image_wg, auto_trace, variance = err, mask=mask, unit=u.Jy)</span>
<span class="n">ext1d_psfweight</span> <span class="o">=</span> <span class="n">optimal</span><span class="p">(</span><span class="n">inarr</span><span class="p">,</span> <span class="n">auto_trace</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-08 17:22:20,146 - stpipe - WARNING - /Users/ofox/miniconda3/envs/lrssn/lib/python3.9/site-packages/specreduce/extract.py:224: UserWarning: image NDData object&#39;s uncertainty interpreted as standard deviation. if incorrect, use VarianceUncertainty when assigning image object&#39;s uncertainty.
  warnings.warn(&quot;image NDData object&#39;s uncertainty &quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext1d_psfweight</span> <span class="o">=</span> <span class="n">ext1d_psfweight</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span>
<span class="c1"># convert from MJy/sr to Jy</span>
<span class="n">ext1d_psfweight</span> <span class="o">*=</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">s2d</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_psfweight</span> <span class="o">&gt;</span> <span class="mf">0.</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_boxcar</span> <span class="o">&gt;</span> <span class="mf">0.</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="n">ext1d_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;boxcar&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="n">ext1d_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;boxcar (bkgsub)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">jpipe_x1d</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">jpipe_x1d</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;jpipe_x1d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="n">ext1d_psfweight</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;psf weighted (bkgsub)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PSF weigthed extracted spectrum&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;wavelength [$\mu$m]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flux Density [Jy]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-08-08 17:22:20,419 - stpipe - WARNING - /var/folders/yh/kl4y3s1x3_j3ywy3qq67g3vc0001kc/T/ipykernel_97625/3310229130.py:7: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &quot;k-&quot; (-&gt; color=&#39;k&#39;). The keyword argument will take precedence.
  ax.plot(waves_boxcar[gpts], ext1d_boxcar[gpts], &#39;k-&#39;, label=&quot;boxcar&quot;, color=&#39;red&#39;)

2022-08-08 17:22:20,422 - stpipe - WARNING - /var/folders/yh/kl4y3s1x3_j3ywy3qq67g3vc0001kc/T/ipykernel_97625/3310229130.py:8: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &quot;k-&quot; (-&gt; color=&#39;k&#39;). The keyword argument will take precedence.
  ax.plot(waves_boxcar_bkgsub[gpts], ext1d_boxcar_bkgsub[gpts], &#39;k-&#39;, label=&quot;boxcar (bkgsub)&quot;, color=&#39;blue&#39;)

2022-08-08 17:22:20,425 - stpipe - WARNING - /var/folders/yh/kl4y3s1x3_j3ywy3qq67g3vc0001kc/T/ipykernel_97625/3310229130.py:9: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &quot;k-&quot; (-&gt; color=&#39;k&#39;). The keyword argument will take precedence.
  ax.plot(jpipe_x1d.spectral_axis, jpipe_x1d.flux, &#39;k-&#39;, label=&quot;jpipe_x1d&quot;, color=&#39;green&#39;)

2022-08-08 17:22:20,428 - stpipe - WARNING - /var/folders/yh/kl4y3s1x3_j3ywy3qq67g3vc0001kc/T/ipykernel_97625/3310229130.py:10: UserWarning: color is redundantly defined by the &#39;color&#39; keyword argument and the fmt string &quot;k-&quot; (-&gt; color=&#39;k&#39;). The keyword argument will take precedence.
  ax.plot(waves_boxcar_bkgsub[gpts], ext1d_psfweight[gpts], &#39;k-&#39;, label=&quot;psf weighted (bkgsub)&quot;, color=&#39;orange&#39;)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f89093dc670&gt;
</pre></div>
</div>
<img alt="../../_images/9445e32cf29c0ce4b78a65e23840ddcb4f32f12ddcbca1c76c16e3c5e186e46f.png" src="../../_images/9445e32cf29c0ce4b78a65e23840ddcb4f32f12ddcbca1c76c16e3c5e186e46f.png" />
</div>
</div>
<p>Note that the psf weighted extraction has visabily higher S/N, especially at the longer wavelengths where the S/N is lowest overall.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot in Specviz</span>

<span class="n">specviz2</span> <span class="o">=</span> <span class="n">Specviz</span><span class="p">()</span>
<span class="n">specviz2</span><span class="o">.</span><span class="n">app</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "1159736578fe4dab9d3a8567504bae74", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ext1d_boxcar_spec1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">waves_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">ext1d_boxcar</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
<span class="n">ext1d_boxcar_bkgsub_spec1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">ext1d_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
<span class="n">ext1d_psfweight_spec1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">micron</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">ext1d_psfweight</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">specviz2</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">ext1d_boxcar_spec1d</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">&#39;boxcar&#39;</span><span class="p">)</span>
<span class="n">specviz2</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">ext1d_boxcar_bkgsub_spec1d</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">&#39;boxcar bkgsub&#39;</span><span class="p">)</span>
<span class="n">specviz2</span><span class="o">.</span><span class="n">load_spectrum</span><span class="p">(</span><span class="n">ext1d_psfweight_spec1d</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">&#39;psfweight&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-in-rayleigh-jeans-units">
<h4>Plotting in Rayleigh-Jeans units<a class="headerlink" href="#plotting-in-rayleigh-jeans-units" title="Permalink to this heading">#</a></h4>
<p>For sources that have stellar continuum, it can be useful to plot MIR spectra in Rayleigh-Jeans units.  This just means removing the spectral shape expected for a blackbody with a peak at much shorter wavelengths than the MIR.  This is easily done by multiplying the spectrum by lambda^4 or nu^2.</p>
<p>An example of this is given below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Rayleigh-Jeans plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_psfweight</span> <span class="o">&gt;</span> <span class="mf">0.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">ext1d_psfweight</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;psf weighted (bkgsub)&quot;</span><span class="p">)</span>
<span class="n">gpts</span> <span class="o">=</span> <span class="n">ext1d_boxcar_bkgsub</span> <span class="o">&gt;</span> <span class="mf">0.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="p">(</span><span class="n">waves_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">]</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">ext1d_boxcar_bkgsub</span><span class="p">[</span><span class="n">gpts</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;fixed boxcar (bkgsub)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rayleigh-Jeans plot for all extractions&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;wavelength [$\mu$m]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rayleigh-Jeans Flux Density [$\mu$m$^4$ Jy]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x7f8919eb64f0&gt;
</pre></div>
</div>
<img alt="../../_images/a233f0c5c9a8182b3ad0ce57ae3d63efa7689a89f1d7fe2f86fd71dcacc7262a.png" src="../../_images/a233f0c5c9a8182b3ad0ce57ae3d63efa7689a89f1d7fe2f86fd71dcacc7262a.png" />
</div>
</div>
</section>
</section>
</section>
<section id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://jwst-docs.stsci.edu/mid-infrared-instrument/miri-observing-modes/miri-low-resolution-spectroscopy">MIRI LRS</a></p></li>
<li><p><a class="reference external" href="http://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/mirisim">MIRISim</a></p></li>
<li><p><a class="reference external" href="https://jwst-docs.stsci.edu/jwst-data-reduction-pipeline">JWST pipeline</a></p></li>
<li><p>PSF weighted extraction <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/abstract">Horne 1986, PASP, 98, 609</a>.</p></li>
</ul>
</section>
<section id="about-this-notebook">
<h2>About this notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this heading">#</a></h2>
<p><strong>Author:</strong> Karl Gordon, JWST
<strong>Updated On:</strong> 2020-07-07</p>
<hr class="docutils" />
<p><span class="xref myst">Top of Page</span>
<a class="reference internal" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png"><img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;" /></a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/MIRI_LRS_spectral_extraction"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">MIRI LRS Optimal Spectral Extraction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-ask-karl-exactly-how-these-functions-work-seems-like-all-weights-are-equal">Developer note: Ask Karl exactly how these functions work? Seems like all weights are equal?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#devloper-notes">Devloper notes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#download-files">Download Files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#file-information">File information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-data">Loading data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-the-2d-spectrum-in-imviz-and-get-the-center-of-the-cross-dispersion">View the 2D Spectrum in Imviz and get the center of the cross-dispersion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#view-the-jwst-pipeline-1d-extraction-in-specviz">View the JWST pipeline 1D extraction in Specviz</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#boxcar-extraction">Boxcar Extraction</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-allow-for-a-bad-pixel-mask">Developer note: Allow for a bad pixel mask</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fixed-width-boxcar">Fixed width boxcar</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#develepor-note-place-trace-back-into-specviz2d-imviz-etc">Develepor Note: Place trace back into Specviz2d/Imviz/Etc</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background-subtraction">Background Subtraction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-trace">Advanced Trace</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-old-vs-new-trace">Plot old vs new trace</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract">Extract</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#wavelength-scaled-width-boxcar">Wavelength scaled width boxcar</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#developer-note-not-currently-possible-allow-for-wavelength-scaled-width-in-the-boxcar">Developer note:  Not currently possible. Allow for wavelength scaled width in the boxcar</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-based-extraction">PSF based Extraction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-in-the-jdat-notebook-guide-on-optimal-extraction">Steps in the JDAT Notebook guide on optimal extraction:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-in-the-original-horne-1986-paper">Steps in the original Horne (1986) paper:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#psf-weighted-extaction">PSF weighted extaction</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#generate-the-psf-profile-as-a-function-of-wavelength">Generate the PSF profile as a function of wavelength</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-spectrum-using-wavelength-dependent-psf-profiles-using-the-same-traces-as-defined-above">Extract spectrum using wavelength dependent PSF profiles using the same traces as defined above</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-in-rayleigh-jeans-units">Plotting in Rayleigh-Jeans units</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#about-this-notebook">About this notebook</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By STScI
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>