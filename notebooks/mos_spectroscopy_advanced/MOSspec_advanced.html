<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   MOS Spectroscopy of Extragalactic Field — STScI JDAT Notebooks
  </title>
  <script data-cfasync="false">
   document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" rel="preload"/>
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/_sphinx_javascript_frameworks_compat.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script>
   DOCUMENTATION_OPTIONS.pagename = 'notebooks/mos_spectroscopy_advanced/MOSspec_advanced';
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html" rel="next" title="BOTS Time Series Observations"/>
  <link href="../optimal_extraction/Spectral_Extraction-static.html" rel="prev" title="MOS Optimal Spectral Extraction"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="en" name="docsearch:language"/>
 </head>
 <body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
  <a class="skip-link" href="#main-content">
   Skip to main content
  </a>
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
  <label class="overlay overlay-primary" for="__primary">
  </label>
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
  <label class="overlay overlay-secondary" for="__secondary">
  </label>
  <div class="search-button__wrapper">
   <div class="search-button__overlay">
   </div>
   <div class="search-button__search-container">
    <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
     <i class="fa-solid fa-magnifying-glass">
     </i>
     <input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
     <span class="search-button__kbd-shortcut">
      <kbd class="kbd-shortcut__modifier">
       Ctrl
      </kbd>
      +
      <kbd>
       K
      </kbd>
     </span>
    </form>
   </div>
  </div>
  <nav class="bd-header navbar navbar-expand-lg bd-navbar">
  </nav>
  <div class="bd-container">
   <div class="bd-container__inner bd-page-width">
    <div class="bd-sidebar-primary bd-sidebar">
     <div class="sidebar-header-items sidebar-primary__section">
     </div>
     <div class="sidebar-primary-items__start sidebar-primary__section">
      <div class="sidebar-primary-item">
       <a class="navbar-brand logo" href="../../intro.html">
        <img alt="Logo image" class="logo__image only-light" src="../../_static/stsci_logo2.png"/>
        <script>
         document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="Logo image"/>`);
        </script>
       </a>
      </div>
      <div class="sidebar-primary-item">
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item navbar-nav active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/notebook_development_workflow.html">
            Notebook Development Workflow
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Development
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/submitting_notebooks.html">
            Submitting Notebooks
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/requirements.html">
            Requirements file
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/notebooks.html">
            Jupyter Notebooks
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/data_files.html">
            Data Files
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           GitHub Guidelines
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_setup.html">
            GitHub Setup
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_workflow.html">
            GitHub Workflow
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_pr.html">
            GitHub PR
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">
            RGB images with Imviz
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
     </div>
     <div class="sidebar-primary-items__end sidebar-primary__section">
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <main class="bd-main" id="main-content">
     <div class="sbt-scroll-pixel-helper">
     </div>
     <div class="bd-content">
      <div class="bd-article-container">
       <div class="bd-header-article">
        <div class="header-article-items header-article__inner">
         <div class="header-article-items__start">
          <div class="header-article-item">
           <label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
            <span class="fa-solid fa-bars">
            </span>
           </label>
          </div>
         </div>
         <div class="header-article-items__end">
          <div class="header-article-item">
           <div class="article-header-buttons">
            <div class="dropdown dropdown-launch-buttons">
             <button aria-expanded="false" aria-label="Launch interactive content" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fas fa-rocket">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <button class="btn btn-sm btn-launch-thebe dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
                <span class="btn__icon-container">
                 <i class="fas fa-play">
                 </i>
                </span>
                <span class="btn__text-container">
                 Live Code
                </span>
               </button>
              </li>
             </ul>
            </div>
            <div class="dropdown dropdown-source-buttons">
             <button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fab fa-github">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <a class="btn btn-sm btn-source-repository-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks" target="_blank" title="Source repository">
                <span class="btn__icon-container">
                 <i class="fab fa-github">
                 </i>
                </span>
                <span class="btn__text-container">
                 Repository
                </span>
               </a>
              </li>
              <li>
               <a class="btn btn-sm btn-source-issues-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/mos_spectroscopy_advanced/MOSspec_advanced.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
                <span class="btn__icon-container">
                 <i class="fas fa-lightbulb">
                 </i>
                </span>
                <span class="btn__text-container">
                 Open issue
                </span>
               </a>
              </li>
             </ul>
            </div>
            <div class="dropdown dropdown-download-buttons">
             <button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fas fa-download">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../../_sources/notebooks/mos_spectroscopy_advanced/MOSspec_advanced.ipynb" target="_blank" title="Download source file">
                <span class="btn__icon-container">
                 <i class="fas fa-file">
                 </i>
                </span>
                <span class="btn__text-container">
                 .ipynb
                </span>
               </a>
              </li>
              <li>
               <button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
                <span class="btn__icon-container">
                 <i class="fas fa-file-pdf">
                 </i>
                </span>
                <span class="btn__text-container">
                 .pdf
                </span>
               </button>
              </li>
             </ul>
            </div>
            <button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
             <span class="btn__icon-container">
              <i class="fas fa-expand">
              </i>
             </span>
            </button>
            <script>
             document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
            </script>
            <script>
             document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
            </script>
            <label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
             <span class="fa-solid fa-list">
             </span>
            </label>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         MOS Spectroscopy of Extragalactic Field
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#">
              MOS Spectroscopy of Extragalactic Field
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#introduction">
                Introduction
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#objective-of-the-notebook">
                  Objective of the notebook
                 </a>
                </li>
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#workflow">
                  Workflow
                 </a>
                </li>
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#system-requirements">
                  System requirements
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#imports">
                Imports
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#check-versions-should-be">
                Check versions. Should be:
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#set-path-to-data-and-download-from-box-link">
                Set path to data and download from box link
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#open-data-in-mosviz">
                Open data in Mosviz
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#choose-one-galaxy">
                Choose one galaxy
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#use-specviz2d-to-extract-a-better-1d-spectrum">
                Use Specviz2d to extract a better 1D spectrum
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#workflow-via-api-calls">
                Workflow via API calls
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#same-workflow-with-specutils-old-workflow">
              Same workflow with specutils (old workflow)
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-and-substract-the-continuum">
                Fit and substract the continuum
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#creating-the-continuum-subtracted-spectrum">
                  Creating the continuum-subtracted spectrum
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#find-emission-and-absorption-lines">
                Find emission and absorption lines
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#measure-line-centroids-and-fluxes">
                Measure line centroids and fluxes
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-the-line-with-a-gaussian">
                Fit the line with a Gaussian
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#measure-the-equivalent-width-of-the-lines">
                Measure the equivalent width of the lines
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#find-the-best-fitting-template">
                Find the best-fitting template
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <div id="searchbox">
       </div>
       <article class="bd-article" role="main">
        <section id="mos-spectroscopy-of-extragalactic-field">
         <h1>
          MOS Spectroscopy of Extragalactic Field
          <a class="headerlink" href="#mos-spectroscopy-of-extragalactic-field" title="Permalink to this heading">
           #
          </a>
         </h1>
         <p>
          <strong>
           Use case:
          </strong>
          emission-line measurements and template matching on 1D spectra.
          <br/>
          <strong>
           Data:
          </strong>
          CEERS NIRSpec observations
          <br/>
          <strong>
           Tools:
          </strong>
          specutils, astropy, matplotlib, jdaviz.
          <br/>
          <strong>
           Cross-intrument:
          </strong>
          <br/>
          <strong>
           Documentation:
          </strong>
          This notebook is part of a STScI’s larger
          <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
           post-pipeline Data Analysis Tools Ecosystem
          </a>
          .
          <br/>
         </p>
         <section id="introduction">
          <h2>
           Introduction
           <a class="headerlink" href="#introduction" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           In this notebook, we will inspect a set of spectra and perform a seris of spectroscopic analyses on an example spectrum, including continuum fitting and subtraction, line identification, centroiding and flux measurements, gaussian fitting, equivalent widths, and template fitting. We will do so using the interactive
           <a class="reference external" href="https://github.com/spacetelescope/jdaviz">
            jdaviz package
           </a>
           and the command line. We will use a JWST/NIRSpec spectroscopic dataset from the
           <a class="reference external" href="https://ceers.github.io/index.html">
            CEERS program
           </a>
           .
          </p>
          <section id="objective-of-the-notebook">
           <h3>
            Objective of the notebook
            <a class="headerlink" href="#objective-of-the-notebook" title="Permalink to this heading">
             #
            </a>
           </h3>
           <p>
            The aim of the notebook is to showcase how to use the visualization tool Jdaviz or the combination Specutils+Matplotlib to measure the properties of the OII emission line in a NIRSpec spectrum.
           </p>
          </section>
          <section id="workflow">
           <h3>
            Workflow
            <a class="headerlink" href="#workflow" title="Permalink to this heading">
             #
            </a>
           </h3>
           <ul class="simple">
            <li>
             <p>
              visualize the spectroscopic dataset in Mosviz
             </p>
            </li>
            <li>
             <p>
              select one galaxy (s02904) and visualize it in Specviz2d
             </p>
            </li>
            <li>
             <p>
              perform the 1D extraction of the bright companion using the Spectral Extraction plugin in Specviz2d
             </p>
            </li>
            <li>
             <p>
              attach the wavelength axis to the extracted 1D spectrum
             </p>
            </li>
            <li>
             <p>
              select the OII emission line and measure
             </p>
             <ul>
              <li>
               <p>
                the redshift of the source
               </p>
              </li>
              <li>
               <p>
                the properties of the emission line
               </p>
              </li>
             </ul>
            </li>
            <li>
             <p>
              fit a model with continuum + a Gaussian to the OII emission line
             </p>
            </li>
            <li>
             <p>
              perform the same tasks using Specutils and Matplotlib instead of Jdaviz
             </p>
            </li>
            <li>
             <p>
              find the best-fitting template of the observed spectrum
             </p>
            </li>
           </ul>
          </section>
          <section id="system-requirements">
           <h3>
            System requirements
            <a class="headerlink" href="#system-requirements" title="Permalink to this heading">
             #
            </a>
           </h3>
           <p>
            First, we create an environment with jdaviz which contains all the spectroscopic packages we need.
           </p>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              conda
             </span>
             <span class="pre">
              create
             </span>
             <span class="pre">
              -n
             </span>
             <span class="pre">
              jdaviz
             </span>
             <span class="pre">
              python
             </span>
            </code>
            <br/>
            <code class="docutils literal notranslate">
             <span class="pre">
              conda
             </span>
             <span class="pre">
              activate
             </span>
             <span class="pre">
              jdaviz
             </span>
            </code>
            <br/>
            <code class="docutils literal notranslate">
             <span class="pre">
              pip
             </span>
             <span class="pre">
              install
             </span>
             <span class="pre">
              jdaviz
             </span>
            </code>
           </p>
          </section>
         </section>
         <section id="imports">
          <h2>
           Imports
           <a class="headerlink" href="#imports" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># general os</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># general plotting</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># table/math handling</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># astropy</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">quantity_support</span>

<span class="c1"># specutils</span>
<span class="kn">import</span> <span class="nn">specutils</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span><span class="p">,</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">fit_generic_continuum</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">find_lines_threshold</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">fit_lines</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">extract_region</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">centroid</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">line_flux</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">equivalent_width</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">template_comparison</span>

<span class="c1"># jdaviz</span>
<span class="kn">import</span> <span class="nn">jdaviz</span>
<span class="kn">from</span> <span class="nn">jdaviz</span> <span class="kn">import</span> <span class="n">Mosviz</span><span class="p">,</span> <span class="n">Specviz2d</span><span class="p">,</span> <span class="n">Specviz</span>

<span class="c1"># glue</span>
<span class="kn">from</span> <span class="nn">glue.core.roi</span> <span class="kn">import</span> <span class="n">XRangeROI</span>

<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">)</span>  <span class="c1"># hides irrelevant warnings about divide-by-zero, etc</span>
<span class="n">quantity_support</span><span class="p">()</span>  <span class="c1"># auto-recognizes units on matplotlib plots</span>

<span class="c1"># Matplotlib parameters</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'legend.fontsize'</span><span class="p">:</span> <span class="s1">'18'</span><span class="p">,</span> 
          <span class="s1">'axes.labelsize'</span><span class="p">:</span> <span class="s1">'18'</span><span class="p">,</span>
          <span class="s1">'axes.titlesize'</span><span class="p">:</span> <span class="s1">'18'</span><span class="p">,</span> 
          <span class="s1">'xtick.labelsize'</span><span class="p">:</span> <span class="s1">'18'</span><span class="p">,</span>
          <span class="s1">'ytick.labelsize'</span><span class="p">:</span> <span class="s1">'18'</span><span class="p">,</span> 
          <span class="s1">'lines.linewidth'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
          <span class="s1">'axes.linewidth'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> 
          <span class="s1">'animation.html'</span><span class="p">:</span> <span class="s1">'html5'</span><span class="p">}</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">'figure.max_open_warning'</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="check-versions-should-be">
          <h2>
           Check versions. Should be:
           <a class="headerlink" href="#check-versions-should-be" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Numpy:  1.24.2
           <br/>
           Astropy:  5.2.1
           <br/>
           Specutils:  1.9.1
           <br/>
           Jdaviz: 3.4.0
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"Numpy: "</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Astropy: "</span><span class="p">,</span> <span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Specutils: "</span><span class="p">,</span> <span class="n">specutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Jdaviz: "</span><span class="p">,</span> <span class="n">jdaviz</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="set-path-to-data-and-download-from-box-link">
          <h2>
           Set path to data and download from box link
           <a class="headerlink" href="#set-path-to-data-and-download-from-box-link" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Download the data from the old version of this notebook. They include the templates for fitting</span>
<span class="n">boxlink</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/mos_spectroscopy/mos_spectroscopy.zip'</span>
<span class="n">boxfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'./mos_spectroscopy.zip'</span><span class="p">)</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>

<span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
<span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Download the s2d and x1d files</span>
<span class="n">boxlink_ceers</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/mos_spectroscopy/mos_ceers_data.zip'</span>
<span class="n">boxfile_ceers</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'./mos_ceers_data.zip'</span><span class="p">)</span>
<span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_ceers</span><span class="p">,</span> <span class="n">boxfile_ceers</span><span class="p">)</span>

<span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">boxfile_ceers</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
<span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <strong>
            Developer note
           </strong>
           :
           <br/>
           The download of JWST data could happen directly from MAST, but the observations are organized in separate folders, while Mosviz wants the data in a single folder. So we go with a box download.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">pathtodata</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'./data'</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="open-data-in-mosviz">
          <h2>
           Open data in Mosviz
           <a class="headerlink" href="#open-data-in-mosviz" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           In Mosviz we can explore all the data products in the folder. This cell takes a minute or two to run. Since we are not including images, we can expand the 2D/1D spectra viewers to use the full width of the GUI. We can also keep the plugin tray open on metadata to check specifics of the files we are looking at.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">mosviz</span> <span class="o">=</span> <span class="n">Mosviz</span><span class="p">()</span>
<span class="n">mosviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">pathtodata</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="s2">"nirspec"</span><span class="p">)</span>
<span class="n">mosviz</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="choose-one-galaxy">
          <h2>
           Choose one galaxy
           <a class="headerlink" href="#choose-one-galaxy" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           We choose s02904 because we want to extract the very bright companion below the target.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">file1d</span> <span class="o">=</span> <span class="n">pathtodata</span> <span class="o">/</span> <span class="s1">'jw01345-o064_s02904_nirspec_f100lp-g140m_x1d.fits'</span>
<span class="n">file2d</span> <span class="o">=</span> <span class="n">pathtodata</span> <span class="o">/</span> <span class="s1">'jw01345-o064_s02904_nirspec_f100lp-g140m_s2d.fits'</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="use-specviz2d-to-extract-a-better-1d-spectrum">
          <h2>
           Use Specviz2d to extract a better 1D spectrum
           <a class="headerlink" href="#use-specviz2d-to-extract-a-better-1d-spectrum" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           We open the Spectral Extraction plugin and select the appropriate trace (Polynomial, order 3, on pixel 2), background (Manual, on pixel 8, width 2, statistic average), and extraction (From Plugin, Horne). We then click Extract and inspect the extracted spectrum in the 1D viewer.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">specviz2d</span> <span class="o">=</span> <span class="n">Specviz2d</span><span class="p">()</span>
<span class="n">specviz2d</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">file2d</span><span class="p">)</span>
<span class="n">specviz2d</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <strong>
            Developer note
           </strong>
           <br/>
           Is there a way to get out an uncertainty array from the extraction?
           <br/>
           This is being worked on.
          </p>
          <p>
           Specviz2d cannot yet work with the WCS of the 2D spectrum, so we use this workaround to get the spectral axis from the 1D spectrum extracted by the pipeline (the x1d file).
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Get out extracted spectrum from Specviz2d</span>
<span class="n">spectra</span> <span class="o">=</span> <span class="n">specviz2d</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_data_from_viewer</span><span class="p">(</span><span class="s1">'spectrum-viewer'</span><span class="p">,</span> <span class="s1">'Spectrum 1D'</span><span class="p">)</span>
<span class="n">spectra</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Get wavelength array from x1d spectrum</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1d</span><span class="p">)</span>
<span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'WAVELENGTH'</span><span class="p">]</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Combine to get the extracted spectrum with WCS</span>
<span class="c1"># Include some fake uncertainty for now</span>
<span class="n">spec1d_wcs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'WAVELENGTH'</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span>
                        <span class="n">flux</span><span class="o">=</span><span class="n">spectra</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
                        <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">spectra</span><span class="o">.</span><span class="n">flux</span><span class="p">))</span>
<span class="n">spec1d_wcs</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># And open in Specviz</span>
<span class="n">specviz</span> <span class="o">=</span> <span class="n">Specviz</span><span class="p">()</span>
<span class="n">specviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">spec1d_wcs</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">'spec1d calibrated'</span><span class="p">)</span>
<span class="n">specviz</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           There are still some artifacts, but we can select a subset masking the artifacts and get out a spectrum without unwanted spikes. We can do so using the tool to select a subset with the “add” option (in the top bar) to select multiple regions as part of a single subset.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Create a subset in the area of interest if it has not been created manually</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">region1</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">get_spectra</span><span class="p">(</span><span class="n">data_label</span><span class="o">=</span><span class="s1">'spec1d calibrated'</span><span class="p">,</span> <span class="n">subset_to_apply</span><span class="o">=</span><span class="s1">'Subset 1'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">region1</span><span class="p">)</span>
    <span class="n">region1_exists</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"There are no subsets selected."</span><span class="p">)</span>
    <span class="n">region1_exists</span> <span class="o">=</span> <span class="kc">False</span>
    
<span class="c1"># Spectral region for masking artifacts</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">region1_exists</span><span class="p">:</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_viewer</span><span class="p">(</span><span class="s1">'spectrum-viewer'</span><span class="p">)</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">toolbar_active_subset</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sv</span><span class="o">.</span><span class="n">apply_roi</span><span class="p">(</span><span class="n">XRangeROI</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.58</span><span class="p">))</span>  
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Get spectrum out with mask</span>
<span class="n">spec1d_wcs_region</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">get_spectral_regions</span><span class="p">()</span>
<span class="n">spec1d_wcs_masked</span> <span class="o">=</span> <span class="n">extract_region</span><span class="p">(</span><span class="n">spec1d_wcs</span><span class="p">,</span> <span class="n">spec1d_wcs_region</span><span class="p">[</span><span class="s1">'Subset 1'</span><span class="p">],</span> <span class="n">return_single_spectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Load in specviz</span>
<span class="n">specviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">'spec1d masked'</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Write the extracted spectrum to a fits file</span>
<span class="n">file_extracted</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">'./extracted _spectrum.fits'</span><span class="p">)</span>
<span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_extracted</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Check that it has everything</span>
<span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_extracted</span><span class="p">)</span>
<span class="n">hdu</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="workflow-via-api-calls">
          <h2>
           Workflow via API calls
           <a class="headerlink" href="#workflow-via-api-calls" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           I can do some analysis on the spectrum using the plugins in the GUI. For reproducibility, I can do the same thing from the API, changing the parameters in the plugins programmatically.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Select a region in the spectrum</span>
<span class="n">sv</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_viewer</span><span class="p">(</span><span class="s1">'spectrum-viewer'</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Region with just line for line analysis</span>
<span class="n">sv</span><span class="o">.</span><span class="n">toolbar_active_subset</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sv</span><span class="o">.</span><span class="n">apply_roi</span><span class="p">(</span><span class="n">XRangeROI</span><span class="p">(</span><span class="mf">1.124</span><span class="p">,</span> <span class="mf">1.131</span><span class="p">))</span>  
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Region with some continuum for gaussian fit</span>
<span class="n">sv</span><span class="o">.</span><span class="n">toolbar_active_subset</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sv</span><span class="o">.</span><span class="n">apply_roi</span><span class="p">(</span><span class="n">XRangeROI</span><span class="p">(</span><span class="mf">1.11</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">))</span>  
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Open line analysis plugin</span>
<span class="n">plugin_la</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">'Line Analysis'</span><span class="p">]</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">open_in_tray</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># List what is in the data menu</span>
<span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">specviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">data_collection</span><span class="p">]</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Input the appropriate spectrum and region</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="s1">'spec1d masked'</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">spectral_subset</span> <span class="o">=</span> <span class="s1">'Subset 2'</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Input the values for the continuum</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">continuum</span> <span class="o">=</span> <span class="s1">'Surrounding'</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">7</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Return line analysis results</span>
<span class="n">plugin_la</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Open line list plugin</span>
<span class="n">plugin_ll</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">'Line Lists'</span><span class="p">]</span>
<span class="n">plugin_ll</span><span class="o">.</span><span class="n">open_in_tray</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <strong>
            Developer note
           </strong>
           <br/>
           The line list plugin cannot yet be accessed by the notebook. I can do it in the GUI though.
          </p>
          <p>
           Open line list plugin. Select the SDSS IV line list. Load the Oxygen lines and Hb. Go back to line analysis plugin and associate the Oxygen II line with the line we just analyzed.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Open model fitting plugin</span>
<span class="n">plugin_mf</span> <span class="o">=</span> <span class="n">specviz</span><span class="o">.</span><span class="n">plugins</span><span class="p">[</span><span class="s1">'Model Fitting'</span><span class="p">]</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">open_in_tray</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Input the appropriate datasets</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="s1">'spec1d masked'</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">spectral_subset</span> <span class="o">=</span> <span class="s1">'Subset 3'</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Input the model components</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">create_model_component</span><span class="p">(</span><span class="n">model_component</span><span class="o">=</span><span class="s1">'Polynomial1D'</span><span class="p">,</span>
                                 <span class="n">poly_order</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">model_component_label</span><span class="o">=</span><span class="s1">'P2'</span><span class="p">)</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">create_model_component</span><span class="p">(</span><span class="n">model_component</span><span class="o">=</span><span class="s1">'Gaussian1D'</span><span class="p">,</span>
                                 <span class="n">model_component_label</span><span class="o">=</span><span class="s1">'G'</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plugin_mf</span><span class="o">.</span><span class="n">get_model_component</span><span class="p">(</span><span class="s1">'G'</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Model equation gets populated automatically</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">equation</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># After we run this, we go to the GUI and check that the fit makes sense</span>
<span class="n">plugin_mf</span><span class="o">.</span><span class="n">calculate_fit</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">specviz</span><span class="o">.</span><span class="n">get_model_parameters</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
        </section>
        <section id="same-workflow-with-specutils-old-workflow">
         <h1>
          Same workflow with specutils (old workflow)
          <a class="headerlink" href="#same-workflow-with-specutils-old-workflow" title="Permalink to this heading">
           #
          </a>
         </h1>
         <p>
          The same workflow can be achieved using directly the package specutils (which is used under the hood in jdaviz) and using matplotlib for a static visualization.
         </p>
         <section id="fit-and-substract-the-continuum">
          <h2>
           Fit and substract the continuum
           <a class="headerlink" href="#fit-and-substract-the-continuum" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">cont_spec1d</span> <span class="o">=</span> <span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="p">)</span>
<span class="n">cont_fit</span> <span class="o">=</span> <span class="n">cont_spec1d</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">cont_fit</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"modeled continuum"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Observed spectrum and fitted continuum"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"uncertainty ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Uncertianty of observed spectrum"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <section id="creating-the-continuum-subtracted-spectrum">
           <h3>
            Creating the continuum-subtracted spectrum
            <a class="headerlink" href="#creating-the-continuum-subtracted-spectrum" title="Permalink to this heading">
             #
            </a>
           </h3>
           <p>
            Specutils will figure out what to do with the uncertainty!
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">spec1d_sub</span> <span class="o">=</span> <span class="n">spec1d_wcs_masked</span> <span class="o">-</span> <span class="n">cont_fit</span>
<span class="n">spec1d_sub</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Continuum-subracted spectrum"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"uncertainty ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Uncertainty of continuum-subracted spectrum"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
         </section>
         <section id="find-emission-and-absorption-lines">
          <h2>
           Find emission and absorption lines
           <a class="headerlink" href="#find-emission-and-absorption-lines" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">lines</span> <span class="o">=</span> <span class="n">find_lines_threshold</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="p">,</span> <span class="n">noise_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">lines</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           Plot the emission lines on the spectrum.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">'line_center'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'emission lines'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">'line_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'emission'</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">'line_center'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Continuum-subtracted spectrum and marked lines using find_lines_threshold"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           Work by hand on a single line.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Define limits for plotting</span>
<span class="n">x_min</span> <span class="o">=</span> <span class="mf">1.1</span>
<span class="n">x_max</span> <span class="o">=</span> <span class="mf">1.16</span>

<span class="c1"># Define limits for line region</span>
<span class="n">line_min</span> <span class="o">=</span> <span class="mf">1.124</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span>
<span class="n">line_max</span> <span class="o">=</span> <span class="mf">1.131</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="s1">'line_center'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'[OII]'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="s1">'line_type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'emission'</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s1">'line_center'</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Continuum-subtracted spectrum zoomed on [OII]"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="measure-line-centroids-and-fluxes">
          <h2>
           Measure line centroids and fluxes
           <a class="headerlink" href="#measure-line-centroids-and-fluxes" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Example with just one line</span>
<span class="n">centroid</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="p">,</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="n">line_min</span><span class="p">,</span> <span class="n">line_max</span><span class="p">))</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">sline</span> <span class="o">=</span> <span class="n">centroid</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="p">,</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="n">line_min</span><span class="p">,</span> <span class="n">line_max</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sline</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"[OII]"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'flux = 0'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Continuum-subtracted spectrum zoomed on [OII]"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">line_flux</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="p">,</span> <span class="n">SpectralRegion</span><span class="p">(</span><span class="n">line_min</span><span class="p">,</span> <span class="n">line_max</span><span class="p">))</span>  
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="fit-the-line-with-a-gaussian">
          <h2>
           Fit the line with a Gaussian
           <a class="headerlink" href="#fit-the-line-with-a-gaussian" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">g_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian1D</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">1.1278909</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.001</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">)</span>
<span class="n">g_fit</span> <span class="o">=</span> <span class="n">fit_lines</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="p">,</span> <span class="n">g_init</span><span class="p">)</span>
<span class="n">spec1d_fit</span> <span class="o">=</span> <span class="n">g_fit</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>
<span class="n">g_fit</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_fit</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'darkorange'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Gaussian fit'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_sub</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Gaussian fit to the [OII] line'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="measure-the-equivalent-width-of-the-lines">
          <h2>
           Measure the equivalent width of the lines
           <a class="headerlink" href="#measure-the-equivalent-width-of-the-lines" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           This needs the spectrum continuum normalized.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">spec1d_norm</span> <span class="o">=</span> <span class="n">spec1d_wcs_masked</span> <span class="o">/</span> <span class="n">cont_fit</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_norm</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_norm</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'flux = 1'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_norm</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux (normalized)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Continuum-normalized spectrum, zoomed on [OII]"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_norm</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_norm</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_norm</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"uncertainty (normalized)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Uncertainty of continuum-normalized spectrum, zoomed on [OII]"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">equivalent_width</span><span class="p">(</span><span class="n">spec1d_norm</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="n">SpectralRegion</span><span class="p">(</span><span class="n">line_min</span><span class="p">,</span> <span class="n">line_max</span><span class="p">))</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="find-the-best-fitting-template">
          <h2>
           Find the best-fitting template
           <a class="headerlink" href="#find-the-best-fitting-template" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           It needs a list of templates and the redshift of the observed galaxy. For the templates, I am using a set of model SEDs generated with Bruzual &amp; Charlot stellar population models, emission lines, and dust attenuation as described in Pacifici et al. (2012).
          </p>
          <p>
           <strong>
            Developer note
           </strong>
           <br/>
           Maybe there is a way to speed this up (maybe using astropy model_sets)? This fit is run with 100 models, but ideally, if we want to extract physical parameters from this, we would need at least 10,000 models. A dictionary structure with meaningful keys (which can be, e.g., tuples of the relevant physical parameters) could be better than a list? It could make later analysis much clearer than having to map from the list indices back to the relevant parameters.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">templatedir</span> <span class="o">=</span> <span class="s1">'./mos_spectroscopy/templates/'</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Redshift taken from the Specviz analysis</span>
<span class="n">zz</span> <span class="o">=</span> <span class="mf">2.0269</span>

<span class="n">f_lamb_units</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span>

<span class="n">templatelist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Run on 30 out of 100 for speed</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
    <span class="n">template_file</span> <span class="o">=</span> <span class="s2">"</span><span class="si">{0}{1:05d}</span><span class="s2">.dat"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">templatedir</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
    <span class="n">temp1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="p">(</span><span class="n">template</span><span class="p">[</span><span class="s1">'col1'</span><span class="p">]</span><span class="o">/</span><span class="mf">1E4</span><span class="p">)</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">um</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">'col2'</span><span class="p">]</span><span class="o">*</span><span class="n">f_lamb_units</span><span class="p">)</span>
    <span class="n">templatelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp1d</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Change the units of the observed spectrum to match the template</span>
<span class="n">spec1d_wcs_masked_flamb</span> <span class="o">=</span> <span class="n">spec1d_wcs_masked</span><span class="o">.</span><span class="n">new_flux_unit</span><span class="p">(</span><span class="n">f_lamb_units</span><span class="p">)</span>
<span class="c1"># The new_flux_unit function does not change the uncertainty and specviz complains that there is a mismatch</span>
<span class="c1"># so we re-add the uncertainty as a percentage of the new flux</span>
<span class="n">spec1d_wcs_masked_flamb_unc</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">spec1d_wcs_masked_flamb</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span>
                                         <span class="n">flux</span><span class="o">=</span><span class="n">spec1d_wcs_masked_flamb</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span>
                                         <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">spec1d_wcs_masked_flamb</span><span class="o">.</span><span class="n">flux</span><span class="p">))</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Take a look at the observed spectrum and one of the templates at the correct redshift</span>
<span class="n">mean_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
<span class="n">mean_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">templatelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
<span class="n">temp_for_plot</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">templatelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_axis</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">zz</span><span class="p">),</span>
                           <span class="n">flux</span><span class="o">=</span><span class="n">templatelist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="o">*</span><span class="n">mean_obs</span><span class="o">/</span><span class="n">mean_temp</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temp_for_plot</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">temp_for_plot</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'model'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux (normalized)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">4e-18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Observed spectrum compared to one template at correct redshift"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">tm_results</span> <span class="o">=</span> <span class="n">template_comparison</span><span class="o">.</span><span class="n">template_match</span><span class="p">(</span><span class="n">observed_spectrum</span><span class="o">=</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="p">,</span> 
                                                <span class="n">spectral_templates</span><span class="o">=</span><span class="n">templatelist</span><span class="p">,</span> 
                                                <span class="n">resample_method</span><span class="o">=</span><span class="s2">"flux_conserving"</span><span class="p">,</span> 
                                                <span class="n">redshift</span><span class="o">=</span><span class="n">zz</span><span class="p">)</span>
<span class="n">tm_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <strong>
            Developer note
           </strong>
           <br/>
           The fit returns nan and I do not understand why. Maybe the observed spectrum is not properly flux calibrated, but there should still be a best chi^2 from the pile of templates.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tm_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">,</span> <span class="n">tm_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'model'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"wavelength ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"flux ({:latex})"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec1d_wcs_masked_flamb_unc</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Observed spectrum and best-fitting model template"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png">
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;"/>
          </a>
          <p>
           Notebook created by Camilla Pacifici (cpacifici@stsci.edu)
          </p>
         </section>
        </section>
        <script type="text/x-thebe-config">
         {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/mos_spectroscopy_advanced"
        },
        predefinedOutput: true
    }
        </script>
        <script>
         kernelName = 'python3'
        </script>
       </article>
       <footer class="bd-footer-article">
        <div class="footer-article-items footer-article__inner">
         <div class="footer-article-item">
          <!-- Previous / next buttons -->
          <div class="prev-next-area">
           <a class="left-prev" href="../optimal_extraction/Spectral_Extraction-static.html" title="previous page">
            <i class="fa-solid fa-angle-left">
            </i>
            <div class="prev-next-info">
             <p class="prev-next-subtitle">
              previous
             </p>
             <p class="prev-next-title">
              MOS Optimal Spectral Extraction
             </p>
            </div>
           </a>
           <a class="right-next" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html" title="next page">
            <div class="prev-next-info">
             <p class="prev-next-subtitle">
              next
             </p>
             <p class="prev-next-title">
              BOTS Time Series Observations
             </p>
            </div>
            <i class="fa-solid fa-angle-right">
            </i>
           </a>
          </div>
         </div>
        </div>
       </footer>
      </div>
      <div class="bd-sidebar-secondary bd-toc">
       <div class="sidebar-secondary-items sidebar-secondary__inner">
        <div class="sidebar-secondary-item">
         <div class="page-toc tocsection onthispage">
          <i class="fa-solid fa-list">
          </i>
          Contents
         </div>
         <nav class="bd-toc-nav page-toc">
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h1 nav-item toc-entry">
            <a class="reference internal nav-link" href="#">
             MOS Spectroscopy of Extragalactic Field
            </a>
            <ul class="visible nav section-nav flex-column">
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#introduction">
               Introduction
              </a>
              <ul class="nav section-nav flex-column">
               <li class="toc-h3 nav-item toc-entry">
                <a class="reference internal nav-link" href="#objective-of-the-notebook">
                 Objective of the notebook
                </a>
               </li>
               <li class="toc-h3 nav-item toc-entry">
                <a class="reference internal nav-link" href="#workflow">
                 Workflow
                </a>
               </li>
               <li class="toc-h3 nav-item toc-entry">
                <a class="reference internal nav-link" href="#system-requirements">
                 System requirements
                </a>
               </li>
              </ul>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#imports">
               Imports
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#check-versions-should-be">
               Check versions. Should be:
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#set-path-to-data-and-download-from-box-link">
               Set path to data and download from box link
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#open-data-in-mosviz">
               Open data in Mosviz
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#choose-one-galaxy">
               Choose one galaxy
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#use-specviz2d-to-extract-a-better-1d-spectrum">
               Use Specviz2d to extract a better 1D spectrum
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#workflow-via-api-calls">
               Workflow via API calls
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h1 nav-item toc-entry">
            <a class="reference internal nav-link" href="#same-workflow-with-specutils-old-workflow">
             Same workflow with specutils (old workflow)
            </a>
            <ul class="visible nav section-nav flex-column">
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#fit-and-substract-the-continuum">
               Fit and substract the continuum
              </a>
              <ul class="nav section-nav flex-column">
               <li class="toc-h3 nav-item toc-entry">
                <a class="reference internal nav-link" href="#creating-the-continuum-subtracted-spectrum">
                 Creating the continuum-subtracted spectrum
                </a>
               </li>
              </ul>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#find-emission-and-absorption-lines">
               Find emission and absorption lines
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#measure-line-centroids-and-fluxes">
               Measure line centroids and fluxes
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#fit-the-line-with-a-gaussian">
               Fit the line with a Gaussian
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#measure-the-equivalent-width-of-the-lines">
               Measure the equivalent width of the lines
              </a>
             </li>
             <li class="toc-h2 nav-item toc-entry">
              <a class="reference internal nav-link" href="#find-the-best-fitting-template">
               Find the best-fitting template
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </nav>
        </div>
       </div>
      </div>
     </div>
     <footer class="bd-footer-content">
      <div class="bd-footer-content__inner container">
       <div class="footer-item">
        <p class="component-author">
         By STScI
        </p>
       </div>
       <div class="footer-item">
        <p class="copyright">
         © Copyright 2022.
         <br/>
        </p>
       </div>
       <div class="footer-item">
       </div>
       <div class="footer-item">
       </div>
      </div>
     </footer>
    </main>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52">
  </script>
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52">
  </script>
  <footer class="bd-footer">
  </footer>
 </body>
</html>
