<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Complex 2D Background — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <script>
   window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}
  </script>
  <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../composite_model_fitting/specfit_demo_3.html" rel="next" title="Composite Model Spectral Fitting"/>
  <link href="../asdf_example/asdf_example.html" rel="prev" title="ASDF Example"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/background_estimation_imaging/Imaging_Sky_Background_Estimation.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/background_estimation_imaging/Imaging_Sky_Background_Estimation.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imaging-sky-background-estimation">
           Imaging Sky Background Estimation
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imports">
           Imports
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
           Matplotlib setup for plotting
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#create-an-image-with-a-somewhat-pathological-background-pattern">
           Create an image with a somewhat pathological background pattern
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#set-up-grid-and-the-random-number-seed-for-the-simulation">
             Set up grid and the random number seed for the simulation
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-the-nasty-sky-background">
             Create the nasty sky background
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#look-at-it-with-noise-added-and-then-smoothed-a-bit">
             Look at it with noise added and then smoothed a bit
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#video1">
           Video1:
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#add-some-random-sources">
             Add some random sources
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#routine-for-making-a-plot-to-compare-two-images-side-by-side">
             Routine for making a plot to compare two images side by side
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#try-using-photutils-background2d-mesh-grid-as-a-first-attempt">
           Try using Photutils Background2D mesh grid as a  first attempt
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#ring-median-filtering-the-image">
           Ring median filtering the image
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#set-up-some-routines-for-convenience-in-iterating-the-mask">
           Set up some routines for convenience in iterating the mask
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#estimate-the-background-on-a-finer-scale-after-masking-sources">
           Estimate the background on a finer scale after masking sources
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#try-a-different-interpolation-algorithm">
             Try a different interpolation algorithm.
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#make-a-deeper-source-mask">
             Make a deeper source mask.
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#redo-the-background-estimation-using-this-new-mask">
             Redo the background estimation using this new mask.
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#check-for-bias-in-due-to-the-galaxies">
           Check for bias in due to the galaxies
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#testing-for-bias-on-real-data">
             Testing for bias on real data
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#routines-to-facilitate-looking-at-the-rms-of-the-residual-background-as-a-function-of-scale">
           Routines to facilitate looking at the RMS of the residual background as a function of scale
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Complex 2D Background
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imaging-sky-background-estimation">
              Imaging Sky Background Estimation
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
              Matplotlib setup for plotting
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#create-an-image-with-a-somewhat-pathological-background-pattern">
              Create an image with a somewhat pathological background pattern
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#set-up-grid-and-the-random-number-seed-for-the-simulation">
                Set up grid and the random number seed for the simulation
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-the-nasty-sky-background">
                Create the nasty sky background
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#look-at-it-with-noise-added-and-then-smoothed-a-bit">
                Look at it with noise added and then smoothed a bit
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#video1">
              Video1:
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#add-some-random-sources">
                Add some random sources
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#routine-for-making-a-plot-to-compare-two-images-side-by-side">
                Routine for making a plot to compare two images side by side
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#try-using-photutils-background2d-mesh-grid-as-a-first-attempt">
              Try using Photutils Background2D mesh grid as a  first attempt
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#ring-median-filtering-the-image">
              Ring median filtering the image
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#set-up-some-routines-for-convenience-in-iterating-the-mask">
              Set up some routines for convenience in iterating the mask
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#estimate-the-background-on-a-finer-scale-after-masking-sources">
              Estimate the background on a finer scale after masking sources
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#try-a-different-interpolation-algorithm">
                Try a different interpolation algorithm.
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#make-a-deeper-source-mask">
                Make a deeper source mask.
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#redo-the-background-estimation-using-this-new-mask">
                Redo the background estimation using this new mask.
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#check-for-bias-in-due-to-the-galaxies">
              Check for bias in due to the galaxies
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#testing-for-bias-on-real-data">
                Testing for bias on real data
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#routines-to-facilitate-looking-at-the-rms-of-the-residual-background-as-a-function-of-scale">
              Routines to facilitate looking at the RMS of the residual background as a function of scale
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="complex-2d-background">
          <h1>
           Complex 2D Background
           <a class="headerlink" href="#complex-2d-background" title="Permalink to this headline">
            #
           </a>
          </h1>
          <section id="imaging-sky-background-estimation">
           <h2>
            Imaging Sky Background Estimation
            <a class="headerlink" href="#imaging-sky-background-estimation" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Use case:
            </strong>
            estimate the sky background in complex scenes and evaluate the quality of the sky estimation.
            <br/>
            <strong>
             Data:
            </strong>
            images with pathological background pattern created in the notebook.
            <br/>
            <strong>
             Tools:
            </strong>
            photutils.
            <br/>
            <strong>
             Cross-intrument:
            </strong>
            all instruments.
            <br/>
            <strong>
             Documentation:
            </strong>
            This notebook is part of a STScI’s larger
            <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
             post-pipeline Data Analysis Tools Ecosystem
            </a>
            .
            <br/>
           </p>
          </section>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Sky estimation is one of the tricker aspects of image processing. This is in part because the “sky” is part of the astronomical scene. Some of what is considered background may be in the foreground (thermal background in the detector, scattered light, or zodiacal light). Sometimes the objects of interest overlap (galaxies in front of other galaxies). This notebook does not address the “de-blending” problem of overlapping galaxies, but does outline some of the techniques for dealing with large-scale patterns in the sky.
           </p>
           <p>
            The Photutils manual has an extensive discussion of
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/background.html">
             background estimation
            </a>
            , which is the basis for much of what is in this notebook.
           </p>
          </section>
          <section id="imports">
           <h2>
            Imports
            <a class="headerlink" href="#imports" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              Numpy for general array computations
             </p>
            </li>
            <li>
             <p>
              Scipy for some stats operations and interpolation
             </p>
            </li>
            <li>
             <p>
              Photutils for photometry calculations
             </p>
            </li>
            <li>
             <p>
              Astropy table for viewing the parameters of the sky-background blemishes
             </p>
            </li>
            <li>
             <p>
              Astropy convolution for smoothing the image
             </p>
            </li>
            <li>
             <p>
              Routines from photutils for background subtraction and masking
             </p>
            </li>
            <li>
             <p>
              Astropy tables for manipulating a list of sources (galaxies) injected into the image
             </p>
            </li>
            <li>
             <p>
              Astropy convolution for dilating the sky image and source mask
             </p>
            </li>
            <li>
             <p>
              Astropy modeling for fitting a line to the residuals of the background subtraction
             </p>
            </li>
            <li>
             <p>
              Astropy block_reduce for looking at the RMS of the residuals as a function of scale (blocking factor)
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import numpy as np
from scipy import stats, ndimage, interpolate
from astropy import stats as astrostats
from photutils import (
    datasets,  # For making simulated data
    Background2D,  # For estimating the background
    MedianBackground, BiweightLocationBackground, SExtractorBackground,
    BkgIDWInterpolator, BkgZoomInterpolator,  # For interpolating background
    make_source_mask)
from photutils.utils import ShepardIDWInterpolator as idw
from astropy.table import Table
from astropy.convolution import (
    convolve, Box2DKernel, Tophat2DKernel,
    Ring2DKernel, Gaussian2DKernel)
from scipy.ndimage.filters import median_filter
from astropy.modeling import models, fitting
from astropy.nddata.blocks import block_reduce
from IPython.display import HTML
from jdaviz import Imviz
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.Background2D` is a deprecated alias for `photutils.background.Background2D` and will be removed in the future. Instead, please use `from photutils.background import Background2D` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.MedianBackground` is a deprecated alias for `photutils.background.MedianBackground` and will be removed in the future. Instead, please use `from photutils.background import MedianBackground` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.BiweightLocationBackground` is a deprecated alias for `photutils.background.BiweightLocationBackground` and will be removed in the future. Instead, please use `from photutils.background import BiweightLocationBackground` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.SExtractorBackground` is a deprecated alias for `photutils.background.SExtractorBackground` and will be removed in the future. Instead, please use `from photutils.background import SExtractorBackground` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.BkgIDWInterpolator` is a deprecated alias for `photutils.background.BkgIDWInterpolator` and will be removed in the future. Instead, please use `from photutils.background import BkgIDWInterpolator` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.BkgZoomInterpolator` is a deprecated alias for `photutils.background.BkgZoomInterpolator` and will be removed in the future. Instead, please use `from photutils.background import BkgZoomInterpolator` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:4: DeprecationWarning: `photutils.make_source_mask` is a deprecated alias for `photutils.segmentation.make_source_mask` and will be removed in the future. Instead, please use `from photutils.segmentation import make_source_mask` to silence this warning.
  from photutils import (
/tmp/ipykernel_3964/3828681719.py:15: DeprecationWarning: Please use `median_filter` from the `scipy.ndimage` namespace, the `scipy.ndimage.filters` namespace is deprecated.
  from scipy.ndimage.filters import median_filter
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="matplotlib-setup-for-plotting">
           <h2>
            Matplotlib setup for plotting
            <a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            There are two versions
           </p>
           <ul class="simple">
            <li>
             <p>
              notebook – gives interactive plots, but makes the overall notebook a bit harder to scroll
             </p>
            </li>
            <li>
             <p>
              inline – gives non-interactive plots for better overall scrolling
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import matplotlib.pyplot as plt
import matplotlib as mpl

# Use this version for non-interactive plots (easier scrolling of the notebook)
%matplotlib inline

# Use this version if you want interactive plots
# %matplotlib notebook

# These gymnastics are needed to make the sizes of the figures
# be the same in both the inline and notebook versions
%config InlineBackend.print_figure_kwargs = {'bbox_inches': None}

mpl.rcParams['savefig.dpi'] = 80
mpl.rcParams['figure.dpi'] = 80
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>np.random.seed(seed=4)  # For repeatability
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="create-an-image-with-a-somewhat-pathological-background-pattern">
           <h2>
            Create an image with a somewhat pathological background pattern
            <a class="headerlink" href="#create-an-image-with-a-somewhat-pathological-background-pattern" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This image has a pixel-to-pixel RMS of 0.1, and the background non-uniformities we add are of comparable level to the pixel-to-pixel noise. So you can’t get rid of the non-uniformities without doing a fair amount of smoothing. We’ll add:
           </p>
           <ul class="simple">
            <li>
             <p>
              A background gradient
             </p>
            </li>
            <li>
             <p>
              A few sinc-function blemishes scattered around the image. Make the period of the sinc function large enough that these blemishes shouldn’t look much like sources (assumed to be only a few pixels to tens of pixels across).
             </p>
            </li>
           </ul>
           <p>
            This particular test case was deviously chosen to be one where just adding higher orders to (say) a Chebyshev polynomial surface fit is likely to do a poor job. Similarly, increasing the order of a bicubic spline is not likely to be satisfactory.
           </p>
           <section id="set-up-grid-and-the-random-number-seed-for-the-simulation">
            <h3>
             Set up grid and the random number seed for the simulation
             <a class="headerlink" href="#set-up-grid-and-the-random-number-seed-for-the-simulation" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The test is best illustrated with a 2000x2000 image, but
             <code class="docutils literal notranslate">
              <span class="pre">
               shrink_factor
              </span>
             </code>
             can be used to make the notebook run fast for testing. The random number seed is set to allow for repeatability.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>default_size = 2000
shrink_factor = 2  # To make the images smaller for faster execution
nrow = ncol = default_size // shrink_factor  # Image size
row, col = np.mgrid[0:nrow, 0:ncol]
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="create-the-nasty-sky-background">
            <h3>
             Create the nasty sky background
             <a class="headerlink" href="#create-the-nasty-sky-background" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Blemishes are inserted as sinc-functions with random centers and widths and amplitudes.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>nblemish = 16//shrink_factor  # Number of sinc-function blemishes to add
row_centers = ncol*np.random.random_sample(size=nblemish)
col_centers = nrow*np.random.random_sample(size=nblemish)
# Make the wavelength of sinc ripples pretty large
width = 30+100.*np.random.random_sample(size=nblemish)
amplitude = 1.*np.random.random_sample(size=nblemish)
noiseless_sky = np.zeros((nrow, ncol), dtype=np.float32)
for rr, cc, w, a in zip(row_centers, col_centers, width, amplitude):
    r = np.sqrt((row-rr)**2 + (col-cc)**2)
    noiseless_sky = noiseless_sky + a*np.sinc(r/(w*np.pi))
blemishes = Table([col_centers, row_centers, width, amplitude],
                  names=['x', 'y', 'width', 'amplitude'])
blemishes
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_html">
               <div>
                <i>
                 Table length=8
                </i>
                <table class="table-striped table-bordered table-condensed" id="table139841600879968">
                 <thead>
                  <tr>
                   <th>
                    x
                   </th>
                   <th>
                    y
                   </th>
                   <th>
                    width
                   </th>
                   <th>
                    amplitude
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                  </tr>
                 </thead>
                 <tr>
                  <td>
                   252.98236238344396
                  </td>
                  <td>
                   967.0298390136767
                  </td>
                  <td>
                   30.8986097667555
                  </td>
                  <td>
                   0.17316542149594816
                  </td>
                 </tr>
                 <tr>
                  <td>
                   434.7915324044458
                  </td>
                  <td>
                   547.2322491757224
                  </td>
                  <td>
                   68.65712826436294
                  </td>
                  <td>
                   0.07494858701310703
                  </td>
                 </tr>
                 <tr>
                  <td>
                   779.3829217937524
                  </td>
                  <td>
                   972.6843599648844
                  </td>
                  <td>
                   34.41600579314996
                  </td>
                  <td>
                   0.6007427213777693
                  </td>
                 </tr>
                 <tr>
                  <td>
                   197.68507460025307
                  </td>
                  <td>
                   714.8159936743647
                  </td>
                  <td>
                   125.66529677142358
                  </td>
                  <td>
                   0.16797218371840383
                  </td>
                 </tr>
                 <tr>
                  <td>
                   862.9932355992222
                  </td>
                  <td>
                   697.7288245972708
                  </td>
                  <td>
                   73.61466468797977
                  </td>
                  <td>
                   0.7333801675105699
                  </td>
                 </tr>
                 <tr>
                  <td>
                   983.4006771753128
                  </td>
                  <td>
                   216.08949558037637
                  </td>
                  <td>
                   124.89773067815628
                  </td>
                  <td>
                   0.4084438601520147
                  </td>
                 </tr>
                 <tr>
                  <td>
                   163.8422414046987
                  </td>
                  <td>
                   976.2744547762418
                  </td>
                  <td>
                   108.6305985935061
                  </td>
                  <td>
                   0.5279088234179203
                  </td>
                 </tr>
                 <tr>
                  <td>
                   597.3339439328593
                  </td>
                  <td>
                   6.230255204589863
                  </td>
                  <td>
                   116.62892985816984
                  </td>
                  <td>
                   0.937571583950942
                  </td>
                 </tr>
                </table>
               </div>
              </div>
             </div>
            </div>
            <p>
             Add a gradient on top of the blemishes
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>gradient = (1.*row)/nrow+(0.25*col)/ncol
noiseless_sky += gradient
noise = np.random.normal(scale=0.1, size=np.shape(noiseless_sky))
sky_bkgd = noiseless_sky + noise
mean_bkgd = sky_bkgd.mean()
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure(figsize=(6, 6))
plt.imshow(noiseless_sky, origin='lower')
plt.title('The noiseless sky background')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'The noiseless sky background')
</pre>
               </div>
              </div>
              <img alt="../../_images/Imaging_Sky_Background_Estimation_14_1.png" src="../../_images/Imaging_Sky_Background_Estimation_14_1.png"/>
             </div>
            </div>
            <p>
             Alternatively, try opening the image in Imviz, the new interactive image viewing tool. For more information on Imviz, please visit this link.
             <a class="reference external" href="https://jdaviz.readthedocs.io/en/latest/imviz/index.html">
              https://jdaviz.readthedocs.io/en/latest/imviz/index.html
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz = Imviz()
viewer = imviz.default_viewer
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz.app
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <script type="application/vnd.jupyter.widget-view+json">
               {"version_major": 2, "version_minor": 0, "model_id": "d02ee07016e44180827eb1dc5d8e4abe"}
              </script>
              <img align=center height=auto width=50% src="../../jdaviz_placeholder_new.png">
              </img align=center height=auto width=50%>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz.load_data(noiseless_sky, data_label='noiseless_sky_background')
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Consider some example API commands you can run from the notebook, although many of the manipulation can be done within Imviz.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>viewer.stretch_options
viewer.stretch = 'sqrt'
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>viewer.colormap_options
viewer.set_colormap('Viridis')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="look-at-it-with-noise-added-and-then-smoothed-a-bit">
            <h3>
             Look at it with noise added and then smoothed a bit
             <a class="headerlink" href="#look-at-it-with-noise-added-and-then-smoothed-a-bit" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Smooth with a 10x10 boxcar kernel
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>sky_smoothed = convolve(sky_bkgd-mean_bkgd, Box2DKernel(10))
zmin, zmax = np.percentile(sky_smoothed, (0.1, 99.9))
plt.figure(figsize=(10, 5))
ax1 = plt.subplot(121)
ax1.imshow(sky_bkgd-mean_bkgd, vmin=zmin, vmax=zmax, origin='lower')
ax1.set_title('The sky with noise')
ax2 = plt.subplot(122, sharex=ax1, sharey=ax1)
ax2.set_title('The sky smoothed')
ax2.imshow(sky_smoothed, vmin=zmin, vmax=zmax, origin='lower')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f2f34cd2280&gt;
</pre>
               </div>
              </div>
              <img alt="../../_images/Imaging_Sky_Background_Estimation_23_1.png" src="../../_images/Imaging_Sky_Background_Estimation_23_1.png"/>
             </div>
            </div>
            <p>
             Do the same thing in Imviz and compare images side-by-side, locking by pixels.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz2 = Imviz()
viewer = imviz2.default_viewer
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz2.app
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <script type="application/vnd.jupyter.widget-view+json">
               {"version_major": 2, "version_minor": 0, "model_id": "ecb42b733f8e437bb152b590dc4f1aca"}
              </script>
              <img align=center height=auto width=50% src="../../jdaviz_placeholder_new.png">
              </img align=center height=auto width=50%>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz2.load_data(sky_bkgd-mean_bkgd, data_label='sky_with_noise')
viewer.stretch_options
viewer.stretch = 'sqrt'
viewer.colormap_options
viewer.set_colormap('Viridis')
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz2.load_data(sky_smoothed, data_label='sky_smoothed')
viewer2_name = 'viewer2'
viewer2 = imviz2.create_image_viewer(viewer_name=viewer2_name)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>imviz2.app.add_data_to_viewer(viewer2_name, 'sky_smoothed')
viewer2.stretch_options
viewer2.stretch = 'sqrt'
viewer2.colormap_options
viewer2.set_colormap('Viridis')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="video1">
           <h2>
            Video1:
            <a class="headerlink" href="#video1" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Link two images in different windows by pixel and manipulate image.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Video showing how to link two images in pixel space using plugin
HTML('&lt;iframe width="700" height="500" src="https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/Background_Estimation/imviz_demo_1.mov" frameborder="0" allowfullscreen&gt;&lt;/iframe&gt;')
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/IPython/core/display.py:431: UserWarning: Consider using IPython.display.IFrame instead
  warnings.warn("Consider using IPython.display.IFrame instead")
</pre>
              </div>
             </div>
             <div class="output text_html">
              <iframe allowfullscreen="" frameborder="0" height="500" src="https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/Background_Estimation/imviz_demo_1.mov" width="700">
              </iframe>
             </div>
            </div>
           </div>
           <section id="add-some-random-sources">
            <h3>
             Add some random sources
             <a class="headerlink" href="#add-some-random-sources" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We’ll create a catalog of sources that have elliptical Gaussian profiles with a variety of fluxes, sizes, and position angles. The sizes are kept relatively small relative to the structure in the background. Store these sources in an Astropy table for convenience.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>sources = Table()
nsources = 5000//(shrink_factor**2)
rand_sample = np.random.random_sample  # Save typing
random_sample = rand_sample(nsources)
sources['x_mean'] = 2.+(ncol-4.)*rand_sample(nsources)  # avoid the edges
sources['y_mean'] = 2.+(nrow-4.)*rand_sample(nsources)
sources['flux'] = 50*rand_sample(nsources)
sources['x_stddev'] = 5.*rand_sample(nsources)
sources['y_stddev'] = 5.*rand_sample(nsources)
sources['re'] = np.sqrt(sources['x_stddev']*sources['y_stddev'])
sources['theta'] = 180.*rand_sample(nsources)*np.pi / 180.
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Add these sources to the image to create a scene.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>source_img = datasets.make_gaussian_sources_image(sky_bkgd.shape, sources)
scene = source_img + sky_bkgd
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.figure(figsize=(6, 6))
plt.imshow(scene-mean_bkgd, vmin=zmin, vmax=zmax, origin='lower')
plt.title('The scene, with the sources and nasty sky background')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'The scene, with the sources and nasty sky background')
</pre>
               </div>
              </div>
              <img alt="../../_images/Imaging_Sky_Background_Estimation_36_1.png" src="../../_images/Imaging_Sky_Background_Estimation_36_1.png"/>
             </div>
            </div>
           </section>
           <section id="routine-for-making-a-plot-to-compare-two-images-side-by-side">
            <h3>
             Routine for making a plot to compare two images side by side
             <a class="headerlink" href="#routine-for-making-a-plot-to-compare-two-images-side-by-side" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def plot_two(img1, img2, vmin, vmax, figsize=(10, 6), titles=['', ''],
             cmap=plt.cm.viridis):
    ax1 = plt.figure(figsize=figsize)
    ax1 = plt.subplot(121)
    ax1.imshow(img1, vmin=vmin, vmax=vmax, cmap=cmap, origin='lower')
    ax1.set_title(titles[0])
    ax2 = plt.subplot(122, sharex=ax1, sharey=ax1)
    ax2.imshow(img2, vmin=vmin, vmax=vmax, cmap=cmap, origin='lower')
    ax2.set_title(titles[1])
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="try-using-photutils-background2d-mesh-grid-as-a-first-attempt">
           <h2>
            Try using Photutils Background2D mesh grid as a  first attempt
            <a class="headerlink" href="#try-using-photutils-background2d-mesh-grid-as-a-first-attempt" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Now we need to make a first-cut estimate of the background. Photutils provides a flexible interface to estimating the background in a mesh of cells. We use the
            <code class="docutils literal notranslate">
             <span class="pre">
              Background2D
             </span>
            </code>
            routine here, with a fairly typical set of parameters. See the
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.background.Background2D.html#photutils.background.Background2D">
             documentation
            </a>
            for more information.
           </p>
           <p>
            This tasks creates a mesh of rectangular cells covering the image. The unmasked pixels within each cell are “averaged” using a configurable robust statistic. These averages can then be “averaged” on some larger scale using a configurable robust statistic. This filtered set of averages is then used to feed an interpolation routine to make a smooth background. The default interpolation is a bicubic spline, but we will illustrate inverse-distance weighting interpolation later on in the notebook.
           </p>
           <p>
            Try adjusting the arguments to Background2D to see the effect.
           </p>
           <ul class="simple">
            <li>
             <p>
              The second argument (50 below) is the mesh grid size. This can also be a rectangle – e.g. (50,40) –  if desired.
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                sigma_clip
               </span>
              </code>
              is the method to use for robust averaging within the grid cells.
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                filter_size
               </span>
              </code>
              is how many cells to “averaged” before doing the interpolation. This can also be a rectangle – e.g. (3,4) – if desired.
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                bkg_estimator
               </span>
              </code>
              is the method to use for averaging the values in the cells.
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                exclude_percentile
               </span>
              </code>
              If a mesh has more than this percent of its pixels masked then it will be excluded from the low-resolution map.
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                interpolator
               </span>
              </code>
              is the method to use to interpolate the background (bicubic spline in this case)
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>bkg = Background2D(scene, box_size=50,
                   sigma_clip=astrostats.SigmaClip(sigma=3.),
                   filter_size=3,
                   exclude_percentile=50,
                   bkg_estimator=MedianBackground(),
                   interpolator=BkgZoomInterpolator(order=3))
plt.figure(figsize=(6, 6))
plt.imshow(bkg.background-noiseless_sky, vmin=0.1*zmin, vmax=0.1*zmax, origin='lower')
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f2f3491acd0&gt;
</pre>
              </div>
             </div>
             <img alt="../../_images/Imaging_Sky_Background_Estimation_40_1.png" src="../../_images/Imaging_Sky_Background_Estimation_40_1.png"/>
            </div>
           </div>
           <p>
            Make a couple masks. The
            <code class="docutils literal notranslate">
             <span class="pre">
              make_source_mask
             </span>
            </code>
            routine has a few options. Try changing them to see what they do. The aim here is to find and mask sources without seeing an appreciable enhancement of sources in regions where the background  is high. There are several parameters that can be adjusted:
           </p>
           <ul class="simple">
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                nsigma
               </span>
              </code>
              – we will try this with 2 and 3 sigma cuts
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                npixels
               </span>
              </code>
              – the number of connected pixels above the threshold required before masking
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                dilate_size
               </span>
              </code>
              – the size of a square box-car filter used to grow the mask
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                filter_fwhm
               </span>
              </code>
              – the image is convolved with a Gaussian of this FWHM before thresholding.
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>mask_2sigma = make_source_mask(scene-bkg.background, nsigma=2, npixels=3,
                               dilate_size=5, filter_fwhm=3)
mask_3sigma = make_source_mask(scene-bkg.background, nsigma=3, npixels=3,
                               dilate_size=5, filter_fwhm=3)
plot_two(mask_2sigma, mask_3sigma, 0, 1)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: AstropyDeprecationWarning: The make_source_mask function is deprecated and may be removed in a future version.
        Use SegmentationImage.make_source_mask instead. [warnings]
WARNING:astroquery:AstropyDeprecationWarning: The make_source_mask function is deprecated and may be removed in a future version.
        Use SegmentationImage.make_source_mask instead.
</pre>
              </div>
             </div>
             <div class="output traceback highlight-ipythontb notranslate">
              <div class="highlight">
               <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">25</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mask_2sigma</span> <span class="o">=</span> <span class="n">make_source_mask</span><span class="p">(</span><span class="n">scene</span><span class="o">-</span><span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                                <span class="n">dilate_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">filter_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">mask_3sigma</span> <span class="o">=</span> <span class="n">make_source_mask</span><span class="p">(</span><span class="n">scene</span><span class="o">-</span><span class="n">bkg</span><span class="o">.</span><span class="n">background</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">npixels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                                <span class="n">dilate_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">filter_fwhm</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">plot_two</span><span class="p">(</span><span class="n">mask_2sigma</span><span class="p">,</span> <span class="n">mask_3sigma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/utils/decorators.py:136,</span> in <span class="ni">deprecated.&lt;locals&gt;.deprecate_function.&lt;locals&gt;.deprecated_func</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>     <span class="n">category</span> <span class="o">=</span> <span class="n">warning_type</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span> <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">136</span> <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="ne">TypeError</span>: make_source_mask() got an unexpected keyword argument 'filter_fwhm'
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Try reducing the mesh size of the background estimation in the
            <code class="docutils literal notranslate">
             <span class="pre">
              Background2D
             </span>
            </code>
            task. The smaller mesh size definitely helps, but there is a hint in the residual image on the right that sources are biasing the background estimate.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>sigma_clip = astrostats.SigmaClip(sigma=3.)
bkg_estimator = MedianBackground()
bkg1 = Background2D(scene, (30, 30), filter_size=(3, 3), mask=mask_3sigma,
                    sigma_clip=sigma_clip, bkg_estimator=bkg_estimator)
bkg2 = Background2D(scene, (15, 15), filter_size=(3, 3), mask=mask_3sigma,
                    sigma_clip=sigma_clip, bkg_estimator=bkg_estimator)
plot_two(bkg1.background-noiseless_sky, bkg2.background-noiseless_sky,
         0.1*zmin, 0.1*zmax, titles=['bkg1', 'bkg2'])
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="ring-median-filtering-the-image">
           <h2>
            Ring median filtering the image
            <a class="headerlink" href="#ring-median-filtering-the-image" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            It’s clear we are going to do more iteration to do the source removal. Before doing that, let’s try another approach to removing the sources: the ring-median filter. To do this, create a filter kernel that is larger than the sources of interest. Use the scipy median-filtering routine to slide this across the image, taking the median of all the pixels within the ring. This basically gives a local-background estimate for each pixel.
(While we don’t illustrate it here, it’s possible to use
            <a class="reference external" href="https://docs.scipy.org/doc/scipy-0.16.1/reference/generated/scipy.ndimage.filters.generic_filter.html">
             <code class="docutils literal notranslate">
              <span class="pre">
               scipy.ndimage.generic_filter
              </span>
             </code>
            </a>
            and pass it a function to compute something other than a median.)
           </p>
           <p>
            The cell below sets up the kernel.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>ring = Ring2DKernel(15, 5)
plt.imshow(ring.array)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Compare the scene (minus the mean background) to the filtered scene.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>filtered = median_filter(scene, footprint=ring.array)
plot_two(scene-mean_bkgd, filtered-mean_bkgd, zmin, zmax,
         titles=['Sources', 'ring-median filtered'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Subtract the ring-median filtered image from the scene as the first cut at background subtraction. Convolve this with a kernel to smooth for source detection, and threshold that to identify pixels that are part of sources.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>difference = scene-filtered
smoothed = convolve(difference, Gaussian2DKernel(3))
mask = smoothed &gt; 1.*smoothed.std()
plot_two(difference, mask, zmin, zmax,
         titles=['scene minus ring-median filtered scene', 'mask'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            It’s often useful to grow the mask. This can be accomplished by convolving with a filter. Here, we adopt a circular tophat filter.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def dilate_mask(mask, tophat_size):
    ''' Take a mask and make the masked regions bigger.'''
    area = np.pi*tophat_size**2.
    kernel = Tophat2DKernel(tophat_size)
    dilated_mask = convolve(mask, kernel) &gt;= 1./area
    return dilated_mask
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>dilated_mask = dilate_mask(mask, 2)
plot_two(mask, dilated_mask, 0, 1, titles=['mask', 'dilated mask'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Mask the image and see how many sources are still remaining
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plot_two(scene-noiseless_sky, (scene-noiseless_sky)*(1.-mask), zmin, zmax,
         titles=['scene without background', 'masked scene without background'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Let’s make a fancier plot that shows background residuals, the residuals with the sources and source mask overlayed, and the background-subtracted scene.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def plot_bkgd(scene, mask, bkgd, noiseless_bkgd, sources,
              zmin, zmax, factor=0.1,  # Control the colormap stretch
              figsize=(20, 10)):
    '''Make a three-panel plot of:
         * the residual sky background
         * the residual sky background times the mask with
           masked sources overlayed as '+' signs and
           unmasked sources overlayed as circles, and
         * The background-subtracted scene.
    '''
    residual = bkgd-noiseless_bkgd
    plt.figure(figsize=figsize)
    # Plot the background residual
    ax1 = plt.subplot(131)
    ax1.imshow(residual, vmin=factor*zmin, vmax=factor*zmax, origin='lower')
    ax1.set_title('residual sky background')
    ax2 = plt.subplot(132, sharex=ax1, sharey=ax1)
    ax2.imshow(residual*(1-mask), vmin=factor*zmin, vmax=factor*zmax,
               origin='lower')
    xs = np.rint(sources['x_mean']).astype(np.int32)
    ys = np.rint(sources['y_mean']).astype(np.int32)
    masked = mask[ys, xs]
    unmasked = np.invert(masked)
    ax2.scatter(xs[masked], ys[masked], s=sources['flux'][masked], marker='+',
                c='red', alpha=0.2)
    ax2.scatter(xs[unmasked], ys[unmasked], s=sources['flux'][unmasked],
                c='black', alpha=0.5)
    ax2.set_xlim(0, scene.shape[1])
    ax2.set_ylim(0, scene.shape[0])
    ax2.set_title('with masked + unmasked O sources')
    ax3 = plt.subplot(133, sharex=ax1, sharey=ax1)
    ax3.imshow(scene-bkgd, vmin=zmin, vmax=zmax, origin='lower')
    ax3.set_title('Scene minus estimated background')
    print(f"Residual RMS, peak = {residual.std():.4f}, {residual.max():.4f}")
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Try this fancier plot. The default scaling of the first two plots has a harder stretch in the colormap, so we can now see that there are ring-shaped residuals around all the bright sources. These are not readily apparent in the third plot, which has the stretch we used for the earlier plots.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plot_bkgd(scene, mask, filtered, noiseless_sky, sources, zmin, zmax)
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="set-up-some-routines-for-convenience-in-iterating-the-mask">
           <h2>
            Set up some routines for convenience in iterating the mask
            <a class="headerlink" href="#set-up-some-routines-for-convenience-in-iterating-the-mask" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Next we will try iterating in fitting the background and progressively removing sources at lower and lower S/N. We’ll want to inspect at each step. Here are some functions to reduce typing:
           </p>
           <ul class="simple">
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                SourceMask
               </span>
              </code>
              – This is an class to set up some parameters for the masking and give us a couple methods:
             </p>
             <ul>
              <li>
               <p>
                <code class="docutils literal notranslate">
                 <span class="pre">
                  single
                 </span>
                </code>
                – appy an existing mask and then use photutils make_source_mask to make a new one; convolve the mask with a circular tophat kernel and threshold to dilate it
               </p>
              </li>
              <li>
               <p>
                <code class="docutils literal notranslate">
                 <span class="pre">
                  multiple
                 </span>
                </code>
                – repeatedly apply the
                <code class="docutils literal notranslate">
                 <span class="pre">
                  single
                 </span>
                </code>
                method to make a new mask. OR that with the previous masks.
               </p>
              </li>
             </ul>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                find_worst_residual_near_center
               </span>
              </code>
              – when plotting a zoomed in image for inspection, we’d like to select the section away from the edges that has the worst residuals
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                plot_mask
               </span>
              </code>
              – plots the mask for the whole image and plots it as contours overlayed on a small subsection
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def my_background(img, box_size, mask, interp=None, filter_size=1,
                  exclude_percentile=90):
    ''' Run photutils background with SigmaClip and MedianBackground'''
    if interp is None:
        interp = BkgZoomInterpolator()
    return Background2D(img, box_size,
                        sigma_clip=astrostats.SigmaClip(sigma=3.),
                        filter_size=filter_size,
                        bkg_estimator=MedianBackground(),
                        exclude_percentile=exclude_percentile,
                        mask=mask,
                        interpolator=interp)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>class SourceMask:
    def __init__(self, img, nsigma=3., npixels=3):
        ''' Helper for making &amp; dilating a source mask.
             See Photutils docs for make_source_mask.'''
        self.img = img
        self.nsigma = nsigma
        self.npixels = npixels

    def single(self, filter_fwhm=3., tophat_size=5., mask=None):
        '''Mask on a single scale'''
        if mask is None:
            image = self.img
        else:
            image = self.img*(1-mask)
        mask = make_source_mask(image, nsigma=self.nsigma,
                                npixels=self.npixels,
                                dilate_size=1, filter_fwhm=filter_fwhm)
        return dilate_mask(mask, tophat_size)

    def multiple(self, filter_fwhm=[3.], tophat_size=[3.], mask=None):
        '''Mask repeatedly on different scales'''
        if mask is None:
            self.mask = np.zeros(self.img.shape, dtype=bool)
        for fwhm, tophat in zip(filter_fwhm, tophat_size):
            smask = self.single(filter_fwhm=fwhm, tophat_size=tophat)
            self.mask = self.mask | smask  # Or the masks at each iteration
        return self.mask
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def find_worst_residual_near_center(resid):
    '''Find the pixel location of the worst residual, avoiding the edges'''
    yc, xc = resid.shape[0]/2., resid.shape[1]/2.
    radius = resid.shape[0]/3.
    y, x = np.mgrid[0:resid.shape[0], 0:resid.shape[1]]
    mask = np.sqrt((y-yc)**2+(x-xc)**2) &lt; radius
    rmasked = resid*mask
    return np.unravel_index(np.argmax(rmasked), resid.shape)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def plot_mask(scene, bkgd, mask, zmin, zmax, worst=None, smooth=0):
    '''Make a three-panel plot of:
         * the mask for the whole image,
         * the scene times the mask
         * a zoomed-in region, with the mask shown as contours
    '''
    if worst is None:
        y, x = find_worst_residual_near_center(bkgd-noiseless_sky)
    else:
        x, y = worst
    plt.figure(figsize=(20, 10))
    plt.subplot(131)
    plt.imshow(mask, vmin=0, vmax=1, cmap=plt.cm.gray, origin='lower')
    plt.subplot(132)
    if smooth == 0:
        plt.imshow((scene-bkgd)*(1-mask), vmin=zmin, vmax=zmax, origin='lower')
    else:
        smoothed = convolve((scene-bkgd)*(1-mask), Gaussian2DKernel(smooth))
        plt.imshow(smoothed*(1-mask), vmin=zmin/smooth, vmax=zmax/smooth,
                   origin='lower')
    plt.subplot(133)
    plt.imshow(scene-bkgd, vmin=zmin, vmax=zmax)
    plt.contour(mask, colors='red', alpha=0.2)
    plt.ylim(y-100, y+100)
    plt.xlim(x-100, x+100)
    return x, y
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="estimate-the-background-on-a-finer-scale-after-masking-sources">
           <h2>
            Estimate the background on a finer scale after masking sources
            <a class="headerlink" href="#estimate-the-background-on-a-finer-scale-after-masking-sources" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>bkg3 = my_background(scene, box_size=10, filter_size=5, mask=mask)
plot_bkgd(scene, mask, bkg1.background, noiseless_sky, sources, zmin, zmax)
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="try-a-different-interpolation-algorithm">
            <h3>
             Try a different interpolation algorithm.
             <a class="headerlink" href="#try-a-different-interpolation-algorithm" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The Shephard inverse-distance weighting searches for
the N grid points nearest to the pixel of interest and weights them as
             <span class="math notranslate nohighlight">
              \(1/(D^p + \lambda)\)
             </span>
             where
             <span class="math notranslate nohighlight">
              \(D\)
             </span>
             is the distance to the neighbor,
             <span class="math notranslate nohighlight">
              \(p\)
             </span>
             is a power, and
             <span class="math notranslate nohighlight">
              \(\lambda\)
             </span>
             is a parameter to
make the weighting of the neighbors smoother closer to the pixel of interest.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>interpolator = BkgIDWInterpolator(n_neighbors=20, power=1, reg=30)
bkg4 = my_background(scene, box_size=10, filter_size=5, mask=mask,
                     interp=interpolator, exclude_percentile=90)
plot_bkgd(scene, mask, bkg4.background, noiseless_sky, sources, zmin, zmax)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="make-a-deeper-source-mask">
            <h3>
             Make a deeper source mask.
             <a class="headerlink" href="#make-a-deeper-source-mask" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             This runs three iterations, with different kernel widths and different tophat sizes for growing the mask. Try varying
             <code class="docutils literal notranslate">
              <span class="pre">
               sigma
              </span>
             </code>
             ,
             <code class="docutils literal notranslate">
              <span class="pre">
               filter_fwhm
              </span>
             </code>
             and
             <code class="docutils literal notranslate">
              <span class="pre">
               tophat_size
              </span>
             </code>
             to see how they affect the sources. The aim is to mask sources that are easily visible, but leave plenty of pixels for tracing the background.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>sm = SourceMask(scene-bkg4.background, nsigma=1.5)
mask = sm.multiple(filter_fwhm=[1, 3, 5],
                   tophat_size=[4, 2, 1])
plot_mask(scene, bkg4.background, mask, zmin, zmax)
mask.sum()
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="redo-the-background-estimation-using-this-new-mask">
            <h3>
             Redo the background estimation using this new mask.
             <a class="headerlink" href="#redo-the-background-estimation-using-this-new-mask" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Play with
             <code class="docutils literal notranslate">
              <span class="pre">
               n_neighbors
              </span>
             </code>
             ,
             <code class="docutils literal notranslate">
              <span class="pre">
               box_size
              </span>
             </code>
             ,
             <code class="docutils literal notranslate">
              <span class="pre">
               filter_size
              </span>
             </code>
             and
             <code class="docutils literal notranslate">
              <span class="pre">
               exclude_percentile
              </span>
             </code>
             to see how they affect the residuals.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>interpolator = BkgIDWInterpolator(n_neighbors=20, power=0, reg=30)
bkg5 = my_background(scene, box_size=6, filter_size=3, mask=mask,
                     interp=interpolator, exclude_percentile=90)
plot_bkgd(scene, mask, bkg5.background, noiseless_sky, sources, zmin, zmax)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="check-for-bias-in-due-to-the-galaxies">
           <h2>
            Check for bias in due to the galaxies
            <a class="headerlink" href="#check-for-bias-in-due-to-the-galaxies" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Since we are dealing with a simulation, where we know truth, we can evaluate the biases directly. (In the case of a real image, we can’t do that; we’ll suggest another test further down).
           </p>
           <p>
            Tabulate the residual background under the central 3x3 pixels under each galaxy vs the flux of the galaxy, separately for those that are masked and those that are unmasked. First we need to get these values. Take the mean for  3x3 pixels centered on each source. Keep track of the ones that were masked in fitting the background and the ones that weren’t so we can check separately for any bias.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>bkgd = bkg5.background
residual_image = bkgd-noiseless_sky

# Create columns in the table for the background estimate, the residual,
# and a flag for whether or not this source was masked
sources['bkgd'] = 0.*sources['flux']
sources['resid'] = 0.*sources['flux']
sources['masked'] = np.zeros(len(sources), dtype=bool)

# Compute the values for the 3x3 pixels centered on each source
for i in range(len(sources)):
    s = sources[i]
    x = np.rint(s['x_mean']).astype(np.int32)
    y = np.rint(s['y_mean']).astype(np.int32)
    xmin, xmax = max(0, x-1), min(ncol, x+1)
    ymin, ymax = max(0, y-1), min(nrow, y+1)
    sources['resid'][i] = residual_image[ymin:ymax, xmin:xmax].mean()
    sources['bkgd'][i] = bkgd[ymin:ymax, xmin:xmax].mean()
    sources['masked'][i] = mask[y, x]  # Flag only if central pixel was masked
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Make a list of random positions and do the same measurement, as a control.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Set up the arrays for the random positions
N_random = 5*len(sources)
resid_under_random = np.zeros(N_random, dtype=np.float64)
bkgd_under_random = np.zeros(N_random, dtype=np.float64)
masked_random = np.zeros(N_random, dtype=bool)

# Grab a random flux and radius from the catalog, just so we can plot
# The results for the random sources on the same axis as the real sources
random_flux = sources['flux'][np.random.randint(0, len(sources), N_random)]
random_re = sources['re'][np.random.randint(0, len(sources), N_random)]
rnd_x = np.random.randint(2, ncol-2, size=N_random)
rnd_y = np.random.randint(2, nrow-2, size=N_random)

# Compute the values for the 3x3 pixels centered on each source
for i, x, y in zip(range(len(rnd_x)), rnd_x, rnd_y):
    resid_under_random[i] = residual_image[y-1:y+1, x-1:x+1].mean()
    bkgd_under_random[i] = bkgd[y-1:y+1, x-1:x+1].mean()
    masked_random[i] = mask[y-1:y+1, x-1:x+1].min().astype(bool)

# Only keep the results for locations that weren't masked
resid_under_random = resid_under_random[~masked_random]
random_flux = random_flux[~masked_random]
random_re = random_re[~masked_random]
print(f"Nsources, Nrandom: {len(sources)} {len(resid_under_random)}")
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Make lists of the masked and unmasked sources
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>flux = sources['flux']
resid = sources['resid']
re = sources['re']
masked = sources['masked']
unmasked = np.invert(sources['masked'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Define a function
            <code class="docutils literal notranslate">
             <span class="pre">
              fit_line
             </span>
            </code>
            to fit a line to the data points, and another function
            <code class="docutils literal notranslate">
             <span class="pre">
              fit_and_plot
             </span>
            </code>
            to plot the data points and the best-fit line together.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def fit_line(x, y):
    line = models.Linear1D(1., 1.)
    fit = fitting.LinearLSQFitter()
    best_fit = fit(line, x, y)
    return best_fit
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def fit_and_plot(x, y, alpha=0.2, color='red', s=10,
                 marker='o', label=''):
    xfit = np.linspace(0, x.max(), 10)
    line = fit_line(x, y)
    plt.scatter(x, y, alpha=alpha, color=color, s=s, marker=marker,
                label=label)
    plt.plot(xfit, line(xfit), color=color, alpha=0.7)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Plot the residuals vs. source flux, separately for the masked, unmasked, and randomized source positions. Make the sizes of the markers proportional to the fluxes of the sources. Ideally, this should be centered at 0.0 for all three cases, with no correlation with source flux. Of course, it is nearly impossible not to have a bias where the sources were not masked, since they then contribute to the background estimate. In this particular case, there is a small offset in the residuals when the source was not masked, and evidence of a trend with the flux of the source.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure(figsize=(10, 5))
fit_and_plot(flux[unmasked], resid[unmasked], s=10.*re[unmasked],
             label='unmasked', color='black', alpha=0.5, marker='s')
fit_and_plot(flux[masked], resid[masked], s=10.*re[masked],
             label='masked', color='red', alpha=0.3, marker='o')
fit_and_plot(random_flux, resid_under_random, color='blue', alpha=0.1,
             marker='+', label='random')
plt.legend()
plt.ylim(-0.05, 0.05)
plt.title('residuals vs. flux')
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure(figsize=(10, 6))
fit_and_plot(re[unmasked], resid[unmasked], s=2*flux[unmasked],
             label='unmasked', color='black', alpha=0.5, marker='s')
fit_and_plot(re[masked], resid[masked], s=flux[masked],
             label='masked', color='red', alpha=0.2, marker='o')
fit_and_plot(random_re, resid_under_random, color='blue', alpha=0.1,
             marker='+', label='random')
plt.legend()
plt.ylim(-0.05, 0.05)
plt.title('residuals vs. radius')
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="testing-for-bias-on-real-data">
            <h3>
             Testing for bias on real data
             <a class="headerlink" href="#testing-for-bias-on-real-data" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             With real data, we can’t take the residual relative to noiseless sky. However, we can check for evidence that the background under the masked areas is statistically higher than the background in the random areas. Given that astronomical sources have wings and these can’t be subtracted without modeling them, it is very hard to achieve perfection here. This test will tell you the magnitude of the potential bias (in flux per pixel) and whether or not it looks significant.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>mean_masked = bkgd[mask].mean()
std_masked = bkgd[mask].std()
stderr_masked = mean_masked/(np.sqrt(len(bkgd[mask]))*std_masked)

mean_unmasked = bkgd[~mask].mean()
std_unmasked = bkgd[~mask].std()
stderr_unmasked = mean_unmasked/(np.sqrt(len(bkgd[~mask]))*std_unmasked)

diff = mean_masked - mean_unmasked
significance = diff/np.sqrt(stderr_masked**2 + stderr_unmasked**2)

print(f"Mean under masked pixels   = {mean_masked:.4f} +- {stderr_masked:.4f}")
print(f"Mean under unmasked pixels = "
      f"{mean_unmasked:.4f} +- {stderr_unmasked:.4f}")
print(f"Difference = {diff:.4f} at {significance:.2f} sigma significance")
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="routines-to-facilitate-looking-at-the-rms-of-the-residual-background-as-a-function-of-scale">
           <h2>
            Routines to facilitate looking at the RMS of the residual background as a function of scale
            <a class="headerlink" href="#routines-to-facilitate-looking-at-the-rms-of-the-residual-background-as-a-function-of-scale" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            One way to evaluate whether the sky-subtraction looks sensible is to see whether the RMS is dropping sensibly as a
function of scale. It should drop linearly with the area size of the image sampled.
           </p>
           <p>
            To do this test, we would like to look at unmasked regions, but have them all have the same S/N. So we need a way to set up a mesh grid that has no masked pixels in each of the mesh areas.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def smoothsample_masked(img, mask, width=9):
    '''Take the means in squares that have no masked pixels'''
    nrow, ncol = img.shape
    w = width/2
    # Mask out the borders
    row, col = np.mgrid[0:nrow, 0:ncol]
    mask = mask | (row &lt; w) | (row &gt; nrow-w) | (col &lt; w) | (col &gt; ncol-w)
    # Make a list of the squares that contain no masked pixels
    mm = block_reduce(mask, width)
    means = block_reduce(img, width, func=np.mean)
    good = np.where(mm == 0)
    return means[good]


def calculate_stats(residual, mask, widths):
    stats = []
    for w in widths:
        val = smoothsample_masked(residual, mask, w)
        stats += [val.std()]
    return np.array(stats)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Calculate the statistics for the different background estimates. These are the residuals of the masked “scene” – i.e. with the sources in it, but masked as well as one might do for a real scene. These are to be compared to the “perfect” case of the noisy sky background minus the noiseless sky background, where the statistics are computed in the same unmasked cells.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>rms = Table()
widths = rms['widths'] = np.arange(3, 30, 1)
rms['bkg1'] = calculate_stats(scene-bkg1.background, mask, widths)
rms['bkg2'] = calculate_stats(scene-bkg2.background, mask, widths)
rms['bkg3'] = calculate_stats(scene-bkg3.background, mask, widths)
rms['bkg4'] = calculate_stats(scene-bkg4.background, mask, widths)
rms['bkg5'] = calculate_stats(scene-bkg5.background, mask, widths)
rms['perfect'] = calculate_stats(sky_bkgd-noiseless_sky, mask, widths)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Plot the results relative to the perfect case (we’ve commented out the initial
            <code class="docutils literal notranslate">
             <span class="pre">
              bkg1
             </span>
            </code>
            estimate just to make the scale more visible for the better estimates). It is worth noting that the
            <code class="docutils literal notranslate">
             <span class="pre">
              bkg1
             </span>
            </code>
            is typical of what one might get from SExtractor, which offers only a single pass for the background estimation.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>plt.figure(figsize=(10, 6))
perfect = rms['perfect']
# plt.plot(rms['widths'],rms['bkg1']/perfect,alpha=0.5,label='bkg1')
plt.plot(rms['widths'], rms['bkg2']/perfect, alpha=0.5, label='bkg2')
plt.plot(rms['widths'], rms['bkg3']/perfect, alpha=0.5, label='bkg3')
plt.plot(rms['widths'], rms['bkg4']/perfect, alpha=0.5, label='bkg4')
plt.plot(rms['widths'], rms['bkg5']/perfect, alpha=0.5, label='bkg5')
plt.plot(rms['widths'], rms['perfect']/perfect, 'k-', alpha=1, label='perfect')
plt.legend()
</pre>
              </div>
             </div>
            </div>
           </div>
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/background_estimation_imaging"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../asdf_example/asdf_example.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            ASDF Example
           </p>
          </div>
         </a>
         <a class="right-next" href="../composite_model_fitting/specfit_demo_3.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            Composite Model Spectral Fitting
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>