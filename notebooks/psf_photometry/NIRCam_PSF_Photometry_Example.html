<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   PSF Photometry — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <script>
   window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}
  </script>
  <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html" rel="next" title="WFSS Spectra Part 0: Optimal Extraction"/>
  <link href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html" rel="prev" title="Cross-Filter PSF Matching"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/psf_photometry/NIRCam_PSF_Photometry_Example.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/psf_photometry/NIRCam_PSF_Photometry_Example.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#work-in-progress">
           Work in Progress:
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#data-download-functions">
           Data Download Functions
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-functions">
           Import Functions
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-plotting-functions">
           Import Plotting Functions
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#load-the-images-and-create-some-useful-dictionaries">
           Load the images and create some useful dictionaries
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#select-the-detectors-and-or-filters-for-the-analysis">
           Select the detectors and/or filters for the analysis
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-the-images">
           Display the images
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#note-for-developers">
             Note for developers:
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             Note for developers:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#create-the-psf-models">
           Create the PSF models
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#i-create-the-psf-model-using-webbpsf">
           I. Create the PSF model using WebbPSF
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#single-psf-model">
             Single PSF model
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-the-single-psf-models">
           Display the single PSF models
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#psf-grid">
             PSF grid
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-the-psfs-grid">
           Display the PSFs grid
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#developer-note-currently-display-psf-grid-has-a-bug-which-has-been-fixed-but-will-not-merged-into-the-latest-webbpsf-release-until-after-commissioning-we-have-turned-off-this-cell-for-the-time-being">
             Developer Note: Currently, display_psf_grid has a bug which has been fixed, but will not merged into the latest WebbPSF release until after commissioning. We have turned off this cell for the time being.
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#ii-create-the-psf-model-building-an-effective-psf-epsf">
           II. Create the PSF model building an Effective PSF (ePSF)
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#ii-build-effective-psf">
             II. Build Effective PSF
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-the-epsfs">
           Display the ePSFs
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#work-in-progress-build-a-grid-of-effective-psf">
           Work in Progress - Build a grid of effective PSF
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#i-counting-psf-stars-in-each-region-of-the-grid">
             I. Counting PSF stars in each region of the grid
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#todo-create-a-grid-of-epsf">
           TODO - Create a grid of ePSF
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#todo-use-the-epsf-grid-to-perturbate-the-webbpsf-model">
           TODO - Use the ePSF grid to perturbate the WebbPSF model
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#perform-psf-photometry">
           Perform PSF photometry
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#output-photometry-table">
           Output Photometry Table
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#note-for-developer">
             Note for developer:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#display-subtracted-image">
           Display subtracted image
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#part-ii-data-analysis">
           Part II - Data Analysis
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#load-tables-with-psf-photometry">
           Load Tables with PSF Photometry
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#transform-the-images-to-datamodel">
           Transform the images to DataModel
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#cross-match-the-catalogs-from-the-two-filters-for-the-4-images">
           Cross-match the catalogs from the two filters for the 4 images
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#color-magnitude-diagrams-instrumental-magnitudes-for-the-4-images">
           Color-Magnitude Diagrams (Instrumental Magnitudes) for the 4 images
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#difference-in-retrieved-positions-in-pixels-between-daofind-an-psf-routine">
           Difference in retrieved positions (in pixels) between daofind an PSF routine
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#cross-match-the-4-catalogs-for-each-filter">
           Cross-match the 4 catalogs for each filter
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id2">
             Note for developer:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#final-color-magnitude-diagram-instrumental-magnitudes">
           Final Color-Magnitude Diagram (Instrumental Magnitudes)
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#photometric-zeropoints">
           Photometric Zeropoints
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#load-the-calibrated-and-rectified-images-level-3-imaging-pipeline">
           Load the calibrated and rectified images (Level 3 imaging pipeline)
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#id3">
           Display the images
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#aperture-photometry">
           Aperture Photometry
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#find-bright-isolated-stars">
             Find bright isolated stars
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-aperture-correction-table">
             Load aperture correction table
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#perform-aperture-photometry">
             Perform Aperture Photometry
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#derive-zeropoints">
             Derive Zeropoints
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-input-photometry">
           Import input photometry
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#calibrated-color-magnitude-diagram">
           Calibrated Color-Magnitude Diagram
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#comparison-between-input-and-output-photometry">
           Comparison between input and output photometry
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#final-notes">
           Final notes
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#about-this-notebook">
           About this Notebook
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         PSF Photometry
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#work-in-progress">
              Work in Progress:
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#data-download-functions">
              Data Download Functions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-functions">
              Import Functions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-plotting-functions">
              Import Plotting Functions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#load-the-images-and-create-some-useful-dictionaries">
              Load the images and create some useful dictionaries
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#select-the-detectors-and-or-filters-for-the-analysis">
              Select the detectors and/or filters for the analysis
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-the-images">
              Display the images
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#note-for-developers">
                Note for developers:
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                Note for developers:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#create-the-psf-models">
              Create the PSF models
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#i-create-the-psf-model-using-webbpsf">
              I. Create the PSF model using WebbPSF
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#single-psf-model">
                Single PSF model
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-the-single-psf-models">
              Display the single PSF models
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#psf-grid">
                PSF grid
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-the-psfs-grid">
              Display the PSFs grid
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#developer-note-currently-display-psf-grid-has-a-bug-which-has-been-fixed-but-will-not-merged-into-the-latest-webbpsf-release-until-after-commissioning-we-have-turned-off-this-cell-for-the-time-being">
                Developer Note: Currently, display_psf_grid has a bug which has been fixed, but will not merged into the latest WebbPSF release until after commissioning. We have turned off this cell for the time being.
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#ii-create-the-psf-model-building-an-effective-psf-epsf">
              II. Create the PSF model building an Effective PSF (ePSF)
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#ii-build-effective-psf">
                II. Build Effective PSF
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-the-epsfs">
              Display the ePSFs
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#work-in-progress-build-a-grid-of-effective-psf">
              Work in Progress - Build a grid of effective PSF
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#i-counting-psf-stars-in-each-region-of-the-grid">
                I. Counting PSF stars in each region of the grid
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#todo-create-a-grid-of-epsf">
              TODO - Create a grid of ePSF
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#todo-use-the-epsf-grid-to-perturbate-the-webbpsf-model">
              TODO - Use the ePSF grid to perturbate the WebbPSF model
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#perform-psf-photometry">
              Perform PSF photometry
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#output-photometry-table">
              Output Photometry Table
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#note-for-developer">
                Note for developer:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#display-subtracted-image">
              Display subtracted image
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#part-ii-data-analysis">
              Part II - Data Analysis
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#load-tables-with-psf-photometry">
              Load Tables with PSF Photometry
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#transform-the-images-to-datamodel">
              Transform the images to DataModel
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#cross-match-the-catalogs-from-the-two-filters-for-the-4-images">
              Cross-match the catalogs from the two filters for the 4 images
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#color-magnitude-diagrams-instrumental-magnitudes-for-the-4-images">
              Color-Magnitude Diagrams (Instrumental Magnitudes) for the 4 images
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#difference-in-retrieved-positions-in-pixels-between-daofind-an-psf-routine">
              Difference in retrieved positions (in pixels) between daofind an PSF routine
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#cross-match-the-4-catalogs-for-each-filter">
              Cross-match the 4 catalogs for each filter
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id2">
                Note for developer:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#final-color-magnitude-diagram-instrumental-magnitudes">
              Final Color-Magnitude Diagram (Instrumental Magnitudes)
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#photometric-zeropoints">
              Photometric Zeropoints
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#load-the-calibrated-and-rectified-images-level-3-imaging-pipeline">
              Load the calibrated and rectified images (Level 3 imaging pipeline)
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#id3">
              Display the images
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#aperture-photometry">
              Aperture Photometry
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#find-bright-isolated-stars">
                Find bright isolated stars
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-aperture-correction-table">
                Load aperture correction table
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#perform-aperture-photometry">
                Perform Aperture Photometry
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#derive-zeropoints">
                Derive Zeropoints
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-input-photometry">
              Import input photometry
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#calibrated-color-magnitude-diagram">
              Calibrated Color-Magnitude Diagram
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#comparison-between-input-and-output-photometry">
              Comparison between input and output photometry
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#final-notes">
              Final notes
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#about-this-notebook">
              About this Notebook
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="psf-photometry">
          <h1>
           PSF Photometry
           <a class="headerlink" href="#psf-photometry" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           PSF photometry, creating a PSF, derive Color-Magnitude Diagram.
           <br/>
           <strong>
            Data:
           </strong>
           NIRCam simulated images obtained using
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
            MIRAGE
           </a>
           and run through the
           <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">
            JWST pipeline
           </a>
           of the Large Magellanic Cloud (LMC) Astrometric Calibration Field. Simulations is obtained using a 4-pt subpixel dither for three couples of wide filters: F070W, F115W, and F200W for the SW channel, and F277W, F356W, and F444W for the LW channel. We simulated only 1 NIRCam SW detector (i.e., “NRCB1”). For this example, we use Level-2 images (.cal, calibrated but not rectified) for two SW filters (i.e., F115W and F200W) and derive the photometry in each one of them. The images for the other filters are also available and can be used to test the notebook and/or different filters combination.
           <br/>
           <strong>
            Tools:
           </strong>
           photutils.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec, NIRISS, MIRI.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <p>
           PSF Photometry can be obtained using:
          </p>
          <ul class="simple">
           <li>
            <p>
             single model obtained from WebbPSF
            </p>
           </li>
           <li>
            <p>
             grid of PSF models from WebbPSF
            </p>
           </li>
           <li>
            <p>
             single effective PSF (ePSF)
            </p>
           </li>
          </ul>
          <section id="work-in-progress">
           <h2>
            Work in Progress:
            <a class="headerlink" href="#work-in-progress" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              create a grid of ePSF and perform reduction using the ePSF grid
             </p>
            </li>
            <li>
             <p>
              use the ePSF grid to perturbate the WebbPSF model
             </p>
            </li>
           </ul>
           <p>
            The notebook shows:
           </p>
           <ul class="simple">
            <li>
             <p>
              how to obtain the PSF model from WebbPSF (or build an ePSF)
             </p>
            </li>
            <li>
             <p>
              how to perform PSF photometry on the image
             </p>
            </li>
            <li>
             <p>
              how to cross-match the catalogs of the different images
             </p>
            </li>
            <li>
             <p>
              how to derive and apply photometric zeropoint
             </p>
            </li>
           </ul>
           <p>
            Final plots show:
           </p>
           <ul class="simple">
            <li>
             <p>
              Instrumental Color-Magnitude Diagrams for the 4 images
             </p>
            </li>
            <li>
             <p>
              Instrumental Color-Magnitude Diagrams and errors
             </p>
            </li>
            <li>
             <p>
              Magnitudes Zeropoints
             </p>
            </li>
            <li>
             <p>
              Calibrated Color-Magnitude Diagram (compared with Input Color-Magnitude Diagram)
             </p>
            </li>
            <li>
             <p>
              Comparison between input and output photometry
             </p>
            </li>
           </ul>
           <p>
            <strong>
             Note on pysynphot
            </strong>
            : Data files for pysynphot are distributed separately by Calibration Reference Data System. They are expected to follow a certain directory structure under the root directory, identified by the PYSYN_CDBS environment variable that must be set prior to using this package. In the example below, the root directory is arbitrarily named /my/local/dir/trds/.
            <br/>
            export PYSYN_CDBS=/my/local/dir/trds/
            <br/>
            See documentation
            <a class="reference external" href="https://pysynphot.readthedocs.io/en/latest/#installation-and-setup">
             here
            </a>
            for the configuration and download of the data files.
           </p>
          </section>
          <section id="data-download-functions">
           <h2>
            Data Download Functions
            <a class="headerlink" href="#data-download-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="c1"># Set environmental variables</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"WEBBPSF_PATH"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./webbpsf-data/webbpsf-data"</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"PYSYN_CDBS"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"./grp/redcat/trds/"</span>

<span class="c1"># WEBBPSF Data</span>
<span class="n">boxlink</span> <span class="o">=</span> <span class="s1">'https://stsci.box.com/shared/static/34o0keicz2iujyilg4uz617va46ks6u9.gz'</span>                                                           
<span class="n">boxfile</span> <span class="o">=</span> <span class="s1">'./webbpsf-data/webbpsf-data-1.0.0.tar.gz'</span>
<span class="n">synphot_url</span> <span class="o">=</span> <span class="s1">'http://ssb.stsci.edu/trds/tarfiles/synphot5.tar.gz'</span>
<span class="n">synphot_file</span> <span class="o">=</span> <span class="s1">'./synphot5.tar.gz'</span>

<span class="n">webbpsf_folder</span> <span class="o">=</span> <span class="s1">'./webbpsf-data'</span>
<span class="n">synphot_folder</span> <span class="o">=</span> <span class="s1">'./grp'</span>

<span class="c1"># Gather webbpsf files</span>
<span class="n">psfExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">psfExist</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">)</span>
    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span>
    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">webbpsf_folder</span><span class="p">)</span>

<span class="c1"># Gather synphot files</span>
<span class="n">synExist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">synExist</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">synphot_folder</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">synphot_url</span><span class="p">,</span> <span class="n">synphot_file</span><span class="p">)</span>
    <span class="n">gzf</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">synphot_file</span><span class="p">)</span>
    <span class="n">gzf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s1">'./'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="import-functions">
           <h2>
            Import Functions
            <a class="headerlink" href="#import-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">glob</span> <span class="k">as</span> <span class="nn">glob</span>

<span class="kn">import</span> <span class="nn">jwst</span>
<span class="kn">from</span> <span class="nn">jwst.datamodels</span> <span class="kn">import</span> <span class="n">ImageModel</span>

<span class="kn">import</span> <span class="nn">tarfile</span>

<span class="kn">import</span> <span class="nn">urllib.request</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ZScaleInterval</span><span class="p">,</span> <span class="n">SqrtStretch</span><span class="p">,</span> <span class="n">ImageNormalize</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">simple_norm</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">Cutout2D</span><span class="p">,</span> <span class="n">NDData</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">gaussian_sigma_to_fwhm</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">QTable</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.fitting</span> <span class="kn">import</span> <span class="n">LevMarLSQFitter</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">pixel_to_skycoord</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span>

<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">EPSFBuilder</span><span class="p">,</span> <span class="n">find_peaks</span><span class="p">,</span> <span class="n">CircularAnnulus</span>
<span class="kn">from</span> <span class="nn">photutils.detection</span> <span class="kn">import</span> <span class="n">DAOStarFinder</span><span class="p">,</span> <span class="n">IRAFStarFinder</span>
<span class="kn">from</span> <span class="nn">photutils.psf</span> <span class="kn">import</span> <span class="n">DAOGroup</span><span class="p">,</span> <span class="n">IntegratedGaussianPRF</span><span class="p">,</span> <span class="n">extract_stars</span><span class="p">,</span> <span class="n">IterativelySubtractedPSFPhotometry</span>
<span class="kn">from</span> <span class="nn">photutils.background</span> <span class="kn">import</span> <span class="n">MMMBackground</span><span class="p">,</span> <span class="n">MADStdBackgroundRMS</span>
<span class="kn">from</span> <span class="nn">photutils.centroids</span> <span class="kn">import</span> <span class="n">centroid_2dg</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">aperture_photometry</span>

<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span>

<span class="kn">import</span> <span class="nn">webbpsf</span>
<span class="kn">from</span> <span class="nn">webbpsf.utils</span> <span class="kn">import</span> <span class="n">to_griddedpsfmodel</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="import-plotting-functions">
           <h2>
            Import Plotting Functions
            <a class="headerlink" href="#import-plotting-functions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">style</span><span class="p">,</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.cmap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'viridis'</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.origin'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'lower'</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'axes.titlesize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'axes.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'xtick.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'ytick.labelsize'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">font1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'family'</span><span class="p">:</span> <span class="s1">'helvetica'</span><span class="p">,</span> <span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="s1">'12'</span><span class="p">}</span>
<span class="n">font2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'family'</span><span class="p">:</span> <span class="s1">'helvetica'</span><span class="p">,</span> <span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'weight'</span><span class="p">:</span> <span class="s1">'normal'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="s1">'20'</span><span class="p">}</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="load-the-images-and-create-some-useful-dictionaries">
           <h2>
            Load the images and create some useful dictionaries
            <a class="headerlink" href="#load-the-images-and-create-some-useful-dictionaries" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We load all the images and we create a dictionary that contains all of them, divided by detectors and filters. This is useful to check which detectors and filters are available and to decide if we want to perform the photometry on all of them or only on a subset (for example, only on the SW filters).
           </p>
           <p>
            We also create a dictionary with some useful parameters for the analysis. The dictionary contains the photometric zeropoints (from
            <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
             MIRAGE
            </a>
            configuration files) and the NIRCam point spread function (PSF) FWHM, from the
            <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions">
             NIRCam Point Spread Function
            </a>
            JDox page. The FWHM are calculated from the analysis of the expected NIRCam PSFs simulated with
            <a class="reference external" href="https://www.stsci.edu/jwst/science-planning/proposal-planning-toolbox/psf-simulation-tool">
             WebbPSF
            </a>
            .
           </p>
           <p>
            <strong>
             Note
            </strong>
            : this dictionary will be updated once the values for zeropoints and FWHM will be available for each detectors after commissioning.
           </p>
           <p>
            Hence, we have two dictionaries:
           </p>
           <ul class="simple">
            <li>
             <p>
              dictionary for the single Level-2 calibrated images
             </p>
            </li>
            <li>
             <p>
              dictionary with some other useful parameters
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_images</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'NRCA1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA5'</span><span class="p">:</span> <span class="p">{},</span>
               <span class="s1">'NRCB1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB5'</span><span class="p">:</span> <span class="p">{}}</span>

<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*cal*fits'</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading images"</span><span class="p">)</span>

    <span class="n">boxlink_images_lev2</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level2.tar.gz'</span>
    <span class="n">boxfile_images_lev2</span> <span class="o">=</span> <span class="s1">'./images_level2.tar.gz'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev2</span><span class="p">,</span> <span class="n">boxfile_images_lev2</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev2</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*cal.fits"</span><span class="p">)))</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*cal.fits"</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'DETECTOR'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCBLONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCB5'</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCALONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCA5'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>         
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>   

    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>

            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>   

    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'images'</span><span class="p">:</span> <span class="p">[</span><span class="n">image</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for SW channel:"</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for LW channel:"</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available SW Filters:"</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available LW Filters:"</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Downloading images
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Available Detectors for SW channel: ['NRCB1']
Available Detectors for LW channel: ['NRCB5']
Available SW Filters: ['F070W', 'F115W', 'F200W']
Available LW Filters: ['F277W', 'F356W', 'F444W']
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/tmp/ipykernel_4711/3061117394.py:48: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  wv = np.float(f[1:3])
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="s1">'F090W'</span><span class="p">,</span> <span class="s1">'F115W'</span><span class="p">,</span> <span class="s1">'F140M'</span><span class="p">,</span> <span class="s1">'F150W2'</span><span class="p">,</span> <span class="s1">'F150W'</span><span class="p">,</span> <span class="s1">'F162M'</span><span class="p">,</span> <span class="s1">'F164N'</span><span class="p">,</span> <span class="s1">'F182M'</span><span class="p">,</span>
           <span class="s1">'F187N'</span><span class="p">,</span> <span class="s1">'F200W'</span><span class="p">,</span> <span class="s1">'F210M'</span><span class="p">,</span> <span class="s1">'F212N'</span><span class="p">,</span> <span class="s1">'F250M'</span><span class="p">,</span> <span class="s1">'F277W'</span><span class="p">,</span> <span class="s1">'F300M'</span><span class="p">,</span> <span class="s1">'F322W2'</span><span class="p">,</span> <span class="s1">'F323N'</span><span class="p">,</span>
           <span class="s1">'F335M'</span><span class="p">,</span> <span class="s1">'F356W'</span><span class="p">,</span> <span class="s1">'F360M'</span><span class="p">,</span> <span class="s1">'F405N'</span><span class="p">,</span> <span class="s1">'F410M'</span><span class="p">,</span> <span class="s1">'F430M'</span><span class="p">,</span> <span class="s1">'F444W'</span><span class="p">,</span> <span class="s1">'F460M'</span><span class="p">,</span> <span class="s1">'F466N'</span><span class="p">,</span> <span class="s1">'F470N'</span><span class="p">,</span> <span class="s1">'F480M'</span><span class="p">]</span>

<span class="n">psf_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.987</span><span class="p">,</span> <span class="mf">1.103</span><span class="p">,</span> <span class="mf">1.298</span><span class="p">,</span> <span class="mf">1.553</span><span class="p">,</span> <span class="mf">1.628</span><span class="p">,</span> <span class="mf">1.770</span><span class="p">,</span> <span class="mf">1.801</span><span class="p">,</span> <span class="mf">1.494</span><span class="p">,</span> <span class="mf">1.990</span><span class="p">,</span> <span class="mf">2.060</span><span class="p">,</span> <span class="mf">2.141</span><span class="p">,</span> <span class="mf">2.304</span><span class="p">,</span> <span class="mf">2.341</span><span class="p">,</span> <span class="mf">1.340</span><span class="p">,</span>
            <span class="mf">1.444</span><span class="p">,</span> <span class="mf">1.585</span><span class="p">,</span> <span class="mf">1.547</span><span class="p">,</span> <span class="mf">1.711</span><span class="p">,</span> <span class="mf">1.760</span><span class="p">,</span> <span class="mf">1.830</span><span class="p">,</span> <span class="mf">1.901</span><span class="p">,</span> <span class="mf">2.165</span><span class="p">,</span> <span class="mf">2.179</span><span class="p">,</span> <span class="mf">2.300</span><span class="p">,</span> <span class="mf">2.302</span><span class="p">,</span> <span class="mf">2.459</span><span class="p">,</span> <span class="mf">2.507</span><span class="p">,</span> <span class="mf">2.535</span><span class="p">,</span> <span class="mf">2.574</span><span class="p">]</span>

<span class="n">zp_modA</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7977</span><span class="p">,</span> <span class="mf">25.9686</span><span class="p">,</span> <span class="mf">25.8419</span><span class="p">,</span> <span class="mf">24.8878</span><span class="p">,</span> <span class="mf">27.0048</span><span class="p">,</span> <span class="mf">25.6536</span><span class="p">,</span> <span class="mf">24.6957</span><span class="p">,</span> <span class="mf">22.3073</span><span class="p">,</span> <span class="mf">24.8258</span><span class="p">,</span> <span class="mf">22.1775</span><span class="p">,</span> <span class="mf">25.3677</span><span class="p">,</span> <span class="mf">24.3296</span><span class="p">,</span>
           <span class="mf">22.1036</span><span class="p">,</span> <span class="mf">22.7850</span><span class="p">,</span> <span class="mf">23.5964</span><span class="p">,</span> <span class="mf">24.8239</span><span class="p">,</span> <span class="mf">23.6452</span><span class="p">,</span> <span class="mf">25.3648</span><span class="p">,</span> <span class="mf">20.8604</span><span class="p">,</span> <span class="mf">23.5873</span><span class="p">,</span> <span class="mf">24.3778</span><span class="p">,</span> <span class="mf">23.4778</span><span class="p">,</span> <span class="mf">20.5588</span><span class="p">,</span>
           <span class="mf">23.2749</span><span class="p">,</span> <span class="mf">22.3584</span><span class="p">,</span> <span class="mf">23.9731</span><span class="p">,</span> <span class="mf">21.9502</span><span class="p">,</span> <span class="mf">20.0428</span><span class="p">,</span> <span class="mf">19.8869</span><span class="p">,</span> <span class="mf">21.9002</span><span class="p">]</span>

<span class="n">zp_modB</span> <span class="o">=</span> <span class="p">[</span><span class="mf">25.7568</span><span class="p">,</span> <span class="mf">25.9771</span><span class="p">,</span> <span class="mf">25.8041</span><span class="p">,</span> <span class="mf">24.8738</span><span class="p">,</span> <span class="mf">26.9821</span><span class="p">,</span> <span class="mf">25.6279</span><span class="p">,</span> <span class="mf">24.6767</span><span class="p">,</span> <span class="mf">22.2903</span><span class="p">,</span> <span class="mf">24.8042</span><span class="p">,</span> <span class="mf">22.1499</span><span class="p">,</span> <span class="mf">25.3391</span><span class="p">,</span> <span class="mf">24.2909</span><span class="p">,</span>
           <span class="mf">22.0574</span><span class="p">,</span> <span class="mf">22.7596</span><span class="p">,</span> <span class="mf">23.5011</span><span class="p">,</span> <span class="mf">24.6792</span><span class="p">,</span> <span class="mf">23.5769</span><span class="p">,</span> <span class="mf">25.3455</span><span class="p">,</span> <span class="mf">20.8631</span><span class="p">,</span> <span class="mf">23.4885</span><span class="p">,</span> <span class="mf">24.3883</span><span class="p">,</span> <span class="mf">23.4555</span><span class="p">,</span> <span class="mf">20.7007</span><span class="p">,</span>
           <span class="mf">23.2763</span><span class="p">,</span> <span class="mf">22.4677</span><span class="p">,</span> <span class="mf">24.1562</span><span class="p">,</span> <span class="mf">22.0422</span><span class="p">,</span> <span class="mf">20.1430</span><span class="p">,</span> <span class="mf">20.0173</span><span class="p">,</span> <span class="mf">22.4086</span><span class="p">]</span>

<span class="n">dict_utils</span> <span class="o">=</span> <span class="p">{</span><span class="n">filters</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">{</span><span class="s1">'psf fwhm'</span><span class="p">:</span> <span class="n">psf_fwhm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">'VegaMAG zp modA'</span><span class="p">:</span> <span class="n">zp_modA</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                           <span class="s1">'VegaMAG zp modB'</span><span class="p">:</span> <span class="n">zp_modB</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">))}</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="select-the-detectors-and-or-filters-for-the-analysis">
           <h2>
            Select the detectors and/or filters for the analysis
            <a class="headerlink" href="#select-the-detectors-and-or-filters-for-the-analysis" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            If we are interested only in some filters (and/or some detectors) in the analysis, as in this example, we can select the Level-2 calibrated images from the dictionary for those filters (detectors) and analyze only those images.
           </p>
           <p>
            In this particular example, we analyze images for filters
            <strong>
             F115W
            </strong>
            and
            <strong>
             F200W
            </strong>
            for the detector
            <strong>
             NRCB1
            </strong>
            .
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dets_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">]</span>  <span class="c1"># detector of interest in this example</span>
<span class="n">filts_short</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'F115W'</span><span class="p">,</span> <span class="s1">'F200W'</span><span class="p">]</span>  <span class="c1"># filters of interest in this example</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="display-the-images">
           <h2>
            Display the images
            <a class="headerlink" href="#display-the-images" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            To check that our images do not present artifacts and can be used in the analysis, we display them using an interactive cursor that allows to shuffle through the different images for each filter.
           </p>
           <section id="note-for-developers">
            <h3>
             Note for developers:
             <a class="headerlink" href="#note-for-developers" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             this is only a sketch of what I would like to show (I am not very familiar with ipywidgets). Would it be possible to show both filters at the same time, in a 2 window panel as in the static plot below? Or even better, have a widget control that allows to select the filters available and then use interact to cycle through the images?
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># cell for display images using ipywidgets</span>

<span class="k">def</span> <span class="nf">browse_images</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">view_image</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
        <span class="n">det</span> <span class="o">=</span> <span class="s1">'NRCB1'</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="s1">'F115W'</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">image</span><span class="p">])</span>

        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>   
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">interact</span><span class="p">(</span><span class="n">view_image</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">browse_images</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F115W'</span><span class="p">][</span><span class="s1">'images'</span><span class="p">])</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <script type="application/vnd.jupyter.widget-view+json">
               {"version_major": 2, "version_minor": 0, "model_id": "13570eb04f6b4d0a90da0263d8c5a711"}
              </script>
              <img align=center height=auto width=50% src="../../jdaviz_placeholder_new.png">
              </img align=center height=auto width=50%>
             </div>
            </div>
           </section>
           <section id="id1">
            <h3>
             Note for developers:
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Cell below should be removed once we finalize the interactive one above.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"X [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Y [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>findfont: Font family ['helvetica'] not found. Falling back to DejaVu Sans.
</pre>
               </div>
              </div>
              <img alt="../../_images/NIRCam_PSF_Photometry_Example_17_1.png" src="../../_images/NIRCam_PSF_Photometry_Example_17_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="create-the-psf-models">
           <h2>
            Create the PSF models
            <a class="headerlink" href="#create-the-psf-models" title="Permalink to this headline">
             #
            </a>
           </h2>
          </section>
          <section id="i-create-the-psf-model-using-webbpsf">
           <h2>
            I. Create the PSF model using WebbPSF
            <a class="headerlink" href="#i-create-the-psf-model-using-webbpsf" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We create a dictionary that contains the PSF created using WebbPSF for the detectors and filters selected above.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_psfs_webbpsf</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="n">dict_psfs_webbpsf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model grid'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model single'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            The function below allows to create a single PSF or a grid of PSFs and allows to save the PSF as a fits file. The model PSF are stored by default in the psf dictionary. For the grid of PSFs, users can select the number of PSFs to be created. The PSF can be created detector sampled or oversampled (the oversample can be changed inside the function).
           </p>
           <p>
            <strong>
             Note
            </strong>
            : The default source spectrum is, if
            <code class="docutils literal notranslate">
             <span class="pre">
              pysynphot
             </span>
            </code>
            is installed, a G2V star spectrum from Castelli &amp; Kurucz (2004). Without
            <code class="docutils literal notranslate">
             <span class="pre">
              pysynphot
             </span>
            </code>
            , the default is a simple flat spectrum such that the same number of photons are detected at each wavelength.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">def</span> <span class="nf">create_psf_model</span><span class="p">(</span><span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">nrc</span> <span class="o">=</span> <span class="n">webbpsf</span><span class="o">.</span><span class="n">NIRCam</span><span class="p">()</span>

    <span class="n">nrc</span><span class="o">.</span><span class="n">detector</span> <span class="o">=</span> <span class="n">det</span> 
    <span class="n">nrc</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">filt</span>

    <span class="n">src</span> <span class="o">=</span> <span class="n">webbpsf</span><span class="o">.</span><span class="n">specFromSpectralType</span><span class="p">(</span><span class="s1">'G5V'</span><span class="p">,</span> <span class="n">catalog</span><span class="o">=</span><span class="s1">'phoenix'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">detsampled</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating a detector sampled PSF"</span><span class="p">)</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="s1">'detector sampled'</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mi">21</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating a oversampled PSF"</span><span class="p">)</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="s1">'oversampled'</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Using a </span><span class="si">{field}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">fov</span><span class="p">),</span> <span class="s2">"px fov"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_grid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating a grid of PSF for filter </span><span class="si">{filt}</span><span class="s2"> and detector </span><span class="si">{det}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">num</span>

        <span class="k">if</span> <span class="n">save_psf</span><span class="p">:</span>

            <span class="n">outname</span> <span class="o">=</span> <span class="s2">"./PSF_</span><span class="si">%s</span><span class="s2">_samp4_G5V_fov</span><span class="si">%d</span><span class="s2">_npsfs</span><span class="si">%d</span><span class="s2">.fits"</span> <span class="o">%</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
            <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span>
                         <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">)</span>
            <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model grid'</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid_psf</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating a single PSF for filter </span><span class="si">{filt}</span><span class="s2"> and detector </span><span class="si">{det}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">save_psf</span><span class="p">:</span>
            <span class="n">outname</span> <span class="o">=</span> <span class="s2">"./PSF_</span><span class="si">%s</span><span class="s2">_samp4_G5V_fov</span><span class="si">%d</span><span class="s2">_npsfs</span><span class="si">%d</span><span class="s2">.fits"</span> <span class="o">%</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
            <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span>
                         <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outname</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">single_psf</span> <span class="o">=</span> <span class="n">nrc</span><span class="o">.</span><span class="n">psf_grid</span><span class="p">(</span><span class="n">num_psfs</span><span class="o">=</span><span class="n">num</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">all_detectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov</span><span class="p">,</span> <span class="n">use_detsampled_psf</span><span class="o">=</span><span class="n">detsampled</span><span class="p">)</span>
            <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model single'</span><span class="p">]</span> <span class="o">=</span> <span class="n">single_psf</span>

    <span class="k">return</span>        
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="single-psf-model">
            <h3>
             Single PSF model
             <a class="headerlink" href="#single-psf-model" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts_short</span><span class="p">:</span>
        <span class="n">create_psf_model</span><span class="p">(</span><span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: Failed to load Vega spectrum from ./grp/redcat/trds//calspec/alpha_lyr_stis_010.fits; Functionality involving Vega will be cripped: FileNotFoundError(2, 'No such file or directory') [stsynphot.spectrum]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating a oversampled PSF
Using a 11 px fov

Creating a single PSF for filter F115W and detector NRCB1


Running instrument: NIRCam, filter: F115W
  Running detector: NRCB1
    Position 1/1: (1023, 1023) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating a oversampled PSF
Using a 11 px fov

Creating a single PSF for filter F200W and detector NRCB1


Running instrument: NIRCam, filter: F200W
  Running detector: NRCB1
    Position 1/1: (1023, 1023) pixels
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="display-the-single-psf-models">
           <h2>
            Display the single PSF models
            <a class="headerlink" href="#display-the-single-psf-models" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model single'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">'log'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model single'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'X [px]'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Y [px]'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_26_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_26_0.png"/>
            </div>
           </div>
           <section id="psf-grid">
            <h3>
             PSF grid
             <a class="headerlink" href="#psf-grid" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filts_short</span><span class="p">:</span>
        <span class="n">create_psf_model</span><span class="p">(</span><span class="n">fov</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">create_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_psf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detsampled</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating a oversampled PSF
Using a 11 px fov

Creating a grid of PSF for filter F115W and detector NRCB1


Running instrument: NIRCam, filter: F115W
  Running detector: NRCB1
    Position 1/25: (0, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 2/25: (0, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 3/25: (0, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 4/25: (0, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 5/25: (0, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 6/25: (512, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 7/25: (512, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 8/25: (512, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 9/25: (512, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 10/25: (512, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 11/25: (1024, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 12/25: (1024, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 13/25: (1024, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 14/25: (1024, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 15/25: (1024, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 16/25: (1535, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 17/25: (1535, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 18/25: (1535, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 19/25: (1535, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 20/25: (1535, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 21/25: (2047, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 22/25: (2047, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 23/25: (2047, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 24/25: (2047, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 25/25: (2047, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating a oversampled PSF
Using a 11 px fov

Creating a grid of PSF for filter F200W and detector NRCB1


Running instrument: NIRCam, filter: F200W
  Running detector: NRCB1
    Position 1/25: (0, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 2/25: (0, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 3/25: (0, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 4/25: (0, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 5/25: (0, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 6/25: (512, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 7/25: (512, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 8/25: (512, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 9/25: (512, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 10/25: (512, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 11/25: (1024, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 12/25: (1024, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 13/25: (1024, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 14/25: (1024, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 15/25: (1024, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 16/25: (1535, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 17/25: (1535, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 18/25: (1535, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 19/25: (1535, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 20/25: (1535, 2047) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 21/25: (2047, 0) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 22/25: (2047, 512) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 23/25: (2047, 1024) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 24/25: (2047, 1535) pixels
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>    Position 25/25: (2047, 2047) pixels
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="display-the-psfs-grid">
           <h2>
            Display the PSFs grid
            <a class="headerlink" href="#display-the-psfs-grid" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We show for 1 filter (
            <strong>
             F115W
            </strong>
            ) the grid of PSFs and the difference from the mean
           </p>
           <section id="developer-note-currently-display-psf-grid-has-a-bug-which-has-been-fixed-but-will-not-merged-into-the-latest-webbpsf-release-until-after-commissioning-we-have-turned-off-this-cell-for-the-time-being">
            <h3>
             Developer Note: Currently, display_psf_grid has a bug which has been fixed, but will not merged into the latest WebbPSF release until after commissioning. We have turned off this cell for the time being.
             <a class="headerlink" href="#developer-note-currently-display-psf-grid-has-a-bug-which-has-been-fixed-but-will-not-merged-into-the-latest-webbpsf-release-until-after-commissioning-we-have-turned-off-this-cell-for-the-time-being" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             webbpsf.gridded_library.display_psf_grid(dict_psfs_webbpsf[dets_short[0]][filts_short[0]][‘psf model grid’],
zoom_in=False, figsize=(14, 14))
            </p>
           </section>
          </section>
          <section id="ii-create-the-psf-model-building-an-effective-psf-epsf">
           <h2>
            II. Create the PSF model building an Effective PSF (ePSF)
            <a class="headerlink" href="#ii-create-the-psf-model-building-an-effective-psf-epsf" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            More information on the PhotUtils Effective PSF can be found
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/epsf.html">
             here
            </a>
            .
           </p>
           <ul class="simple">
            <li>
             <p>
              Select the stars from the images we want to use for building the PSF. We use the
              <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html">
               DAOStarFinder
              </a>
              function to find bright stars in the images (setting a high detection threshold).
              <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.detection.DAOStarFinder.html#photutils.detection.DAOStarFinder">
               DAOStarFinder
              </a>
              detects stars in an image using the DAOFIND (
              <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1987PASP...99..191S/abstract">
               Stetson 1987
              </a>
              ) algorithm. DAOFIND searches images for local density maxima that have a peak amplitude greater than
              <code class="docutils literal notranslate">
               <span class="pre">
                threshold
               </span>
              </code>
              (approximately; threshold is applied to a convolved image) and have a size and shape similar to the defined 2D Gaussian kernel.
              <br/>
              <strong>
               Note
              </strong>
              : The threshold and the maximum distance to the closest neighbour depend on the user science case (i.e.; number of stars in the field of view, crowding, number of bright sources, minimum number of stars required to build the ePSF, etc.) and must be modified accordingly.
             </p>
            </li>
            <li>
             <p>
              Build the effective PSF (excluding objects for which the bounding box exceed the detector edge) using
              <a class="reference external" href="https://photutils.readthedocs.io/en/stable/api/photutils.psf.EPSFBuilder.html#photutils.psf.EPSFBuilder">
               EPSBuilder
              </a>
              function.
             </p>
            </li>
           </ul>
           <p>
            We create a dictionary that contains the effective PSF for the detectors and filters selected above.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_psfs_epsf</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="n">dict_psfs_epsf</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf grid'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf grid'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Note that the unit of the Level-2 and Level-3 Images from the pipeline is MJy/sr (hence a surface brightness). The actual unit of the image can be checked from the header keyword
            <strong>
             BUNIT
            </strong>
            . The scalar conversion constant is copied to the header keyword
            <strong>
             PHOTMJSR
            </strong>
            , which gives the conversion from DN/s to megaJy/steradian. For our analysis we revert back to DN/s.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">def</span> <span class="nf">find_stars_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Finding PSF stars on image </span><span class="si">{number}</span><span class="s2"> of filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/s for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">'BUNIT'</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">])</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf fwhm'</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"FWHM for the filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">psf_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stars</span>
    
    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Calculating closest neigbhour distance"</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">daofind_tot</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

        <span class="n">stars_tot</span> <span class="o">=</span> <span class="n">daofind_tot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">x_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">'xcentroid'</span><span class="p">]</span>
        <span class="n">y_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">'ycentroid'</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">[</span><span class="s1">'xcentroid'</span><span class="p">],</span> <span class="n">psf_stars</span><span class="p">[</span><span class="s1">'ycentroid'</span><span class="p">]):</span>

            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_tot</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_tot</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

        <span class="n">psf_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">psf_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">psf_stars</span> <span class="o">=</span> <span class="n">psf_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>

        <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf_stars</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"Minimum distance required:"</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">"px"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of isolated sources found in the image used to build ePSF for </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"-----------------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of sources used to build ePSF for </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"--------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># threshold level for the two filters (length must match number of filters analyzed)</span>
<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># minimum separation acceptable for ePSF stars from closest neighbour</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">find_stars_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed Time for finding stars:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Finding PSF stars on image 1 of filter F115W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F115W: 1306
--------------------------------------------

Finding PSF stars on image 2 of filter F115W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F115W: 1326
--------------------------------------------

Finding PSF stars on image 3 of filter F115W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F115W: 1309
--------------------------------------------

Finding PSF stars on image 4 of filter F115W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F115W: 1318
--------------------------------------------

Finding PSF stars on image 1 of filter F200W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F200W: 1277
--------------------------------------------

Finding PSF stars on image 2 of filter F200W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F200W: 1288
--------------------------------------------

Finding PSF stars on image 3 of filter F200W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F200W: 1293
--------------------------------------------

Finding PSF stars on image 4 of filter F200W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Number of sources used to build ePSF for F200W: 1279
--------------------------------------------

Elapsed Time for finding stars: 14.532359861999794
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="ii-build-effective-psf">
            <h3>
             II. Build Effective PSF
             <a class="headerlink" href="#ii-build-effective-psf" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">build_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">):</span>
    
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>
    
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>

    <span class="n">hsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">sizes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">hsize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">hsize</span><span class="p">)))</span>

    <span class="n">stars_tbl</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">stars_tbl</span><span class="p">[</span><span class="s1">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">data_bkgsub</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">data_bkgsub</span> <span class="o">-=</span> <span class="n">bkg</span>

    <span class="n">nddata</span> <span class="o">=</span> <span class="n">NDData</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_bkgsub</span><span class="p">)</span>
    <span class="n">stars</span> <span class="o">=</span> <span class="n">extract_stars</span><span class="p">(</span><span class="n">nddata</span><span class="p">,</span> <span class="n">stars_tbl</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sizes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Creating ePSF for image </span><span class="si">{number}</span><span class="s2"> of filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>

    <span class="n">epsf_builder</span> <span class="o">=</span> <span class="n">EPSFBuilder</span><span class="p">(</span><span class="n">oversampling</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">epsf</span><span class="p">,</span> <span class="n">fitted_stars</span> <span class="o">=</span> <span class="n">epsf_builder</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span>
    <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsf</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             <strong>
              Note
             </strong>
             : here we limit the maximum number of iterations to 3 (to limit it’s run time), but in practice one should use about 10 or more iterations.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">]</span>  <span class="c1"># size of the cutout (extract region) for each PSF star - must match number of filters analyzed</span>
<span class="n">oversample</span> <span class="o">=</span> <span class="mi">4</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">build_epsf</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Time to build the Effective PSF:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>                  
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 1 of filter F115W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 2 of filter F115W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1391.1452222702674, 738.6528545179536) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1391.1452222702674, 738.6528545179536) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 3 of filter F115W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 4 of filter F115W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 1 of filter F200W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (2024.6595128949493, 303.0634606219833) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1287.6965897101857, 184.05069022241696) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (2024.6595128949493, 303.0634606219833) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1385.8629191096552, 733.9023689687727) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (26.28681998392782, 926.502329891462) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1942.22627595253, 1446.329187981408) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1356.784671724015, 1694.7586247777103) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1913.8077309926325, 2036.2037553576909) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 2 of filter F200W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1254.1492594438082, 37.36030946861016) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (2013.6385349597467, 312.8287073252741) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (31.328240473813157, 933.8427167874119) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (271.31229935357635, 1692.692940981157) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1918.5810765216122, 2040.9913917136926) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 3 of filter F200W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (811.4408157764483, 595.3569805774516) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1366.832457458384, 231.94252230132415) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (1366.7211474267363, 232.75017017657123) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (2010.546703251338, 315.49457413370965) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (378.3662433269573, 577.7725833867047) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (811.4408157764483, 595.3569805774516) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (970.302703215343, 816.2065643151739) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1212.6856449739892, 1638.0975835397799) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Creating ePSF for image 4 of filter F200W, detector NRCB1
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (975.797203174936, 810.4555842259333) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1371.171562733183, 227.0223121999746) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (1371.785528170863, 227.05625295777764) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (2031.644886958731, 304.5138548940783) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (2015.8228181916807, 309.51198461545647) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (380.016666853446, 573.3389799191176) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (975.797203174936, 810.4555842259333) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
WARNING: The star at (1252.453767037233, 883.7576488769319) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1217.2253688737771, 1632.3908600513005) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Time to build the Effective PSF: 153.80947099100013
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The star at (1921.7713418151031, 2037.8678253585756) cannot be fit because its fitting region extends beyond the star cutout image. [photutils.psf.epsf]
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="display-the-epsfs">
           <h2>
            Display the ePSFs
            <a class="headerlink" href="#display-the-epsfs" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We display only 1 ePSF for each filter
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">norm_epsf</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">'log'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm_epsf</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_43_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_43_0.png"/>
            </div>
           </div>
          </section>
          <section id="work-in-progress-build-a-grid-of-effective-psf">
           <h2>
            Work in Progress - Build a grid of effective PSF
            <a class="headerlink" href="#work-in-progress-build-a-grid-of-effective-psf" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Two functions:
           </p>
           <ul class="simple">
            <li>
             <p>
              count PSF stars in the grid
             </p>
            </li>
            <li>
             <p>
              create a gridded ePSF
             </p>
            </li>
           </ul>
           <p>
            The purpose of the first function is to count how many good PSF stars are in each sub-region defined by the grid number N. The function should start from the number provided by the user and iterate until the minimum grid size 2x2. Depending on the number of PSF stars that the users want in each cell of the grid, they can choose the appropriate grid size or modify the threshold values for the stars detection, selected when creating the single ePSF (in the
            <strong>
             Finding stars
            </strong>
            cell above).
           </p>
           <p>
            The second function creates a grid of PSFs with EPSFBuilder. The function will return a a GriddedEPSFModel object containing a 3D array of N  ×  n  ×  n. The 3D array represents the N number of 2D n  ×  n ePSFs created. It should include a grid_xypos key which will state the position of the PSF on the detector for each of the PSFs. The order of the tuples in grid_xypos refers to the number the PSF is in the 3D array.
           </p>
           <section id="i-counting-psf-stars-in-each-region-of-the-grid">
            <h3>
             I. Counting PSF stars in each region of the grid
             <a class="headerlink" href="#i-counting-psf-stars-in-each-region-of-the-grid" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">count_PSFstars_grid</span><span class="p">(</span><span class="n">grid_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_numpsf</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>

    <span class="n">num_grid_calc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">grid_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">num_grid_calc</span> <span class="o">=</span> <span class="n">num_grid_calc</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">num_grid_calc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Calculating the number of PSF stars in a </span><span class="si">%d</span><span class="s2"> x </span><span class="si">%d</span><span class="s2"> grid:"</span> <span class="o">%</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">((</span><span class="n">data_sb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span><span class="p">)</span>
        <span class="n">y_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span> <span class="o">*</span> <span class="p">(</span><span class="n">num</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">points</span><span class="p">)</span>

        <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_center</span><span class="p">,</span> <span class="n">y_center</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'table psf stars'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'flux'</span><span class="p">]</span>

            <span class="n">half_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">lim1</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span> <span class="o">+</span> <span class="n">half_size</span>
            <span class="n">lim2</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span> <span class="o">-</span> <span class="n">half_size</span>
            <span class="n">lim3</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">points</span> <span class="o">+</span> <span class="n">half_size</span>
            <span class="n">lim4</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">points</span> <span class="o">-</span> <span class="n">half_size</span>

            <span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">lim1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">lim2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">lim3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">lim4</span><span class="p">)</span>

            <span class="c1"># if np.count_nonzero(test) &lt; min_numpsf:</span>
            <span class="c1"># raise ValueError("Not enough PSF stars in all the cells (&gt; %d): Decrease your grid size or the minimum number of PSF stars in each cell or change parameters in the finder" %(min_numpsf))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_numpsf</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Center Coordinates of grid cell </span><span class="si">%d</span><span class="s2"> are (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">) --- Not enough PSF stars in the cell (number of PSF stars &lt; </span><span class="si">%d</span><span class="s2">)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">min_numpsf</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Center Coordinate of grid cell </span><span class="si">%d</span><span class="s2"> are (</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">) --- Number of PSF stars:"</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>                
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">"Analyzing image </span><span class="si">{number}</span><span class="s2"> of filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2"> "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>

            <span class="n">count_PSFstars_grid</span><span class="p">(</span><span class="n">grid_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">min_numpsf</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Analyzing image 1 of filter F115W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 72
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 46
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 51
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 48
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 51
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 55
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 51
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 45
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 40
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 57
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 47
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 50
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 55
Center Coordinates of grid cell 1 are (1020, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 15 are (1020, 1836) --- Number of PSF stars: 43
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 50
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 44
Center Coordinates of grid cell 1 are (1428, 1020) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 47
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 50
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 45
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 50
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 54
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 44
Center Coordinate of grid cell 25 are (1836, 1836) --- Number of PSF stars: 40

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 122
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 73
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 70
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 90
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 84
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 75
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 84
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 81
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 77
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 87
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 59
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 75
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 75
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 64
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 76
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 67

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 186
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 129
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 149
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 132
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 151
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 132
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 132
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 118
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 126

Calculating the number of PSF stars in a 2 x 2 grid:
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 359
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 331
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 307
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 286

Analyzing image 2 of filter F115W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 74
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 50
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 45
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 48
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 59
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 53
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 43
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 62
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 50
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 55
Center Coordinate of grid cell 14 are (1020, 1428) --- Number of PSF stars: 42
Center Coordinate of grid cell 15 are (1020, 1836) --- Number of PSF stars: 42
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 55
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 43
Center Coordinates of grid cell 2 are (1428, 1020) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 47
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 50
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 41
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 47
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 60
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 44
Center Coordinates of grid cell 2 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 138
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 79
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 75
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 82
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 84
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 73
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 84
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 86
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 80
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 82
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 61
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 69
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 72
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 62
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 71
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 73

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 201
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 134
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 150
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 139
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 143
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 133
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 126
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 124
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 125

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 378
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 333
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 303
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 281

Analyzing image 3 of filter F115W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 73
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 50
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 47
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 45
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 46
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 57
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 47
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 58
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 46
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 52
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 56
Center Coordinate of grid cell 14 are (1020, 1428) --- Number of PSF stars: 44
Center Coordinates of grid cell 3 are (1020, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 48
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 41
Center Coordinates of grid cell 3 are (1428, 1020) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 51
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 53
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 43
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 52
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 46
Center Coordinates of grid cell 3 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 128
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 78
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 69
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 81
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 81
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 73
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 87
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 79
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 75
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 82
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 65
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 74
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 71
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 66
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 75
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 69

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 191
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 128
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 147
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 135
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 140
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 133
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 131
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 121
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 131

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 367
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 320
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 298
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 292

Analyzing image 4 of filter F115W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 66
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 46
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 48
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 48
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 51
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 59
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 52
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 47
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 44
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 63
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 47
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 50
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 56
Center Coordinate of grid cell 14 are (1020, 1428) --- Number of PSF stars: 41
Center Coordinate of grid cell 15 are (1020, 1836) --- Number of PSF stars: 41
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 54
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 45
Center Coordinate of grid cell 18 are (1428, 1020) --- Number of PSF stars: 41
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 50
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 50
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 42
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 51
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 55
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 42
Center Coordinates of grid cell 4 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 121
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 76
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 70
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 90
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 86
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 76
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 84
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 83
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 79
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 89
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 64
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 71
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 72
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 67
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 71
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 70

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 188
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 132
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 155
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 138
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 145
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 132
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 134
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 121
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 124

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 366
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 334
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 312
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 282

Analyzing image 1 of filter F200W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 81
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 45
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 46
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 65
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 46
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 43
Center Coordinates of grid cell 1 are (612, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 57
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 43
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 47
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 55
Center Coordinates of grid cell 1 are (1020, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinates of grid cell 1 are (1020, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 46
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 41
Center Coordinate of grid cell 18 are (1428, 1020) --- Number of PSF stars: 42
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 57
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 43
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 44
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 49
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 42
Center Coordinates of grid cell 1 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 149
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 79
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 65
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 81
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 75
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 68
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 80
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 77
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 71
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 89
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 58
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 71
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 72
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 56
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 70
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 69

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 211
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 121
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 142
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 127
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 145
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 123
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 123
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 108
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 128

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 376
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 308
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 291
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 278

Analyzing image 2 of filter F200W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 78
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 48
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 45
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 40
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 47
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 77
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 45
Center Coordinates of grid cell 2 are (612, 1020) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 43
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 61
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 47
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 48
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 56
Center Coordinates of grid cell 2 are (1020, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinates of grid cell 2 are (1020, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 49
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 42
Center Coordinate of grid cell 18 are (1428, 1020) --- Number of PSF stars: 42
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 47
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 51
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 40
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 47
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 53
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 41
Center Coordinates of grid cell 2 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 155
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 77
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 63
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 80
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 80
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 69
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 81
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 81
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 77
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 91
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 57
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 67
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 68
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 58
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 66
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 67

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 216
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 119
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 143
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 132
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 147
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 124
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 124
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 110
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 121

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 385
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 310
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 301
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 263

Analyzing image 3 of filter F200W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 76
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 52
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 41
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 45
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 46
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 69
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 43
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 44
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 45
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 55
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 47
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 51
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 54
Center Coordinates of grid cell 3 are (1020, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinates of grid cell 3 are (1020, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 47
Center Coordinates of grid cell 3 are (1428, 612) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 18 are (1428, 1020) --- Number of PSF stars: 42
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 55
Center Coordinate of grid cell 21 are (1836, 204) --- Number of PSF stars: 43
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 45
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 51
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 43
Center Coordinates of grid cell 3 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 156
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 76
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 66
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 79
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 76
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 69
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 82
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 74
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 73
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 88
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 57
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 70
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 70
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 61
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 69
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 71

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 218
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 115
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 145
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 132
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 146
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 123
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 125
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 113
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 127

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 383
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 305
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 296
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 275

Analyzing image 4 of filter F200W, detector NRCB1 

Calculating the number of PSF stars in a 5 x 5 grid:

Center Coordinate of grid cell 1 are (204, 204) --- Number of PSF stars: 73
Center Coordinate of grid cell 2 are (204, 612) --- Number of PSF stars: 47
Center Coordinate of grid cell 3 are (204, 1020) --- Number of PSF stars: 42
Center Coordinate of grid cell 4 are (204, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 5 are (204, 1836) --- Number of PSF stars: 49
Center Coordinate of grid cell 6 are (612, 204) --- Number of PSF stars: 73
Center Coordinate of grid cell 7 are (612, 612) --- Number of PSF stars: 45
Center Coordinate of grid cell 8 are (612, 1020) --- Number of PSF stars: 42
Center Coordinate of grid cell 9 are (612, 1428) --- Number of PSF stars: 42
Center Coordinate of grid cell 10 are (612, 1836) --- Number of PSF stars: 57
Center Coordinate of grid cell 11 are (1020, 204) --- Number of PSF stars: 45
Center Coordinate of grid cell 12 are (1020, 612) --- Number of PSF stars: 45
Center Coordinate of grid cell 13 are (1020, 1020) --- Number of PSF stars: 54
Center Coordinates of grid cell 4 are (1020, 1428) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinates of grid cell 4 are (1020, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 16 are (1428, 204) --- Number of PSF stars: 52
Center Coordinate of grid cell 17 are (1428, 612) --- Number of PSF stars: 41
Center Coordinate of grid cell 18 are (1428, 1020) --- Number of PSF stars: 45
Center Coordinate of grid cell 19 are (1428, 1428) --- Number of PSF stars: 46
Center Coordinate of grid cell 20 are (1428, 1836) --- Number of PSF stars: 51
Center Coordinates of grid cell 4 are (1836, 204) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)
Center Coordinate of grid cell 22 are (1836, 612) --- Number of PSF stars: 49
Center Coordinate of grid cell 23 are (1836, 1020) --- Number of PSF stars: 55
Center Coordinate of grid cell 24 are (1836, 1428) --- Number of PSF stars: 42
Center Coordinates of grid cell 4 are (1836, 1836) --- Not enough PSF stars in the cell (number of PSF stars &lt; 40)

Calculating the number of PSF stars in a 4 x 4 grid:

Center Coordinate of grid cell 1 are (256, 256) --- Number of PSF stars: 143
Center Coordinate of grid cell 2 are (256, 768) --- Number of PSF stars: 75
Center Coordinate of grid cell 3 are (256, 1280) --- Number of PSF stars: 64
Center Coordinate of grid cell 4 are (256, 1792) --- Number of PSF stars: 85
Center Coordinate of grid cell 5 are (768, 256) --- Number of PSF stars: 78
Center Coordinate of grid cell 6 are (768, 768) --- Number of PSF stars: 69
Center Coordinate of grid cell 7 are (768, 1280) --- Number of PSF stars: 80
Center Coordinate of grid cell 8 are (768, 1792) --- Number of PSF stars: 75
Center Coordinate of grid cell 9 are (1280, 256) --- Number of PSF stars: 76
Center Coordinate of grid cell 10 are (1280, 768) --- Number of PSF stars: 88
Center Coordinate of grid cell 11 are (1280, 1280) --- Number of PSF stars: 58
Center Coordinate of grid cell 12 are (1280, 1792) --- Number of PSF stars: 71
Center Coordinate of grid cell 13 are (1792, 256) --- Number of PSF stars: 68
Center Coordinate of grid cell 14 are (1792, 768) --- Number of PSF stars: 65
Center Coordinate of grid cell 15 are (1792, 1280) --- Number of PSF stars: 68
Center Coordinate of grid cell 16 are (1792, 1792) --- Number of PSF stars: 68

Calculating the number of PSF stars in a 3 x 3 grid:

Center Coordinate of grid cell 1 are (341, 341) --- Number of PSF stars: 206
Center Coordinate of grid cell 2 are (341, 1023) --- Number of PSF stars: 117
Center Coordinate of grid cell 3 are (341, 1705) --- Number of PSF stars: 148
Center Coordinate of grid cell 4 are (1023, 341) --- Number of PSF stars: 129
Center Coordinate of grid cell 5 are (1023, 1023) --- Number of PSF stars: 145
Center Coordinate of grid cell 6 are (1023, 1705) --- Number of PSF stars: 122
Center Coordinate of grid cell 7 are (1705, 341) --- Number of PSF stars: 125
Center Coordinate of grid cell 8 are (1705, 1023) --- Number of PSF stars: 116
Center Coordinate of grid cell 9 are (1705, 1705) --- Number of PSF stars: 121

Calculating the number of PSF stars in a 2 x 2 grid:

Center Coordinate of grid cell 1 are (512, 512) --- Number of PSF stars: 371
Center Coordinate of grid cell 2 are (512, 1536) --- Number of PSF stars: 311
Center Coordinate of grid cell 3 are (1536, 512) --- Number of PSF stars: 302
Center Coordinate of grid cell 4 are (1536, 1536) --- Number of PSF stars: 272
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="todo-create-a-grid-of-epsf">
           <h2>
            TODO - Create a grid of ePSF
            <a class="headerlink" href="#todo-create-a-grid-of-epsf" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Here goes the function that creates a grid of ePSF that can be saved in the epsf dictionary.
           </p>
          </section>
          <section id="todo-use-the-epsf-grid-to-perturbate-the-webbpsf-model">
           <h2>
            TODO - Use the ePSF grid to perturbate the WebbPSF model
            <a class="headerlink" href="#todo-use-the-epsf-grid-to-perturbate-the-webbpsf-model" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Here goes the function that create a grid of PSF models obtained perturbating the WebbPSF PSF models using the ePSF grid created above.
           </p>
          </section>
          <section id="perform-psf-photometry">
           <h2>
            Perform PSF photometry
            <a class="headerlink" href="#perform-psf-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We perform the PSF photometry on the images, saving by default the output catalogs and the residual images in the dictionary created below. It is also possible to save the output catalogs (pickles pandas object) and residual images (fits files) in the current directory using the parameters
            <code class="docutils literal notranslate">
             <span class="pre">
              save_output
             </span>
            </code>
            and
            <code class="docutils literal notranslate">
             <span class="pre">
              save_residuals
             </span>
            </code>
            .
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_phot</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="n">dict_phot</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'residual images'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'output photometry tables'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'residual images'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'output photometry tables'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            <strong>
             Note
            </strong>
            : since performing the PSF photometry on the images takes some time (for the 8 images in this example ~ 4 hours), to speed up the notebook, we use a high threshold in the finding algorithm (threshold ~ 2000) and we will use in the analyis below the catalogs obtained with a sigma threshold = 10 from a previous reduction run. To perform a meaningful data reduction, the user should modify the threshold accordingly.
           </p>
           <p>
            Here we use as PSF model the grid of WebbPSF PSFs, but the users can change the model and use the others available (i.e., single WebbPSF PSF, single ePSF) modifying the
            <code class="docutils literal notranslate">
             <span class="pre">
              psf
             </span>
            </code>
            parameter in the function.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">def</span> <span class="nf">psf_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">psf</span><span class="o">=</span><span class="s1">'grid_webbpsf'</span><span class="p">,</span> <span class="n">save_residuals</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>
    <span class="n">fitter</span> <span class="o">=</span> <span class="n">LevMarLSQFitter</span><span class="p">()</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'DETECTOR'</span><span class="p">]</span>
    <span class="n">prim_dith_pos</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'PATT_NUM'</span><span class="p">]</span>
    <span class="n">prim_dith_num</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'NUMDTHPT'</span><span class="p">]</span>
    <span class="n">subpx_dith_pos</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'SUBPXNUM'</span><span class="p">]</span>
    <span class="n">subpx_dith_num</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'SUBPXPNS'</span><span class="p">]</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/s for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">'BUNIT'</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Applying conversion to the data"</span><span class="p">)</span>
            
    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf fwhm'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"FWHM for the filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">)</span>
    
    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>
    
    <span class="n">daogroup</span> <span class="o">=</span> <span class="n">DAOGroup</span><span class="p">(</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">sigma_psf</span><span class="p">)</span>
    
    <span class="c1"># grid PSF</span>

    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">'grid_webbpsf'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Using as PSF model WebbPSF PSFs grid"</span><span class="p">)</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model grid'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># single psf:</span>

    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">'single_webbpsf'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Using as PSF model WebbPSF single PSF"</span><span class="p">)</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_webbpsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf model single'</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># epsf:</span>

    <span class="k">if</span> <span class="n">psf</span> <span class="o">==</span> <span class="s1">'single_epsf'</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Using as PSF model single ePSF"</span><span class="p">)</span>
        <span class="n">psf_model</span> <span class="o">=</span> <span class="n">dict_psfs_epsf</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'epsf single'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing the photometry on image </span><span class="si">{number}</span><span class="s2"> of filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>
            
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="n">phot</span> <span class="o">=</span> <span class="n">IterativelySubtractedPSFPhotometry</span><span class="p">(</span><span class="n">finder</span><span class="o">=</span><span class="n">daofind</span><span class="p">,</span> <span class="n">group_maker</span><span class="o">=</span><span class="n">daogroup</span><span class="p">,</span>
                                              <span class="n">bkg_estimator</span><span class="o">=</span><span class="n">mmm_bkg</span><span class="p">,</span> <span class="n">psf_model</span><span class="o">=</span><span class="n">psf_model</span><span class="p">,</span>
                                              <span class="n">fitter</span><span class="o">=</span><span class="n">LevMarLSQFitter</span><span class="p">(),</span>
                                              <span class="n">niters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fitshape</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">aperture_radius</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">phot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Time needed to perform photometry on image </span><span class="si">{number}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"</span><span class="si">%.2f</span><span class="s2">"</span> <span class="o">%</span> <span class="p">((</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span> <span class="s2">"hours"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of sources detected in image </span><span class="si">{number}</span><span class="s2"> for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        
    <span class="n">residual_image</span> <span class="o">=</span> <span class="n">phot</span><span class="o">.</span><span class="n">get_residual_image</span><span class="p">()</span>
                            
    <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'residual images'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual_image</span>
    <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'output photometry tables'</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="c1"># save the residual images as fits file:</span>

    <span class="k">if</span> <span class="n">save_residuals</span><span class="p">:</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">residual_image</span><span class="p">)</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu</span><span class="p">])</span>
        <span class="n">residual_outname</span> <span class="o">=</span> <span class="s1">'residual_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_webbPSF_gridPSF_</span><span class="si">%d</span><span class="s1">of</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">of</span><span class="si">%d</span><span class="s1">.fits'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">prim_dith_pos</span><span class="p">,</span> <span class="n">prim_dith_num</span><span class="p">,</span> <span class="n">subpx_dith_pos</span><span class="p">,</span> <span class="n">subpx_dith_num</span><span class="p">)</span>

        <span class="n">dir_output_phot</span> <span class="o">=</span> <span class="s1">'./'</span>

        <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_output_phot</span><span class="p">,</span> <span class="n">residual_outname</span><span class="p">))</span>

        <span class="n">outname</span> <span class="o">=</span> <span class="s1">'phot_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_webbPSF_gridPSF_level2_</span><span class="si">%d</span><span class="s1">of</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">of</span><span class="si">%d</span><span class="s1">.pkl'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="n">prim_dith_pos</span><span class="p">,</span> <span class="n">prim_dith_num</span><span class="p">,</span> <span class="n">subpx_dith_pos</span><span class="p">,</span> <span class="n">subpx_dith_num</span><span class="p">)</span>

    <span class="c1"># save the output photometry Tables</span>

    <span class="k">if</span> <span class="n">save_output</span><span class="p">:</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">tab</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_output_phot</span><span class="p">,</span> <span class="n">outname</span><span class="p">))</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">tic_tot</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]</span>  <span class="c1"># must match the number of filters analyzed</span>

<span class="k">if</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*residual*.fits'</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Deleting Residual images from directory"</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./residual*.fits'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>
            
            <span class="n">psf_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">th</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">psf</span><span class="o">=</span><span class="s1">'grid_webbpsf'</span><span class="p">,</span> <span class="n">save_residuals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

<span class="n">toc_tot</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Time elapsed to perform the photometry of the </span><span class="si">{number}</span><span class="s2"> images:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]))),</span> <span class="s2">"</span><span class="si">%.2f</span><span class="s2">"</span> <span class="o">%</span> <span class="p">((</span><span class="n">toc_tot</span> <span class="o">-</span> <span class="n">tic_tot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">),</span> <span class="s2">"hours"</span><span class="p">)</span>    
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
Applying conversion to the data
FWHM for the filter F115W: 1.298
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 1 of filter F115W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 1: 0.01 hours
Number of sources detected in image 1 for filter F115W: 555
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
Applying conversion to the data
FWHM for the filter F115W: 1.298
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 2 of filter F115W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 2: 0.01 hours
Number of sources detected in image 2 for filter F115W: 566
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
Applying conversion to the data
FWHM for the filter F115W: 1.298
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 3 of filter F115W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 3: 0.01 hours
Number of sources detected in image 3 for filter F115W: 586
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
Applying conversion to the data
FWHM for the filter F115W: 1.298
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 4 of filter F115W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 4: 0.01 hours
Number of sources detected in image 4 for filter F115W: 570
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
Applying conversion to the data
FWHM for the filter F200W: 2.141
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 1 of filter F200W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 1: 0.01 hours
Number of sources detected in image 1 for filter F200W: 411
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
Applying conversion to the data
FWHM for the filter F200W: 2.141
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 2 of filter F200W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 2: 0.01 hours
Number of sources detected in image 2 for filter F200W: 432
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
Applying conversion to the data
FWHM for the filter F200W: 2.141
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 3 of filter F200W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 3: 0.01 hours
Number of sources detected in image 3 for filter F200W: 427
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
Applying conversion to the data
FWHM for the filter F200W: 2.141
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Using as PSF model WebbPSF PSFs grid
Performing the photometry on image 4 of filter F200W, detector NRCB1
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Time needed to perform photometry on image 4: 0.01 hours
Number of sources detected in image 4 for filter F200W: 428
Time elapsed to perform the photometry of the 8 images: 0.09 hours
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="output-photometry-table">
           <h2>
            Output Photometry Table
            <a class="headerlink" href="#output-photometry-table" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="note-for-developer">
            <h3>
             Note for developer:
             <a class="headerlink" href="#note-for-developer" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             It would be really useful, if PhotUtils can provide some diagnostics to identify the quality of the photometry in the final catalog for each source (similarly to all the other PSF photometry programs available).
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">dict_phot</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F115W'</span><span class="p">][</span><span class="s1">'output photometry tables'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_html">
               <div>
                <i>
                 QTable length=555
                </i>
                <table class="table-striped table-bordered table-condensed" id="table139694395901216">
                 <thead>
                  <tr>
                   <th>
                    x_0
                   </th>
                   <th>
                    x_fit
                   </th>
                   <th>
                    y_0
                   </th>
                   <th>
                    y_fit
                   </th>
                   <th>
                    flux_0
                   </th>
                   <th>
                    flux_fit
                   </th>
                   <th>
                    id
                   </th>
                   <th>
                    group_id
                   </th>
                   <th>
                    flux_unc
                   </th>
                   <th>
                    x_0_unc
                   </th>
                   <th>
                    y_0_unc
                   </th>
                   <th>
                    iter_detected
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    int64
                   </th>
                   <th>
                    int64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    float64
                   </th>
                   <th>
                    int64
                   </th>
                  </tr>
                 </thead>
                 <tr>
                  <td>
                   319.4246272692402
                  </td>
                  <td>
                   319.614432609092
                  </td>
                  <td>
                   16.698703477762294
                  </td>
                  <td>
                   16.800449249833818
                  </td>
                  <td>
                   501.75719770521033
                  </td>
                  <td>
                   639.8321697911706
                  </td>
                  <td>
                   1
                  </td>
                  <td>
                   1
                  </td>
                  <td>
                   3.320980141607031
                  </td>
                  <td>
                   0.0042158557310491025
                  </td>
                  <td>
                   0.004723466179597204
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   239.0768721020347
                  </td>
                  <td>
                   239.06415408391143
                  </td>
                  <td>
                   21.592480836614882
                  </td>
                  <td>
                   21.41414253086782
                  </td>
                  <td>
                   343.6234934840883
                  </td>
                  <td>
                   435.7241323051302
                  </td>
                  <td>
                   2
                  </td>
                  <td>
                   2
                  </td>
                  <td>
                   2.7507372613619583
                  </td>
                  <td>
                   0.0066146440554844
                  </td>
                  <td>
                   0.005116731871655718
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   486.6367666857731
                  </td>
                  <td>
                   486.38990920579386
                  </td>
                  <td>
                   25.298505463617687
                  </td>
                  <td>
                   25.605558632158374
                  </td>
                  <td>
                   604.8881437343549
                  </td>
                  <td>
                   767.1292766886022
                  </td>
                  <td>
                   3
                  </td>
                  <td>
                   3
                  </td>
                  <td>
                   4.26936023459487
                  </td>
                  <td>
                   0.004327878110198047
                  </td>
                  <td>
                   0.004403692771710578
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1498.5839125909997
                  </td>
                  <td>
                   1498.365719035797
                  </td>
                  <td>
                   25.6631229240583
                  </td>
                  <td>
                   25.767535093427128
                  </td>
                  <td>
                   378.6377445720579
                  </td>
                  <td>
                   471.43106794003637
                  </td>
                  <td>
                   4
                  </td>
                  <td>
                   4
                  </td>
                  <td>
                   3.8848213130153946
                  </td>
                  <td>
                   0.006425460106237189
                  </td>
                  <td>
                   0.007276487319329457
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1772.2253846017907
                  </td>
                  <td>
                   1772.1719268323254
                  </td>
                  <td>
                   25.870632603225165
                  </td>
                  <td>
                   25.90373355911056
                  </td>
                  <td>
                   309.43207431013496
                  </td>
                  <td>
                   388.91158213171747
                  </td>
                  <td>
                   5
                  </td>
                  <td>
                   5
                  </td>
                  <td>
                   4.461046441901409
                  </td>
                  <td>
                   0.010011899089592081
                  </td>
                  <td>
                   0.011345607755247117
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1249.3889857168049
                  </td>
                  <td>
                   1249.5137062343383
                  </td>
                  <td>
                   33.16566789529202
                  </td>
                  <td>
                   33.61719739076291
                  </td>
                  <td>
                   5405.538619274992
                  </td>
                  <td>
                   3078.938783104911
                  </td>
                  <td>
                   6
                  </td>
                  <td>
                   6
                  </td>
                  <td>
                   14.909640537218833
                  </td>
                  <td>
                   0.011553779775221585
                  </td>
                  <td>
                   0.010356846669278063
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1969.249564486074
                  </td>
                  <td>
                   1969.1858683501841
                  </td>
                  <td>
                   33.29229202474314
                  </td>
                  <td>
                   33.58281460875994
                  </td>
                  <td>
                   867.9781668624267
                  </td>
                  <td>
                   1111.4098283229728
                  </td>
                  <td>
                   7
                  </td>
                  <td>
                   7
                  </td>
                  <td>
                   90.64468686029946
                  </td>
                  <td>
                   0.036993561206897146
                  </td>
                  <td>
                   0.029755176433758572
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1815.8771749851915
                  </td>
                  <td>
                   1815.8941205382537
                  </td>
                  <td>
                   39.23846442364802
                  </td>
                  <td>
                   39.28430808471541
                  </td>
                  <td>
                   2717.0411072916036
                  </td>
                  <td>
                   2666.8461101275393
                  </td>
                  <td>
                   8
                  </td>
                  <td>
                   8
                  </td>
                  <td>
                   3.432649350796222
                  </td>
                  <td>
                   0.004543898723236718
                  </td>
                  <td>
                   0.006080337754531596
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   524.6487414790004
                  </td>
                  <td>
                   524.3924351739768
                  </td>
                  <td>
                   47.0243260305926
                  </td>
                  <td>
                   47.05182493381155
                  </td>
                  <td>
                   472.5062413512691
                  </td>
                  <td>
                   591.3874391128787
                  </td>
                  <td>
                   9
                  </td>
                  <td>
                   9
                  </td>
                  <td>
                   36.96558207914641
                  </td>
                  <td>
                   0.023996624725600334
                  </td>
                  <td>
                   0.024593554757973715
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   283.71266676422766
                  </td>
                  <td>
                   283.6971715320774
                  </td>
                  <td>
                   51.77102830090859
                  </td>
                  <td>
                   51.773664228834555
                  </td>
                  <td>
                   1290.358437806277
                  </td>
                  <td>
                   1338.3757775257645
                  </td>
                  <td>
                   10
                  </td>
                  <td>
                   10
                  </td>
                  <td>
                   10.46206795129999
                  </td>
                  <td>
                   0.004620143414951862
                  </td>
                  <td>
                   0.004635962767410045
                  </td>
                  <td>
                   1
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1662.0784227181123
                  </td>
                  <td>
                   1661.7031980037675
                  </td>
                  <td>
                   1707.0680962395472
                  </td>
                  <td>
                   1705.7722356711897
                  </td>
                  <td>
                   -1028.1388861054534
                  </td>
                  <td>
                   -728.720319282499
                  </td>
                  <td>
                   31
                  </td>
                  <td>
                   24
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   632.0481580197213
                  </td>
                  <td>
                   633.3034746855895
                  </td>
                  <td>
                   1832.1091309936398
                  </td>
                  <td>
                   1832.2790211396712
                  </td>
                  <td>
                   -939.316915566727
                  </td>
                  <td>
                   -581.7585805180905
                  </td>
                  <td>
                   32
                  </td>
                  <td>
                   25
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   829.2835527234259
                  </td>
                  <td>
                   829.502014258833
                  </td>
                  <td>
                   1840.4717024078438
                  </td>
                  <td>
                   1840.2109180818131
                  </td>
                  <td>
                   491.48489633896986
                  </td>
                  <td>
                   498.1651917503661
                  </td>
                  <td>
                   33
                  </td>
                  <td>
                   26
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1953.188670819475
                  </td>
                  <td>
                   1953.7030392134025
                  </td>
                  <td>
                   1879.2076214294204
                  </td>
                  <td>
                   1878.9846850462613
                  </td>
                  <td>
                   785.0123245478006
                  </td>
                  <td>
                   814.7267880245073
                  </td>
                  <td>
                   34
                  </td>
                  <td>
                   27
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1803.0450422242557
                  </td>
                  <td>
                   1803.095580208553
                  </td>
                  <td>
                   1888.5964307997951
                  </td>
                  <td>
                   1889.052185488207
                  </td>
                  <td>
                   264.11587901377294
                  </td>
                  <td>
                   343.6584570045722
                  </td>
                  <td>
                   35
                  </td>
                  <td>
                   28
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   80.96610720572573
                  </td>
                  <td>
                   81.10557758068046
                  </td>
                  <td>
                   1947.0145813103545
                  </td>
                  <td>
                   1945.7564534137834
                  </td>
                  <td>
                   -965.9685418712497
                  </td>
                  <td>
                   -592.3847752708929
                  </td>
                  <td>
                   36
                  </td>
                  <td>
                   29
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   219.98598207746315
                  </td>
                  <td>
                   219.88946762810644
                  </td>
                  <td>
                   1947.0278130114093
                  </td>
                  <td>
                   1945.7251647028304
                  </td>
                  <td>
                   -705.7095102455148
                  </td>
                  <td>
                   -440.7544673442177
                  </td>
                  <td>
                   37
                  </td>
                  <td>
                   30
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   904.1745255971633
                  </td>
                  <td>
                   904.0606795582356
                  </td>
                  <td>
                   1981.5235153514277
                  </td>
                  <td>
                   1981.8314994803115
                  </td>
                  <td>
                   572.6413588150949
                  </td>
                  <td>
                   542.9774488568007
                  </td>
                  <td>
                   38
                  </td>
                  <td>
                   31
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1194.960763318125
                  </td>
                  <td>
                   1195.006193833526
                  </td>
                  <td>
                   1992.26818345456
                  </td>
                  <td>
                   1992.3975187436713
                  </td>
                  <td>
                   1601.6043576535567
                  </td>
                  <td>
                   1142.2233190106554
                  </td>
                  <td>
                   39
                  </td>
                  <td>
                   32
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                 <tr>
                  <td>
                   1911.263903967847
                  </td>
                  <td>
                   1911.6591659658268
                  </td>
                  <td>
                   2038.010069945047
                  </td>
                  <td>
                   2037.6251208638462
                  </td>
                  <td>
                   907.3328373002328
                  </td>
                  <td>
                   688.0135646782896
                  </td>
                  <td>
                   40
                  </td>
                  <td>
                   33
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   --
                  </td>
                  <td>
                   2
                  </td>
                 </tr>
                </table>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="display-subtracted-image">
           <h2>
            Display subtracted image
            <a class="headerlink" href="#display-subtracted-image" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            As an example, we show the comparison between one science image and the residual image after the data reduction for both filters. Note that the residual image is obtained from the photometry run in the cell above with a very high detection threshold.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"X [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Y [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">dict_phot</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'residual images'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"X [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Y [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_60_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_60_0.png"/>
            </div>
           </div>
          </section>
          <section id="part-ii-data-analysis">
           <h2>
            Part II - Data Analysis
            <a class="headerlink" href="#part-ii-data-analysis" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Note
            </strong>
            : here we use the reduction obtained using a grid of WebbPSF PSFs as PSF models. The users can perform the data analysis using different PSF models (single PSF model, PSF grid, etc.) and compare the results.
           </p>
          </section>
          <section id="load-tables-with-psf-photometry">
           <h2>
            Load Tables with PSF Photometry
            <a class="headerlink" href="#load-tables-with-psf-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*phot*gridPSF*.pkl'</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading Photometry Output"</span><span class="p">)</span>

    <span class="n">boxlink_cat_f115w</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/phot_cat_F115W.tar.gz'</span>
    <span class="n">boxfile_cat_f115w</span> <span class="o">=</span> <span class="s1">'./phot_cat_F115W.tar.gz'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_cat_f115w</span><span class="p">,</span> <span class="n">boxfile_cat_f115w</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_cat_f115w</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="n">boxlink_cat_f200w</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/phot_cat_F200W.tar.gz'</span>
    <span class="n">boxfile_cat_f200w</span> <span class="o">=</span> <span class="s1">'./phot_cat_F200W.tar.gz'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_cat_f200w</span><span class="p">,</span> <span class="n">boxfile_cat_f200w</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_cat_f200w</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="n">cat_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">phots_pkl_f115w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">'*F115W*gridPSF*.pkl'</span><span class="p">)))</span>
    <span class="n">phots_pkl_f200w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">'*F200W*gridPSF*.pkl'</span><span class="p">)))</span>                       

<span class="k">else</span><span class="p">:</span>

    <span class="n">cat_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">phots_pkl_f115w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">'*F115W*gridPSF*.pkl'</span><span class="p">)))</span>
    <span class="n">phots_pkl_f200w</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cat_dir</span><span class="p">,</span> <span class="s1">'*F200W*gridPSF*.pkl'</span><span class="p">)))</span>                      

<span class="n">results_f115w</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results_f200w</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">phot_pkl_f115w</span><span class="p">,</span> <span class="n">phot_pkl_f200w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">phots_pkl_f115w</span><span class="p">,</span> <span class="n">phots_pkl_f200w</span><span class="p">):</span>

    <span class="n">ph_f115w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">phot_pkl_f115w</span><span class="p">)</span>
    <span class="n">ph_f200w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">phot_pkl_f200w</span><span class="p">)</span>

    <span class="n">result_f115w</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">ph_f115w</span><span class="p">)</span>
    <span class="n">result_f200w</span> <span class="o">=</span> <span class="n">QTable</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">ph_f200w</span><span class="p">)</span>

    <span class="n">results_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_f115w</span><span class="p">)</span>
    <span class="n">results_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_f200w</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Downloading Photometry Output
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="transform-the-images-to-datamodel">
           <h2>
            Transform the images to DataModel
            <a class="headerlink" href="#transform-the-images-to-datamodel" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            In order to assign the WCS coordinate and hence cross-match the images, we need to transform the images to DataModel. The coordinates are assigned during the step
            <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/assign_wcs/main.html#using-the-wcs-interactively">
             assign_wcs
            </a>
            step in the JWST pipeline and allow us to cross-match the different catalogs obtained for each filter.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">images_f115w</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">images_f200w</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F115W'</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">image_f115w</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F115W'</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">images_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_f115w</span><span class="p">)</span>
        
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F200W'</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">image_f200w</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images</span><span class="p">[</span><span class="s1">'NRCB1'</span><span class="p">][</span><span class="s1">'F200W'</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">images_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_f200w</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="cross-match-the-catalogs-from-the-two-filters-for-the-4-images">
           <h2>
            Cross-match the catalogs from the two filters for the 4 images
            <a class="headerlink" href="#cross-match-the-catalogs-from-the-two-filters-for-the-4-images" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We cross-match the catalogs to obtain the single color-magnitude diagrams.
           </p>
           <p>
            Stars from the two filters are associated if the distance between the matches is &lt; 0.5 px.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">results_clean_f115w</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">results_clean_f200w</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">images_f115w</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">mask_f115w</span> <span class="o">=</span> <span class="p">((</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">result_clean_f115w</span> <span class="o">=</span> <span class="n">results_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask_f115w</span><span class="p">]</span>

    <span class="n">ra_f115w</span><span class="p">,</span> <span class="n">dec_f115w</span> <span class="o">=</span> <span class="n">images_f115w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">'x_fit'</span><span class="p">],</span> <span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">'y_fit'</span><span class="p">])</span>
    <span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_f115w</span><span class="p">,</span> <span class="n">dec_f115w</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>
    <span class="n">result_clean_f115w</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f115w</span>
    <span class="n">results_clean_f115w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_clean_f115w</span><span class="p">)</span>

    <span class="n">mask_f200w</span> <span class="o">=</span> <span class="p">((</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

    <span class="n">result_clean_f200w</span> <span class="o">=</span> <span class="n">results_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">mask_f200w</span><span class="p">]</span>

    <span class="n">ra_f200w</span><span class="p">,</span> <span class="n">dec_f200w</span> <span class="o">=</span> <span class="n">images_f200w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">'x_fit'</span><span class="p">],</span> <span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">'y_fit'</span><span class="p">])</span>
    <span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra_f200w</span><span class="p">,</span> <span class="n">dec_f200w</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>

    <span class="n">result_clean_f200w</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f200w</span>
    <span class="n">results_clean_f200w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_clean_f200w</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">max_sep</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span>

<span class="n">matches_phot_single</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filt1</span> <span class="o">=</span> <span class="s1">'F115W'</span>
<span class="n">filt2</span> <span class="o">=</span> <span class="s1">'F200W'</span>

<span class="k">for</span> <span class="n">res1</span><span class="p">,</span> <span class="n">res2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results_clean_f115w</span><span class="p">,</span> <span class="n">results_clean_f200w</span><span class="p">):</span>

    <span class="n">idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">],</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">])</span>

    <span class="n">sep_constraint</span> <span class="o">=</span> <span class="n">d2d</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="n">match_phot_single</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="n">x_0_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'x_0'</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">y_0_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'y_0'</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">x_fit_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'x_fit'</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">y_fit_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'y_fit'</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">mag_f115w</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">emag_f115w</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span> <span class="n">res1</span><span class="p">[</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">sep_constraint</span><span class="p">]</span>

    <span class="n">x_0_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'x_0'</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>
    <span class="n">y_0_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'y_0'</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>
    <span class="n">x_fit_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'x_fit'</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>
    <span class="n">y_fit_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'y_fit'</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>
    <span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="n">sep_constraint</span><span class="p">]</span>
    <span class="n">mag_f200w</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>
    <span class="n">emag_f200w</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span> <span class="n">res2</span><span class="p">[</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx</span><span class="p">[</span><span class="n">sep_constraint</span><span class="p">]]</span>

    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'x_0_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_0_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'y_0_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_0_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'x_fit_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_fit_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'y_fit_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_fit_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">emag_f115w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'x_0_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_0_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'y_0_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_0_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'x_fit_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_fit_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'y_fit_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_fit_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_f200w</span>
    <span class="n">match_phot_single</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">emag_f200w</span>

    <span class="n">matches_phot_single</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match_phot_single</span><span class="p">)</span>    
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="color-magnitude-diagrams-instrumental-magnitudes-for-the-4-images">
           <h2>
            Color-Magnitude Diagrams (Instrumental Magnitudes) for the 4 images
            <a class="headerlink" href="#color-magnitude-diagrams-instrumental-magnitudes-for-the-4-images" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches_phot_single</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
    <span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="n">f115w_single</span> <span class="o">=</span> <span class="n">matches_phot_single</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span>
    <span class="n">f200w_single</span> <span class="o">=</span> <span class="n">matches_phot_single</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_single</span> <span class="o">-</span> <span class="n">f200w_single</span><span class="p">,</span> <span class="n">f115w_single</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">8.65</span><span class="p">,</span> <span class="s2">"Image </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">j</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_71_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_71_0.png"/>
            </div>
           </div>
          </section>
          <section id="difference-in-retrieved-positions-in-pixels-between-daofind-an-psf-routine">
           <h2>
            Difference in retrieved positions (in pixels) between daofind an PSF routine
            <a class="headerlink" href="#difference-in-retrieved-positions-in-pixels-between-daofind-an-psf-routine" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We show the difference in the stars position derived from daofind and the psf fitting algorithm. We also show the difference
            <span class="math notranslate nohighlight">
             \(\Delta\)
            </span>
            X and
            <span class="math notranslate nohighlight">
             \(\Delta\)
            </span>
            Y as a function of the instrumental magnitudes.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">x_find_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'x_0'</span><span class="p">]</span>
<span class="n">y_find_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'y_0'</span><span class="p">]</span>

<span class="n">x_psf_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span>
<span class="n">y_psf_f115w</span> <span class="o">=</span> <span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span>

<span class="n">delta_x_f115w</span> <span class="o">=</span> <span class="n">x_find_f115w</span> <span class="o">-</span> <span class="n">x_psf_f115w</span>
<span class="n">delta_y_f115w</span> <span class="o">=</span> <span class="n">y_find_f115w</span> <span class="o">-</span> <span class="n">y_psf_f115w</span>

<span class="n">_</span><span class="p">,</span> <span class="n">d_x_f115w</span><span class="p">,</span> <span class="n">sigma_d_x_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_x_f115w</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">d_y_f115w</span><span class="p">,</span> <span class="n">sigma_d_y_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_y_f115w</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">delta_x_f115w</span><span class="p">,</span> <span class="n">delta_y_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$\Delta$ X (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Y (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">' $\Delta$ X = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d_x_f115w</span><span class="p">,</span> <span class="n">sigma_d_x_f115w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">' $\Delta$ Y = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d_y_f115w</span><span class="p">,</span> <span class="n">sigma_d_y_f115w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">x_find_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'x_0'</span><span class="p">]</span>
<span class="n">y_find_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'y_0'</span><span class="p">]</span>

<span class="n">x_psf_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'x_fit'</span><span class="p">]</span>
<span class="n">y_psf_f200w</span> <span class="o">=</span> <span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'y_fit'</span><span class="p">]</span>

<span class="n">delta_x_f200w</span> <span class="o">=</span> <span class="n">x_find_f200w</span> <span class="o">-</span> <span class="n">x_psf_f200w</span>
<span class="n">delta_y_f200w</span> <span class="o">=</span> <span class="n">y_find_f200w</span> <span class="o">-</span> <span class="n">y_psf_f200w</span>

<span class="n">_</span><span class="p">,</span> <span class="n">d_x_f200w</span><span class="p">,</span> <span class="n">sigma_d_x_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_x_f200w</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">d_y_f200w</span><span class="p">,</span> <span class="n">sigma_d_y_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">delta_y_f200w</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">delta_x_f200w</span><span class="p">,</span> <span class="n">delta_y_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="s1">' $\Delta$ X = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d_x_f200w</span><span class="p">,</span> <span class="n">sigma_d_x_f200w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s1">' $\Delta$ Y = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">d_y_f200w</span><span class="p">,</span> <span class="n">sigma_d_y_f200w</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$\Delta$ X (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Y (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_73_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_73_0.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">mag_inst_f115w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results_clean_f115w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">])</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f115w</span><span class="p">,</span> <span class="n">delta_x_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ X (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f115w</span><span class="p">,</span> <span class="n">delta_y_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Y (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">mag_inst_f200w</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">results_clean_f200w</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">])</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f200w</span><span class="p">,</span> <span class="n">delta_x_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ X (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag_inst_f200w</span><span class="p">,</span> <span class="n">delta_y_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Y (px)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_74_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_74_0.png"/>
            </div>
           </div>
          </section>
          <section id="cross-match-the-4-catalogs-for-each-filter">
           <h2>
            Cross-match the 4 catalogs for each filter
            <a class="headerlink" href="#cross-match-the-4-catalogs-for-each-filter" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            To obtain a final color-magnitude diagram, we need to cross-match all the catalogs for each filters and then cross-match the derived final catalogs.
           </p>
           <p>
            <strong>
             Note
            </strong>
            : this is the most conservative approach since we impose that a star must be found in all 4 catalogs.
           </p>
           <section id="id2">
            <h3>
             Note for developer:
             <a class="headerlink" href="#id2" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             I couldn’t find an easier way to write this function, where you need to match the first two catalogs, derive a sub-catalogs with only the matches and then iterate for all the other catalogs available. We should also think on how to create a function that allows to keep the stars also if they are available in X out of Y catalogs (i.e., if for some reasons, a measure is not available in 1 of the images, but the star is well measured in the other 3, it doesn’t make sense to discard the object).
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_cat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="s1">'</span><span class="si">%d</span><span class="s1">'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">idx_12</span><span class="p">,</span> <span class="n">d2d_12</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

    <span class="n">sep_constraint_12</span> <span class="o">=</span> <span class="n">d2d_12</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="n">matches_12</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">sep_constraint_12</span><span class="p">]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">sep_constraint_12</span><span class="p">]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span> 
                                                   <span class="n">table</span><span class="p">[</span><span class="n">num</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">sep_constraint_12</span><span class="p">]</span>

    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>
    <span class="n">matches_12</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span>
                                                       <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_12</span><span class="p">[</span><span class="n">sep_constraint_12</span><span class="p">]]</span>

    <span class="n">idx_123</span><span class="p">,</span> <span class="n">d2d_123</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">matches_12</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

    <span class="n">sep_constraint_123</span> <span class="o">=</span> <span class="n">d2d_123</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="n">matches_123</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_12</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_123</span><span class="p">]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>
    <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span>
                                                        <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_123</span><span class="p">[</span><span class="n">sep_constraint_123</span><span class="p">]]</span>

    <span class="n">idx_1234</span><span class="p">,</span> <span class="n">d2d_1234</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]],</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

    <span class="n">sep_constraint_1234</span> <span class="o">=</span> <span class="n">d2d_1234</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

    <span class="n">matches_1234</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">matches_123</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]][</span><span class="n">sep_constraint_1234</span><span class="p">]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'radec_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">][</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'mag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>
    <span class="n">matches_1234</span><span class="p">[</span><span class="s1">'emag_'</span> <span class="o">+</span> <span class="n">num_cat</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.086</span> <span class="o">*</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">'flux_unc'</span><span class="p">]</span> <span class="o">/</span>
                                                         <span class="n">table</span><span class="p">[</span><span class="n">num</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][</span><span class="s1">'flux_fit'</span><span class="p">]))[</span><span class="n">idx_1234</span><span class="p">[</span><span class="n">sep_constraint_1234</span><span class="p">]]</span>

    <span class="n">matches_1234</span>

    <span class="k">return</span> <span class="n">matches_1234</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">matches_f115w</span> <span class="o">=</span> <span class="n">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">results_clean_f115w</span><span class="p">)</span>
<span class="n">matches_f200w</span> <span class="o">=</span> <span class="n">crossmatch_filter</span><span class="p">(</span><span class="n">table</span><span class="o">=</span><span class="n">results_clean_f200w</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             For the final catalog, we assume that the magnitude is the mean of the 4 measures and the error on the magnitude is its standard deviation.
            </p>
            <p>
             To easily perform this arithmetic operation on the table, we convert the table to pandas dataframe.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">df_f115w</span> <span class="o">=</span> <span class="n">matches_f115w</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="n">df_f200w</span> <span class="o">=</span> <span class="n">matches_f200w</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>

<span class="n">df_f115w</span><span class="p">[</span><span class="s1">'RA_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'radec_1.ra'</span><span class="p">,</span> <span class="s1">'radec_2.ra'</span><span class="p">,</span> <span class="s1">'radec_3.ra'</span><span class="p">,</span> <span class="s1">'radec_4.ra'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">'e_RA_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'radec_1.ra'</span><span class="p">,</span> <span class="s1">'radec_2.ra'</span><span class="p">,</span> <span class="s1">'radec_3.ra'</span><span class="p">,</span> <span class="s1">'radec_4.ra'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">'Dec_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'radec_1.dec'</span><span class="p">,</span> <span class="s1">'radec_2.dec'</span><span class="p">,</span> <span class="s1">'radec_3.dec'</span><span class="p">,</span> <span class="s1">'radec_4.dec'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">'e_Dec_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'radec_1.dec'</span><span class="p">,</span> <span class="s1">'radec_2.dec'</span><span class="p">,</span> <span class="s1">'radec_3.dec'</span><span class="p">,</span> <span class="s1">'radec_4.dec'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'mag_1'</span><span class="p">,</span> <span class="s1">'mag_2'</span><span class="p">,</span> <span class="s1">'mag_3'</span><span class="p">,</span> <span class="s1">'mag_4'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f115w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f115w</span><span class="p">[[</span><span class="s1">'mag_1'</span><span class="p">,</span> <span class="s1">'mag_2'</span><span class="p">,</span> <span class="s1">'mag_3'</span><span class="p">,</span> <span class="s1">'mag_4'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">df_f200w</span><span class="p">[</span><span class="s1">'RA_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'radec_1.ra'</span><span class="p">,</span> <span class="s1">'radec_2.ra'</span><span class="p">,</span> <span class="s1">'radec_3.ra'</span><span class="p">,</span> <span class="s1">'radec_4.ra'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">'e_RA_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'radec_1.ra'</span><span class="p">,</span> <span class="s1">'radec_2.ra'</span><span class="p">,</span> <span class="s1">'radec_3.ra'</span><span class="p">,</span> <span class="s1">'radec_4.ra'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">'Dec_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'radec_1.dec'</span><span class="p">,</span> <span class="s1">'radec_2.dec'</span><span class="p">,</span> <span class="s1">'radec_3.dec'</span><span class="p">,</span> <span class="s1">'radec_4.dec'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">'e_Dec_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'radec_1.dec'</span><span class="p">,</span> <span class="s1">'radec_2.dec'</span><span class="p">,</span> <span class="s1">'radec_3.dec'</span><span class="p">,</span> <span class="s1">'radec_4.dec'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'mag_1'</span><span class="p">,</span> <span class="s1">'mag_2'</span><span class="p">,</span> <span class="s1">'mag_3'</span><span class="p">,</span> <span class="s1">'mag_4'</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_f200w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_f200w</span><span class="p">[[</span><span class="s1">'mag_1'</span><span class="p">,</span> <span class="s1">'mag_2'</span><span class="p">,</span> <span class="s1">'mag_3'</span><span class="p">,</span> <span class="s1">'mag_4'</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="final-color-magnitude-diagram-instrumental-magnitudes">
           <h2>
            Final Color-Magnitude Diagram (Instrumental Magnitudes)
            <a class="headerlink" href="#final-color-magnitude-diagram-instrumental-magnitudes" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst -'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">radec_f115w_inst</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="s1">'RA_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">df_f115w</span><span class="p">[</span><span class="s1">'Dec_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>
<span class="n">radec_f200w_inst</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="s1">'RA_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">df_f200w</span><span class="p">[</span><span class="s1">'Dec_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>

<span class="n">idx_inst</span><span class="p">,</span> <span class="n">d2d_inst</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_f115w_inst</span><span class="p">,</span> <span class="n">radec_f200w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_inst</span> <span class="o">=</span> <span class="n">d2d_inst</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f115w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">])</span>
<span class="n">ef115w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">sep_constraint_inst</span><span class="p">])</span>
<span class="n">radec_f115w</span> <span class="o">=</span> <span class="n">radec_f115w_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]</span>

<span class="n">f200w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]])</span>
<span class="n">ef200w_inst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]])</span>
<span class="n">radec_f200w</span> <span class="o">=</span> <span class="n">radec_f200w_inst</span><span class="p">[</span><span class="n">idx_inst</span><span class="p">[</span><span class="n">sep_constraint_inst</span><span class="p">]]</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_inst</span> <span class="o">-</span> <span class="n">f200w_inst</span><span class="p">,</span> <span class="n">f115w_inst</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\sigma$'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span> 
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">df_f115w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\sigma$'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">df_f200w</span><span class="p">[</span><span class="s1">'e'</span> <span class="o">+</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_81_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_81_0.png"/>
            </div>
           </div>
          </section>
          <section id="photometric-zeropoints">
           <h2>
            Photometric Zeropoints
            <a class="headerlink" href="#photometric-zeropoints" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            To obtain the final calibrated color-magnitude diagram, we need to calculate the photometric zeropoints. Hence we need to perform aperture photometry on the calibrated images (Level-3), apply the appropriate aperture correction for the finite aperture adopted (the values provided in the dictionary above are for an infinite aperture) and then compare it with the PSF photometry. Hence, we can summarize the steps as follows:
           </p>
           <ul class="simple">
            <li>
             <p>
              perform aperture photometry
             </p>
            </li>
            <li>
             <p>
              apply appropriate aperture correction
             </p>
            </li>
            <li>
             <p>
              apply tabulated zeropoint
             </p>
            </li>
            <li>
             <p>
              cross-match with psf photometry
             </p>
            </li>
           </ul>
          </section>
          <section id="load-the-calibrated-and-rectified-images-level-3-imaging-pipeline">
           <h2>
            Load the calibrated and rectified images (Level 3 imaging pipeline)
            <a class="headerlink" href="#load-the-calibrated-and-rectified-images-level-3-imaging-pipeline" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_images_combined</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'NRCA1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCA5'</span><span class="p">:</span> <span class="p">{},</span>
                        <span class="s1">'NRCB1'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB2'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB3'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB4'</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">'NRCB5'</span><span class="p">:</span> <span class="p">{}}</span>

<span class="n">dict_filter_short</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">dict_filter_long</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">ff_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">det_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ff_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detlist_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filtlist_long</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">'./*combined*fits'</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading images"</span><span class="p">)</span>

    <span class="n">boxlink_images_lev3</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/images_level3.tar.gz'</span>
    <span class="n">boxfile_images_lev3</span> <span class="o">=</span> <span class="s1">'./images_level3.tar.gz'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_images_lev3</span><span class="p">,</span> <span class="n">boxfile_images_lev3</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">boxfile_images_lev3</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">()</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">files_singles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*combined*fits"</span><span class="p">)))</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">images_dir</span> <span class="o">=</span> <span class="s1">'./'</span>
    <span class="n">files_singles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_dir</span><span class="p">,</span> <span class="s2">"*combined*fits"</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_singles</span><span class="p">:</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'FILTER'</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'DETECTOR'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCBLONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCB5'</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s1">'NRCALONG'</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="s1">'NRCA5'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span>

    <span class="n">wv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">wv</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">ff_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">ff_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">det_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

    <span class="n">detlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_short</span><span class="p">)))</span>
    <span class="n">detlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">det_long</span><span class="p">)))</span>

    <span class="n">unique_list_filters_short</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unique_list_filters_long</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_short</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_short</span><span class="p">:</span>

            <span class="n">dict_filter_short</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ff_long</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_list_filters_long</span><span class="p">:</span>
            <span class="n">dict_filter_long</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">d_s</span> <span class="ow">in</span> <span class="n">detlist_short</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d_s</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_short</span>

    <span class="k">for</span> <span class="n">d_l</span> <span class="ow">in</span> <span class="n">detlist_long</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_filter_long</span>

    <span class="n">filtlist_short</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_short</span><span class="p">)))</span>
    <span class="n">filtlist_long</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dict_filter_long</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'images'</span><span class="p">:</span> <span class="p">[</span><span class="n">file</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dict_images_combined</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for SW channel:"</span><span class="p">,</span> <span class="n">detlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available Detectors for LW channel:"</span><span class="p">,</span> <span class="n">detlist_long</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available SW Filters:"</span><span class="p">,</span> <span class="n">filtlist_short</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Available LW Filters:"</span><span class="p">,</span> <span class="n">filtlist_long</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Downloading images
</pre>
              </div>
             </div>
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>2022-08-08 16:08:36,553 - stpipe - WARNING - /tmp/ipykernel_4711/1516415332.py:48: DeprecationWarning: `np.float` is a deprecated alias for the builtin `float`. To silence this warning, use `float` by itself. Doing this will not modify any behavior and is safe. If you specifically wanted the numpy scalar type, use `np.float64` here.
Deprecated in NumPy 1.20; for more details and guidance: https://numpy.org/devdocs/release/1.20.0-notes.html#deprecations
  wv = np.float(f[1:3])
</pre>
              </div>
             </div>
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Available Detectors for SW channel: ['NRCB1']
Available Detectors for LW channel: ['NRCB5']
Available SW Filters: ['F070W', 'F115W', 'F200W']
Available LW Filters: ['F277W', 'F356W', 'F444W']
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="id3">
           <h2>
            Display the images
            <a class="headerlink" href="#id3" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filts_short</span><span class="p">),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="n">simple_norm</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="s1">'sqrt'</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mf">99.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"X [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Y [px]"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data_sb</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_86_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_86_0.png"/>
            </div>
           </div>
          </section>
          <section id="aperture-photometry">
           <h2>
            Aperture Photometry
            <a class="headerlink" href="#aperture-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            As we have done previously, we create a dictionary that contains the tables with the derived aperture photometry for each image.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">dict_aper</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>

    <span class="n">dict_aper</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="find-bright-isolated-stars">
            <h3>
             Find bright isolated stars
             <a class="headerlink" href="#find-bright-isolated-stars" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="s1">'NRCA1'</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">bkgrms</span> <span class="o">=</span> <span class="n">MADStdBackgroundRMS</span><span class="p">()</span>
    <span class="n">mmm_bkg</span> <span class="o">=</span> <span class="n">MMMBackground</span><span class="p">()</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"Selecting stars for aperture photometry on image </span><span class="si">{number}</span><span class="s2"> of filter </span><span class="si">{f}</span><span class="s2">, detector </span><span class="si">{d}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">det</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Conversion factor from </span><span class="si">{units}</span><span class="s2"> to DN/s for filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">imh</span><span class="p">[</span><span class="s1">'BUNIT'</span><span class="p">],</span> <span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">])</span>

    <span class="n">sigma_psf</span> <span class="o">=</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'psf fwhm'</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">"FWHM for the filter </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="n">sigma_psf</span><span class="p">,</span> <span class="s2">"px"</span><span class="p">)</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">bkgrms</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">bkg</span> <span class="o">=</span> <span class="n">mmm_bkg</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="n">th</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

    <span class="n">apcorr_stars</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">]</span> <span class="o">=</span> <span class="n">apcorr_stars</span>
    
    <span class="k">if</span> <span class="n">dist_sel</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Calculating closest neigbhour distance"</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">daofind_tot</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">10</span> <span class="o">*</span> <span class="n">std</span> <span class="o">+</span> <span class="n">bkg</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">sigma_psf</span><span class="p">,</span> <span class="n">roundhi</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">roundlo</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">sharplo</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span> <span class="n">sharphi</span><span class="o">=</span><span class="mf">1.40</span><span class="p">)</span>

        <span class="n">stars_tot</span> <span class="o">=</span> <span class="n">daofind_tot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">x_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">'xcentroid'</span><span class="p">]</span>
        <span class="n">y_tot</span> <span class="o">=</span> <span class="n">stars_tot</span><span class="p">[</span><span class="s1">'ycentroid'</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">'xcentroid'</span><span class="p">],</span> <span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">'ycentroid'</span><span class="p">]):</span>

            <span class="n">sep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_tot</span> <span class="o">-</span> <span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_tot</span> <span class="o">-</span> <span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dist</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

        <span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">mask_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">apcorr_stars</span><span class="p">[</span><span class="s1">'min distance'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">apcorr_stars</span> <span class="o">=</span> <span class="n">apcorr_stars</span><span class="p">[</span><span class="n">mask_dist</span><span class="p">]</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">]</span> <span class="o">=</span> <span class="n">apcorr_stars</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">"Minimum distance required:"</span><span class="p">,</span> <span class="n">min_sep</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s2">"px"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of bright isolated sources found in the image for </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"-----------------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Number of bright sources found in the image for </span><span class="si">{f}</span><span class="s2">:"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">filt</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">apcorr_stars</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"--------------------------------------------"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>    
    
    <span class="k">return</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="n">th</span> <span class="o">=</span> <span class="p">[</span><span class="mi">700</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>  <span class="c1"># threshold level for the two filters (length must match number of filters analyzed)</span>
<span class="n">min_sep</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>  <span class="c1"># minimum separation acceptable for zp stars from closest neighbour</span>


<span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">find_bright_stars</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">dist_sel</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Elapsed Time for finding stars for Aperture Photometry:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>            
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Selecting stars for aperture photometry on image 1 of filter F115W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F115W: 3.821892261505127
FWHM for the filter F115W: 1.298 px
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Number of bright sources found in the image for F115W: 1303
--------------------------------------------

Selecting stars for aperture photometry on image 1 of filter F200W, detector NRCB1
Conversion factor from MJy/sr to DN/s for filter F200W: 2.564082860946655
FWHM for the filter F200W: 2.141 px
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Number of bright sources found in the image for F200W: 1483
--------------------------------------------

Elapsed Time for finding stars for Aperture Photometry: 3.207331062999401
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             As a further way to obtain a good quality sample, we cross-match the catalogs from the two filters and retain only the stars in common
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">dets_short</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">filt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filts_short</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">]),</span> <span class="mi">1</span><span class="p">):</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

            <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">],</span>
                                     <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">])</span>
        
            <span class="n">radec</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>
            <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">idx_ap</span><span class="p">,</span> <span class="n">d2d_ap</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span>
                                          <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">])</span>

<span class="n">sep_constraint_ap</span> <span class="o">=</span> <span class="n">d2d_ap</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">matched_apcorr_f115w</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
<span class="n">matched_apcorr_f200w</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

<span class="n">matched_apcorr_f115w</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="n">sep_constraint_ap</span><span class="p">]</span>
<span class="n">matched_apcorr_f200w</span> <span class="o">=</span> <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'stars for ap phot'</span><span class="p">][</span><span class="n">idx_ap</span><span class="p">[</span><span class="n">sep_constraint_ap</span><span class="p">]]</span>

<span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_apcorr_f115w</span>
<span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_apcorr_f200w</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="load-aperture-correction-table">
            <h3>
             Load aperture correction table
             <a class="headerlink" href="#load-aperture-correction-table" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <strong>
              Note
             </strong>
             : these values are obtained from the study of the synthetic WebbPSF PSFs. They will be updated once we have in-flight measures.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">'./aperture_correction_table.txt'</span><span class="p">):</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading the aperture correction table"</span><span class="p">)</span>

    <span class="n">boxlink_apcorr_table</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/aperture_correction_table.txt'</span>
    <span class="n">boxfile_apcorr_table</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_apcorr_table</span><span class="p">,</span> <span class="n">boxfile_apcorr_table</span><span class="p">)</span>
    <span class="n">ap_tab</span> <span class="o">=</span> <span class="s1">'./aperture_correction_table.txt'</span>

<span class="n">aper_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ap_tab</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'\s+'</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">'filter'</span><span class="p">,</span> <span class="s1">'pupil'</span><span class="p">,</span> <span class="s1">'wave'</span><span class="p">,</span> <span class="s1">'r10'</span><span class="p">,</span> <span class="s1">'r20'</span><span class="p">,</span> <span class="s1">'r30'</span><span class="p">,</span> <span class="s1">'r40'</span><span class="p">,</span> <span class="s1">'r50'</span><span class="p">,</span> <span class="s1">'r60'</span><span class="p">,</span> <span class="s1">'r70'</span><span class="p">,</span> <span class="s1">'r80'</span><span class="p">,</span>
                                <span class="s1">'r85'</span><span class="p">,</span> <span class="s1">'r90'</span><span class="p">,</span> <span class="s1">'sky_flux_px'</span><span class="p">,</span> <span class="s1">'apcorr10'</span><span class="p">,</span> <span class="s1">'apcorr20'</span><span class="p">,</span> <span class="s1">'apcorr30'</span><span class="p">,</span> <span class="s1">'apcorr40'</span><span class="p">,</span>
                                <span class="s1">'apcorr50'</span><span class="p">,</span> <span class="s1">'apcorr60'</span><span class="p">,</span> <span class="s1">'apcorr70'</span><span class="p">,</span> <span class="s1">'apcorr80'</span><span class="p">,</span> <span class="s1">'apcorr85'</span><span class="p">,</span> <span class="s1">'apcorr90'</span><span class="p">,</span> <span class="s1">'sky_in'</span><span class="p">,</span>
                                <span class="s1">'sky_out'</span><span class="p">],</span> <span class="n">comment</span><span class="o">=</span><span class="s1">'#'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">26</span><span class="p">))</span>
<span class="n">aper_table</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Downloading the aperture correction table
</pre>
               </div>
              </div>
              <div class="output text_html">
               <div>
                <style scoped="">
                 .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
                </style>
                <table border="1" class="dataframe">
                 <thead>
                  <tr style="text-align: right;">
                   <th>
                   </th>
                   <th>
                    pupil
                   </th>
                   <th>
                    wave
                   </th>
                   <th>
                    r10
                   </th>
                   <th>
                    r20
                   </th>
                   <th>
                    r30
                   </th>
                   <th>
                    r40
                   </th>
                   <th>
                    r50
                   </th>
                   <th>
                    r60
                   </th>
                   <th>
                    r70
                   </th>
                   <th>
                    r80
                   </th>
                   <th>
                    ...
                   </th>
                   <th>
                    apcorr30
                   </th>
                   <th>
                    apcorr40
                   </th>
                   <th>
                    apcorr50
                   </th>
                   <th>
                    apcorr60
                   </th>
                   <th>
                    apcorr70
                   </th>
                   <th>
                    apcorr80
                   </th>
                   <th>
                    apcorr85
                   </th>
                   <th>
                    apcorr90
                   </th>
                   <th>
                    sky_in
                   </th>
                   <th>
                    sky_out
                   </th>
                  </tr>
                  <tr>
                   <th>
                    filter
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                   <th>
                   </th>
                  </tr>
                 </thead>
                 <tbody>
                  <tr>
                   <th>
                    F070W
                   </th>
                   <td>
                    CLEAR
                   </td>
                   <td>
                    70
                   </td>
                   <td>
                    0.451
                   </td>
                   <td>
                    0.869
                   </td>
                   <td>
                    1.263
                   </td>
                   <td>
                    1.648
                   </td>
                   <td>
                    2.191
                   </td>
                   <td>
                    3.266
                   </td>
                   <td>
                    5.176
                   </td>
                   <td>
                    7.292
                   </td>
                   <td>
                    ...
                   </td>
                   <td>
                    3.3651
                   </td>
                   <td>
                    2.5305
                   </td>
                   <td>
                    2.0347
                   </td>
                   <td>
                    1.7210
                   </td>
                   <td>
                    1.5328
                   </td>
                   <td>
                    1.4174
                   </td>
                   <td>
                    1.4174
                   </td>
                   <td>
                    1.5880
                   </td>
                   <td>
                    7.292
                   </td>
                   <td>
                    9.017
                   </td>
                  </tr>
                  <tr>
                   <th>
                    F090W
                   </th>
                   <td>
                    CLEAR
                   </td>
                   <td>
                    90
                   </td>
                   <td>
                    0.408
                   </td>
                   <td>
                    0.638
                   </td>
                   <td>
                    0.992
                   </td>
                   <td>
                    1.503
                   </td>
                   <td>
                    1.925
                   </td>
                   <td>
                    2.549
                   </td>
                   <td>
                    4.162
                   </td>
                   <td>
                    7.480
                   </td>
                   <td>
                    ...
                   </td>
                   <td>
                    3.3519
                   </td>
                   <td>
                    2.5241
                   </td>
                   <td>
                    2.0253
                   </td>
                   <td>
                    1.6977
                   </td>
                   <td>
                    1.4908
                   </td>
                   <td>
                    1.4173
                   </td>
                   <td>
                    1.4173
                   </td>
                   <td>
                    1.6016
                   </td>
                   <td>
                    7.480
                   </td>
                   <td>
                    9.251
                   </td>
                  </tr>
                  <tr>
                   <th>
                    F115W
                   </th>
                   <td>
                    CLEAR
                   </td>
                   <td>
                    115
                   </td>
                   <td>
                    0.374
                   </td>
                   <td>
                    0.571
                   </td>
                   <td>
                    0.778
                   </td>
                   <td>
                    1.036
                   </td>
                   <td>
                    1.768
                   </td>
                   <td>
                    2.324
                   </td>
                   <td>
                    3.287
                   </td>
                   <td>
                    6.829
                   </td>
                   <td>
                    ...
                   </td>
                   <td>
                    3.3404
                   </td>
                   <td>
                    2.5070
                   </td>
                   <td>
                    2.0131
                   </td>
                   <td>
                    1.6825
                   </td>
                   <td>
                    1.4520
                   </td>
                   <td>
                    1.3310
                   </td>
                   <td>
                    1.3310
                   </td>
                   <td>
                    1.3964
                   </td>
                   <td>
                    6.829
                   </td>
                   <td>
                    9.723
                   </td>
                  </tr>
                  <tr>
                   <th>
                    F140M
                   </th>
                   <td>
                    CLEAR
                   </td>
                   <td>
                    140
                   </td>
                   <td>
                    0.414
                   </td>
                   <td>
                    0.617
                   </td>
                   <td>
                    0.801
                   </td>
                   <td>
                    1.031
                   </td>
                   <td>
                    1.367
                   </td>
                   <td>
                    2.434
                   </td>
                   <td>
                    3.118
                   </td>
                   <td>
                    6.031
                   </td>
                   <td>
                    ...
                   </td>
                   <td>
                    3.3397
                   </td>
                   <td>
                    2.5060
                   </td>
                   <td>
                    2.0067
                   </td>
                   <td>
                    1.6815
                   </td>
                   <td>
                    1.4465
                   </td>
                   <td>
                    1.3029
                   </td>
                   <td>
                    1.3029
                   </td>
                   <td>
                    1.3794
                   </td>
                   <td>
                    6.031
                   </td>
                   <td>
                    9.608
                   </td>
                  </tr>
                  <tr>
                   <th>
                    F150W
                   </th>
                   <td>
                    CLEAR
                   </td>
                   <td>
                    150
                   </td>
                   <td>
                    0.431
                   </td>
                   <td>
                    0.639
                   </td>
                   <td>
                    0.826
                   </td>
                   <td>
                    1.065
                   </td>
                   <td>
                    1.360
                   </td>
                   <td>
                    2.476
                   </td>
                   <td>
                    3.199
                   </td>
                   <td>
                    6.082
                   </td>
                   <td>
                    ...
                   </td>
                   <td>
                    3.3405
                   </td>
                   <td>
                    2.5067
                   </td>
                   <td>
                    2.0070
                   </td>
                   <td>
                    1.6828
                   </td>
                   <td>
                    1.4485
                   </td>
                   <td>
                    1.3068
                   </td>
                   <td>
                    1.3068
                   </td>
                   <td>
                    1.4188
                   </td>
                   <td>
                    6.082
                   </td>
                   <td>
                    9.496
                   </td>
                  </tr>
                 </tbody>
                </table>
                <p>
                 5 rows × 25 columns
                </p>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="perform-aperture-photometry">
            <h3>
             Perform Aperture Photometry
             <a class="headerlink" href="#perform-aperture-photometry" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="k">def</span> <span class="nf">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="s1">'F070W'</span><span class="p">):</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r70'</span><span class="p">]]</span>

    <span class="n">ees</span> <span class="o">=</span> <span class="s1">'70'</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">ee_radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ees</span><span class="p">,</span> <span class="n">radii</span><span class="p">))</span>

    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">][</span><span class="s1">'xcentroid'</span><span class="p">],</span>
                              <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">][</span><span class="s1">'ycentroid'</span><span class="p">]))</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dict_images_combined</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'images'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_sb</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">imh</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data_sb</span> <span class="o">/</span> <span class="n">imh</span><span class="p">[</span><span class="s1">'PHOTMJSR'</span><span class="p">]</span>

    <span class="c1"># sky from the aperture correction table:</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"sky_in"</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r80'</span><span class="p">],</span> <span class="s2">"sky_out"</span><span class="p">:</span> <span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'r85'</span><span class="p">]}</span>

    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">table_aper</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ee</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="n">ee_radii</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"Performing aperture photometry for radius equivalent to EE = </span><span class="si">{0}% f</span><span class="s2">or filter </span><span class="si">{1}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">filt</span><span class="p">))</span>
        <span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">annulus_aperture</span> <span class="o">=</span> <span class="n">CircularAnnulus</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">"sky_in"</span><span class="p">],</span> <span class="n">r_out</span><span class="o">=</span><span class="n">sky</span><span class="p">[</span><span class="s2">"sky_out"</span><span class="p">])</span>
        <span class="n">annulus_mask</span> <span class="o">=</span> <span class="n">annulus_aperture</span><span class="o">.</span><span class="n">to_mask</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'center'</span><span class="p">)</span>

        <span class="n">bkg_median</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">annulus_mask</span><span class="p">:</span>
            <span class="n">annulus_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">annulus_data_1d</span> <span class="o">=</span> <span class="n">annulus_data</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">median_sigclip</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">annulus_data_1d</span><span class="p">)</span>
            <span class="n">bkg_median</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_sigclip</span><span class="p">)</span>
        <span class="n">bkg_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bkg_median</span><span class="p">)</span>

        <span class="n">phot</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'exact'</span><span class="p">)</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkg_median</span> <span class="o">*</span> <span class="n">aperture</span><span class="o">.</span><span class="n">area</span>
        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">]</span> <span class="o">-</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">]</span>

        <span class="n">apcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">aper_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'apcorr70'</span><span class="p">]]</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_corrected'</span><span class="p">]</span> <span class="o">=</span> <span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">]</span> <span class="o">*</span> <span class="n">apcorr</span>

        <span class="n">phot</span><span class="p">[</span><span class="s1">'mag_corrected'</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_corrected'</span><span class="p">])</span> <span class="o">+</span> <span class="n">dict_utils</span><span class="p">[</span><span class="n">filt</span><span class="p">][</span><span class="s1">'VegaMAG zp modB'</span><span class="p">]</span>

        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'annulus_median'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'annulus_median_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_bkg'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_bkg_ee_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_bkgsub'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_bkgsub_'</span> <span class="o">+</span> <span class="n">ee</span><span class="p">)</span>
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'aper_sum_corrected'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'aper_sum_corrected_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span> 
        <span class="n">table_aper</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">phot</span><span class="p">[</span><span class="s1">'mag_corrected'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'mag_corrected_'</span> <span class="o">+</span> <span class="n">filt</span><span class="p">)</span>

        <span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_aper</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Time Elapsed:"</span><span class="p">,</span> <span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="p">)</span>

    <span class="k">return</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt1</span><span class="p">)</span>
<span class="n">aperture_phot</span><span class="p">(</span><span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span> <span class="n">filt</span><span class="o">=</span><span class="n">filt2</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Performing aperture photometry for radius equivalent to EE = 70% for filter F115W
Time Elapsed: 0.11253217000012228
Performing aperture photometry for radius equivalent to EE = 70% for filter F200W
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Time Elapsed: 0.10422008800014737
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="derive-zeropoints">
            <h3>
             Derive Zeropoints
             <a class="headerlink" href="#derive-zeropoints" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zeropoint'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_zp_1</span><span class="p">,</span> <span class="n">d2d_zp_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span> <span class="n">radec_f115w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_zp_1</span> <span class="o">=</span> <span class="n">d2d_zp_1</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f115w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt1</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'mag_corrected_'</span> <span class="o">+</span> <span class="n">filt1</span><span class="p">][</span><span class="n">sep_constraint_zp_1</span><span class="p">])</span>
<span class="n">f115w_psf_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f115w</span><span class="p">[</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_zp_1</span><span class="p">[</span><span class="n">sep_constraint_zp_1</span><span class="p">]])</span>

<span class="n">diff_f115w</span> <span class="o">=</span> <span class="n">f115w_ap_matched</span> <span class="o">-</span> <span class="n">f115w_psf_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_psf_matched</span><span class="p">,</span> <span class="n">diff_f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_f115w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">' Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f115w</span><span class="p">,</span> <span class="n">zp_sigma_f115w</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
                
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zeropoint'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_zp_2</span><span class="p">,</span> <span class="n">d2d_zp_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'stars for ap phot matched'</span><span class="p">][</span><span class="s1">'radec'</span><span class="p">],</span> <span class="n">radec_f200w_inst</span><span class="p">)</span>

<span class="n">sep_constraint_zp_2</span> <span class="o">=</span> <span class="n">d2d_zp_2</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f200w_ap_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dict_aper</span><span class="p">[</span><span class="n">det</span><span class="p">][</span><span class="n">filt2</span><span class="p">][</span><span class="s1">'aperture phot table'</span><span class="p">][</span><span class="s1">'mag_corrected_'</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">][</span><span class="n">sep_constraint_zp_2</span><span class="p">])</span>
<span class="n">f200w_psf_matched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_f200w</span><span class="p">[</span><span class="n">filt2</span> <span class="o">+</span> <span class="s1">'_inst'</span><span class="p">][</span><span class="n">idx_zp_2</span><span class="p">[</span><span class="n">sep_constraint_zp_2</span><span class="p">]])</span>

<span class="n">diff_f200w</span> <span class="o">=</span> <span class="n">f200w_ap_matched</span> <span class="o">-</span> <span class="n">f200w_psf_matched</span>
<span class="n">_</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_psf_matched</span><span class="p">,</span> <span class="n">diff_f200w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_f200w</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">' Zeropoint = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">zp_f200w</span><span class="p">,</span> <span class="n">zp_sigma_f200w</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
                
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/NIRCam_PSF_Photometry_Example_102_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_102_0.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="import-input-photometry">
           <h2>
            Import input photometry
            <a class="headerlink" href="#import-input-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">'./pointsource.cat'</span><span class="p">):</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>

<span class="k">else</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"Downloading input pointsource catalog"</span><span class="p">)</span>

    <span class="n">boxlink_input_cat</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/stellar_photometry/pointsource.cat'</span>
    <span class="n">boxfile_input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">boxlink_input_cat</span><span class="p">,</span> <span class="n">boxfile_input_cat</span><span class="p">)</span>
    <span class="n">input_cat</span> <span class="o">=</span> <span class="s1">'./pointsource.cat'</span>

<span class="n">cat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_cat</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">'\s+'</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">,</span> <span class="s1">'dec_in'</span><span class="p">,</span> <span class="s1">'f070w_in'</span><span class="p">,</span> <span class="s1">'f115w_in'</span><span class="p">,</span>
                                                            <span class="s1">'f200w_in'</span><span class="p">,</span> <span class="s1">'f277w_in'</span><span class="p">,</span> <span class="s1">'f356w_in'</span><span class="p">,</span> <span class="s1">'f444w_in'</span><span class="p">],</span>
                  <span class="n">comment</span><span class="o">=</span><span class="s1">'#'</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">cat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Downloading input pointsource catalog
</pre>
              </div>
             </div>
             <div class="output text_html">
              <div>
               <style scoped="">
                .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
               </style>
               <table border="1" class="dataframe">
                <thead>
                 <tr style="text-align: right;">
                  <th>
                  </th>
                  <th>
                   ra_in
                  </th>
                  <th>
                   dec_in
                  </th>
                  <th>
                   f070w_in
                  </th>
                  <th>
                   f115w_in
                  </th>
                  <th>
                   f200w_in
                  </th>
                  <th>
                   f277w_in
                  </th>
                  <th>
                   f356w_in
                  </th>
                  <th>
                   f444w_in
                  </th>
                 </tr>
                </thead>
                <tbody>
                 <tr>
                  <th>
                   0
                  </th>
                  <td>
                   80.386396
                  </td>
                  <td>
                   -69.468909
                  </td>
                  <td>
                   21.34469
                  </td>
                  <td>
                   20.75333
                  </td>
                  <td>
                   20.25038
                  </td>
                  <td>
                   20.23116
                  </td>
                  <td>
                   20.20482
                  </td>
                  <td>
                   20.23520
                  </td>
                 </tr>
                 <tr>
                  <th>
                   1
                  </th>
                  <td>
                   80.385588
                  </td>
                  <td>
                   -69.469201
                  </td>
                  <td>
                   20.12613
                  </td>
                  <td>
                   19.33709
                  </td>
                  <td>
                   18.64676
                  </td>
                  <td>
                   18.63521
                  </td>
                  <td>
                   18.58796
                  </td>
                  <td>
                   18.64291
                  </td>
                 </tr>
                 <tr>
                  <th>
                   2
                  </th>
                  <td>
                   80.380365
                  </td>
                  <td>
                   -69.470930
                  </td>
                  <td>
                   21.52160
                  </td>
                  <td>
                   20.98518
                  </td>
                  <td>
                   20.53500
                  </td>
                  <td>
                   20.51410
                  </td>
                  <td>
                   20.49231
                  </td>
                  <td>
                   20.51610
                  </td>
                 </tr>
                 <tr>
                  <th>
                   3
                  </th>
                  <td>
                   80.388130
                  </td>
                  <td>
                   -69.468453
                  </td>
                  <td>
                   20.82162
                  </td>
                  <td>
                   20.06542
                  </td>
                  <td>
                   19.40552
                  </td>
                  <td>
                   19.39262
                  </td>
                  <td>
                   19.34927
                  </td>
                  <td>
                   19.40018
                  </td>
                 </tr>
                 <tr>
                  <th>
                   4
                  </th>
                  <td>
                   80.388936
                  </td>
                  <td>
                   -69.468196
                  </td>
                  <td>
                   21.47197
                  </td>
                  <td>
                   20.92519
                  </td>
                  <td>
                   20.46507
                  </td>
                  <td>
                   20.44447
                  </td>
                  <td>
                   20.42186
                  </td>
                  <td>
                   20.44687
                  </td>
                 </tr>
                </tbody>
               </table>
              </div>
             </div>
            </div>
           </div>
           <p>
            Extract from the input catalog the stars in the same region as the one analyzed
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">lim_ra_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
<span class="n">lim_ra_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
<span class="n">lim_dec_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
<span class="n">lim_dec_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>

<span class="n">cat_sel</span> <span class="o">=</span> <span class="n">cat</span><span class="p">[(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_ra_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_ra_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim_dec_min</span><span class="p">)</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lim_dec_max</span><span class="p">)]</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="calibrated-color-magnitude-diagram">
           <h2>
            Calibrated Color-Magnitude Diagram
            <a class="headerlink" href="#calibrated-color-magnitude-diagram" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">mag1_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f115w_in'</span><span class="p">])</span>
<span class="n">mag2_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f200w_in'</span><span class="p">])</span>
<span class="n">diff_in</span> <span class="o">=</span> <span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">1.75</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">15</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">mag1_in</span> <span class="o">-</span> <span class="n">mag2_in</span><span class="p">,</span> <span class="n">mag1_in</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">"Input"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">f115w</span> <span class="o">=</span> <span class="n">f115w_inst</span> <span class="o">+</span> <span class="n">zp_f115w</span> 
<span class="n">f200w</span> <span class="o">=</span> <span class="n">f200w_inst</span> <span class="o">+</span> <span class="n">zp_f200w</span>

<span class="n">maglim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">errs_mag</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">errs_col</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>

    <span class="n">mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">err_mag1</span> <span class="o">=</span> <span class="n">ef115w_inst</span><span class="p">[(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
    <span class="n">err_mag2</span> <span class="o">=</span> <span class="n">ef200w_inst</span><span class="p">[(</span><span class="n">f115w</span> <span class="o">&gt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f115w</span> <span class="o">&lt;</span> <span class="n">maglim</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
    <span class="n">err_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_mag1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">err_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">err_mag1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">err_mag2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">err_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">err_temp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">errs_mag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_mag</span><span class="p">)</span>                  
    <span class="n">errs_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err_col</span><span class="p">)</span>
    <span class="n">mags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>

<span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">maglim</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">mags</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errs_mag</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">errs_col</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
        
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w</span> <span class="o">-</span> <span class="n">f200w</span><span class="p">,</span> <span class="n">f115w</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">15.5</span><span class="p">,</span> <span class="s2">"Output"</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span> <span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_108_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_108_0.png"/>
            </div>
           </div>
          </section>
          <section id="comparison-between-input-and-output-photometry">
           <h2>
            Comparison between input and output photometry
            <a class="headerlink" href="#comparison-between-input-and-output-photometry" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Mag'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">radec_input</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">],</span> <span class="n">cat_sel</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">'deg'</span><span class="p">)</span>

<span class="n">idx_f115w_cfr</span><span class="p">,</span> <span class="n">d2d_f115w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">radec_f115w</span><span class="p">)</span>

<span class="n">sep_f115w_cfr</span> <span class="o">=</span> <span class="n">d2d_f115w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f115w_in'</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>
<span class="n">f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f115w</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>

<span class="n">diff_f115w_cfr</span> <span class="o">=</span> <span class="n">f115w_inp_cfr</span> <span class="o">-</span> <span class="n">f115w_psf_cfr</span>
<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mf">24.5</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f115w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f115w_psf_cfr</span><span class="p">,</span> <span class="n">diff_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt1</span> <span class="o">+</span> <span class="s1">' $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f115w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Mag'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">idx_f200w_cfr</span><span class="p">,</span> <span class="n">d2d_f200w_cfr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">radec_input</span><span class="p">,</span> <span class="n">radec_f200w</span><span class="p">)</span>

<span class="n">sep_f200w_cfr</span> <span class="o">=</span> <span class="n">d2d_f200w_cfr</span> <span class="o">&lt;</span> <span class="n">max_sep</span>

<span class="n">f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'f200w_in'</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>
<span class="n">f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f200w</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>

<span class="n">diff_f200w_cfr</span> <span class="o">=</span> <span class="n">f200w_inp_cfr</span> <span class="o">-</span> <span class="n">f200w_psf_cfr</span>
<span class="n">_</span><span class="p">,</span> <span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> 
<span class="n">ylim1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff_f200w_cfr</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">f200w_psf_cfr</span><span class="p">,</span> <span class="n">diff_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">filt2</span> <span class="o">+</span> <span class="s1">' $\Delta$ Mag = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diff_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diff_f200w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_110_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_110_0.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$\Delta$ RA (mas)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Dec (mas)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt1</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ra_f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>
<span class="n">ra_f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>

<span class="n">dec_f115w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">][</span><span class="n">sep_f115w_cfr</span><span class="p">])</span>
<span class="n">dec_f115w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f115w</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">idx_f115w_cfr</span><span class="p">[</span><span class="n">sep_f115w_cfr</span><span class="p">]])</span>

<span class="n">dec_rad_f115w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec_f115w_psf_cfr</span><span class="p">)</span>

<span class="n">diffra_f115w_cfr</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ra_f115w_inp_cfr</span> <span class="o">-</span> <span class="n">ra_f115w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad_f115w</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffra_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffra_f115w_cfr</span><span class="p">)</span>

<span class="n">diffdec_f115w_cfr</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dec_f115w_inp_cfr</span> <span class="o">-</span> <span class="n">dec_f115w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffdec_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f115w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffdec_f115w_cfr</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diffra_f115w_cfr</span><span class="p">,</span> <span class="n">diffdec_f115w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">1.50</span><span class="p">,</span> <span class="s1">' $\Delta$ RA (mas) = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diffra_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f115w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s1">' $\Delta$ Dec (mas) = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diffdec_f115w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f115w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">xlim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">xlim1</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">ylim0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
<span class="n">ylim1</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">filt2</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$\Delta$ RA (mas)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta$ Dec (mas)'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">ra_f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'ra_in'</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>
<span class="n">ra_f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f200w</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>

<span class="n">dec_f200w_inp_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_sel</span><span class="p">[</span><span class="s1">'dec_in'</span><span class="p">][</span><span class="n">sep_f200w_cfr</span><span class="p">])</span>
<span class="n">dec_f200w_psf_cfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">radec_f200w</span><span class="o">.</span><span class="n">dec</span><span class="p">[</span><span class="n">idx_f200w_cfr</span><span class="p">[</span><span class="n">sep_f200w_cfr</span><span class="p">]])</span>

<span class="n">dec_rad_f200w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dec_f200w_psf_cfr</span><span class="p">)</span>

<span class="n">diffra_f200w_cfr</span> <span class="o">=</span> <span class="p">((((</span><span class="n">ra_f200w_inp_cfr</span> <span class="o">-</span> <span class="n">ra_f200w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dec_rad_f200w</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffra_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffra_f200w_cfr</span><span class="p">)</span>

<span class="n">diffdec_f200w_cfr</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dec_f200w_inp_cfr</span> <span class="o">-</span> <span class="n">dec_f200w_psf_cfr</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">mas</span><span class="p">))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">med_diffdec_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f200w_cfr</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">diffdec_f200w_cfr</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">diffra_f200w_cfr</span><span class="p">,</span> <span class="n">diffdec_f200w_cfr</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ylim0</span><span class="p">,</span> <span class="n">ylim1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">xlim0</span><span class="p">,</span> <span class="n">xlim1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">'--'</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">1.50</span><span class="p">,</span> <span class="s1">' $\Delta$ RA (mas) = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diffra_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffra_f200w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xlim0</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim1</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s1">' $\Delta$ Dec (mas) = </span><span class="si">%5.3f</span><span class="s1"> $\pm$ </span><span class="si">%5.3f</span><span class="s1">'</span>
         <span class="o">%</span> <span class="p">(</span><span class="n">med_diffdec_f200w_cfr</span><span class="p">,</span> <span class="n">sig_diffdec_f200w_cfr</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font2</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/NIRCam_PSF_Photometry_Example_111_0.png" src="../../_images/NIRCam_PSF_Photometry_Example_111_0.png"/>
            </div>
           </div>
          </section>
          <section id="final-notes">
           <h2>
            Final notes
            <a class="headerlink" href="#final-notes" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This notebook provides a general overview on how to perform PSF photometry using the
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/">
             PhotUtils
            </a>
            package. The choice of the different parameters adopted in all the reduction steps as well as the choice of the PSF model depend on the specific user science case. Moreover, a detailed analysis that allow to provide recommendations on how to set those parameters and outline the differences in the output photometry when different PSF models are adopted (single vs PSF grid, number of PSFs in the grid, etc.) will be possible only when real data will be available after the instrument commissioning. In this context, we note that one of the selected ERS program (ERS 1334 - The Resolved Stellar Populations Early Release Science Program) will provide a fundamental test benchmark to explore how the different choices outlined above will impact the quality of the PSF photometry in a crowded stellar region.
           </p>
          </section>
          <section id="about-this-notebook">
           <h2>
            About this Notebook
            <a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Author
            </strong>
            : Matteo Correnti, JWST/NIRCam STScI Scientist II
            <br/>
            <strong>
             Updated on
            </strong>
            : 2021-01-15
           </p>
           <p>
            <a class="reference external" href="#top">
             Top of Page
            </a>
           </p>
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
          </section>
         </section>
