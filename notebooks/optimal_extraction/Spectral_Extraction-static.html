<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   MOS Optimal Spectral Extraction — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <script>
   window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}
  </script>
  <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../mos-spectroscopy/MOSspec_sv06_revised.html" rel="next" title="MOS Spectroscopy of Extragalactic Field"/>
  <link href="../ifu_optimal/ifu_optimal.html" rel="prev" title="IFU Optimal Spectral Extraction"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/optimal_extraction/Spectral_Extraction-static.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/optimal_extraction/Spectral_Extraction-static.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#defining-terms">
           Defining terms
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#imports">
           Imports
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#loading-data">
           Loading data
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#optimal-extraction-algorithm">
           Optimal Extraction algorithm
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#define-an-extraction-region">
             Define an extraction region
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-kernel-slice">
             Create kernel slice
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#define-the-extraction-kernel">
             Define the extraction kernel
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#select-a-psf-template">
               Select a PSF template
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#polynomial-background">
               Polynomial background
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-extraction-kernel">
             Fit extraction kernel
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#wavelength-varying-fwhm-skipped">
               Wavelength-varying FWHM (skipped)
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-geometric-distortion-skipped">
             Fit geometric distortion
             <em>
              (skipped)
             </em>
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#define-bins-for-trace-fitting">
               Define bins for trace fitting
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#fit-each-bin-with-a-modified-extraction-kernel">
               Fit each bin with a modified extraction kernel
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#fit-the-trace-centers-with-a-1d-polynomial">
               Fit the trace centers with a 1D polynomial
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#construct-final-1d-spectrum">
             Construct final 1D spectrum
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#create-a-variance-image">
               Create a variance image
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#generate-the-1d-spectrum">
           Generate the 1D spectrum
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#developer-note-we-will-not-use-datamodels-here-because-the-latest-packages-do-not-support-the-simulated-data-previously-created-for-this-notebook-the-data-set-will-have-to-be-updated-after-commissioning">
             Developer Note: We will not use datamodels here because the latest packages do not support the simulated data previously created for this notebook. The data set will have to be updated after commissioning.
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#appendix-a-batch-processing">
           Appendix A: Batch Processing
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             Define an extraction region
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id2">
             Create Kernel Slice
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-and-fit-the-extraction-kernel">
             Create and fit the extraction kernel
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#account-for-varying-fwhm">
             Account for varying FWHM
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-the-trace-centers">
             Fit the trace centers
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id3">
             Generate the 1D spectrum
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#convenience-functions">
             Convenience functions
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#iterate-over-the-desired-files">
             Iterate over the desired files
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#run-on-example-dataset">
             Run on example dataset
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#appendix-b-webbpsf">
           Appendix B: WebbPSF
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#instrument-properties">
             Instrument properties
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#monochromatic-psfs">
             Monochromatic PSFs
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#interpolation-methods">
             Interpolation Methods
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#full-trace-psf">
             Full trace PSF
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#resampling-the-trace">
             Resampling the trace
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#about-this-notebook">
           About this notebook
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         MOS Optimal Spectral Extraction
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#defining-terms">
              Defining terms
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#loading-data">
              Loading data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#optimal-extraction-algorithm">
              Optimal Extraction algorithm
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#define-an-extraction-region">
                Define an extraction region
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-kernel-slice">
                Create kernel slice
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#define-the-extraction-kernel">
                Define the extraction kernel
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#select-a-psf-template">
                  Select a PSF template
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#polynomial-background">
                  Polynomial background
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-extraction-kernel">
                Fit extraction kernel
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#wavelength-varying-fwhm-skipped">
                  Wavelength-varying FWHM (skipped)
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-geometric-distortion-skipped">
                Fit geometric distortion
                <em>
                 (skipped)
                </em>
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#define-bins-for-trace-fitting">
                  Define bins for trace fitting
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#fit-each-bin-with-a-modified-extraction-kernel">
                  Fit each bin with a modified extraction kernel
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#fit-the-trace-centers-with-a-1d-polynomial">
                  Fit the trace centers with a 1D polynomial
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#construct-final-1d-spectrum">
                Construct final 1D spectrum
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#create-a-variance-image">
                  Create a variance image
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#generate-the-1d-spectrum">
              Generate the 1D spectrum
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#developer-note-we-will-not-use-datamodels-here-because-the-latest-packages-do-not-support-the-simulated-data-previously-created-for-this-notebook-the-data-set-will-have-to-be-updated-after-commissioning">
                Developer Note: We will not use datamodels here because the latest packages do not support the simulated data previously created for this notebook. The data set will have to be updated after commissioning.
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#appendix-a-batch-processing">
              Appendix A: Batch Processing
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                Define an extraction region
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id2">
                Create Kernel Slice
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-and-fit-the-extraction-kernel">
                Create and fit the extraction kernel
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#account-for-varying-fwhm">
                Account for varying FWHM
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-the-trace-centers">
                Fit the trace centers
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id3">
                Generate the 1D spectrum
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#convenience-functions">
                Convenience functions
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#iterate-over-the-desired-files">
                Iterate over the desired files
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#run-on-example-dataset">
                Run on example dataset
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#appendix-b-webbpsf">
              Appendix B: WebbPSF
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#instrument-properties">
                Instrument properties
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#monochromatic-psfs">
                Monochromatic PSFs
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#interpolation-methods">
                Interpolation Methods
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#full-trace-psf">
                Full trace PSF
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#resampling-the-trace">
                Resampling the trace
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#about-this-notebook">
              About this notebook
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="mos-optimal-spectral-extraction">
          <h1>
           MOS Optimal Spectral Extraction
           <a class="headerlink" href="#mos-optimal-spectral-extraction" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            NOTE:
           </strong>
           This is a static version of the notebook for web rendering. The full, interactive version is available
           <a class="reference external" href="https://github.com/spacetelescope/dat_pyinthesky/blob/master/jdat_notebooks/optimal_extraction/Spectral%20Extraction.ipynb">
            here
           </a>
           .
          </p>
          <p>
           <strong>
            Use case:
           </strong>
           optimal spectral extraction; method by
           <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/abstract">
            Horne (1986)
           </a>
           .
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRSpec MOS data; point sources.
           <br/>
           <strong>
            Tools:
           </strong>
           jwst, webbpsf, matplotlib, scipy, custom functions.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           any spectrograph.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            The JWST pipeline produces 1-D and 2-D rectified spectra from combined exposures for each spectroscopic mode. Currently, the 1D products are produced using aperture extraction, with plans to implement optimal extraction via PSF-weighting or fitting. However, there are many situations in which the output will not necessarily be “optimal”, and fine-tuning the parameters will be needed to improve the results. This notebook is intended to provide a walkthrough of the optimal extraction procedure with example JWST data.
           </p>
          </section>
          <section id="defining-terms">
           <h2>
            Defining terms
            <a class="headerlink" href="#defining-terms" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Optimal extraction:
            </strong>
            a method of aperture extraction first defined in
            <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/">
             Horne (1986)
            </a>
            .
            <br/>
            <strong>
             S/N:
            </strong>
            Signal-to-noise ratio, a measure of how noisy a spectrum is.
            <br/>
            <strong>
             WCS:
            </strong>
            World Coordinate System, used for converting between different reference frames.
            <br/>
           </p>
          </section>
          <section id="imports">
           <h2>
            Imports
            <a class="headerlink" href="#imports" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We will be using the following libraries to perform optimal spectral extraction.
           </p>
           <ul class="simple">
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                glob
               </span>
               <span class="pre">
                glob
               </span>
              </code>
              for collecting filenames
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                numpy
               </span>
              </code>
              to handle array functions, as well as other various and sundry activities
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                jwst.datamodels
               </span>
               <span class="pre">
                ImageModel,
               </span>
               <span class="pre">
                MultiSpecModel
               </span>
              </code>
              for accessing the datamodels for our example data
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                astropy.io
               </span>
               <span class="pre">
                fits
               </span>
              </code>
              for low-level FITS file I/O
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                astropy.modeling
               </span>
               <span class="pre">
                models,
               </span>
               <span class="pre">
                fitting
               </span>
              </code>
              for the many fitting tasks
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                astropy.visualization
               </span>
               <span class="pre">
                astropy_mpl_style,
               </span>
               <span class="pre">
                simple_norm
               </span>
              </code>
              for displaying nice images
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                scipy.interpolate
               </span>
               <span class="pre">
                interp1d,
               </span>
               <span class="pre">
                RegularGridInterpolator
               </span>
              </code>
              for all our interpolation needs
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                matplotlib.pyplot
               </span>
              </code>
              for plotting data
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                matplotlib.patches
               </span>
               <span class="pre">
                Rectangle
               </span>
              </code>
              for plotting rectangles on our data
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                webbpsf
               </span>
               <span class="pre">
                NIRSpec
               </span>
              </code>
              to generate and visualize a PSF from the instrument model (see Appendix B)
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import os
import tarfile
import urllib.request

# Set environmental variables
os.environ["WEBBPSF_PATH"] = "./webbpsf-data/webbpsf-data"

# WEBBPSF Data
boxlink = 'https://stsci.box.com/shared/static/34o0keicz2iujyilg4uz617va46ks6u9.gz'                                                           
boxfile = './webbpsf-data/webbpsf-data-1.0.0.tar.gz'

webbpsf_folder = './webbpsf-data'

# Gather webbpsf files
psfExist = os.path.exists(webbpsf_folder)
if not psfExist:
    os.makedirs(webbpsf_folder)
    urllib.request.urlretrieve(boxlink, boxfile)
    gzf = tarfile.open(boxfile)
    gzf.extractall(webbpsf_folder)
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>%matplotlib inline
from glob import glob
import numpy as np
from jwst.datamodels import ImageModel, MultiSpecModel
from astropy.io import fits
from astropy.modeling import models, fitting
from astropy.visualization import astropy_mpl_style, simple_norm
from specutils import Spectrum1D
from scipy.interpolate import interp1d, RegularGridInterpolator
import matplotlib.pyplot as plt
from matplotlib.patches import Rectangle

plt.style.use(astropy_mpl_style) #use the style we imported for matplotlib displays
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="loading-data">
           <h2>
            Loading data
            <a class="headerlink" href="#loading-data" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We will be using simulated level 3 MOS data provided by James Muzerolle. These files come from a simulated visit with many point sources, and we will begin with the products of the
            <code class="docutils literal notranslate">
             <span class="pre">
              resample
             </span>
            </code>
            step, which have the file extension
            <code class="docutils literal notranslate">
             <span class="pre">
              s2d.fits
             </span>
            </code>
            . We will also compare the results of our optimal extraction with the products of the
            <code class="docutils literal notranslate">
             <span class="pre">
              extract1d
             </span>
            </code>
            step, with the
            <code class="docutils literal notranslate">
             <span class="pre">
              x1d.fits
             </span>
            </code>
            extension. See
            <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/stable/jwst/data_products/product_types.html#stage-3-data-products">
             the science data products specification
            </a>
            and links therein for details on structure and format of these files.
           </p>
           <p>
            The optimal extraction procedure laid out below can be repeated for each
            <code class="docutils literal notranslate">
             <span class="pre">
              'SCI'
             </span>
            </code>
            extension in each
            <code class="docutils literal notranslate">
             <span class="pre">
              s2d
             </span>
            </code>
            file. For the purposes of this notebook, we will assume that the
            <code class="docutils literal notranslate">
             <span class="pre">
              resample
             </span>
            </code>
            step has produced optimal output, so those are the only extensions we need to access. (Rectifying and combining the input spectra is a complicated process on its own, and is far beyond the scope of this notebook!)
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import os
# If the example dataset has already been downloaded, comment out these lines:
import zipfile
import urllib.request
boxlink = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/optimal_extraction/optimal_extraction.zip'
boxfile = './optimal_extraction.zip'
urllib.request.urlretrieve(boxlink, boxfile)
zf = zipfile.ZipFile(boxfile, 'r')
zf.extractall()
# ...to here

example_file = 'F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30263_'
s2d_file = os.path.join('s2d_files', example_file+'s2d.fits')
x1d_file = os.path.join('x1d_files', example_file+'x1d.fits')
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>data_model = ImageModel(s2d_file)
resampled_2d_image = data_model.data # if multiple SCI extensions, also specify EXTVER
weights_2d_image = data_model.wht # we will use this to estimate the per-pixel variance later

image_shape = resampled_2d_image.shape
print(image_shape) #note the swap of x and y
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>(25, 1298)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            When we want to view 2d spectra, we’ll generally need to stretch the pixels vertically to get a useful image. We can do this by setting the plot aspect ratio explicitly (we’ll try to retain a measure of rectangularity).
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>norm = simple_norm(resampled_2d_image, stretch='power')
aspect_ratio = image_shape[1] / (2 * image_shape[0])
fig1 = plt.figure() # we save these in dummy variables to avoid spurious Jupyter Notebook output
img1 = plt.imshow(resampled_2d_image, cmap='gray', aspect=aspect_ratio, 
                  norm=norm, interpolation='none')
clb1 = plt.colorbar()
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/Spectral_Extraction-static_10_0.png" src="../../_images/Spectral_Extraction-static_10_0.png"/>
            </div>
           </div>
          </section>
          <hr class="docutils"/>
          <section id="optimal-extraction-algorithm">
           <h2>
            Optimal Extraction algorithm
            <a class="headerlink" href="#optimal-extraction-algorithm" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Here is an outline of the steps we’ll be following:
           </p>
           <ol class="simple">
            <li>
             <p>
              <a class="reference external" href="#Define-an-extraction-region">
               Define an extraction region on the 2D image
              </a>
             </p>
            </li>
            <li>
             <p>
              <a class="reference external" href="#Create-kernel-slice">
               Identify a high S/N cross-dispersion (binned &amp; coadded) slice to use for the initial kernel fit
              </a>
             </p>
            </li>
            <li>
             <p>
              <a class="reference external" href="#Define-the-extraction-kernel">
               Define the extraction kernel
              </a>
             </p>
             <ol class="simple">
              <li>
               <p>
                Single or composite PSF
               </p>
              </li>
              <li>
               <p>
                Polynomial fit to background
               </p>
              </li>
             </ol>
            </li>
            <li>
             <p>
              <a class="reference external" href="#Fit-extraction-kernel">
               Fit extraction kernel to initial slice
              </a>
             </p>
            </li>
            <li>
             <p>
              <em>
               <strong>
                Skipped:
               </strong>
              </em>
              <a class="reference external" href="#Fit-geometric-distortion-(skipped)">
               <em>
                Fit geometric distortion
               </em>
              </a>
             </p>
             <ol class="simple">
              <li>
               <p>
                <em>
                 Determine cross-dispersion bins for trace fitting
                </em>
               </p>
              </li>
              <li>
               <p>
                <em>
                 First-pass fit of kernel to each bin to find trace center
                </em>
               </p>
              </li>
              <li>
               <p>
                <em>
                 Polynomial fit of trace centers
                </em>
               </p>
              </li>
             </ol>
            </li>
            <li>
             <p>
              <a class="reference external" href="#Construct-final-1D-spectrum">
               Combine composite model (kernel | trace) with 2D image to create output 1D spectrum
              </a>
             </p>
            </li>
            <li>
             <p>
              Compare output spectrum with catalog photometry for flux calibration (not sure how to do this yet)
             </p>
            </li>
           </ol>
           <p>
            Appendices:
           </p>
           <ul class="simple">
            <li>
             <p>
              <a class="reference external" href="#Appendix-A:-Batch-Processing">
               Appendix A: Batch Processing
              </a>
             </p>
            </li>
            <li>
             <p>
              <a class="reference external" href="#Appendix-B:-WebbPSF">
               Appendix B: WebbPSF
              </a>
             </p>
            </li>
           </ul>
           <p>
            <em>
             Developer Note:
            </em>
           </p>
           <p>
            This sort of functionality is desired by many, and as of yet, no general-purpose optimal extraction Python packages exist. While this notebook can provide optimal extraction for 2D resampled JWST pipeline products, and could be adapted for use with other data, it is a far cry from a widely-applicable, maintained and updated spectral extraction codebase. It would be very nice if such a thing existed…!
           </p>
           <section id="define-an-extraction-region">
            <h3>
             Define an extraction region
             <a class="headerlink" href="#define-an-extraction-region" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We begin by identifying the region in the 2D resampled image which contains the spectral trace we want to extract. For a simple case with only a single source, we can theoretically use the entire image. However, we may still want to exclude large systematic fluctuations in the background which might complicate the fit, or part of the trace with essentially no signal which will make fitting the trace centers difficult. In addition, when working with background nod-subtracted data, the images will contain negative traces, which we will want to exclude.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig2 = plt.figure(figsize=(9,9)) # we want the largest figure that will fit in the notebook
img2 = plt.imshow(resampled_2d_image, cmap='gray', aspect=aspect_ratio, 
                  norm=norm, interpolation='none') # reuse norm from earlier

# create region box and slider
region_x = region_y = 0
region_h, region_w = image_shape
region_rectangle = Rectangle((region_x, region_y), region_w, region_h, 
                             facecolor='none', edgecolor='b', linestyle='--')
current_axis = plt.gca()
rect_patch = current_axis.add_patch(region_rectangle)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/Spectral_Extraction-static_17_0.png" src="../../_images/Spectral_Extraction-static_17_0.png"/>
             </div>
            </div>
            <p>
             We’ll set the region coordinates to
             <code class="docutils literal notranslate">
              <span class="pre">
               x1=51,
              </span>
              <span class="pre">
               y1=3,
              </span>
              <span class="pre">
               x2=1268,
              </span>
              <span class="pre">
               y2=9
              </span>
             </code>
             , then create a new array containing only our extraction region (so that we don’t need to continually index our original array).
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>x1, x2 = 51, 1268
y1, y2 = 3, 9

er_y, er_x = np.mgrid[y1:y2+1, x1:x2+1]
extraction_region = resampled_2d_image[er_y, er_x]
weights_region = weights_2d_image[er_y, er_x]
er_ny, er_nx = extraction_region.shape

aspect_ratio = er_nx / (3. * er_ny)

er_norm = simple_norm(extraction_region, stretch='power')
fig3 = plt.figure()
img3 = plt.imshow(extraction_region, cmap='gray', aspect=aspect_ratio, 
                  norm=er_norm, interpolation='none')
clb3 = plt.colorbar()
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/Spectral_Extraction-static_19_0.png" src="../../_images/Spectral_Extraction-static_19_0.png"/>
             </div>
            </div>
           </section>
           <section id="create-kernel-slice">
            <h3>
             Create kernel slice
             <a class="headerlink" href="#create-kernel-slice" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We now define a cross-dispersion slice of our extraction region with which to fit our initial extraction kernel. As an initial guess, we’ll coadd the 30 columns centered on the middle of the trace.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>slice_width = 30
initial_column = er_nx // 2

def kernel_slice_coadd(width, column_idx):
    """
    Coadd a number of columns (= width) of the extraction region,
    centered on column_idx.
    """
    
    half_width = width // 2
    to_coadd = np.arange(max(0, column_idx - half_width), 
                         min(er_nx-1, column_idx + half_width))
    return extraction_region[:, to_coadd].sum(axis=1) / width

slice_0 = kernel_slice_coadd(slice_width, initial_column)
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Next, we’ll plot the resulting slice, and see if we need to adjust the width and center of the coadd region.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig4, (iax4, pax4) = plt.subplots(nrows=2, ncols=1, figsize=(8, 12))
plt.subplots_adjust(hspace=0.15, top=0.95, bottom=0.05)
img4 = iax4.imshow(extraction_region, cmap='gray', aspect=aspect_ratio, 
                  norm=er_norm, interpolation='none')

#create slice box
def make_slice(width, column_idx):
    sy, sh, sw = 0, er_ny, width
    sx = column_idx - width // 2
    return sx, sy, sw, sh

*sxy, sw, sh = make_slice(slice_width, initial_column)
slice_rectangle = Rectangle(sxy, sw, sh, facecolor='none', 
                            edgecolor='b', linestyle='--')
iax4.add_patch(slice_rectangle)

#plot the coadded slice
xd_pixels = np.arange(er_ny)
lin4, = pax4.plot(xd_pixels, slice_0, 'k-')
xlbl4 = pax4.set_xlabel('Cross-dispersion pixel')
ylbl4 = pax4.set_ylabel('Coadded signal')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/Spectral_Extraction-static_24_0.png" src="../../_images/Spectral_Extraction-static_24_0.png"/>
             </div>
            </div>
            <p>
             A column index of 670 and width 50 seem to work reasonably well for this file, so we can now generate the final slice for kernel fitting.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>kernel_slice = kernel_slice_coadd(50, 670)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="define-the-extraction-kernel">
            <h3>
             Define the extraction kernel
             <a class="headerlink" href="#define-the-extraction-kernel" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Now we will define an extraction kernel which will be used to fit our trace at each pixel in the dispersion direction. This kernel will be made of 2 parts:
            </p>
            <ul class="simple">
             <li>
              <p>
               a PSF template (or a composite of multiple PSFs, for deblending purposes)
              </p>
             </li>
             <li>
              <p>
               a polynomial for background fitting
              </p>
             </li>
            </ul>
            <section id="select-a-psf-template">
             <h4>
              Select a PSF template
              <a class="headerlink" href="#select-a-psf-template" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              There are many options for PSF template that we could consider for our kernel, but a full comparison is outside the scope of this notebook. We will be demonstrating only Gaussian and Moffat profiles.
             </p>
             <p>
              There are two things to note:
             </p>
             <ol class="simple">
              <li>
               <p>
                The methods shown here are only applicable to a true point source. Extended sources require a different methodology.
               </p>
              </li>
              <li>
               <p>
                The
                <code class="docutils literal notranslate">
                 <span class="pre">
                  WebbPSF
                 </span>
                </code>
                package can be used to directly construct a composite PSF from the instrument model; however, this process is far more arduous than fitting a 1D profile using the
                <code class="docutils literal notranslate">
                 <span class="pre">
                  astropy.modeling
                 </span>
                </code>
                tools, and has thus been banished to Appendix B.
               </p>
              </li>
             </ol>
             <p>
              We start by plotting the two profiles against the kernel slice, with a naive normalization so that we can ignore scaling for the time being, centered on the pixel with the kernel’s maximum value. (We will perform a true fit later, don’t worry!)
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>max_pixel = np.argmax(kernel_slice)
fwhm = 1.

moffat_profile = models.Moffat1D(amplitude=1, gamma=fwhm, x_0=max_pixel, alpha=1)
gauss_profile = models.Gaussian1D(amplitude=1, mean=max_pixel, stddev=fwhm)

fig5 = plt.figure()
kern5 = plt.plot(xd_pixels, kernel_slice / kernel_slice[max_pixel], label='Kernel Slice')
moff5 = plt.plot(xd_pixels, moffat_profile(xd_pixels), label='Moffat Profile')
gaus5 = plt.plot(xd_pixels, gauss_profile(xd_pixels), label='Gaussian Profile')
lgd5 = plt.legend()
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <img alt="../../_images/Spectral_Extraction-static_32_0.png" src="../../_images/Spectral_Extraction-static_32_0.png"/>
              </div>
             </div>
             <p>
              The Gaussian profile looks like a better approximation, so that’s the profile we’ll use for this spectrum. In the cell below, we could add more PSF templates using
              <a class="reference external" href="https://docs.astropy.org/en/stable/modeling/compound-models.html">
               model operations
              </a>
              ; this is left as an exercise for the reader.
             </p>
             <p>
              We need to de-normalize our amplitude, so we’ll set it to the maximum pixel value of the slice.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>psf_template = gauss_profile
psf_template.amplitude = kernel_slice[max_pixel]
print(psf_template)
# If deblending multiple sources, add more PSF templates here:



</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: Gaussian1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Parameters:
        amplitude     mean stddev
    ----------------- ---- ------
    213.2068328857422  3.0    1.0
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
            <section id="polynomial-background">
             <h4>
              Polynomial background
              <a class="headerlink" href="#polynomial-background" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              We will fit the background with a polynomial. Some experimentation is recommended to find the polynomial degree which best fits the data; for this example, we’ll use a 2nd-degree polynomial.
             </p>
             <p>
              For nod-subtracted data, there may not be enough pixels in the extraction region to accurately fit a residual. In such cases, use a 0th-order polynomial or a
              <code class="docutils literal notranslate">
               <span class="pre">
                Const1D
               </span>
              </code>
              model for the background; to avoid fitting the background at all, set the parameter to
              <code class="docutils literal notranslate">
               <span class="pre">
                fixed
               </span>
               <span class="pre">
                =
               </span>
               <span class="pre">
                True
               </span>
              </code>
              .
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>background_poly = models.Polynomial1D(2)
print(background_poly)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: Polynomial1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Degree: 2
Parameters:
     c0  c1  c2
    --- --- ---
    0.0 0.0 0.0
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              The final step is to combine the PSF(s) and the background to create our compound model.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>extraction_kernel = psf_template + background_poly
print(extraction_kernel)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: CompoundModel
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Expression: [0] + [1]
Components: 
    [0]: &lt;Gaussian1D(amplitude=213.20683289, mean=3., stddev=1.)&gt;

    [1]: &lt;Polynomial1D(2, c0=0., c1=0., c2=0.)&gt;
Parameters:
       amplitude_0    mean_0 stddev_0 c0_1 c1_1 c2_1
    ----------------- ------ -------- ---- ---- ----
    213.2068328857422    3.0      1.0  0.0  0.0  0.0
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
           </section>
           <section id="fit-extraction-kernel">
            <h3>
             Fit extraction kernel
             <a class="headerlink" href="#fit-extraction-kernel" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Now that we have an extraction kernel, we want to fit it to our kernel slice, so as to have the best tool for fitting trace centers in the next step. We also plot the fit components, as well as the fit vs the kernel slice, as visual checks; if they are unacceptable, we can go back to the previous section, tweak parameters, and try again.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fitter = fitting.LevMarLSQFitter()
fit_extraction_kernel = fitter(extraction_kernel, xd_pixels, kernel_slice)
print(fit_extraction_kernel)

fit_line = fit_extraction_kernel(xd_pixels)

fig6, (fax6, fln6) = plt.subplots(nrows=2, ncols=1, figsize=(8, 12))
plt.subplots_adjust(hspace=0.15, top=0.95, bottom=0.05)
psf6 = fax6.plot(xd_pixels, fit_extraction_kernel[0](xd_pixels), label="PSF")
poly6 = fax6.plot(xd_pixels, fit_extraction_kernel[1](xd_pixels), label="Background")
sum6 = fax6.plot(xd_pixels, fit_line, label="Composite Kernel")
lgd6a = fax6.legend()
lin6 = fln6.plot(xd_pixels, kernel_slice, label='Kernel Slice')
fit6 = fln6.plot(xd_pixels, fit_line, 'o', label='Extraction Kernel')
lgd6b = fln6.legend()
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Model: CompoundModel
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Expression: [0] + [1]
Components: 
    [0]: &lt;Gaussian1D(amplitude=206.65933153, mean=3.106053, stddev=0.54468205)&gt;

    [1]: &lt;Polynomial1D(2, c0=-2.55189855, c1=8.41768163, c2=-1.36350019)&gt;
Parameters:
       amplitude_0           mean_0      ...       c1_1               c2_1       
    ------------------ ----------------- ... ---------------- -------------------
    206.65933152600587 3.106052999972261 ... 8.41768163230283 -1.3635001903214896
</pre>
               </div>
              </div>
              <img alt="../../_images/Spectral_Extraction-static_42_1.png" src="../../_images/Spectral_Extraction-static_42_1.png"/>
             </div>
            </div>
            <section id="wavelength-varying-fwhm-skipped">
             <h4>
              Wavelength-varying FWHM (skipped)
              <a class="headerlink" href="#wavelength-varying-fwhm-skipped" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              The NIRSpec PSF width changes with wavelength, and so for science data, it may be beneficial to fit multiple locations along the spectral trace. Below is a demonstration of the process; note, however, for this example dataset, the (not-yet-optimized) resampling and combining of the dithered input spectra introduces a width variation artifact, so we will not actually be using the results of this step for the extraction.
             </p>
             <p>
              If we wish to account for a varying FWHM, we can bin the 2D spectrum in the dispersion direction and fit each bin. The kernel we defined above can act as our initial estimate, which can be helpful in very faint regions of the spectrum, since
              <code class="docutils literal notranslate">
               <span class="pre">
                astropy.modeling
               </span>
              </code>
              fitting routines can be sensitive to initial estimates.
             </p>
             <p>
              (Once the binned kernel FWHMs have been calculated and plotted, the next step would be to find an appropriate model and fit the FWHM as a function of bin center. The fit model would then be included in the final 1D extraction below.)
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>from astropy.stats import sigma_clip

n_bin = 100
bin_width = er_nx // n_bin
bin_centers = np.arange(0, er_nx, bin_width+1, dtype=float) + bin_width // 2
binned_spectrum = np.hstack([extraction_region[:, i:i+bin_width+1].sum(axis=1)[:, None] 
                                 for i in range(0, er_nx, bin_width+1)])
bin_fwhms = np.zeros_like(bin_centers, dtype=float)

for y in range(bin_centers.size):
    bin_fit = fitter(fit_extraction_kernel, xd_pixels, binned_spectrum[:, y])
    bin_fwhms[y] = bin_fit.stddev_0.value
    
bin_ny, bin_nx = binned_spectrum.shape
bin_ar = bin_nx / (3 * bin_ny)

fig_fwhm, ax_fwhm = plt.subplots(nrows=2, ncols=1, figsize=(6, 10))
plt.subplots_adjust(hspace=0.05)
fwhm_img = ax_fwhm[0].imshow(binned_spectrum, aspect=bin_ar, interpolation='none',
                             cmap='gray')
fwhm_plot = ax_fwhm[1].plot(bin_centers, bin_fwhms)
xlbl_fwhm = ax_fwhm[1].set_xlabel("Bin center (px)")
ylbl_fwhm = ax_fwhm[1].set_ylabel("FWHM (arcsec)")
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <img alt="../../_images/Spectral_Extraction-static_45_0.png" src="../../_images/Spectral_Extraction-static_45_0.png"/>
              </div>
             </div>
            </section>
           </section>
           <section id="fit-geometric-distortion-skipped">
            <h3>
             Fit geometric distortion
             <em>
              (skipped)
             </em>
             <a class="headerlink" href="#fit-geometric-distortion-skipped" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The pipeline
             <code class="docutils literal notranslate">
              <span class="pre">
               resample
              </span>
             </code>
             step drizzles all input 2d spectra onto a rectified grid, so this particular step of our optimal extraction process is not typically necessary. A brief discussion of the procedure is included here as a guideline for extracting unrectified spectra (with the suffix
             <code class="docutils literal notranslate">
              <span class="pre">
               _cal.fits
              </span>
             </code>
             ), where the trace can have significant curvature and the trace dispersion is not column-aligned.
            </p>
            <section id="define-bins-for-trace-fitting">
             <h4>
              Define bins for trace fitting
              <a class="headerlink" href="#define-bins-for-trace-fitting" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              Depending on how noisy the 2D resampled spectrum is, it may be beneficial to define bins in the dispersion direction. These can be evenly- or unevenly-spaced, and once they’re defined, coadd the columns in each bin (possibly using the
              <code class="docutils literal notranslate">
               <span class="pre">
                WHT
               </span>
              </code>
              extension in the
              <code class="docutils literal notranslate">
               <span class="pre">
                s2d
               </span>
              </code>
              file) and create an array of bin center locations.
             </p>
             <p>
              If the 2D spectrum has high S/N, this may not be necessary, and each cross-dispersed column can be fit individually in the next step.
             </p>
            </section>
            <section id="fit-each-bin-with-a-modified-extraction-kernel">
             <h4>
              Fit each bin with a modified extraction kernel
              <a class="headerlink" href="#fit-each-bin-with-a-modified-extraction-kernel" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              We want to fit each of the defined bins with our extraction kernel, but we don’t want any other artifacts or noise to confuse the trace. So, we copy the extraction kernel, then set each parameter other than the profile center (
              <code class="docutils literal notranslate">
               <span class="pre">
                mean_0
               </span>
              </code>
              in the example above) to
              <code class="docutils literal notranslate">
               <span class="pre">
                fixed
               </span>
               <span class="pre">
                =
               </span>
               <span class="pre">
                True
               </span>
              </code>
              . Starting at one end of the trace, iterate over each bin to fit the slice with the extraction kernel, and store the resulting trace centers in an array.
             </p>
            </section>
            <section id="fit-the-trace-centers-with-a-1d-polynomial">
             <h4>
              Fit the trace centers with a 1D polynomial
              <a class="headerlink" href="#fit-the-trace-centers-with-a-1d-polynomial" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              This step is straightforward: create a
              <code class="docutils literal notranslate">
               <span class="pre">
                Polynomial1D
               </span>
              </code>
              model, then fit it to the trace centers from the previous step.
             </p>
             <p>
              Since we won’t be fitting, instead we’ll create a placeholder trace center model: a 0th-order polynomial.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>trace_center_model = models.Polynomial1D(0) #we use a constant because the spectrum has already been rectified
trace_center_model.c0 = fit_extraction_kernel.mean_0.value # use the parameter for center of the PSF profile
print(trace_center_model)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: Polynomial1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Degree: 0
Parameters:
            c0       
    -----------------
    3.106052999972261
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
           </section>
           <section id="construct-final-1d-spectrum">
            <h3>
             Construct final 1D spectrum
             <a class="headerlink" href="#construct-final-1d-spectrum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We calculate the final 1D spectrum as a weighted sum in the cross-dispersion direction the 2D spectrum, using our composite model (the extraction kernel centered on the trace) for the weights. We also need to incorporate the variance for each pixel, which we’ll estimate from the
             <code class="docutils literal notranslate">
              <span class="pre">
               WHT
              </span>
             </code>
             extension output by the resample step.
            </p>
            <section id="create-a-variance-image">
             <h4>
              Create a variance image
              <a class="headerlink" href="#create-a-variance-image" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              Horne’s algorithm requires the variance for each pixel. Errors are not currently propagated through the resample step; however, as per the
              <a class="reference external" href="https://www.stsci.edu/files/live/sites/www/files/home/scientific-community/software/drizzlepac/_documents/drizzlepac-handbook.pdf">
               DrizzlePac Handbook
              </a>
              , we can estimate the variance from the drizzle weights image:
              <span class="math notranslate nohighlight">
               \( Var \approx 1 / (W \times s^4) \)
              </span>
              , where
              <span class="math notranslate nohighlight">
               \(s\)
              </span>
              is the pixel scale. Currently, the NIRSpec drizzle parameters are set to
              <code class="docutils literal notranslate">
               <span class="pre">
                PIXFRAC
               </span>
               <span class="pre">
                =
               </span>
               <span class="pre">
                1.0
               </span>
              </code>
              .
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>scale = 1.0 # adjust this if and when the NIRSpec PIXFRAC changes

# We want any pixel with 0 weight to be excluded from the calculation
# in the next step, so we'll use masked array operations.
bad_pixels = weights_region == 0
masked_wht = np.ma.array(weights_region, mask=bad_pixels)
variance_image = np.ma.divide(1., weights_region * scale**4)
</pre>
                </div>
               </div>
              </div>
             </div>
             <p>
              We can display the variance image to see if there are any regions of the extraction region which will not be included in the spectrum (indicated in red below). For this particular example spectrum, every pixel has a nonzero weight.
             </p>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>from copy import copy

fig_var = plt.figure()
palette = copy(plt.cm.gray)
palette.set_bad('r', alpha=0.7)
var_norm = simple_norm(variance_image, stretch='log', min_cut=0.006, max_cut=0.1)
img_var = plt.imshow(variance_image, interpolation='none', aspect=aspect_ratio, norm=var_norm, cmap=palette)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <img alt="../../_images/Spectral_Extraction-static_57_0.png" src="../../_images/Spectral_Extraction-static_57_0.png"/>
              </div>
             </div>
            </section>
           </section>
          </section>
          <section id="generate-the-1d-spectrum">
           <h2>
            Generate the 1D spectrum
            <a class="headerlink" href="#generate-the-1d-spectrum" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Now, we finally calculate our 1D spectrum, summing over cross-dispersed columns:
$
            <span class="math notranslate nohighlight">
             \(S_x = \frac{1}{G_x}\sum_{y} \frac{I_{xy}\cdot K_y(x)}{V_{xy}}\)
            </span>
            <span class="math notranslate nohighlight">
             \(
where \)
            </span>
            I
            <span class="math notranslate nohighlight">
             \( is the pixel value in the 2D resampled image, \)
            </span>
            K
            <span class="math notranslate nohighlight">
             \( is our extraction kernel set to the column's trace center, \)
            </span>
            V
            <span class="math notranslate nohighlight">
             \( is the pixel value in the variance image, and \)
            </span>
            G
            <span class="math notranslate nohighlight">
             \( is the kernel normalization given by:
\)
            </span>
            <span class="math notranslate nohighlight">
             \(G_x = \sum_y \frac{K_y^2(x)}{V_{xy}}\)
            </span>
            $
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>spectrum = np.zeros(er_nx, dtype=float) #initialize our spectrum with zeros
column_pixels = np.arange(er_nx)
trace_centers = trace_center_model(column_pixels) # calculate our trace centers array

# Loop over columns
for x in column_pixels:
    # create the kernel for this column, using the fit trace centers
    kernel_column = fit_extraction_kernel.copy()
    kernel_column.mean_0 = trace_centers[x]
    # kernel_column.stddev_0 = fwhm_fit(x) # if accounting for a varying FWHM, uncomment this line.
    kernel_values = kernel_column(xd_pixels)
    
    # isolate the relevant column in the spectrum and variance images
    variance_column = variance_image[:, x] # remember that numpy arrays are row, column
    image_pixels = extraction_region[:, x]
    
    # calculate the kernal normalization
    g_x = np.ma.sum(kernel_values**2 / variance_column)
    if np.ma.is_masked(g_x): #this column isn't valid, so we'll skip it
        continue
    
    # and now sum the weighted column
    weighted_column = np.ma.divide(image_pixels * kernel_values, variance_column)
    spectrum[x] = np.ma.sum(weighted_column) / g_x
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            We need a wavelength array to display the spectrum, which we can create from the WCS object stored in the data model’s metadata.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>wcs = data_model.meta.wcs
print(wcs.__repr__())
alpha_C, delta_C, y = wcs(er_x, er_y)
wavelength = y[0]
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>&lt;WCS(output_frame=world, input_frame=detector, forward_transform=Model: CompoundModel
Inputs: ('x0', 'x1')
Outputs: ('alpha_C', 'delta_C', 'y')
Model set size: 1
Expression: [0] | ([1] &amp; [2] | [3] | [4]) &amp; [5]
Components: 
    [0]: &lt;Mapping((1, 1, 0))&gt;

    [1]: &lt;Linear1D(slope=-0.0000212, intercept=0.00014843)&gt;

    [2]: &lt;Linear1D(slope=-0.00002109, intercept=0.0001476)&gt;

    [3]: &lt;Pix2Sky_Gnomonic()&gt;

    [4]: &lt;RotateNative2Celestial(lon=53.1347588, lat=-27.80662884, lon_pole=180.)&gt;

    [5]: &lt;Tabular1D(points=(&lt;array (unloaded) shape: [1298] dtype: float64&gt;,), lookup_table=[1.64694116 1.64694116 1.64694116 ... 3.17850353 3.17956468 3.17956468])&gt;
Parameters:
            slope_1              intercept_1       ... lon_pole_4
    ----------------------- ---------------------- ... ----------
    -2.1203814393372336e-05 0.00014842677756392322 ...      180.0)&gt;
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>fig7 = plt.figure()
spec7 = plt.plot(wavelength, spectrum)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <img alt="../../_images/Spectral_Extraction-static_62_0.png" src="../../_images/Spectral_Extraction-static_62_0.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Write the extracted spectrum out to a file
# This is left as an exercise for the reader


</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            We also want to compare our optimally-extracted spectrum with the
            <code class="docutils literal notranslate">
             <span class="pre">
              x1d
             </span>
            </code>
            pipeline product. We’ll normalize the spectra so we can plot them on the same axes.
           </p>
           <p>
            (Note that the
            <code class="docutils literal notranslate">
             <span class="pre">
              x1d
             </span>
            </code>
            spectrum includes negative traces from the background subtraction step, which usually results in a negative flux calculation. We need to correct for that when comparing with our optimally-extracted version.)
           </p>
           <section id="developer-note-we-will-not-use-datamodels-here-because-the-latest-packages-do-not-support-the-simulated-data-previously-created-for-this-notebook-the-data-set-will-have-to-be-updated-after-commissioning">
            <h3>
             Developer Note: We will not use datamodels here because the latest packages do not support the simulated data previously created for this notebook. The data set will have to be updated after commissioning.
             <a class="headerlink" href="#developer-note-we-will-not-use-datamodels-here-because-the-latest-packages-do-not-support-the-simulated-data-previously-created-for-this-notebook-the-data-set-will-have-to-be-updated-after-commissioning" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>x1d_model = fits.open(x1d_file)
# For a file with multiple spectra, the index to .spec is EXTVAR
tmp = x1d_model[1].data
x1d_wave = tmp['WAVELENGTH']
x1d_flux = tmp['FLUX']

if x1d_flux.sum() &lt;= 0:
    x1d_flux = -x1d_flux
fig8 = plt.figure()
x1d8 = plt.plot(x1d_wave, x1d_flux / x1d_flux.max(), label="Pipeline")
opt8 = plt.plot(wavelength, spectrum / spectrum.max(), label="Optimal", alpha=0.7)
lgd8 = plt.legend()
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <img alt="../../_images/Spectral_Extraction-static_67_0.png" src="../../_images/Spectral_Extraction-static_67_0.png"/>
             </div>
            </div>
           </section>
          </section>
          <hr class="docutils"/>
          <section id="appendix-a-batch-processing">
           <h2>
            Appendix A: Batch Processing
            <a class="headerlink" href="#appendix-a-batch-processing" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            When optimal extraction is desired for a large number of spectra, going step-by-step through the process laid out above for each spectrum may not be practical. In such cases, we can initially use those interactive methods on one or two spectra to make decisions about some of our extraction parameters (e.g., what PSF template profile to use, or what degree polynonmial to fit the background with), then use those parameters to process all of the spectra non-interactively. Afterwards, we can examine the output from each extracted spectrum and revisit any which need more individualized handling.
           </p>
           <p>
            We can extract a large number of spectra non-interactively by defining functions for each of the steps above, and a single master function to iterate over all the spectra in a single directory.
           </p>
           <section id="id1">
            <h3>
             Define an extraction region
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             There’s no way to perform this step non-interactively, so we’ll skip it here. However, there are two good ways (and one bad way) to deal with this for a real dataset:
            </p>
            <ol class="simple">
             <li>
              <p>
               Define an extraction region for each 2D spectrum before batch processing. You can save the region bounding boxes to a python dictionary (or write them to a file, then read it in during iteration).
              </p>
             </li>
             <li>
              <p>
               Visually examine the 2D spectra, and only batch process those spectra for which a specific extraction region (i.e., smaller than the full 2D spectrum) doesn’t need to be defined. The remainder of the spectra can be extracted individually.
              </p>
             </li>
             <li>
              <p>
               Skip this step, and assume that any spectra for which a specific extraction region would need to be defined will need individualized reprocessing anyway. This step is not recommended, but it is the one we will be using here.
              </p>
             </li>
            </ol>
           </section>
           <section id="id2">
            <h3>
             Create Kernel Slice
             <a class="headerlink" href="#id2" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_kernel_slice(extraction_region, slice_width=30, column_idx=None):
    """
    Create a slice in the cross-dispersion direction out of the 
    2D array `extraction_region`, centered on `column_idx` and 
    `slice_width` pixels wide. If `column_idx` is not given, use
    the column with the largest total signal.
    """
    
    if column_idx is None:
        column_idx = np.argmax(extraction_region.sum(axis=0))
        
    ny, nx = extraction_region.shape
    half_width = slice_width // 2
    
    #make sure we don't go past the edges of the extraction region
    to_coadd = np.arange(max(0, column_idx - half_width), 
                         min(nx-1, column_idx + half_width))
    
    return extraction_region[:, to_coadd].sum(axis=1) / slice_width
    
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="create-and-fit-the-extraction-kernel">
            <h3>
             Create and fit the extraction kernel
             <a class="headerlink" href="#create-and-fit-the-extraction-kernel" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_fit_extraction_kernel(xd_slice, psf_profile=models.Gaussian1D, 
                          height_param_name='amplitude', height_param_value=None,
                          width_param_name='stddev', width_param_value=1.,
                          center_param_name='mean', center_param_value=None,
                          other_psf_args=[], other_psf_kw={},
                          bg_model=models.Polynomial1D,
                          bg_args=[3], bg_kw={}):
    """
    Initialize a composite extraction kernel, then fit it to 
    the 1D array `xd_slice`, which has been nominally
    generated via the `kernel_slice` function defined above. 
    
    To allow for PSF template models with different parameter 
    names, we use the `height_param_*`, `width_param_*`, and
    `center_param_*` keyword arguments. We collect any other
    positional or keyword arguments for the PSF model in 
    `other_psf_*`. If the height or center values are `None`, 
    they will be calculated from the data.
    
    Similarly, any desired positional or keyword arguments to
    the background fit model (default `Polynomial1D`) are
    accepted via `bg_args` and `bg_kw`.
    
    Note that this function can not handle cases which involve
    multiple PSFs for deblending. It is recommended to process
    such spectra individually, using the interactive procedure
    above.
    """
    xd_pixels = np.arange(xd_slice.size)
    
    if center_param_value is None:
        center_param_value = np.argmax(xd_slice)
    
    if height_param_value is None:
        # In case of non-integer values passed via center_param_value,
        # we need to interpolate.
        slice_interp = interp1d(xd_pixels, xd_slice)
        height_param_value = slice_interp(center_param_value)
    
    # Create the PSF and the background models
    psf_kw = dict([(height_param_name, height_param_value), 
                   (width_param_name, width_param_value),
                   (center_param_name, center_param_value)])
    psf_kw.update(other_psf_kw)
    psf = psf_profile(*other_psf_args, **psf_kw)
    
    bg = bg_model(*bg_args, **bg_kw)
    
    composite_kernel = psf + bg
    fitter = fitting.LevMarLSQFitter()
    return fitter(composite_kernel, xd_pixels, xd_slice)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="account-for-varying-fwhm">
            <h3>
             Account for varying FWHM
             <a class="headerlink" href="#account-for-varying-fwhm" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             This is left as an exercise for the user, as per the process shown
             <a class="reference external" href="#Wavelength-varying-FWHM">
              here
             </a>
             . Note that
             <code class="docutils literal notranslate">
              <span class="pre">
               batch_extract_spectrum
              </span>
             </code>
             and
             <code class="docutils literal notranslate">
              <span class="pre">
               batch_optimal_extraction
              </span>
             </code>
             below will also need to be modified to incorporate this function, if desired.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_vary_fwhm(extraction_region, kernel):
    pass # implement a function which fits a wavelength-varying FWHM
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="fit-the-trace-centers">
            <h3>
             Fit the trace centers
             <a class="headerlink" href="#fit-the-trace-centers" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             If this is required, replace this with a real function that does the fitting.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_fit_trace_centers(extraction_region, kernel,
                      trace_model=models.Polynomial1D,
                      trace_args=[0], trace_kw={}):
    """
    Fit the geometric distortion of the trace with
    a model. Currently this is a placeholder function,
    since geometric distortion is typically removed
    during the `resample` step. However, if this
    functionality is necesary, use this function
    signature to remain compatible with the rest of
    this Appendix.
    """
    
    trace_centers = trace_model(*trace_args, **trace_kw)
    trace_centers.c0 = kernel.mean_0
    return trace_centers
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="id3">
            <h3>
             Generate the 1D spectrum
             <a class="headerlink" href="#id3" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_extract_spectrum(extraction_region, trace, kernel, 
                     weights_image, 
                     trace_center_param='mean',
                     scale=1.0):
    """
    Optimally extract the 1D spectrum from the extraction 
    region.
    
    A variance image is created from `weights_image` (which 
    should have the same dimensions as `extraction_region`).
    Then, for each column of the spectrum, we sum the aperture
    as per the equations defined above, masking pixels with
    zero weights. 
    
    Note that unlike the interactive, step-by-step method, 
    here we will vectorize for speed. This requires using
    a model set for the kernel, but this is allowed since
    we are not fitting anything.
    
    `trace_center_param` is the name of the parameter which 
    will defines the trace centers, *without the model number
    subscript* (since we will be dealing with the components
    individually).
    
    `scale` is the size ratio of input to output pixels when
    drizzling, equivalent to PIXFRAC in the drizzle parameters
    from the `resample` step.
    """
    
    bad_pixels = weights_image == 0.
    masked_wht = np.ma.array(weights_image, mask=bad_pixels)
    variance_image = np.ma.divide(1., masked_wht * scale**4)
    
    ny, nx = extraction_region.shape
    trace_pixels = np.arange(nx)
    xd_pixels = np.arange(ny)
    trace_centers = trace(trace_pixels) # calculate our trace centers array
    
    # Create kernel image for vectorizing, which requires some gymnastics...
    # ******************************************************************
    # * IMPORTANT:                                                     *
    # * ----------                                                     *
    # * Note that because of the way model sets are implemented, it is *
    # * not feasible to alter an existing model instance to use them.  *
    # * Instead we'll create a new kernel instance, using the fitted   *
    # * parameters from the original kernel.                           *
    # *                                                                *
    # * Caveat: this assumes that the PSF is the first element, and    *
    # * the background is the second. If you change that when creating *
    # * your composite kernel, make sure you update this section       *
    # * similarly, or it will not work!                                *
    # ******************************************************************
    psf0, bg0 = kernel
    psf_params = {}
    for pname, pvalue in zip(psf0.param_names, psf0.parameters):
        if pname == trace_center_param:
            psf_params[pname] = trace_centers
        else:
            psf_params[pname] = np.full(nx, pvalue)
    psf_set = psf0.__class__(n_models=nx, **psf_params)
    #if not using Polynomial1D for background model, edit this:
    bg_set = bg0.__class__(len(bg0.param_names)-1, n_models=nx)
    for pname, pvalue in zip(bg0.param_names, bg0.parameters):
        setattr(bg_set, pname, np.full(nx, pvalue))
    kernel_set = psf_set + bg_set
    # We pass model_set_axis=False so that every model in the set 
    # uses the same input, and we transpose the result to fix the
    # orientation.
    kernel_image = kernel_set(xd_pixels, model_set_axis=False).T
    
    # Now we perform our weighted sum, using numpy.ma routines
    # to preserve our masks
    g = np.ma.sum(kernel_image**2 / variance_image, axis=0)
    weighted_spectrum = np.ma.divide(kernel_image * extraction_region, variance_image)
    spectrum1d = np.ma.sum(weighted_spectrum, axis=0) / g
    
    # Any masked values we set to 0.
    return spectrum1d.filled(0.)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="convenience-functions">
            <h3>
             Convenience functions
             <a class="headerlink" href="#convenience-functions" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_wavelength_from_wcs(datamodel, pix_x, pix_y):
    """
    Convenience function to grab the WCS object from the
    datamodel's metadata, generate world coordinates from
    the given pixel coordinates, and return the 1D 
    wavelength.
    """
    
    wcs = datamodel.meta.wcs
    aC, dC, y = wcs(pix_x, pix_y)
    return y[0]

def batch_save_extracted_spectrum(filename, wavelength, spectrum):
    """
    Quick &amp; dirty fits dump of an extracted spectrum.
    Replace with your preferred output format &amp; function.
    """
    
    wcol = fits.Column(name='wavelength', format='E', 
                       array=wavelength)
    scol = fits.Column(name='spectrum', format='E',
                       array=spectrum)
    cols = fits.ColDefs([wcol, scol])
    hdu = fits.BinTableHDU.from_columns(cols)
    hdu.writeto(filename, overwrite=True)

def batch_plot_output(resampled_image, extraction_bbox, 
                kernel_slice, kernel_model,
                wavelength, spectrum, filename):
    """
    Convenience function for summary output figures,
    allowing visual inspection of the results from 
    each file being processed.
    """
    
    fig, (ax1, ax2, ax3) = plt.subplots(nrows=3, ncols=1, 
                                        figsize=(8,12))
    fig.suptitle(filename)
    
    ny, nx = resampled_image.shape
    aspect = nx / (2 * ny)
    
    # Subplot 1: Extraction region
    power_norm = simple_norm(resampled_image, 'power')
    er_img = ax1.imshow(resampled_image, interpolation='none',
               aspect=aspect, norm=power_norm, cmap='gray')
    rx, ry, rw, rh = extraction_bbox
    region = Rectangle((rx, ry), rw, rh, facecolor='none', 
                       edgecolor='b', linestyle='--')
    er_ptch = ax1.add_patch(region)
    
    # Subplot 2: Kernel fit
    xd_pixels = np.arange(kernel_slice.size)
    fit_line = kernel_model(xd_pixels)
    ks_line = ax2.plot(xd_pixels, kernel_slice, label='Kernel Slice')
    kf_line = ax2.plot(xd_pixels, fit_line, 'o', label='Extraction Kernel')
    k_lgd = ax2.legend()
    
    # Subplot 3: Extracted spectrum
    spec_line = ax3.plot(wavelength, spectrum)
    
    fig.savefig(filename, bbox_inches='tight')
    plt.close(fig)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="iterate-over-the-desired-files">
            <h3>
             Iterate over the desired files
             <a class="headerlink" href="#iterate-over-the-desired-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def batch_optimal_extraction(file_list):
    """
    Iterate over a list of fits file paths, optimally extract
    the SCI extension in each file, generate an output summary
    image, and then save the resulting spectrum.
    
    Note that in the example dataset, there is only one SCI
    extension in each file. For data with multiple SCI 
    extensions, a second loop over those extensions is
    required.
    """
    
    # For this example data, we'll just use the default values
    # for all the functions
    for i, fitsfile in enumerate(file_list):
        print("Processing file {} of {}: {}".format(i+1, len(file_list), fitsfile))
        dmodel = ImageModel(fitsfile)
        spec2d = dmodel.data
        wht2d = dmodel.wht
        
        k_slice = batch_kernel_slice(spec2d)
        k_model = batch_fit_extraction_kernel(k_slice)
        trace = batch_fit_trace_centers(spec2d, k_model)
        spectrum = batch_extract_spectrum(spec2d, trace, k_model, wht2d)
        
        ny, nx = spec2d.shape
        y2d, x2d = np.mgrid[:ny, :nx]
        wavelength = batch_wavelength_from_wcs(dmodel, x2d, y2d)
        
        bbox = [0, 0, nx-1, ny-1]
        
        outfile = fitsfile.replace('s2d.fits', 'x1d_optimal')
        
        batch_plot_output(spec2d, bbox, k_slice, k_model,
                    wavelength, spectrum, 
                    outfile+'.png')
        batch_save_extracted_spectrum(outfile+'.fits', wavelength, spectrum)
        
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="run-on-example-dataset">
            <h3>
             Run on example dataset
             <a class="headerlink" href="#run-on-example-dataset" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Take particular note of any spectrum which produces a warning during fitting - these are likely to be good candidates for interactive reprocessing.
            </p>
            <p>
             <em>
              Developer Note:
             </em>
            </p>
            <p>
             It would be great if there was a way to do this without spawning invisible plots from the creation of matplotlib figures, so that the
             <code class="docutils literal notranslate">
              <span class="pre">
               ioff
              </span>
             </code>
             and
             <code class="docutils literal notranslate">
              <span class="pre">
               ion
              </span>
             </code>
             calls could be removed.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.ioff() # if we don't turn this off, then matplotlib tries to display an (invisible) plot for each spectrum
s2d_files = glob(os.path.join('s2d_files', '*s2d.fits'))
batch_optimal_extraction(s2d_files)
plt.ion() # now we turn it back on so everything else plots as it should!
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 1 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s35193_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>2022-12-30 17:05:57,370 - stpipe - WARNING - /usr/share/miniconda/lib/python3.9/site-packages/astropy/modeling/fitting.py:1433: AstropyUserWarning: The fit may be unsuccessful; check fit_info['message'] for more information.
  warnings.warn(
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 2 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s54218_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 3 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03262_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 4 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s50037_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 5 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s09616_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 6 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03698_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 7 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s35395_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 8 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s35786_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 9 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s05720_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 10 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s08415_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 11 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s05225_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 12 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s50176_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 13 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00443_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 14 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s06667_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 15 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s05788_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 16 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s04659_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 17 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s50396_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 18 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00708_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 19 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s31404_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 20 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s33926_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 21 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s33778_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 22 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s36383_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 23 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00482_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 24 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s01801_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 25 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00802_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 26 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s33527_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 27 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s31248_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 28 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s33685_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 29 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s35815_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 30 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00205_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 31 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s32667_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 32 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s52673_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 33 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03495_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 34 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30455_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 35 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s06174_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 36 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30576_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 37 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s02615_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 38 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00646_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 39 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s06661_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 40 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s02690_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 41 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s50007_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 42 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s04012_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 43 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03317_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 44 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s36863_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 45 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s32150_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 46 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s01154_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 47 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00417_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 48 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s09427_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 49 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s02853_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 50 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00618_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 51 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s05447_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 52 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03162_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 53 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00279_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 54 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03812_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 55 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s04353_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 56 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s31771_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 57 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s06001_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 58 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30263_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 59 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03211_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 60 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s01158_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 61 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s05337_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 62 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00716_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 63 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s36510_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 64 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s01186_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 65 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00492_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 66 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03055_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 67 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00546_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 68 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03901_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 69 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s36786_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 70 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s41066_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 71 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s02624_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 72 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s30440_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 73 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00227_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 74 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00204_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 75 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s06325_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 76 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s02315_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 77 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s00455_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 78 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s32530_s2d.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Processing file 79 of 79: s2d_files/F170LP-G235M_MOS_observation-6_mod_correctedWCS_noflat_nooutlierdet_combined_s03398_s2d.fits
</pre>
               </div>
              </div>
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;contextlib.ExitStack at 0x7fc74da08460&gt;
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <hr class="docutils"/>
          <section id="appendix-b-webbpsf">
           <h2>
            Appendix B: WebbPSF
            <a class="headerlink" href="#appendix-b-webbpsf" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Instead of using a PSF template, we can generate a PSF directly from the instrument model with
            <a class="reference external" href="https://webbpsf.readthedocs.io/en/stable/index.html">
             WebbPSF
            </a>
            . Currently, only the F110W and F140X imaging filters are supported, but we’ll walk through the process anyway for whenever more filters become available.
           </p>
           <p>
            The primary function of WebbPSF is to produce imaging PSFs; however, it
            <em>
             can
            </em>
            generate a set of monochromatic PSFs, which we can combine.
           </p>
           <p>
            <code class="docutils literal notranslate">
             <span class="pre">
              webbpsf
             </span>
            </code>
            is only needed here so we import it at the start of this appendix:
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>from webbpsf import NIRSpec, display_psf
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            WebbPSF has a number of data files which are required to run, so we’ll begin by verifying that they can be accessed (and downloading them if necessary).
           </p>
           <p>
            Note that you will see a big red error message if you have not yet downloaded the data files. Don’t worry, as long as you see “Downloading WebbPSF data files.” everything is still proceeding as expected.
           </p>
           <p>
            <em>
             Developer Note:
            </em>
           </p>
           <p>
            WebbPSF should be updated so that the red error doesn’t appear.  See
            <a class="reference external" href="https://github.com/spacetelescope/webbpsf/issues/380">
             https://github.com/spacetelescope/webbpsf/issues/380
            </a>
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>try:
    instrument = NIRSpec()
except OSError:
    # assume that WebbPSF data files have not been downloaded
    import tarfile, sys
    print("Downloading WebbPSF data files.")
    webb_url = "https://stsci.box.com/shared/static/qcptcokkbx7fgi3c00w2732yezkxzb99.gz"
    webb_file = os.path.join('.', "webbpsf-data-0.9.0.tar.gz")
    urllib.request.urlretrieve(webb_url, webb_file)
    print("Extracting into ./webbpsf-data ...")
    tar = tarfile.open(webb_file)
    tar.extractall()
    tar.close()
    os.environ["WEBBPSF_PATH"] = os.path.join(".","webbpsf-data")
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="instrument-properties">
            <h3>
             Instrument properties
             <a class="headerlink" href="#instrument-properties" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             See the WebbPSF documentation for a full list of instrument settings.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>instrument = NIRSpec()
print(instrument.filter_list)

# For reference:
allowed_masks = ('S200A1','S200A2','S400A1','S1600A1','S200B1', 
                 'MSA all open', 'Single MSA open shutter', 
                 'Three adjacent MSA open shutters')

# Edit these as necessary
instrument.filter = 'F110W' 
instrument.image_mask = 'Three adjacent MSA open shutters'
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>['F110W', 'F140X', 'IFU']
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="monochromatic-psfs">
            <h3>
             Monochromatic PSFs
             <a class="headerlink" href="#monochromatic-psfs" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The most rigorous method we could use is to generate a PSF for each wavelength in the 2D spectrum and combine all of them. However, the computation time and memory required for this method is generally very large unless the spectra are quite short (in the dispersion direction). A more reasonable method (which is what we will be doing here) is to create a subset of monochromatic PSFs spaced evenly across the wavelength range, and interpolate between them.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>psf_wavelengths = np.linspace(wavelength[0], wavelength[-1], num=10) * 1.0e-6 # wavelengths must be in meters

cube_hdul = instrument.calc_datacube(psf_wavelengths) #the output is a HDUList
psf_cube = cube_hdul[1].data
psf_cube.shape
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output traceback highlight-ipythontb notranslate">
               <div class="highlight">
                <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">36</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">psf_wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">wavelength</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-6</span> <span class="c1"># wavelengths must be in meters</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">cube_hdul</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">calc_datacube</span><span class="p">(</span><span class="n">psf_wavelengths</span><span class="p">)</span> <span class="c1">#the output is a HDUList</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">psf_cube</span> <span class="o">=</span> <span class="n">cube_hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">psf_cube</span><span class="o">.</span><span class="n">shape</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/poppy/instrument.py:324,</span> in <span class="ni">Instrument.calc_datacube</span><span class="nt">(self, wavelengths, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">322</span> <span class="c1"># Set up cube and initialize structure based on PSF at first wavelength</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span> <span class="n">poppy_core</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Starting multiwavelength data cube calculation."</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">324</span> <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">monochromatic</span><span class="o">=</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="g g-Whitespace">    </span><span class="mi">326</span> <span class="n">cube</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/webbpsf/webbpsf_core.py:1047,</span> in <span class="ni">JWInstrument.calc_psf</span><span class="nt">(self, outfile, source, nlambda, monochromatic, fov_arcsec, fov_pixels, oversample, detector_oversample, fft_oversample, overwrite, display, save_intermediates, return_intermediates, normalize, add_distortion, crop_psf)</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span>         <span class="bp">self</span><span class="o">.</span><span class="n">pupil</span><span class="o">.</span><span class="n">update_opd</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1046</span> <span class="c1"># Run poppy calc_psf</span>
<span class="ne">-&gt; </span><span class="mi">1047</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">SpaceTelescopeInstrument</span><span class="o">.</span><span class="n">calc_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">nlambda</span><span class="o">=</span><span class="n">nlambda</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1048</span>                                         <span class="n">monochromatic</span><span class="o">=</span><span class="n">monochromatic</span><span class="p">,</span> <span class="n">fov_arcsec</span><span class="o">=</span><span class="n">fov_arcsec</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1049</span>                                         <span class="n">fov_pixels</span><span class="o">=</span><span class="n">fov_pixels</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="n">oversample</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1050</span>                                         <span class="n">detector_oversample</span><span class="o">=</span><span class="n">detector_oversample</span><span class="p">,</span> <span class="n">fft_oversample</span><span class="o">=</span><span class="n">fft_oversample</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1051</span>                                         <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1052</span>                                         <span class="n">save_intermediates</span><span class="o">=</span><span class="n">save_intermediates</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1053</span>                                         <span class="n">return_intermediates</span><span class="o">=</span><span class="n">return_intermediates</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1055</span> <span class="k">return</span> <span class="n">psf</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/poppy/instrument.py:277,</span> in <span class="ni">Instrument.calc_psf</span><span class="nt">(self, outfile, source, nlambda, monochromatic, fov_arcsec, fov_pixels, oversample, detector_oversample, fft_oversample, overwrite, display, save_intermediates, return_intermediates, normalize)</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_jitter</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>                    <span class="n">local_options</span><span class="p">)</span>  <span class="c1"># will immediately return if there is no jitter parameter in local_options</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fits_header</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">local_options</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">277</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_psf_format_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">local_options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span> <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>     <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/webbpsf/webbpsf_core.py:1108,</span> in <span class="ni">JWInstrument._calc_psf_format_output</span><span class="nt">(self, result, options)</span>
<span class="g g-Whitespace">   </span><span class="mi">1105</span> <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"NIRSpec"</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1106</span>     <span class="c1"># Apply distortion effects to NIRSpec psf: Distortion only</span>
<span class="g g-Whitespace">   </span><span class="mi">1107</span>     <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">"NIRSpec: Adding optical distortion"</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1108</span>     <span class="n">psf_distorted</span> <span class="o">=</span> <span class="n">distortion</span><span class="o">.</span><span class="n">apply_distortion</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>  <span class="c1"># apply siaf distortion model</span>
<span class="g g-Whitespace">   </span><span class="mi">1110</span> <span class="c1"># Edit the variable to match if input didn't request distortion</span>
<span class="g g-Whitespace">   </span><span class="mi">1111</span> <span class="c1"># (cannot set result = psf_distorted due to return method)</span>
<span class="g g-Whitespace">   </span><span class="mi">1112</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">ImageHDU</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psf_distorted</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/webbpsf/distortion.py:240,</span> in <span class="ni">apply_distortion</span><span class="nt">(hdulist_or_filename, fill_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="n">psf</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"DISTORT"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"True"</span><span class="p">,</span> <span class="s2">"SIAF distortion coefficients applied"</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">238</span> <span class="n">psf</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">"SIAF_VER"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pysiaf</span><span class="o">.</span><span class="n">JWST_PRD_VERSION</span><span class="p">,</span> <span class="s2">"SIAF PRD version used"</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">240</span> <span class="n">degree</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">aper</span><span class="p">,</span> <span class="s1">'Sci2IdlDeg'</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span> <span class="n">number_of_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">degree</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span> <span class="n">all_keys</span> <span class="o">=</span> <span class="n">aper</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/numpy/__init__.py:284,</span> in <span class="ni">__getattr__</span><span class="nt">(attr)</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="kn">from</span> <span class="nn">.testing</span> <span class="kn">import</span> <span class="n">Tester</span>
<span class="g g-Whitespace">    </span><span class="mi">282</span>     <span class="k">return</span> <span class="n">Tester</span>
<span class="ne">--&gt; </span><span class="mi">284</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">"module </span><span class="si">{!r}</span><span class="s2"> has no attribute "</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span>                      <span class="s2">"</span><span class="si">{!r}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

<span class="ne">AttributeError</span>: module 'numpy' has no attribute 'int'
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>#Display the contents of the data cube
fig9, ax9 = plt.subplots(nrows=5, ncols=2, figsize=(8,12))
plt.subplots_adjust(hspace=0.15, wspace=0.01, left=0.06, 
                   right=0.94, bottom=0.05, top=0.95)
for row in range(5):
    for col in range(2):
        ax = ax9[row, col]
        w = row * 2 + col
        wl = psf_wavelengths[w]
        
        display_psf(cube_hdul, ax=ax, cube_slice=w,
                    title="$\lambda$ = {:.3f} $\mu$m".format(wl*1e6),
                    vmax=.2, vmin=1e-4, ext=1, colorbar=False)
        ax.xaxis.set_visible(False)
        ax.yaxis.set_visible(False)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="interpolation-methods">
            <h3>
             Interpolation Methods
             <a class="headerlink" href="#interpolation-methods" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The method of interpolation we choose depends strongly on how the PSF varies with wavelength. For evaluating the different methods, we’ll create another monochromatic PSF for comparison.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>reference_psf_hdul = instrument.calc_psf(monochromatic=3.0e-6)
reference_psf = reference_psf_hdul[1].data
ref_norm = simple_norm(reference_psf, stretch='log', min_cut=1e-4, max_cut=0.2)
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             The simplest way is a 3D linear interpolation, so let’s see how it does. In the figure below, the top-left image is the reference PSF, the top-right is the linearly-interpolated PSF, the bottom left is a difference image, and the bottom right is a log-log plot of the pixel values in the reference (X) and interpolated (Y) PSFs.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ref_pix = reference_psf &gt;= 1e-4
psf_x = psf_y = np.arange(48)
out_x, out_y = np.meshgrid(psf_x, psf_y, indexing='ij')
interpolator = RegularGridInterpolator((psf_wavelengths, psf_x, psf_y), psf_cube, method='linear')
linear_psf = interpolator((3.0e-6, out_x, out_y))

diff_lin_psf = reference_psf - linear_psf

print("Reference: min {:.3e}, max {:.3e}".format(reference_psf.min(), reference_psf.max()))
print("Linear: min {:.3e}, max {:.3e}".format(linear_psf.min(), linear_psf.max()))
print("Diff: min {:.3e}, max {:.3e}".format(diff_lin_psf.min(), diff_lin_psf.max()))
print("Total error: {:.5e}".format(np.sqrt((diff_lin_psf**2).sum())))

figA, axA = plt.subplots(nrows=2, ncols=2, figsize=(10, 10))
plt.subplots_adjust(wspace=0.01, left=0.05, right=0.95)
axA[0, 0].imshow(reference_psf, interpolation='none', norm=ref_norm)
axA[0, 0].xaxis.set_visible(False)
axA[0, 0].yaxis.set_visible(False)
axA[0, 1].imshow(linear_psf, interpolation='none', norm=ref_norm)
axA[0, 1].xaxis.set_visible(False)
axA[0, 1].yaxis.set_visible(False)
axA[1, 0].imshow(diff_lin_psf, interpolation='none', vmin=-5e-4, vmax=5e-4)
axA[1, 0].xaxis.set_visible(False)
axA[1, 0].yaxis.set_visible(False)
axA[1, 1].loglog(reference_psf[ref_pix], linear_psf[ref_pix], 'k+')
axA[1, 1].set_aspect('equal', 'box')
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             The next method is more calculation-intensive, but could be more accurate. We go pixel-by-pixel through the PSF cube and interpolate with a 1D cubic spline along the wavelength axis.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>cubic_psf = np.zeros_like(psf_cube[0])
for row in np.arange(48):
    for col in np.arange(48):
        spline = interp1d(psf_wavelengths, psf_cube[:, row, col], kind='cubic')
        cubic_psf[row, col] = spline(3.0e-6)
        
diff_cub_psf = reference_psf - cubic_psf

print("Reference: min {:.3e}, max {:.3e}".format(reference_psf.min(), reference_psf.max()))
print("Cubic: min {:.3e}, max {:.3e}".format(cubic_psf.min(), cubic_psf.max()))
print("Diff: min {:.3e}, max {:.3e}".format(diff_cub_psf.min(), diff_cub_psf.max()))
print("Total error: {:.5e}".format(np.sqrt((diff_cub_psf**2).sum())))

figB, axB = plt.subplots(nrows=2, ncols=2, figsize=(10, 10))
plt.subplots_adjust(wspace=0.01, left=0.05, right=0.95)
axB[0, 0].imshow(reference_psf, interpolation='none', norm=ref_norm)
axB[0, 0].xaxis.set_visible(False)
axB[0, 0].yaxis.set_visible(False)
axB[0, 1].imshow(cubic_psf, interpolation='none', norm=ref_norm)
axB[0, 1].xaxis.set_visible(False)
axB[0, 1].yaxis.set_visible(False)
axB[1, 0].imshow(diff_cub_psf, interpolation='none', vmin=-5e-4, vmax=5e-4)
axB[1, 0].xaxis.set_visible(False)
axB[1, 0].yaxis.set_visible(False)
axB[1, 1].loglog(reference_psf[ref_pix], cubic_psf[ref_pix], 'k+')
axB[1, 1].set_aspect('equal', 'box')
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             While the log-log plot looks virtually identical to the linear case, the difference image in the spline case shows slightly larger errors in some of the central pixels. This is consistent with the “total error” statistic (the sum of squares of the difference image), which is larger in this second case.
            </p>
            <p>
             We can see in the plot below that the difference between the two methods is very slight, but the linearly-interpolated PSF is more accurate by about a factor of ~3 in total error.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>figC = plt.figure()
plt.loglog(linear_psf[ref_pix], cubic_psf[ref_pix], 'k+')
plt.xlabel('Linear interpolation')
plt.ylabel('Cubic interpolation')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="full-trace-psf">
            <h3>
             Full trace PSF
             <a class="headerlink" href="#full-trace-psf" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Now we can generate a full PSF for the spectral trace. Note that the PSF at each wavelength is going to be a linear combination of the overlapping adjacent monochromatic PSFs. If geometric distortion is present, it may be beneficial to create this PSF
             <em>
              after
             </em>
             the trace centers have been fit.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>cube_w, cube_x, cube_y = np.meshgrid(wavelength * 1e-6, psf_x, psf_y, indexing='ij')
full_psf_cube = interpolator((cube_w, cube_x, cube_y))
nw, ny, nx = full_psf_cube.shape
half = ny // 2
trace = np.zeros((ny, nw), dtype=float)

for wl, psf in enumerate(full_psf_cube):
    lo = wl - half
    lo_w = max(lo, 0)
    lo_x = lo_w - lo
    hi = wl + half
    hi_w = min(hi, nw)
    hi_x = nx - (hi - hi_w)
    trace[:, lo_w:hi_w] += psf[:, lo_x:hi_x]
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>wpsf_aspect = nw / (2. * ny)
figD = plt.figure(figsize=(10, 8))
trace_norm = simple_norm(trace, stretch='log', min_cut=1e-4, max_cut=0.2)
plt.imshow(trace, interpolation='none', aspect=wpsf_aspect, norm=trace_norm)
plt.colorbar()
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="resampling-the-trace">
            <h3>
             Resampling the trace
             <a class="headerlink" href="#resampling-the-trace" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Currently, our PSF array is not the same size or position as the trace in the extraction region. While we could shift and trim to the correct size, the spectrum will rarely be centered on a pixel, and is sufficiently under-sampled that fractional pixel shifts in the PSF could cause significant errors in the final extraction. Thus, we will perform a final resampling to the location of the spectrum in the extraction region. To do this, we can use our old friend
             <code class="docutils literal notranslate">
              <span class="pre">
               RegularGridInterpolator
              </span>
             </code>
             . We set the center of the WebbPSF trace (originally at row 23) to our fit trace center, and resample appropriately.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>trace_row = np.arange(ny)
trace_interpolator = RegularGridInterpolator((trace_row, wavelength), trace)
center_0 = 23
center_1 = fit_extraction_kernel.mean_0

out_lo = center_0 - center_1
out_hi = out_lo + er_ny

resample_row = np.linspace(out_lo, out_hi, er_ny)
resample_y, resample_w = np.meshgrid(resample_row, wavelength, indexing='ij')

resampled_trace = trace_interpolator((resample_y, resample_w))

figE, axE = plt.subplots(nrows=2, ncols=1, figsize=(10, 8))
plt.subplots_adjust(hspace=0.1)
trace_renorm = simple_norm(resampled_trace, stretch='log')
axE[0].imshow(resampled_trace, interpolation='none', aspect=aspect_ratio, norm=trace_renorm)
axE[1].imshow(extraction_region, cmap='gray', aspect=aspect_ratio, 
                  norm=er_norm, interpolation='none')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="about-this-notebook">
           <h2>
            About this notebook
            <a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <strong>
             Author:
            </strong>
            Graham Kanarek, Staff Scientist, Science Support
            <br/>
            <strong>
             Updated On:
            </strong>
            2020-07-13
           </p>
           <p>
            Optimal extraction algorithm adapted from
            <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/">
             Horne (1986)
            </a>
            .
           </p>
           <hr class="docutils"/>
           <p>
            <a class="reference external" href="#top">
             Top of Page
            </a>
            <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="float: right;" width="200px"/>
           </p>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/optimal_extraction"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../ifu_optimal/ifu_optimal.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            IFU Optimal Spectral Extraction
           </p>
          </div>
         </a>
         <a class="right-next" href="../mos-spectroscopy/MOSspec_sv06_revised.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            MOS Spectroscopy of Extragalactic Field
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>