<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Composite Model Spectral Fitting — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <script>
   window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}
  </script>
  <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html" rel="next" title="MAST Query"/>
  <link href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html" rel="prev" title="Complex 2D Background"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/composite_model_fitting/specfit_demo_3.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/composite_model_fitting/specfit_demo_3.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h1 nav-item toc-entry">
          <a class="reference internal nav-link" href="#">
           Composite Model Spectral Fitting
          </a>
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#introduction">
             Introduction
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#developer-notes">
               Developer Notes
              </a>
              <ul class="nav section-nav flex-column">
               <li class="toc-h4 nav-item toc-entry">
                <a class="reference internal nav-link" href="#id1">
                 Developer notes:
                </a>
               </li>
              </ul>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#data-input">
             Data input
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#developer-note">
               Developer note
              </a>
             </li>
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id2">
               Developer notes
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#put-the-spectrum-into-a-spectrum1d-object">
             Put the spectrum into a Spectrum1D object
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id3">
               Developer notes
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#read-in-the-spectral-regions">
             Read in the spectral regions
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-a-mask-from-the-regions">
             Create a mask from the regions
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id4">
               Developer note
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
             Convenience routine for plotting a spectrum and highlighting the mask
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id5">
               Developer notes
              </a>
             </li>
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id6">
               Developer notes
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h1 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fitting">
           Fitting
          </a>
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id7">
             Developer notes
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id8">
             Developer note
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h1 nav-item toc-entry">
          <a class="reference internal nav-link" href="#looking-at-the-fit-results">
           Looking at the fit results
          </a>
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id9">
             Developer note
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id10">
             Developer note
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id11">
             Developer note
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#input-and-output-compound-models">
             Input and output compound models
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id12">
               Developer notes
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#plot-the-residuals">
             Plot the residuals
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#plot-individual-components">
             Plot individual components
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#id13">
               Developer notes
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Composite Model Spectral Fitting
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#">
              Composite Model Spectral Fitting
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#introduction">
                Introduction
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#developer-notes">
                  Developer Notes
                 </a>
                 <ul class="nav section-nav flex-column">
                  <li class="toc-h4 nav-item toc-entry">
                   <a class="reference internal nav-link" href="#id1">
                    Developer notes:
                   </a>
                  </li>
                 </ul>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#data-input">
                Data input
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#developer-note">
                  Developer note
                 </a>
                </li>
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id2">
                  Developer notes
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#put-the-spectrum-into-a-spectrum1d-object">
                Put the spectrum into a Spectrum1D object
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id3">
                  Developer notes
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#read-in-the-spectral-regions">
                Read in the spectral regions
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-a-mask-from-the-regions">
                Create a mask from the regions
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id4">
                  Developer note
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
                Convenience routine for plotting a spectrum and highlighting the mask
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id5">
                  Developer notes
                 </a>
                </li>
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id6">
                  Developer notes
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fitting">
              Fitting
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id7">
                Developer notes
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id8">
                Developer note
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#looking-at-the-fit-results">
              Looking at the fit results
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id9">
                Developer note
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id10">
                Developer note
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id11">
                Developer note
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#input-and-output-compound-models">
                Input and output compound models
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id12">
                  Developer notes
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#plot-the-residuals">
                Plot the residuals
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#plot-individual-components">
                Plot individual components
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#id13">
                  Developer notes
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="composite-model-spectral-fitting">
          <h1>
           Composite Model Spectral Fitting
           <a class="headerlink" href="#composite-model-spectral-fitting" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Fitting the complex continuum around Lyman-alpha in the spectrum of an active galaxy NGC 5548.
           <br/>
           <strong>
            Data:
           </strong>
           3-column ECSV file with units for each column.
           <br/>
           <strong>
            Tools:
           </strong>
           specutils, numpy.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           all instruments.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            In this example, we are fitting the complex continuum around Lyman-alpha in the spectrum of an active galaxy (NGC 5548). This involves a powerlaw, extinction, emission lines of various widths and absorption lines. Only certain regions of the spectrum (away from strong absorption lines) are fit. The model has some fixed and some free parameters, as well as parameters that are linked together. We are using the Astropy compound-model machinery to add fit all the components simultaneously.
           </p>
           <p>
            The example makes only partial use of specutils. It reads the data into the Spectrum1D data structure. However, when we get to actually fitting the model, we are just grabbing the numpy arrays (without units, because that caused some errors).
           </p>
           <section id="developer-notes">
            <h3>
             Developer Notes
             <a class="headerlink" href="#developer-notes" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             Todo:
            </p>
            <ul class="simple">
             <li>
              <p>
               Move useful stuff from fit_functions upstream to astropy?
              </p>
             </li>
             <li>
              <p>
               Use units and quantities all the way through
              </p>
             </li>
             <li>
              <p>
               Illustrate fixing and freeing parameters
              </p>
             </li>
             <li>
              <p>
               Illustrate locking and unlocking parameters
              </p>
             </li>
             <li>
              <p>
               Figure out how to introspect the tied parameters (may need a helper class for Astropy modeling)
              </p>
             </li>
             <li>
              <p>
               This model doesn’t fit very well. Change the example.
              </p>
             </li>
             <li>
              <p>
               The covariance cell is returning nothing. Is that intended?
              </p>
              <ul>
               <li>
                <p>
                 might be nice to show a triangle diagram of convariances
                </p>
               </li>
              </ul>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>import numpy as np
import specutils
import time
import astropy.modeling.fitting as fitting
from astropy.table import Table, QTable
from astropy.nddata import StdDevUncertainty
import astropy.units as u
from astropy.visualization import quantity_support
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># import astropy
# import matplotlib
# print("Astropy Version: ",astropy.__version__)
# print("Numpy Version: ",np.__version__)
# print("Specutils Version: ",specutils.__version__)
# print("Matplotlib Version: ",matplotlib.__version__)
</pre>
               </div>
              </div>
             </div>
            </div>
            <section id="id1">
             <h4>
              Developer notes:
              <a class="headerlink" href="#id1" title="Permalink to this headline">
               #
              </a>
             </h4>
             <p>
              Versions:
             </p>
             <ul class="simple">
              <li>
               <p>
                Astropy Version:  3.2.3
               </p>
              </li>
              <li>
               <p>
                Numpy Version:  1.17.3
               </p>
              </li>
              <li>
               <p>
                Specutils Version:  0.6
               </p>
              </li>
              <li>
               <p>
                Matplotlib Version:  3.1.2
               </p>
              </li>
             </ul>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>import matplotlib.pyplot as plt
# inline -- noninteractive cells, notebook -- interactive cells 
%matplotlib inline 
# %matplotlib notebook
%config InlineBackend.figure_format ='retina' # Mackbook optimization
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
           </section>
          </section>
          <section id="data-input">
           <h2>
            Data input
            <a class="headerlink" href="#data-input" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              spectrum: simple 3-column ECSV file with units for each column
             </p>
            </li>
            <li>
             <p>
              wavelength regions to be included in fit: simple 2-column ASCII file with lower &amp; upper bounds
             </p>
            </li>
           </ul>
           <p>
            First set up pathnames.
           </p>
           <section id="developer-note">
            <h3>
             Developer note
             <a class="headerlink" href="#developer-note" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               These data files are small ASCII files, so they are in the github repo with the notebook
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>datafile = "./n5548_mean_g130mb4.ecsv"
regionsfile = "./n5548_lyalpha_sample.dat"
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Read the tables using astropy’s QTable, so that we preserve the units.
            </p>
           </section>
           <section id="id2">
            <h3>
             Developer notes
             <a class="headerlink" href="#id2" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             It would be good if this example provided an example of recommended practice for encoding uncertainties in tables. Questions:
            </p>
            <ul class="simple">
             <li>
              <p>
               Should the uncertainties have units?
              </p>
             </li>
             <li>
              <p>
               Seems like the name “uncertainty” is generally understood to mean standard deviation (or the equivalent). So if one wants to have these be, e.g., variance, the user should name the column
               <code class="docutils literal notranslate">
                <span class="pre">
                 variance
                </span>
               </code>
               .
              </p>
             </li>
             <li>
              <p>
               It’s a bit ugly to have to either add a table column to make these an astropy uncertainty object, or just store that as as a separate variable.
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>data = QTable.read(datafile, format='ascii.ecsv')
data[:3]
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="put-the-spectrum-into-a-spectrum1d-object">
           <h2>
            Put the spectrum into a Spectrum1D object
            <a class="headerlink" href="#put-the-spectrum-into-a-spectrum1d-object" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            We need to convert the uncertainty into an astropy uncertainty object first.
           </p>
           <section id="id3">
            <h3>
             Developer notes
             <a class="headerlink" href="#id3" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             I think it might be simpler to hide the uncertainty type as options to the Spectrum1D call, defaulting to standard-deviation.
            </p>
            <p>
             For example…I first tried what I thought would make sense:
            </p>
            <div class="highlight-default notranslate">
             <div class="highlight">
              <pre><span></span>    <span class="n">data</span><span class="p">[</span><span class="s1">'stdev'</span><span class="p">]</span> <span class="o">=</span> <span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">'uncertainty'</span><span class="p">])</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">specutils</span><span class="o">.</span><span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">'wavelength'</span><span class="p">]</span>
                                <span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">'flux'</span><span class="p">],</span><span class="n">uncertainty</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">'stdev'</span><span class="p">])</span>
</pre>
             </div>
            </div>
            <p>
             That raises an
             <code class="docutils literal notranslate">
              <span class="pre">
               IncompatibleUncertaintiesException
              </span>
             </code>
             .
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>uncertainty = StdDevUncertainty(data['uncertainty'])
spectrum = specutils.Spectrum1D(spectral_axis=data['wavelength'],
                                flux=data['flux'], uncertainty=uncertainty)
print(spectrum)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="read-in-the-spectral-regions">
           <h2>
            Read in the spectral regions
            <a class="headerlink" href="#read-in-the-spectral-regions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Convert these into specutils SpectralRegions.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>regionstab = QTable.read(regionsfile,format='ascii')
subregions = []
for x0,x1 in zip(regionstab['col1'],regionstab['col2']):
    subregions += [(x0*u.AA, x1*u.AA)]
regions=specutils.SpectralRegion(subregions)
regions
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="create-a-mask-from-the-regions">
           <h2>
            Create a mask from the regions
            <a class="headerlink" href="#create-a-mask-from-the-regions" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id4">
            <h3>
             Developer note
             <a class="headerlink" href="#id4" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We could probably do the whole workflow extracting regions, but I think it would end up being uglier than using a mask.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def mask_from_regions(spectrum,regions):
    mask = np.zeros(spectrum.spectral_axis.shape,dtype=np.bool)
    for r in regions:
        submask = (spectrum.spectral_axis&gt;r.lower) &amp; (spectrum.spectral_axis&lt;=r.upper)
        mask = mask | submask
    spectrum.mask = mask
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>mask_from_regions(spectrum,regions)
print(spectrum.mask.min(), spectrum.mask.max())
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask">
           <h2>
            Convenience routine for plotting a spectrum and highlighting the mask
            <a class="headerlink" href="#convenience-routine-for-plotting-a-spectrum-and-highlighting-the-mask" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id5">
            <h3>
             Developer notes
             <a class="headerlink" href="#id5" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               I think this way of illustrating the mask is reasonably elegant. I sort of like it better than having the shaded regions extend all the way up to the top. (I do that later when showing the residuals, for comparison).
              </p>
             </li>
             <li>
              <p>
               Another way to do it might be to change the line color to grey, or change the opacity, in the masked regions, but that would be harder to implement and probably slower.
              </p>
             </li>
             <li>
              <p>
               This routine exposes both a benefit of using units and Spectrum1D – you can automatically put the units on the axis
              </p>
             </li>
             <li>
              <p>
               This also exposes a limitation: Right now, while quantity_support() puts the units on the axis automaticall, it doesn’t put the label. It is the standard convention to give
               <code class="docutils literal notranslate">
                <span class="pre">
                 label
                </span>
                <span class="pre">
                 (units)
                </span>
               </code>
               when labeling axes. The trick used here of adding in the label using
               <code class="docutils literal notranslate">
                <span class="pre">
                 get_label()
                </span>
               </code>
               and
               <code class="docutils literal notranslate">
                <span class="pre">
                 set_label()
                </span>
               </code>
               is liable to be too obscure for most users.
              </p>
             </li>
             <li>
              <p>
               Are we going to keep all visualization for specviz, or should there be some tools for visualization in specutils?
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>def plot_spectrum(spectrum,color='b',alpha=0.5,figsize=(15,6),
                  label=None,ax=None,plot_mask=True,
                  mask_color='g',mask_alpha=0.1,title=None):
    with quantity_support():
        if ax is None:
            fig, ax = plt.subplots(figsize=figsize)
        ax.plot(spectrum.spectral_axis,spectrum.flux,color=color,alpha=alpha,label=label)
        if plot_mask: 
            if spectrum.mask is not None:
                ax.fill_between(spectrum.spectral_axis,0,spectrum.flux*spectrum.mask,
                        alpha=mask_alpha,color=mask_color)
    ax.set_xlabel(r"Wavelength (" + ax.get_xlabel() + ")")
    ax.set_ylabel(r"Flux (" + ax.get_ylabel() + ")")
    return ax
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ax = plot_spectrum(spectrum)
ax.set_title('NGC 5548 spectrum and mask to be used for fitting the model');
</pre>
               </div>
              </div>
             </div>
            </div>
            <h1>
             First guess model
            </h1>
            <p>
             The model is imported directly:
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>import n5548_models as models
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             The .py module defined above builds one or more instances of a special type of function defined in the astropy.modeling.models package, called a “compound model”.
            </p>
            <p>
             A compound model is just a combination of astropy.modeling.models functions, using as combination operators such things as addition, multiplication, and others.
            </p>
            <p>
             Example:
            </p>
            <p>
             <code>
              compound_model = models.PowerLaw1D(1.,1.) + models.Gaussian1D(1.,1.,1.)
             </code>
            </p>
            <p>
             will create an instance of a compound model with two components.
            </p>
            <p>
             An actual, importable model definition will look like this:
            </p>
            <div class="highlight-python notranslate">
             <div class="highlight">
              <pre><span></span><span class="kn">from</span> <span class="nn">custom_models</span> <span class="kn">import</span> <span class="n">gaussian</span><span class="p">,</span> <span class="n">powerlaw</span><span class="p">,</span> <span class="n">ccmext</span>

<span class="n">model1</span> <span class="o">=</span> \
    <span class="n">powerlaw</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'powerlaw1'</span><span class="p">,</span>
             <span class="n">amp</span> <span class="o">=</span>   <span class="mf">6.586200E-14</span><span class="p">,</span>
             <span class="n">x_0</span> <span class="o">=</span>   <span class="mf">1000.0</span><span class="p">,</span>
             <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4819233</span><span class="p">,</span>
             <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'amp'</span><span class="p">:</span>   <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-11</span><span class="p">),</span>
                       <span class="s1">'x_0'</span><span class="p">:</span>   <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-11</span><span class="p">),</span>
                       <span class="s1">'alpha'</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)},</span>
             <span class="n">fixed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'x_0'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
             <span class="p">)</span> \
<span class="o">+</span> \
    <span class="n">gaussian</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'C III 1176'</span><span class="p">,</span>
             <span class="n">norm</span> <span class="o">=</span> <span class="mf">2.000000E-14</span><span class="p">,</span>
             <span class="n">mean</span> <span class="o">=</span> <span class="mf">1195.006</span><span class="p">,</span>
             <span class="n">fwhm</span> <span class="o">=</span> <span class="mf">861.4926</span><span class="p">,</span>
             <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'norm'</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.00E-10</span><span class="p">),</span>
                       <span class="s1">'mean'</span><span class="p">:</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="mf">2000.</span><span class="p">),</span>
                       <span class="s1">'fwhm'</span><span class="p">:</span> <span class="p">(</span><span class="mf">1000.</span><span class="p">,</span> <span class="mf">2000.</span><span class="p">),</span>
                       <span class="s1">'skew'</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)},</span>
             <span class="n">fixed</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'norm'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">'mean'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">'fwhm'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="s1">'skew'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
             <span class="p">)</span> \
</pre>
             </div>
            </div>
            <p>
             For this exercise, we pick the model named ‘model1’:
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>compound_model = models.model1
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             The module uses some special function types, defined by overriding the standard functions in asytropy.modeling.models in module custom_models.
            </p>
            <p>
             This overriding is necessary because the spectral components in specfit do not conform with the standards defined in astropy.modeling.models. For example, a Gaussian in specfit is defined by an amplitude, a central wavelength, a FWHM in km/s, and a skweness parameter. In astropy.modeling.models a Gaussian is defined by an amplitude, a central wavelength, and a width in units consistent with the units of the central wavelength. And no skewness parameter. These incompatibilities are addressed by the sub-classes defined in the fit_functions module.
            </p>
           </section>
           <section id="id6">
            <h3>
             Developer notes
             <a class="headerlink" href="#id6" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               Seems useful to have a Gaussian with skew as an Astropy model, so that should probably be moved upstream.
              </p>
             </li>
             <li>
              <p>
               Not sure about the FWHM. It’s probably cleaner for that to be the width parameter when there is skewness, since it’s more intuitive than standard deviation.
              </p>
             </li>
             <li>
              <p>
               The print statement for the compound model below is okay but not great. Might be worth having a pretty print for notebooks that makes this more readable.
              </p>
              <ul>
               <li>
                <p>
                 This print statement does not indicate which parameters are fixed or floating
                </p>
               </li>
               <li>
                <p>
                 It does not indicate which parameters are tied to others and how
                </p>
               </li>
               <li>
                <p>
                 There is an ellipsis in the table at the end
                </p>
               </li>
              </ul>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>print(compound_model)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ax = plot_spectrum(spectrum,label='data')
ax.plot(spectrum.spectral_axis, compound_model(spectrum.spectral_axis.value), 'r',label='initial model')
ax.legend()
ax.set_title("Data and initial model");
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
         </section>
         <section class="tex2jax_ignore mathjax_ignore" id="fitting">
          <h1>
           Fitting
           <a class="headerlink" href="#fitting" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           We have the data and the model, now we need to fit one to the other. We can use that by instantiating an Astropy fitter, in this case the
           <code class="docutils literal notranslate">
            <span class="pre">
             LevMarLSQFitter
            </span>
           </code>
           which uses the Levenberg-Marquardt algorithm for least-squares fitting.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span>fitter = fitting.LevMarLSQFitter()
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           In this example, we have access to the errors for the data points, so we can use their inverse as weights for the fit. To include the mask, which is
           <code class="docutils literal notranslate">
            <span class="pre">
             1
            </span>
           </code>
           for pixels we want to fit and
           <code class="docutils literal notranslate">
            <span class="pre">
             0
            </span>
           </code>
           for pixels we want to exclude, we take
           <span class="math notranslate nohighlight">
            \(\rm {mask} / \sigma\)
           </span>
           , as the weight to give to the fitter.
          </p>
          <section id="id7">
           <h2>
            Developer notes
            <a class="headerlink" href="#id7" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              Because the compound model fitting didn’t work out of the box feeding it the Specutils
              <code class="docutils literal notranslate">
               <span class="pre">
                spectral_axis
               </span>
              </code>
              and
              <code class="docutils literal notranslate">
               <span class="pre">
                flux
               </span>
              </code>
              Quanitities, I’m getting rid of the units. In conversation, it seems like there is some machinery for removing the units and putting them back in
              <code class="docutils literal notranslate">
               <span class="pre">
                fit_line
               </span>
              </code>
              (which is more general than just fitting a line), but I didn’t think to look there.
             </p>
            </li>
            <li>
             <p>
              While it agrees with the scipy fitter conventions, I think it is quite confusing to call
              <span class="math notranslate nohighlight">
               \(w = 1/\sigma\)
              </span>
              the
              <em>
               weight
              </em>
              . I checked the code and for this fitter, indeed it is squaring this to use as the weight, so the calculation is correct. But I think it is more common to think of the correct weight as being
              <span class="math notranslate nohighlight">
               \(w = 1/\sigma^2\)
              </span>
              for least-squares fitting. I’ve now gone down the rabbit hole of trying to double-check that Astropy is doing the weighting correctly twice because of this unusual use of the word “weight.”
             </p>
            </li>
            <li>
             <p>
              Nadia Dencheva is going to check that the non-least-squares fitters are using weight when their instructions say use
              <span class="math notranslate nohighlight">
               \(1/\sigma\)
              </span>
              – i.e. are they squaring it or not before computing the merit function?
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>wavelength = spectrum.spectral_axis.value
flux = spectrum.flux.value
inverse_sigma = spectrum.mask/spectrum.uncertainty.array
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            To do the fit, call the fitter instance with the data, weights, and some control parameters if needed. Let’s do some timing as well:
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>start_time = time.time()
fit_result = fitter(compound_model, wavelength, flux, weights=inverse_sigma, acc=1.E-30, maxiter=6000)
end_time = time.time()
print("Elapsed time: ", end_time - start_time)
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="id8">
           <h2>
            Developer note
            <a class="headerlink" href="#id8" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              I’m not sure how to interpret the fit_info message below that
             </p>
            </li>
           </ul>
           <div class="highlight-Both notranslate">
            <div class="highlight">
             <pre><span></span> are at most 0.0000001```
</pre>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>print(fitter.fit_info['message'])
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            The result is another instance of a compound model, with the fitted values set into the  parameter values:
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>print(fit_result)
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Lets print some derived results:
           </p>
          </section>
         </section>
         <section class="tex2jax_ignore mathjax_ignore" id="looking-at-the-fit-results">
          <h1>
           Looking at the fit results
           <a class="headerlink" href="#looking-at-the-fit-results" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           Create a little routine to estimate chisq. It needs to compute the number of degrees of freedom taking into account the mask and the number of free parameters.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span>def chisq(x, y, err, mask, model, nfree):
    chisq = (y - model(x))**2 / err**2
    chisq = np.sum(chisq * mask)
    npoints = np.sum(mask)
    return np.sqrt(chisq / (npoints - nfree - 1)) 
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           Figure out how many fixed and free parameters there are.
          </p>
          <section id="id9">
           <h2>
            Developer note
            <a class="headerlink" href="#id9" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              This is pretty ugly and involved. The fitter knows how many data points and free parameters there are, but I don’t think it passes that information along as “metadata” to the fit results. The fit_info is a dictionary returned from
              <code class="docutils literal notranslate">
               <span class="pre">
                scipy.optimize.leastsq
               </span>
              </code>
              , but it doesn’t have the number of free parameters.
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>if 'fixed' in fit_result.parameter_constraints:
    fix = np.asarray(fit_result.fixed.values())
    n_fixed_parameters = np.sum(np.where(fix, 1, 0))
else:
    n_fixed_parameters = 0

if 'tied' in fit_result.parameter_constraints:
    tie = np.asarray(fit_result.tied.values())
    n_tied_parameters = np.sum(np.where(tie, 1, 0))
else:
    n_tied_parameters = 0
    
n_free_par = len(fit_result.parameters) - n_fixed_parameters - n_tied_parameters
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Print out
            <span class="math notranslate nohighlight">
             \(\chi^2\)
            </span>
            and other relevant info.
           </p>
          </section>
          <section id="id10">
           <h2>
            Developer note
            <a class="headerlink" href="#id10" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              This kind of thing ought to be standard output
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>chisq_in = chisq(wavelength, flux, spectrum.uncertainty.array, spectrum.mask, compound_model, n_free_par)
chisq_out = chisq(wavelength, flux, spectrum.uncertainty.array, spectrum.mask, fit_result, n_free_par)
print("chisq from input model:  %f" % chisq_in)
print("chisq from output model: %f" % chisq_out)
print("Total data points: %d" % len(wavelength))
print("Data points in wavelength ranges: %d" % np.sum(spectrum.mask))
print("Number of free parameters: %d" % n_free_par)
print("Number of iterations: %d" % fitter.fit_info['nfev'])
print ("Fit engine took %d elapsed seconds." % (end_time - start_time))
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            Errors associated with each free parameter from the covariance matrix.
           </p>
          </section>
          <section id="id11">
           <h2>
            Developer note
            <a class="headerlink" href="#id11" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              This is empty. But it actually is in the fit_info from this fitter, so we could grab it.
             </p>
            </li>
            <li>
             <p>
              It would be nice in a more advanced version of this notebook to show someone how to plot the error ellipses in a triangle (corner) plot, which is a good way to visualize correlations between pairs of parameters.
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>cov = fitter.fit_info['param_cov']

param_errors = {}
i = 0
if cov is not None:
    # extract variances from covariance matrix
    fit_errors = {}
    for param_name in fit_result.param_names:
        fixed = fit_result.fixed[param_name]
        tied = fit_result.tied[param_name]
        if not fixed and not tied:
            fit_errors[param_name] = math.sqrt(cov[i,i])
            i += 1
            
    # map errors to input model's components and parameters.
    for param_name in fit_errors.keys():
        index, target_param_name = fit_result._param_map[param_name]
        component_name = fit_result._submodels_names[index]
        param_errors[(component_name, target_param_name)] = fit_errors[param_name]

print(param_errors)
</pre>
              </div>
             </div>
            </div>
           </div>
           <h1>
            Plots
           </h1>
          </section>
          <section id="input-and-output-compound-models">
           <h2>
            Input and output compound models
            <a class="headerlink" href="#input-and-output-compound-models" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id12">
            <h3>
             Developer notes
             <a class="headerlink" href="#id12" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               A fancy, but
               <em>
                very
               </em>
               useful interactive version of this plot might have the following features
              </p>
              <ul>
               <li>
                <p>
                 Zoom &amp; pan, etc (could get that by using %matplotlib notebook, but scrolling is a pain with that)
                </p>
               </li>
               <li>
                <p>
                 Ability to toggle from curves to histograms for the data
                </p>
               </li>
               <li>
                <p>
                 Ability to toggle on and off the mask, change alpha, etc
                </p>
               </li>
               <li>
                <p>
                 Ability to toggle on and off errorbars on the data, change alpha, etc
                </p>
               </li>
               <li>
                <p>
                 Hover information: data, residual, percent contribution to chisq for that one point
                </p>
               </li>
               <li>
                <p>
                 Ability to toggle on and off individual components of the compound model
                </p>
                <ul>
                 <li>
                  <p>
                   That wouldn’t be all that useful in this example, since it’s better to see them on top of the powerlaw*extinction, but that’s a pretty special use case.
                  </p>
                 </li>
                </ul>
               </li>
              </ul>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ax = plot_spectrum(spectrum,label='data')
ax.plot(wavelength, compound_model(wavelength), 'r',label='initial model')
ax.plot(wavelength, fit_result(wavelength), 'g',label='fitted model')
ax.set_xlim((1200,1275))
ax.set_ylim((0,7e-13))
ax.legend()
ax.set_title("Data and models");
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="plot-the-residuals">
           <h2>
            Plot the residuals
            <a class="headerlink" href="#plot-the-residuals" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Focus in on the most interesting region.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>ylim = (-2.e-13, 2.e-13)
fig,ax = plt.subplots(figsize=(15,6))
ax.plot(wavelength,flux-compound_model(wavelength),label='original')
ax.plot(wavelength,flux-fit_result(wavelength),label='original')
ax.fill_between(wavelength,ylim[0]*spectrum.mask,ylim[1]*spectrum.mask,
                        alpha=0.1,color='g')
ax.set_xlim((1185., 1270.))
ax.set_ylim(ylim)
ax.legend()
ax.set_xlabel(r'Wavelength ($\rm \AA$)',fontsize='large')
ax.set_ylabel(r'Flux ($\rm erg\, cm^{-2}\, s^{-1}\, \AA^{-1}$)',fontsize='large')
ax.set_title('Residuals',fontsize='large');
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="plot-individual-components">
           <h2>
            Plot individual components
            <a class="headerlink" href="#plot-individual-components" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Here we plot them on top of the basic powerlaw*extinction
           </p>
           <section id="id13">
            <h3>
             Developer notes
             <a class="headerlink" href="#id13" title="Permalink to this headline">
              #
             </a>
            </h3>
            <ul class="simple">
             <li>
              <p>
               I was trying to label or otherwise indicate which ones are tied together, but it seems like this information gets lost because because tying parameters is just done by passing a function. It might be better for Astropy to have a base class that people can use that would have the name of the referenced parameter as an attribute and has a
               <code class="docutils literal notranslate">
                <span class="pre">
                 __call__
                </span>
               </code>
               method. Then one could at least recommend that people use this when tying parameters, to facilitate later introspection.
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ax = plot_spectrum(spectrum,label='data')
ax.plot(wavelength, fit_result(wavelength), 'g',label='fitted model')
plext = fit_result['powerlaw1'] * fit_result['extinction']
ax.plot(wavelength,plext(wavelength),'--',alpha=0.5,linewidth=5,label="powerlaw + extinction")
for component in fit_result:
    if component.name != 'powerlaw1' and component.name != 'extinction':
        ax.plot(wavelength,(plext+component)(wavelength),label=component.name,alpha=0.5)
ax.set_xlim((1200,1275))
ax.set_ylim((0,9e-13))
ax.legend(loc='upper right',fontsize='small')
ax.set_title("Data and models");
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/composite_model_fitting"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            Complex 2D Background
           </p>
          </div>
         </a>
         <a class="right-next" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            MAST Query
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>