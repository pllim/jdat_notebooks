<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Cross-Filter PSF Matching — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../psf_photometry/NIRCam_PSF_Photometry_Example.html" rel="next" title="PSF Photometry"/>
  <link href="../NIRCam_photometry/NIRCam_multiband_photometry.html" rel="prev" title="Extended Aperture Photometry"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#import-packages">
           Import packages
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
             Matplotlib setup for plotting
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-list-of-images-to-be-loaded-and-analyzed">
             Create list of images to be loaded and analyzed
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-detection-image-f200w">
             Load detection image: F200W
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#report-image-size-and-field-of-view">
             Report image size and field of view
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#create-color-images-optional">
             Create color images (optional)
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#detect-sources-and-deblend-using-astropy-photutils">
             Detect Sources and Deblend using astropy.photutils
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#measure-photometry-and-more-in-detection-image">
             Measure photometry (and more) in detection image
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#show-detections-alongside-images-optional">
             Show detections alongside images (optional)
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#view-save-measured-quantities-in-detection-image-optional">
             View / save measured quantities in detection image (optional)
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#only-keep-some-quantities">
             Only keep some quantities
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#convert-measured-fluxes-data-units-to-magnitudes">
             Convert measured fluxes (data units) to magnitudes
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image">
             Multiband photometry using isophotal apertures defined in detection image
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes">
             Aperture corrections: isophotal to total (Kron aperture) fluxes
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#reformat-output-catalog-for-readability-optional">
             Reformat output catalog for readability (optional)
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#isophotal-photometry-without-psf-corrections-complete">
             Isophotal Photometry without PSF corrections complete
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#psf-magnitude-corrections">
           PSF magnitude corrections
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-psfs">
             Load PSFs
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#psf-matching">
           PSF Matching
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#determine-psf-convolution-kernels">
             Determine PSF convolution kernels
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#convolve-f200w-detection-image-to-long-wavelength-psfs">
           Convolve F200W detection image to Long Wavelength PSFs
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#multiband-photometry-in-convolved-images">
             Multiband photometry in convolved images
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             PSF magnitude corrections
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#start-new-session-and-analyze-results">
           Start new session and analyze results
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-catalog-and-segmentation-map">
             Load catalog and segmentation map
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#input-simulation-jades-jaguar-catalog">
           Input simulation JADES JAGUAR catalog
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#match-objects-to-photutils-catalog">
             Match objects to photutils catalog
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">
             Plot F200W vs. F090W magnitudes and look for dropouts
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#show-selected-object-in-all-filters">
             Show selected object in all filters
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#plot-spectral-energy-distribution-sed-for-one-object">
           Plot Spectral Energy Distribution (SED) for one object
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Cross-Filter PSF Matching
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#import-packages">
              Import packages
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
                Matplotlib setup for plotting
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-list-of-images-to-be-loaded-and-analyzed">
                Create list of images to be loaded and analyzed
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-detection-image-f200w">
                Load detection image: F200W
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#report-image-size-and-field-of-view">
                Report image size and field of view
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#create-color-images-optional">
                Create color images (optional)
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#detect-sources-and-deblend-using-astropy-photutils">
                Detect Sources and Deblend using astropy.photutils
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#measure-photometry-and-more-in-detection-image">
                Measure photometry (and more) in detection image
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#show-detections-alongside-images-optional">
                Show detections alongside images (optional)
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#view-save-measured-quantities-in-detection-image-optional">
                View / save measured quantities in detection image (optional)
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#only-keep-some-quantities">
                Only keep some quantities
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#convert-measured-fluxes-data-units-to-magnitudes">
                Convert measured fluxes (data units) to magnitudes
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image">
                Multiband photometry using isophotal apertures defined in detection image
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes">
                Aperture corrections: isophotal to total (Kron aperture) fluxes
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#reformat-output-catalog-for-readability-optional">
                Reformat output catalog for readability (optional)
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#isophotal-photometry-without-psf-corrections-complete">
                Isophotal Photometry without PSF corrections complete
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#psf-magnitude-corrections">
              PSF magnitude corrections
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-psfs">
                Load PSFs
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#psf-matching">
              PSF Matching
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#determine-psf-convolution-kernels">
                Determine PSF convolution kernels
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#convolve-f200w-detection-image-to-long-wavelength-psfs">
              Convolve F200W detection image to Long Wavelength PSFs
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#multiband-photometry-in-convolved-images">
                Multiband photometry in convolved images
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                PSF magnitude corrections
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#start-new-session-and-analyze-results">
              Start new session and analyze results
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-catalog-and-segmentation-map">
                Load catalog and segmentation map
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#input-simulation-jades-jaguar-catalog">
              Input simulation JADES JAGUAR catalog
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#match-objects-to-photutils-catalog">
                Match objects to photutils catalog
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">
                Plot F200W vs. F090W magnitudes and look for dropouts
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#show-selected-object-in-all-filters">
                Show selected object in all filters
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#plot-spectral-energy-distribution-sed-for-one-object">
              Plot Spectral Energy Distribution (SED) for one object
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="cross-filter-psf-matching">
          <h1>
           Cross-Filter PSF Matching
           <a class="headerlink" href="#cross-filter-psf-matching" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Measure galaxy photometry in an extragalactic “blank” field. Related to
           <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-example-science-programs/nircam-deep-field-imaging-with-miri-imaging-parallels">
            JDox Science Use Case #22
           </a>
           .
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRCam images from
           <a class="reference external" href="http://fenrir.as.arizona.edu/jwstmock/">
            JADES JWST GTO extragalactic blank field
           </a>
           .
           <br/>
           (Williams et al. 2018)
           <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2018ApJS..236...33W">
            https://ui.adsabs.harvard.edu/abs/2018ApJS..236…33W
           </a>
           .
           <br/>
           <strong>
            Tools:
           </strong>
           photutils, matplotlib.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           potentially NIRISS, MIRI.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This notebook uses
            <code class="docutils literal notranslate">
             <span class="pre">
              photutils
             </span>
            </code>
            to detect objects/galaxies in NIRCam deep imaging.  Detections are first made in a F200W image, then isophotal photometry is obtained in all 9 filters (F090W, F115W, F150W, F200W, F277W, F335M, F356W, F410M, F444W). PSF-matching is used to correct photometry measured in the Long Wavelength images (redder than F200W).
           </p>
           <p>
            After saving the photometry catalog, the notebook demonstrates how one would load the notebook in a new session.
It demonstrates some simple analysis of the full catalog and on an individual galaxy.
By comparing the measured colors to simulated input colors,
it shows the measurements are more accurate after PSF corrections, though they could be improved further.
           </p>
           <p>
            The notebook analyzes only the central 1000 x 1000 pixels (30” x 30”) of the full JADES simulation. These cutouts have been staged at STScI with permission from the authors (Williams et al.).
           </p>
           <p>
            <strong>
             NOTES:
            </strong>
           </p>
           <ul class="simple">
            <li>
             <p>
              This is a work in progress. More accurate photometry may be obtainable.
             </p>
            </li>
            <li>
             <p>
              These JADES images are simulated using
              <a class="reference external" href="https://github.com/cnaw/guitarra">
               Guitarra
              </a>
              ,
not
              <a class="reference external" href="https://github.com/spacetelescope/mirage">
               MIRAGE
              </a>
              .
They have different properties and units (e-/s) than JWST pipeline products (MJy/sr).
             </p>
            </li>
            <li>
             <p>
              All images are aligned to the same 0.03” pixel grid prior to analysis. This alignment can be done using
              <a class="reference external" href="https://reproject.readthedocs.io">
               <code class="docutils literal notranslate">
                <span class="pre">
                 reproject
                </span>
               </code>
              </a>
              , if needed.
             </p>
            </li>
            <li>
             <p>
              The flux uncertainty calculations could be improved further by accounting for correlated noise and/or measuring the noise in each image more directly.
             </p>
            </li>
           </ul>
           <p>
            <em>
             Developer’s Note:
            </em>
           </p>
           <p>
            Summary of issues reported below:
           </p>
           <ul class="simple">
            <li>
             <p>
              units work with
              <code class="docutils literal notranslate">
               <span class="pre">
                plot
               </span>
              </code>
              but are incompatible with
              <code class="docutils literal notranslate">
               <span class="pre">
                errorbar
               </span>
              </code>
              and
              <code class="docutils literal notranslate">
               <span class="pre">
                text
               </span>
              </code>
             </p>
            </li>
            <li>
             <p>
              flux units can be automatically converted to AB magnitudes,
but flux
              <em>
               uncertainties
              </em>
              cannot be automatically converted to magnitude uncertainties
             </p>
            </li>
            <li>
             <p>
              secondary axis should automatically handle conversion between flux and AB magnitude units
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                sharex
               </span>
              </code>
              and
              <code class="docutils literal notranslate">
               <span class="pre">
                sharey
               </span>
              </code>
              don’t work with WCS
              <code class="docutils literal notranslate">
               <span class="pre">
                projection
               </span>
              </code>
             </p>
            </li>
           </ul>
           <p>
            And I couldn’t figure out how to:
           </p>
           <ul class="simple">
            <li>
             <p>
              Make plot axes autoscale to only
              <em>
               some
              </em>
              of plotted data
             </p>
            </li>
            <li>
             <p>
              Make tooltips hover over data points under cursor in interactive plot
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Check PEP 8 style formatting
# %load_ext pycodestyle_magic
# %flake8_on --ignore E261,E501,W291,W2,E302,E305
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="import-packages">
           <h2>
            Import packages
            <a class="headerlink" href="#import-packages" title="Permalink to this headline">
             #
            </a>
           </h2>
           <ul class="simple">
            <li>
             <p>
              Numpy for general array computations
             </p>
            </li>
            <li>
             <p>
              Photutils for photometry calculations, PSF matching
             </p>
            </li>
            <li>
             <p>
              Astropy for FITS, WCS, tables, units, color images, plotting, convolution
             </p>
            </li>
            <li>
             <p>
              os and glob for file management
             </p>
            </li>
            <li>
             <p>
              copy for table modfications
             </p>
            </li>
            <li>
             <p>
              Matplotlib for plotting
             </p>
            </li>
            <li>
             <p>
              Watermark to check versions of all imports (optional)
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import numpy as np
import os
from glob import glob
from copy import deepcopy

import astropy  # version 4.2 is required to write magnitudes to ecsv file
from astropy.io import fits
import astropy.wcs as wcs
from astropy.table import QTable, Table
import astropy.units as u
from astropy.visualization import make_lupton_rgb, SqrtStretch, LogStretch, hist
from astropy.visualization.mpl_normalize import ImageNormalize
from astropy.convolution import Gaussian2DKernel
from astropy.stats import gaussian_fwhm_to_sigma
from astropy.coordinates import SkyCoord

import photutils
# print('photutils', photutils.__version__)
from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
from photutils.utils import calc_total_error

from photutils.psf.matching import resize_psf, SplitCosineBellWindow, create_matching_kernel
from astropy.convolution import convolve, convolve_fft # , Gaussian2DKernel, Tophat2DKernel
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stderr highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/tmp/ipykernel_3670/3714986504.py:19: DeprecationWarning: `photutils.Background2D` is a deprecated alias for `photutils.background.Background2D` and will be removed in the future. Instead, please use `from photutils.background import Background2D` to silence this warning.
  from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
/tmp/ipykernel_3670/3714986504.py:19: DeprecationWarning: `photutils.MedianBackground` is a deprecated alias for `photutils.background.MedianBackground` and will be removed in the future. Instead, please use `from photutils.background import MedianBackground` to silence this warning.
  from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
/tmp/ipykernel_3670/3714986504.py:19: DeprecationWarning: `photutils.detect_sources` is a deprecated alias for `photutils.segmentation.detect_sources` and will be removed in the future. Instead, please use `from photutils.segmentation import detect_sources` to silence this warning.
  from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
/tmp/ipykernel_3670/3714986504.py:19: DeprecationWarning: `photutils.deblend_sources` is a deprecated alias for `photutils.segmentation.deblend_sources` and will be removed in the future. Instead, please use `from photutils.segmentation import deblend_sources` to silence this warning.
  from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
/tmp/ipykernel_3670/3714986504.py:19: DeprecationWarning: `photutils.SourceCatalog` is a deprecated alias for `photutils.segmentation.SourceCatalog` and will be removed in the future. Instead, please use `from photutils.segmentation import SourceCatalog` to silence this warning.
  from photutils import Background2D, MedianBackground, detect_sources, deblend_sources, SourceCatalog#, source_properties (new API)
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="matplotlib-setup-for-plotting">
            <h3>
             Matplotlib setup for plotting
             <a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             There are two versions
            </p>
            <ul class="simple">
             <li>
              <p>
               <code class="docutils literal notranslate">
                <span class="pre">
                 notebook
                </span>
               </code>
               – gives interactive plots, but makes the overall notebook a bit harder to scroll
              </p>
             </li>
             <li>
              <p>
               <code class="docutils literal notranslate">
                <span class="pre">
                 inline
                </span>
               </code>
               – gives non-interactive plots for better overall scrolling
              </p>
             </li>
            </ul>
            <p>
             <em>
              Developer’s Notes:
             </em>
            </p>
            <div class="highlight-none notranslate">
             <div class="highlight">
              <pre><span></span>`%matplotlib notebook` occasionally creates oversized plot; need to rerun cell to get it to settle back down
</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>import matplotlib.pyplot as plt
import matplotlib as mpl

# Use this version for non-interactive plots (easier scrolling of the notebook)
%matplotlib inline

# Use this version if you want interactive plots
# %matplotlib notebook

import matplotlib.ticker as ticker
mpl_colors = plt.rcParams['axes.prop_cycle'].by_key()['color']

# These gymnastics are needed to make the sizes of the figures
# be the same in both the inline and notebook versions
%config InlineBackend.print_figure_kwargs = {'bbox_inches': None}

mpl.rcParams['savefig.dpi'] = 100
mpl.rcParams['figure.dpi'] = 100

import mplcursors  # optional to hover over plotted points and reveal ID number
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Show versions of Python and imported libraries
try:
    import watermark
    %load_ext watermark
    # %watermark -n -v -m -g -iv
    %watermark -iv -v
except ImportError:
    pass
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="create-list-of-images-to-be-loaded-and-analyzed">
            <h3>
             Create list of images to be loaded and analyzed
             <a class="headerlink" href="#create-list-of-images-to-be-loaded-and-analyzed" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             All data and weight images must be aligned to the same pixel grid.
(If needed, use
             <a class="reference external" href="https://reproject.readthedocs.io">
              <code class="docutils literal notranslate">
               <span class="pre">
                reproject
               </span>
              </code>
             </a>
             to do so.)
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>input_file_url = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/'

filters = 'F090W F115W F150W F200W F277W F335M F356W F410M F444W'.split()
wavelengths = np.array([int(filt[1:4]) / 100 for filt in filters]) * u.um  # e.g., F115W = 1.15 microns

# Data images [e-/s], unlike JWST pipeline images that will have units [Myr/sr]
image_files = {}
for filt in filters:
    filename = f'jades_jwst_nircam_goods_s_crop_{filt}.fits'
    image_files[filt] = os.path.join(input_file_url, filename)

# Weight images (Inverse Variance Maps; IVM)
weight_files = {}
for filt in filters:
    filename = f'jades_jwst_nircam_goods_s_crop_{filt}_wht.fits'
    weight_files[filt] = os.path.join(input_file_url, filename)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="load-detection-image-f200w">
            <h3>
             Load detection image: F200W
             <a class="headerlink" href="#load-detection-image-f200w" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>detection_filter = filt = 'F200W'
infile = image_files[filt]
hdu = fits.open(infile)
data = hdu[0].data
imwcs = wcs.WCS(hdu[0].header, hdu)

weight = fits.open(weight_files[filt])[0].data
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="report-image-size-and-field-of-view">
            <h3>
             Report image size and field of view
             <a class="headerlink" href="#report-image-size-and-field-of-view" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>ny, nx = data.shape
# image_pixel_scale = np.abs(hdu[0].header['CD1_1']) * 3600
image_pixel_scale = wcs.utils.proj_plane_pixel_scales(imwcs)[0] 
image_pixel_scale *= imwcs.wcs.cunit[0].to('arcsec')
outline = '%d x %d pixels' % (ny, nx)
outline += ' = %g" x %g"' % (ny * image_pixel_scale, nx * image_pixel_scale)
outline += ' (%.2f" / pixel)' % image_pixel_scale
print(outline)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>1000 x 1000 pixels = 30" x 30" (0.03" / pixel)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="create-color-images-optional">
            <h3>
             Create color images (optional)
             <a class="headerlink" href="#create-color-images-optional" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># 3 NIRCam short wavelength channel images
r = fits.open(image_files['F200W'])[0].data
g = fits.open(image_files['F150W'])[0].data
b = fits.open(image_files['F090W'])[0].data
color_image_short_wavelength = make_lupton_rgb(r, g, b, Q=5, stretch=0.02) # , minimum=-0.001
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># 3 NIRCam long wavelength channel images
r = fits.open(image_files['F444W'])[0].data
g = fits.open(image_files['F356W'])[0].data
b = fits.open(image_files['F277W'])[0].data

color_image_long_wavelength = make_lupton_rgb(r, g, b, Q=5, stretch=0.02) # , minimum=-0.001
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             <em>
              Developer’s Note:
             </em>
            </p>
            <div class="highlight-none notranslate">
             <div class="highlight">
              <pre><span></span>sharex &amp; sharey appear to have some compatibility issues with projection=imwcs

As a workaround, I tried but was unable to turn off yticklabels in the right plot below
</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig = plt.figure(figsize=(9.5, 4))

ax_sw = fig.add_subplot(1, 2, 1, projection=imwcs) # , sharex=True, sharey=True)
ax_sw.imshow(color_image_short_wavelength, origin='lower')
ax_sw.set_xlabel('Right Ascension')
ax_sw.set_ylabel('Declination')
ax_sw.set_title('Short Wavelength Channel')

ax_lw = fig.add_subplot(1, 2, 2, projection=imwcs, sharex=ax_sw, sharey=ax_sw)
ax_lw.imshow(color_image_long_wavelength, origin='lower')
ax_lw.set_xlabel('Right Ascension')
ax_lw.set_title('Long Wavelength Channel')
ax_lw.set_ylabel('')
# ax_lw.set(yticklabels=[])  # this didn't work

# plt.subplots_adjust(left=0.15)
print('Interactive zoom / pan controls both images simultaneously')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Interactive zoom / pan controls both images simultaneously
</pre>
               </div>
              </div>
              <img alt="../../_images/NIRCam_PSF_matched_multiband_photometry_20_1.png" src="../../_images/NIRCam_PSF_matched_multiband_photometry_20_1.png"/>
             </div>
            </div>
           </section>
           <section id="detect-sources-and-deblend-using-astropy-photutils">
            <h3>
             Detect Sources and Deblend using astropy.photutils
             <a class="headerlink" href="#detect-sources-and-deblend-using-astropy-photutils" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://photutils.readthedocs.io/en/latest/segmentation.html">
              https://photutils.readthedocs.io/en/latest/segmentation.html
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Define all detection and measurement parameters here so that we do measurements consistently for every image

class Photutils_Catalog:
    def __init__(self, filt, image_file=None, verbose=True):
        self.image_file = image_file or image_files[filt]
        self.hdu = fits.open(self.image_file)
        self.data = self.hdu[0].data
        self.imwcs = wcs.WCS(self.hdu[0].header, self.hdu)
        self.zeropoint = self.hdu[0].header['ABMAG'] * u.ABmag
        self.weight_file = weight_files[filt]
        self.weight = fits.open(weight_files[filt])[0].data
        if verbose:
            print(filt, '  zeropoint =', self.zeropoint)
            print(self.image_file)
            print(self.weight_file)
        
    def measure_background_map(self, bkg_size=50, filter_size=3, verbose=True):
        # Calculate sigma-clipped background in cells of 50x50 pixels, then median filter over 3x3 cells
        # For best results, the image should span an integer number of cells in both dimensions (here, 1000=20x50 pixels)
        # https://photutils.readthedocs.io/en/stable/background.html
        self.background_map = Background2D(self.data, bkg_size, filter_size=filter_size)

    def run_detect_sources(self, nsigma, npixels, smooth_fwhm=2, kernel_size=5, 
                           deblend_levels=32, deblend_contrast=0.001, verbose=True):

        # Set detection threshold map as nsigma times RMS above background pedestal
        detection_threshold = (nsigma * self.background_map.background_rms) + self.background_map.background

        # Before detection, convolve data with Gaussian
        smooth_sigma = smooth_fwhm * gaussian_fwhm_to_sigma
        smooth_kernel = Gaussian2DKernel(smooth_sigma, x_size=kernel_size, y_size=kernel_size)
        smooth_kernel.normalize()

        # Detect sources with npixels connected pixels at/above threshold in data smoothed by kernel
        # https://photutils.readthedocs.io/en/stable/segmentation.html
        self.segm_detect = detect_sources(self.data, detection_threshold, npixels=npixels, kernel=smooth_kernel)

        # Deblend: separate connected/overlapping sources
        # https://photutils.readthedocs.io/en/stable/segmentation.html#source-deblending
        self.segm_deblend = deblend_sources(self.data, self.segm_detect, npixels=npixels, kernel=smooth_kernel,
                                            nlevels=deblend_levels, contrast=deblend_contrast)
        if verbose:
            output = 'Cataloged %d objects' % self.segm_deblend.nlabels
            output += ', deblended from %d detections' % self.segm_detect.nlabels
            median_threshold = (nsigma * self.background_map.background_rms_median) \
                + self.background_map.background_median
            output += ' with %d pixels above %g-sigma threshold' % (npixels, nsigma)
            # Background outputs equivalent to those reported by SourceExtractor
            output += '\n'
            output += 'Background median %g' % self.background_map.background_median
            output += ', RMS %g' % self.background_map.background_rms_median
            output += ', threshold median %g' % median_threshold
            print(output)

    def measure_source_properties(self, exposure_time, local_background_width=24):
        # "effective_gain" = exposure time map (conversion from data rate units to counts)
        # weight = inverse variance map = 1 / sigma_background**2 (without sources)
        # https://photutils.readthedocs.io/en/latest/api/photutils.utils.calc_total_error.html
        self.exposure_time_map = exposure_time * self.background_map.background_rms_median**2 * self.weight

        # Data RMS uncertainty is combination of background RMS and source Poisson uncertainties
        background_rms = 1 / np.sqrt(self.weight)
        # effective gain parameter required to be positive everywhere (not zero), so adding small value 1e-8
        self.data_rms = calc_total_error(self.data, background_rms, self.exposure_time_map+1e-8)

        self.catalog = SourceCatalog(self.data-self.background_map.background, self.segm_deblend, wcs=self.imwcs, 
                                         error=self.data_rms, background=self.background_map.background, 
                                         localbkg_width=local_background_width)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>detection_catalog = Photutils_Catalog(detection_filter)
detection_catalog.measure_background_map()
detection_catalog.run_detect_sources(nsigma=2, npixels=5)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F200W   zeropoint = 27.9973 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F200W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F200W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: AstropyDeprecationWarning: "kernel" was deprecated in version 1.5 and will be removed in a future version. Instead, if filtering is desired, please input a convolved image directly into the "data" parameter. [warnings]
WARNING: AstropyDeprecationWarning: "kernel" was deprecated in version 1.5 and will be removed in a future version. Instead, if filtering is desired, please input a convolved image directly into the "data" parameter. [warnings]
</pre>
               </div>
              </div>
              <script type="application/vnd.jupyter.widget-view+json">
               {"version_major": 2, "version_minor": 0, "model_id": "1e0aa5a2cee5490190e78ff72e4efa01"}
              </script>
              <img align=center height=auto width=50% src="../../jdaviz_placeholder_new.png">
              </img align=center height=auto width=50%>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Cataloged 323 objects, deblended from 301 detections with 5 pixels above 2-sigma threshold
Background median 6.25759e-06, RMS 0.00187681, threshold median 0.00375987
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="measure-photometry-and-more-in-detection-image">
            <h3>
             Measure photometry (and more) in detection image
             <a class="headerlink" href="#measure-photometry-and-more-in-detection-image" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://photutils.readthedocs.io/en/latest/segmentation.html#centroids-photometry-and-morphological-properties">
              https://photutils.readthedocs.io/en/latest/segmentation.html#centroids-photometry-and-morphological-properties
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># exposure_time = hdu[0].header.get('EXPTIME')  # seconds
exposure_time = 49500  # seconds; Adding by hand because it's missing from the image header
detection_catalog.measure_source_properties(exposure_time)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Save segmentation map of detected objects
segm_hdu = fits.PrimaryHDU(detection_catalog.segm_deblend.data.astype(np.uint32), header=imwcs.to_header())
segm_hdu.writeto('JADES_detections_segm.fits', overwrite=True)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="show-detections-alongside-images-optional">
            <h3>
             Show detections alongside images (optional)
             <a class="headerlink" href="#show-detections-alongside-images-optional" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <em>
              Developer’s Note:
             </em>
            </p>
            <div class="highlight-none notranslate">
             <div class="highlight">
              <pre><span></span>Interactive plots zoom / pan all frames simultaneously. (User can zoom in on individual galaxies.)
</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig, ax = plt.subplots(2, 3, sharex=True, sharey=True, figsize=(9.5, 6))
# fig, ax = plt.subplots(2, 3, sharex=True, sharey=True, figsize=(9.5, 6), subplot_kw={'projection': imwcs})
# For RA,Dec axes instead of pixels, add: , subplot_kw={'projection': imwcs})

# Color image
ax[0,0].imshow(color_image_short_wavelength, origin='lower')
ax[0,0].set_title('Color Image')

# Data
norm = ImageNormalize(stretch=SqrtStretch(), vmin=0)
ax[0,1].imshow(data, origin='lower', cmap='Greys_r', norm=norm)
ax[0,1].set_title('Detection Image F200W')

# Segmentation map
cmap = detection_catalog.segm_deblend.make_cmap(seed=12345)  # ERROR
ax[0,2].imshow(detection_catalog.segm_deblend, origin='lower', cmap=cmap, interpolation='none')
ax[0,2].set_title('Detections (Segmentation Image)')

# norm = ImageNormalize(stretch=SqrtStretch())
# ax[1,0].imshow(weight, origin='lower', cmap='Greys_r', vmin=0)
# ax[1,0].set_title('Weight Image F200W')

ax[1,0].imshow(detection_catalog.exposure_time_map, origin='lower', cmap='Greys_r', vmin=0)
ax[1,0].set_title('Exposure Time Map')

# ax[1,0].imshow(background_map.background, origin='lower', cmap='Greys_r')
# ax[1,0].set_title('Background Pedestal')

# RMS
# norm = ImageNormalize()
vmin, vmax = 0.001, 0.0035
ax[1,1].imshow(detection_catalog.background_map.background_rms, origin='lower', vmin=vmin, vmax=vmax)
ax[1,1].set_title('Background RMS')

# Total error including Poisson noise
ax[1,2].imshow(detection_catalog.data_rms, origin='lower', vmin=vmin, vmax=vmax)
ax[1,2].set_title('RMS + Poisson noise')

fig.tight_layout()

print('Interactive zoom / pan controls all images simultaneously')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Interactive zoom / pan controls all images simultaneously
</pre>
               </div>
              </div>
              <img alt="../../_images/NIRCam_PSF_matched_multiband_photometry_29_1.png" src="../../_images/NIRCam_PSF_matched_multiband_photometry_29_1.png"/>
             </div>
            </div>
           </section>
           <section id="view-save-measured-quantities-in-detection-image-optional">
            <h3>
             View / save measured quantities in detection image (optional)
             <a class="headerlink" href="#view-save-measured-quantities-in-detection-image-optional" title="Permalink to this headline">
              #
             </a>
            </h3>
           </section>
           <section id="only-keep-some-quantities">
            <h3>
             Only keep some quantities
             <a class="headerlink" href="#only-keep-some-quantities" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>columns = 'label xcentroid ycentroid sky_centroid area semimajor_sigma semiminor_sigma'.split()
columns += 'ellipticity orientation gini'.split()
columns += 'kron_radius local_background segment_flux segment_fluxerr kron_flux kron_fluxerr'.split()
# columns += 'source_sum source_sum_err kron_flux kron_fluxerr kron_radius local_background'.split()

source_table = detection_catalog.catalog.to_table(columns=columns)
source_table.rename_column('semimajor_sigma', 'a')
source_table.rename_column('semiminor_sigma', 'b')

# Replace sky_centroid with ra, dec
source_table['ra'] = source_table['sky_centroid'].ra.degree * u.degree
source_table['dec'] = source_table['sky_centroid'].dec.degree * u.degree

columns = list(source_table.columns)
columns = columns[:3] + ['ra', 'dec'] + columns[4:-2]

source_table = source_table[columns]
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># If interested, view / save output, but photometry in other filters will be added soon!
# source_table.write('JADES_detections.ecsv', overwrite=True)
# source_table.write('JADES_detections.cat', format='ascii.fixed_width_two_line', delimiter=' ', overwrite=True)
# source_table
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="convert-measured-fluxes-data-units-to-magnitudes">
            <h3>
             Convert measured fluxes (data units) to magnitudes
             <a class="headerlink" href="#convert-measured-fluxes-data-units-to-magnitudes" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://docs.astropy.org/en/stable/units/">
              https://docs.astropy.org/en/stable/units/
             </a>
            </p>
            <p>
             <a class="reference external" href="https://docs.astropy.org/en/stable/units/equivalencies.html#photometric-zero-point-equivalency">
              https://docs.astropy.org/en/stable/units/equivalencies.html#photometric-zero-point-equivalency
             </a>
            </p>
            <p>
             <a class="reference external" href="https://docs.astropy.org/en/stable/units/logarithmic_units.html#logarithmic-units">
              https://docs.astropy.org/en/stable/units/logarithmic_units.html#logarithmic-units
             </a>
            </p>
            <p>
             <em>
              Developer note:
             </em>
            </p>
            <div class="highlight-none notranslate">
             <div class="highlight">
              <pre><span></span>flux units can be automatically converted to magnitude units
but flux uncertainties *cannot* be automatically converted to magnitude uncertainties
thus I wrote this function to do so

Note magnitude uncertainties for detections should probably be u.mag instead of u.ABmag
but magnitude uncertainties for non-detections quote u.ABmag upper limits
They need to be the same, so we go with u.ABmag
</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># not detected: mag =  99; magerr = 1-sigma upper limit assuming zero flux
# not observed: mag = -99; magerr = 0
def fluxes2mags(flux, fluxerr):
    nondet = flux &lt; 0  # Non-detection if flux is negative
    unobs = (fluxerr &lt;= 0) + (fluxerr == np.inf)  # Unobserved if flux uncertainty is negative or infinity

    mag = flux.to(u.ABmag)
    magupperlimit = fluxerr.to(u.ABmag) # 1-sigma upper limit if flux=0

    mag = np.where(nondet, 99 * u.ABmag, mag)
    mag = np.where(unobs, -99 * u.ABmag, mag)

    magerr = 2.5 * np.log10(1 + fluxerr/flux) 
    magerr = magerr.value * u.ABmag

    magerr = np.where(nondet, magupperlimit, magerr)
    magerr = np.where(unobs, 0 * u.ABmag, magerr)
    
    return mag, magerr

# Includes features I couldn't find in astropy:
# mag = 99 / -99 for non-detections / unobserved
# flux uncertainties -&gt; mag uncertainties
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="multiband-photometry-using-isophotal-apertures-defined-in-detection-image">
            <h3>
             Multiband photometry using isophotal apertures defined in detection image
             <a class="headerlink" href="#multiband-photometry-using-isophotal-apertures-defined-in-detection-image" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             (Similar to running SourceExtractor in double-image mode)
             <br/>
             (No PSF corrections just yet)
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># filters = 'F090W F200W F444W'.split()  # quicker for testing
for filt in filters:
    filter_catalog = Photutils_Catalog(filt)
    filter_catalog.measure_background_map()

    # Measure photometry in this filter for objects detected in detected image
    # segmentation map will define isophotal apertures
    filter_catalog.segm_deblend = detection_catalog.segm_deblend
    filter_catalog.measure_source_properties(exposure_time)
    
    # Convert measured fluxes to fluxes in nJy and to AB magnitudes
    filter_table = filter_catalog.catalog.to_table()
    source_table[filt+'_flux'] = flux = filter_table['segment_flux'] * filter_catalog.zeropoint.to(u.nJy)
    source_table[filt+'_fluxerr'] = fluxerr = filter_table['segment_fluxerr'] * filter_catalog.zeropoint.to(u.nJy)

    mag, magerr = fluxes2mags(flux, fluxerr)
    source_table[filt+'_mag'] = mag
    source_table[filt+'_magerr'] = magerr
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F090W   zeropoint = 27.4525 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F090W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F090W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/function/logarithmic.py:64: RuntimeWarning: invalid value encountered in log10
  return dex.to(self._function_unit, np.log10(x))
/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/quantity.py:673: RuntimeWarning: invalid value encountered in log10
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F115W   zeropoint = 27.5681 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F115W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F115W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F150W   zeropoint = 27.814 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F150W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F150W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F200W   zeropoint = 27.9973 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F200W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F200W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F277W   zeropoint = 27.8803 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F277W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F277W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F335M   zeropoint = 27.0579 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F335M.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F335M_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F356W   zeropoint = 28.0068 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F356W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F356W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F410M   zeropoint = 27.1848 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F410M.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F410M_wht.fits
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/function/logarithmic.py:64: RuntimeWarning: invalid value encountered in log10
  return dex.to(self._function_unit, np.log10(x))
/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/quantity.py:673: RuntimeWarning: invalid value encountered in log10
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre>
               </div>
              </div>
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>F444W   zeropoint = 28.0647 mag(AB)
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F444W.fits
https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/jades_jwst_nircam_goods_s_crop_F444W_wht.fits
</pre>
               </div>
              </div>
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/function/logarithmic.py:64: RuntimeWarning: invalid value encountered in log10
  return dex.to(self._function_unit, np.log10(x))
/usr/share/miniconda/lib/python3.9/site-packages/astropy/units/quantity.py:673: RuntimeWarning: invalid value encountered in log10
  result = super().__array_ufunc__(function, method, *arrays, **kwargs)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="aperture-corrections-isophotal-to-total-kron-aperture-fluxes">
            <h3>
             Aperture corrections: isophotal to total (Kron aperture) fluxes
             <a class="headerlink" href="#aperture-corrections-isophotal-to-total-kron-aperture-fluxes" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>total_flux_table = deepcopy(source_table) # copy to new table, which will include total magnitude corrections

reference_flux_auto = total_flux_table['kron_flux']
reference_flux_iso = total_flux_table['segment_flux']
kron_flux_corrections = reference_flux_auto / reference_flux_iso
total_flux_table['total_flux_cor'] = kron_flux_corrections

for filt in filters:
    total_flux_table[filt+'_flux'] *= kron_flux_corrections
    total_flux_table[filt+'_fluxerr'] *= kron_flux_corrections
    # total_flux_table[filt+'_mag'] = total_flux_table[filt+'_flux'].to(u.ABmag)  # doesn't handle non-detections
    total_flux_table[filt+'_mag'] = fluxes2mags(total_flux_table[filt+'_flux'], total_flux_table[filt+'_fluxerr'])[0]
    # magnitude uncertainty magerr stays the same
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="reformat-output-catalog-for-readability-optional">
            <h3>
             Reformat output catalog for readability (optional)
             <a class="headerlink" href="#reformat-output-catalog-for-readability-optional" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <em>
              Developer’s Note:
             </em>
            </p>
            <div class="highlight-none notranslate">
             <div class="highlight">
              <pre><span></span>'d' format incompatible with units (pix2)
As a workaround, I set the format to '.0f' (a float with no decimals)

ValueError: Unable to parse format string "d" for entry "101.0" in column "area"
</pre>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>isophotal_table = deepcopy(total_flux_table) # copy to new table, which will include PSF-corrections

old_columns = list(isophotal_table.columns)

# Reorder columns,
i = old_columns.index('segment_flux')
j = old_columns.index(filters[0]+'_flux')
columns = old_columns[:i] # detection catalog (except source_sum &amp; kron_flux)
columns += old_columns[-1:]  # total_flux_cor
columns += old_columns[j:-1] # photometry in all filters
        
isophotal_table = isophotal_table[columns]

for column in columns:
    isophotal_table[column].info.format = '.4f'

isophotal_table['ra'].info.format = '11.7f'
isophotal_table['dec'].info.format = ' 11.7f'

isophotal_table['label'].info.format = 'd'
isophotal_table['area'].info.format = '.0f'  # 'd' raises error
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="isophotal-photometry-without-psf-corrections-complete">
            <h3>
             Isophotal Photometry without PSF corrections complete
             <a class="headerlink" href="#isophotal-photometry-without-psf-corrections-complete" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             We recommend proceeding with PSF corrections to photometry in the Long Wavelength Channel. But if you are interested, you may save the catalog now.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># isophotal_table.write('JADES_isophotal_photometry.ecsv', overwrite=True)
# isophotal_table.write('JADES_isophotal_photometry.cat', format='ascii.fixed_width_two_line', delimiter=' ', overwrite=True)
# isophotal_table
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="psf-magnitude-corrections">
           <h2>
            PSF magnitude corrections
            <a class="headerlink" href="#psf-magnitude-corrections" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Color corrections are perfomed as described here:
            <a class="reference external" href="https://www.stsci.edu/~dcoe/ColorPro/color">
             https://www.stsci.edu/~dcoe/ColorPro/color
            </a>
           </p>
           <p>
            Note this is different from one common approach, which is to degrade every image to the broadest PSF.
           </p>
           <p>
            Photometry is only corrected in Long Wavelength images &gt; 2.4 microns. The F200W detection image is convolved (blurred) to the PSF of each Long Wavelength image. Then we correct colors based on the magnitudes lost in that aperture:
           </p>
           <ul class="simple">
            <li>
             <p>
              PSF_magnitude_corrections = detection_image_magnitudes - blurred_detection_image_magnitudes
             </p>
            </li>
           </ul>
           <p>
            In practice, we actually correct the fluxes:
           </p>
           <ul class="simple">
            <li>
             <p>
              PSF_flux_corrections = detection_image_fluxes / blurred_detection_image_fluxes
             </p>
            </li>
           </ul>
           <section id="load-psfs">
            <h3>
             Load PSFs
             <a class="headerlink" href="#load-psfs" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             PSF files used in this notebook were extracted from tar files available on JDox:
             <br/>
             <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions#NIRCamPointSpreadFunctions-SimulatedNIRCamPSFs">
              https://jwst-docs.stsci.edu/near-infrared-camera/nircam-predicted-performance/nircam-point-spread-functions#NIRCamPointSpreadFunctions-SimulatedNIRCamPSFs
             </a>
             <br/>
             PSFs_SW_filters (short wavelength channel):
             <a class="reference external" href="https://stsci.box.com/s/s2lepxr9086gq4sogr3kwftp54n1c5vl">
              https://stsci.box.com/s/s2lepxr9086gq4sogr3kwftp54n1c5vl
             </a>
             <br/>
             PSFs_LW_filters (long wavelength channel):
             <a class="reference external" href="https://stsci.box.com/s/gzl7blxb1k3p4n66gs7jvt7xorfrotyb">
              https://stsci.box.com/s/gzl7blxb1k3p4n66gs7jvt7xorfrotyb
             </a>
            </p>
            <p>
             Each FITS file contains:
             <br/>
             – hdu[0]: a 4x oversampled PSF
             <br/>
             – hdu[1]: PSF at detector pixel scale (0.031” and 0.063” in the short and long wavelength channels, respectively)
             <br/>
             This notebook will use the latter: PSF at detector pixel scale. We find no advantage to the former for this notebook.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>PSF_inputs = {}
PSF_images = {}

detector_pixel_scales = {'SW': 0.031, 'LW': 0.063}

PSF_url = os.path.join(input_file_url, 'NIRCam_PSFs')

for i, filt in enumerate(filters):
    lam = wavelengths[i]
    if lam &lt; 2.4 * u.um:
        channel = 'SW'  # Short Wavelength Channel &lt; 2.4 microns
    else:
        channel = 'LW'  # Long Wavelength Channel &gt; 2.4 microns

    # Load PSF
    PSF_file = 'PSF_%scen_G5V_fov299px_ISIM41.fits' % filt
    # PSF_file = os.path.join('NIRCam_PSFs_' + channel, PSF_file)
    PSF_file = os.path.join(PSF_url, PSF_file)

    print(PSF_file)
    PSF_hdu = fits.open(PSF_file)
    PSF_inputs[filt] = data = PSF_hdu[1].data  # extension [1] is at pixel scale (not oversampled)
    ny, nx = data.shape
    
    # Resize from detector pixel scale to image pixel scale (here 0.03" / pix)
    detector_pixel_scale = detector_pixel_scales[channel]
    ny_resize = ny * detector_pixel_scale / image_pixel_scale  # Assume square PSF (ny = nx)
    ny_resize = np.round(ny_resize)
    ny_resize = np.int((ny_resize // 2) * 2 + 1)  # Make it an odd number of pixels to ensure PSF is centered
    PSF_pixel_scale = ny_resize / ny * image_pixel_scale    
    PSF_image = resize_psf(PSF_inputs[filt], PSF_pixel_scale, image_pixel_scale)  # Resize PSF here
    r = (ny_resize - ny) // 2
    PSF_images[filt] = PSF_image[r:-r, r:-r]  # Trim to same size as input PSFs
    # Note PSF is no longer normalized but will be later in convolution step
    # print(filt, ny, ny_resize, PSF_image.shape, PSF_images[filt].shape, PSF_pixel_scale)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/nircam_photometry/NIRCam_PSFs/PSF_F090Wcen_G5V_fov299px_ISIM41.fits
</pre>
               </div>
              </div>
              <div class="output traceback highlight-ipythontb notranslate">
               <div class="highlight">
                <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="n">line</span> <span class="mi">29</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">detector_pixel_scale</span> <span class="o">/</span> <span class="n">image_pixel_scale</span>  <span class="c1"># Assume square PSF (ny = nx)</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span> <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ny_resize</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">29</span> <span class="n">ny_resize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">((</span><span class="n">ny_resize</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Make it an odd number of pixels to ensure PSF is centered</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span> <span class="n">PSF_pixel_scale</span> <span class="o">=</span> <span class="n">ny_resize</span> <span class="o">/</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">image_pixel_scale</span>    
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="n">PSF_image</span> <span class="o">=</span> <span class="n">resize_psf</span><span class="p">(</span><span class="n">PSF_inputs</span><span class="p">[</span><span class="n">filt</span><span class="p">],</span> <span class="n">PSF_pixel_scale</span><span class="p">,</span> <span class="n">image_pixel_scale</span><span class="p">)</span>  <span class="c1"># Resize PSF here</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/numpy/__init__.py:284,</span> in <span class="ni">__getattr__</span><span class="nt">(attr)</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="kn">from</span> <span class="nn">.testing</span> <span class="kn">import</span> <span class="n">Tester</span>
<span class="g g-Whitespace">    </span><span class="mi">282</span>     <span class="k">return</span> <span class="n">Tester</span>
<span class="ne">--&gt; </span><span class="mi">284</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">"module </span><span class="si">{!r}</span><span class="s2"> has no attribute "</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span>                      <span class="s2">"</span><span class="si">{!r}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

<span class="ne">AttributeError</span>: module 'numpy' has no attribute 'int'
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>np.sum(PSF_images[filt])
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>np.sum(PSF_image[r:-r, r:-r])
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Show PSFs (optional)

fig, ax = plt.subplots(1, len(filters), figsize=(9.5, 1.5), sharex=True, sharey=True)

r = 15  # PSF will be shown out to radius r (pixels)
for i, filt in enumerate(filters):
    data = PSF_images[filt]
    ny, nx = data.shape
    yc = ny // 2
    xc = nx // 2
    stamp = data[yc-r:yc+r+1, xc-r:xc+r+1]
    norm = ImageNormalize(stretch=LogStretch())  # scale each filter individually
    ax[i].imshow(stamp, cmap='Greys_r', norm=norm, origin='lower')
    ax[i].set_title(filt.upper())
    ax[i].axis('off')
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="psf-matching">
           <h2>
            PSF Matching
            <a class="headerlink" href="#psf-matching" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            <a class="reference external" href="https://photutils.readthedocs.io/en/stable/psf_matching.html">
             https://photutils.readthedocs.io/en/stable/psf_matching.html
            </a>
           </p>
           <section id="determine-psf-convolution-kernels">
            <h3>
             Determine PSF convolution kernels
             <a class="headerlink" href="#determine-psf-convolution-kernels" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>PSF_kernels = {}
reference_filter = 'F200W'
reference_PSF = PSF_images[reference_filter]
i_reference = filters.index(reference_filter)
window = SplitCosineBellWindow(alpha=0.35, beta=0.3)
for filt in filters[i_reference+1:]:
    PSF_kernels[filt] = create_matching_kernel(reference_PSF, PSF_images[filt], window=window)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="convolve-f200w-detection-image-to-long-wavelength-psfs">
           <h2>
            Convolve F200W detection image to Long Wavelength PSFs
            <a class="headerlink" href="#convolve-f200w-detection-image-to-long-wavelength-psfs" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>reference_image_hdu = fits.open(image_files[reference_filter])
reference_image_data = reference_image_hdu[0].data[:]

for output_filter in filters[i_reference+1:]:
    output_image = 'jades_convolved_%s_to_%s.fits' % (reference_filter, output_filter)
    if os.path.exists(output_image):
        print(output_image, 'EXISTS')
    else:
        print(output_filter + '...')
        PSF_kernel = PSF_kernels[output_filter][yc-r:yc+r+1, xc-r:xc+r+1]
        # convolve_fft may be faster for larger images / kernels (but doesn't make much difference in this demo):
        convolved_image = convolve(reference_image_data, PSF_kernel, normalize_kernel=True)
        reference_image_hdu[0].data = convolved_image
        print('SAVING %s' % output_image)
        reference_image_hdu.writeto(output_image)
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="multiband-photometry-in-convolved-images">
            <h3>
             Multiband photometry in convolved images
             <a class="headerlink" href="#multiband-photometry-in-convolved-images" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Measure and save the fluxes in each blurry image
blurry_catalog = QTable()

for blurry_filter in filters[i_reference+1:]:
    image_file = 'jades_convolved_%s_to_%s.fits' % (reference_filter, blurry_filter)
    filter_catalog = Photutils_Catalog(blurry_filter, image_file=image_file)
    filter_catalog.measure_background_map()

    # Measure photometry in this filter for objects detected in detected image
    # segmentation map will define isophotal apertures
    filter_catalog.segm_deblend = detection_catalog.segm_deblend
    filter_catalog.measure_source_properties(exposure_time)

    # Convert measured fluxes to fluxes in nJy
    filter_table = filter_catalog.catalog.to_table()
    blurry_catalog[blurry_filter+'_flux'] = filter_table['segment_flux'] * filter_catalog.zeropoint.to(u.nJy)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="id1">
            <h3>
             PSF magnitude corrections
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://www.stsci.edu/~dcoe/ColorPro/color">
              https://www.stsci.edu/~dcoe/ColorPro/color
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>PSF_corrected_table = deepcopy(isophotal_table)

reference_fluxes = PSF_corrected_table[reference_filter+'_flux']  # det_flux_auto

for filt in filters[i_reference+1:]:
    # Convert isophotal fluxes to total fluxes
    blurry_total_fluxes = blurry_catalog[filt+'_flux'] * kron_flux_corrections
    PSF_flux_corrections = reference_fluxes / blurry_total_fluxes
    PSF_corrected_table[filt+'_flux'] *= PSF_flux_corrections
    PSF_corrected_table[filt+'_fluxerr'] *= PSF_flux_corrections
    # PSF_corrected_table[filt+'_mag'] = PSF_corrected_fluxes.to(u.ABmag)  # doesn't handle non-detections
    PSF_corrected_table[filt+'_mag'], PSF_corrected_table[filt+'_magerr'] = \
        fluxes2mags(PSF_corrected_table[filt+'_flux'], PSF_corrected_table[filt+'_fluxerr'])
    PSF_corrected_table[filt+'_PSF_flux_cor'] = PSF_flux_corrections    
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>PSF_corrected_table.write('JADES_photometry.ecsv', overwrite=True)
PSF_corrected_table.write('JADES_photometry.cat', format='ascii.fixed_width_two_line', delimiter=' ', overwrite=True)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># PSF_corrected_table
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># !cat JADES_photometry.cat
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="start-new-session-and-analyze-results">
           <h2>
            Start new session and analyze results
            <a class="headerlink" href="#start-new-session-and-analyze-results" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            Just run the first few blocks above, including imports, defining file lists, and creating the color image
           </p>
           <section id="load-catalog-and-segmentation-map">
            <h3>
             Load catalog and segmentation map
             <a class="headerlink" href="#load-catalog-and-segmentation-map" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Catalog: ecsv format preserves units for loading in Python notebooks
output_catalog = QTable.read('JADES_photometry.ecsv')
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Reconstitute filter list
filters = []
for param in output_catalog.columns:
    if param[-4:] == '_mag':
        filters.append(param[:-4])
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Segmentation map
segmfile = 'JADES_detections_segm.fits'
segm = fits.open(segmfile)[0].data
segm = photutils.segmentation.SegmentationImage(segm)
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="input-simulation-jades-jaguar-catalog">
           <h2>
            Input simulation JADES JAGUAR catalog
            <a class="headerlink" href="#input-simulation-jades-jaguar-catalog" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># full_catalog_file = 'JADES_SF_mock_r1_v1.1.fits.gz'  # not available in this demo
# Cropped 302,515 simulated galaxies down to 653 in the smaller image region used in this demo
cropped_catalog_file = 'JADES_SF_mock_r1_v1.1_crop.fits.gz'
input_catalog_file = os.path.join(input_file_url, cropped_catalog_file)
simulated_catalog = Table.read(input_catalog_file)
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="match-objects-to-photutils-catalog">
            <h3>
             Match objects to photutils catalog
             <a class="headerlink" href="#match-objects-to-photutils-catalog" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <a class="reference external" href="https://docs.astropy.org/en/stable/coordinates/matchsep.html">
              https://docs.astropy.org/en/stable/coordinates/matchsep.html
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>input_coordinates = SkyCoord(ra=simulated_catalog['RA']*u.degree, dec=simulated_catalog['DEC']*u.degree)

# Can use output_catalog['sky_centroid'] if saved in table, but this demo saved (ra,dec) instead:
detected_coordinates = SkyCoord(ra=output_catalog['ra'], dec=output_catalog['dec'])

# Match photutils detection sources to input object catalog:
input_indices, separation2d, distance3d = detected_coordinates.match_to_catalog_sky(input_coordinates)
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Determine threshold maximum distance between input objects and matched output sources
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig = plt.figure(figsize=(9.5, 4))
plt.plot(np.sort(separation2d.to(u.arcsec)), zorder=10)
separation_max = 0.036 * u.arcsec  # determined by eye after plotting
plt.axhline(0, c='k', ls=':')
plt.axhline(separation_max.value, c='r', ls='--', label='"good" matches')
plt.title('Matches between output (detected) and input (simulated) catalogs')
plt.xlabel('Detected sources (sorted)')
plt.ylabel('Separation (arcsec)')
plt.legend()
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>good_matches = separation2d &lt; separation_max
unique_matches, index_counts = np.unique(input_indices[good_matches], return_counts=True)

print('%d matches (%d unique) between input catalog (%d galaxies) and photutils catalog (%d detected sources)'
      % (np.sum(good_matches), len(unique_matches), len(simulated_catalog), len(output_catalog)))

multiple_matches = unique_matches[index_counts &gt; 1]
if len(multiple_matches):
    print('Input sources matched multiple times:', list(output_catalog['id'][multiple_matches]))
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Input vs. Output Color

filt1, filt2 = 'F200W F444W'.split()

input_flux1 = simulated_catalog['NRC_%s_fnu' % filt1][input_indices][good_matches]
input_flux2 = simulated_catalog['NRC_%s_fnu' % filt2][input_indices][good_matches]

input_mag1 = (input_flux1 * u.nJy).to(u.ABmag).value
input_mag2 = (input_flux2 * u.nJy).to(u.ABmag).value

output_mag1 = output_catalog[filt1 + '_mag'][good_matches].value
output_mag2 = output_catalog[filt2 + '_mag'][good_matches].value
output_ids = output_catalog['label'][good_matches].data.astype(int)

# Only plot detections
det1 = (0 &lt; output_mag1) &amp; (output_mag1 &lt; 90)
det2 = (0 &lt; output_mag2) &amp; (output_mag2 &lt; 90)
det = det1 * det2

output_mag1 = output_mag1[det]
output_mag2 = output_mag2[det]

input_color = input_mag1 - input_mag2
output_color = output_mag1 - output_mag2

output_mag1_uncor = output_mag1
PSF_flux_cor = output_catalog[filt2+'_PSF_flux_cor']
PSF_mag_cor = -2.5 * np.log10(PSF_flux_cor)
output_mag2_uncor = output_mag2 - PSF_mag_cor[good_matches][det].value
output_color_uncor = output_mag1_uncor - output_mag2_uncor

plt.figure(figsize=(8, 6))

plt.plot(input_mag1, output_color - input_color, 'bo', alpha=0.5, label='PSF corrected')
plt.plot(input_mag1, output_color_uncor - input_color, 'r.', alpha=0.5, label='uncorrected')

plt.axhline(0, c='g', label='correct')
plt.xlabel('Input  ' + filt1 + '  (mag)')
plt.ylabel('Measured $-$ Input colors  [%s $-$ %s]' % (filt1, filt2))
plt.title('Accuracy of measured JADES photometry colors')

plt.legend();
# plt.savefig('JADES_color_deviation_%s-%s.png' % (filt1, filt2))
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts">
            <h3>
             Plot F200W vs. F090W magnitudes and look for dropouts
             <a class="headerlink" href="#plot-f200w-vs-f090w-magnitudes-and-look-for-dropouts" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>mag1 = output_catalog['F090W_mag']
mag2 = output_catalog['F200W_mag']

# Only plot detections in F200W
det2 = (0*u.ABmag &lt; mag2) &amp; (mag2 &lt; 90*u.ABmag)

mag1 = mag1[det2]
mag2 = mag2[det2]
ids = output_catalog['label'][det2].data.astype(int)

plt.figure(figsize=(8, 4))

plt.scatter(mag1, mag2, c=ids)

plt.xlabel('F090W AB magnitude')
plt.ylabel('F200W AB magnitude')

plt.xlim(plt.xlim()[::-1])  # brighter at right
plt.ylim(plt.ylim()[::-1])  # brighter at top

mplcursors.cursor(hover=mplcursors.HoverMode.Transient)
print('Hover cursor over data point to reveal magnitudes and catalog ID number')
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Select brightest F090W dropout
dropouts = output_catalog['F090W_mag'] &gt; 90 * u.ABmag
i_brightest_dropout = output_catalog[dropouts]['F200W_mag'].argmin()
output_id = output_catalog[dropouts][i_brightest_dropout]['label']
output_id
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Select object with id from catalog
output_index = segm.get_index(output_id)
output_obj = output_catalog[output_index]
segmobj = segm.segments[segm.get_index(output_id)]
print(output_id, output_obj['F090W_mag'], output_obj['F200W_mag'])
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Alternartively, could select an object by position
# x, y = 905, 276
# id = segm.data[y,x]
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="show-selected-object-in-all-filters">
            <h3>
             Show selected object in all filters
             <a class="headerlink" href="#show-selected-object-in-all-filters" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>fig, ax = plt.subplots(2, len(filters)+1, figsize=(9.5, 3.5), sharex=True, sharey=True)

ax[0, 0].imshow(color_image_short_wavelength[segmobj.slices], origin='lower', extent=segmobj.bbox.extent)
ax[0, 0].set_title('Color')

cmap = segm.make_cmap(seed=12345)  # ERROR
ax[1, 0].imshow(segm.data[segmobj.slices], origin='lower', extent=segmobj.bbox.extent, cmap=cmap,
                interpolation='nearest')
ax[1, 0].set_title('Segment')

for i in range(1, len(filters)+1):
    filt = filters[i-1]

    # Show data on top row
    data = fits.open(image_files[filt])[0].data
    stamp = data[segmobj.slices]
    norm = ImageNormalize(stretch=SqrtStretch())  # scale each filter individually
    ax[0, i].imshow(stamp, extent=segmobj.bbox.extent, cmap='Greys_r', norm=norm, origin='lower')
    ax[0, i].set_title(filt.upper())

    # Show weights on bottom row
    weight = fits.open(weight_files[filt])[0].data
    stamp = weight[segmobj.slices]
    # set black to zero weight (no exposure time / bad pixel)
    ax[1, i].imshow(stamp, extent=segmobj.bbox.extent, vmin=0, cmap='Greys_r', origin='lower')

ax[0, 0].set_ylabel('Data')
ax[1, 0].set_ylabel('Weight');
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
          <section id="plot-spectral-energy-distribution-sed-for-one-object">
           <h2>
            Plot Spectral Energy Distribution (SED) for one object
            <a class="headerlink" href="#plot-spectral-energy-distribution-sed-for-one-object" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># output_obj = output_catalog[index]  # already done above
input_obj = simulated_catalog[input_indices][output_index]
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>input_fluxes = np.array([input_obj['NRC_%s_fnu' % filt] for filt in filters])
output_fluxes = np.array([output_obj[filt+'_flux'].value for filt in filters])
output_flux_errs = np.array([output_obj[filt+'_fluxerr'].value for filt in filters])
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span># Measured flux does not recover total input flux
# Given known simulation input, determine what fraction of the flux was recovered
# Use this to scale measured SED to input SED for comparison, plotted below

# Scale output to input flux using F200W only (other filters may have incorrect flux corrections)

filt = 'F200W'
flux_scale_factor = output_obj[filt+'_flux'].value / input_obj['NRC_%s_fnu' % filt]
flux_factor = 1 / flux_scale_factor  # input / output
print('%d%% of input flux recovered by photutils' % (100 * flux_scale_factor))
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>if 0:
    # Scale output to input flux considering all measured fluxes and uncertainties
    # Benitez+00 Equations 8 &amp; 9
    FOT = np.sum(input_fluxes * output_fluxes / output_flux_errs**2)
    FTT = np.sum(input_fluxes**2 / output_flux_errs**2)
    flux_scale_factor = FOT / FTT  # a_m: observed / theoretical (output / input)
    flux_factor = 1 / flux_scale_factor  # input / output
    print('%d%% of input flux recovered by photutils' % (100 * flux_scale_factor))
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>PSF_flux_corrections = np.ones(len(filters))
for i, filt in enumerate(filters):
    PSFcor_column = filt+'_PSF_flux_cor'
    if PSFcor_column in list(output_obj.columns):
        PSF_flux_corrections[i] = output_obj[PSFcor_column]

PSF_flux_corrections
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            <em>
             Developer’s Note:
            </em>
           </p>
           <div class="highlight-none notranslate">
            <div class="highlight">
             <pre><span></span>automatic secondary axis magnitudes don't work when fluxes extend to negative values
so I wrote my own code to do this
</pre>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>def add_magnitude_axis(ax, flux_units=u.nJy, plothuge=True):
    ylo, yhi = plt.ylim() * flux_units
    maghi = yhi.to(u.ABmag).value
    ytx1 = np.ceil(maghi * 10) / 10.  # 24.101 -&gt; 24.2
    ytx2 = np.ceil(maghi)  # 24.1 -&gt; 25

    fpart = ytx1 - int(ytx1)  # 0.2
    if np.isclose(fpart, 0) or np.isclose(fpart, 0.9):
        ytx1 = []
    elif np.isclose(fpart, 0.1) or np.isclose(fpart, 0.2):
        ytx1 = np.array([ytx1, ytx2-0.7, ytx2-0.5, ytx2-0.3])  # 24.1, 24.3, 24.5, 24.7
    elif np.isclose(fpart, 0.3) or np.isclose(fpart, 0.4):
        ytx1 = np.array([ytx1, ytx2-0.5, ytx2-0.3])  # 24.3, 24.5, 24.7
    elif np.isclose(fpart, 0.5):
        ytx1 = np.array([ytx1, ytx2-0.3])  # 24.5, 24.7
    elif np.isclose(fpart, 0.6):
        ytx1 = np.array([ytx1, ytx2-0.2])  # 24.6, 24.8

    if isinstance(ytx1, float):
        ytx1 = np.array([ytx1])

    if plothuge:
        ytx3 = ytx2 + np.array([0, 0.2, 0.5, 1, 2])
    else:
        ytx3 = ytx2 + np.array([0, 0.2, 0.5, 1, 1.5, 2, 3])

    ytx2 = np.array([ytx2])
    ytx = np.concatenate([ytx1, ytx3])
    yts = ['%g' % mag for mag in ytx]

    ytx = (ytx * u.ABmag).to(flux_units).value
    
    ax2 = ax.twinx()
    ax.yaxis.set_label_position('left')
    ax2.yaxis.set_label_position('right')
    ax.yaxis.tick_left()
    ax2.yaxis.tick_right()

    ax2.set_yticks(ytx)
    ax2.set_yticklabels(yts)
    ax2.set_ylabel('Magnitude (AB)')
    ax2.set_ylim(ylo.value, yhi.value)
    ax2.set_zorder(-100)  # interactive cursor will output left axis ax
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            <em>
             Developer’s Note:
            </em>
           </p>
           <div class="highlight-none notranslate">
            <div class="highlight">
             <pre><span></span>errorbar doesn't work with units either
</pre>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>fig, ax = plt.subplots(figsize=(8, 6))

plt.plot(wavelengths, input_fluxes, 'o-', label='Input fluxes', zorder=10)

label = 'Measured PSF-corrected fluxes $\\times$ %.1f' % flux_factor
plt.errorbar(wavelengths.value, output_fluxes * flux_factor, output_flux_errs * flux_factor,
             ms=8, marker='s', mfc=mpl_colors[1], c='k', lw=3, alpha=0.5, ls='none', label=label)

label = 'Measured uncorrected fluxes $\\times$ %.1f' % flux_factor
plt.errorbar(wavelengths.value, output_fluxes * flux_factor / PSF_flux_corrections, output_flux_errs * flux_factor,
             ms=8, marker='s', mfc='r', c='k', lw=3, alpha=0.5, ls='none', label=label, zorder=-10)

plt.legend()
plt.axhline(0, c='k', ls=':')
plt.xlim(0, 5)
plt.xlabel('Wavelength ($\\mu$m)')
plt.ylabel('Flux (nJy)')
add_magnitude_axis(ax)

plt.savefig('JADES photutils SED linear.png')
</pre>
              </div>
             </div>
            </div>
           </div>
           <p>
            <em>
             Developer’s Notes:
            </em>
           </p>
           <div class="highlight-none notranslate">
            <div class="highlight">
             <pre><span></span>Ideally, the secondary axis should know how to convert between units.
As a workaround, I wrote functions and fed them in.

Even then, this only works so long as fluxes are positive.
Clipping all fluxes to positive values doesn't work either.

I would like to automatically scale the y limits to only *some* of the plotted data along the lines of:
https://stackoverflow.com/questions/7386872/make-matplotlib-autoscaling-ignore-some-of-the-plots
But that old solution didn't work.
So for now, I just hard-coded a range that works for this object: y=10-70.
</pre>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>fig, ax = plt.subplots(figsize=(8, 6))

if 0:  # this didn't work
    ax.autoscale(True)
    detections = output_fluxes &gt; 0
    ax.plot(wavelengths[detections], output_fluxes[detections] * flux_factor, visible=False)
    ax.autoscale(False)

plt.plot(wavelengths, input_fluxes, 'o-', label='Input fluxes', zorder=10, scaley=False)

label = 'Measured PSF-corrected fluxes $\\times$ %.1f' % flux_factor
plt.errorbar(wavelengths.value, output_fluxes * flux_factor, output_flux_errs * flux_factor,
             ms=8, marker='s', mfc=mpl_colors[1], c='k', lw=3, alpha=0.5, ls='none', label=label)

label = 'Measured uncorrected fluxes $\\times$ %.1f' % flux_factor
plt.errorbar(wavelengths.value, output_fluxes * flux_factor / PSF_flux_corrections, output_flux_errs * flux_factor,
             ms=8, marker='s', mfc='r', c='k', lw=3, alpha=0.5, ls='none', label=label, zorder=-10)

plt.legend()
plt.axhline(0, c='k', ls=':')
plt.xlim(0, 5)
plt.ylim(15, 70)
plt.xlabel('Wavelength ($\\mu$m)')
plt.ylabel('Flux (nJy)')
plt.semilogy()
ax.yaxis.set_major_formatter(ticker.FormatStrFormatter("%g"))
ax.yaxis.set_minor_formatter(ticker.FormatStrFormatter("%g"))

# Add AB magnitudes as secondary x-axis at right
# (Note this breaks if any fluxes are negative)
# https://matplotlib.org/gallery/subplots_axes_and_figures/secondary_axis.html#sphx-glr-gallery-subplots-axes-and-figures-secondary-axis-py

def AB2nJy(mAB):
    m = mAB * u.ABmag
    f = m.to(u.nJy)
    return f.value

def nJy2AB(F_nJy):
    f = F_nJy * u.nJy
    m = f.to(u.ABmag)
    return m.value

# secondary_axis = add_magnitude_axis(ax, flux_units)
secax = ax.secondary_yaxis('right', functions=(nJy2AB, AB2nJy))
secax.set_ylabel('magnitude (AB)')
secax.yaxis.set_major_formatter(ticker.FormatStrFormatter("%g"))
secax.yaxis.set_minor_formatter(ticker.FormatStrFormatter("%g"))

plt.title('JADES SED PSF-corrected')
# plt.savefig('JADES photutils SED.png')
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/NIRCam_PSF-matched_photometry"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="../NIRCam_photometry/NIRCam_multiband_photometry.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            Extended Aperture Photometry
           </p>
          </div>
         </a>
         <a class="right-next" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            PSF Photometry
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>