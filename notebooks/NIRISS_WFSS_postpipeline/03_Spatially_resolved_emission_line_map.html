<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   WFSS Spectra Part 3: Emission Line Map — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" rel="next" title="IFU Cube Fitting"/>
  <link href="02_Cross_correlation_template.html" rel="prev" title="WFSS Spectra - Part 2: Cross Correlation to Determine Redshift"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../cube_fitting/cube_fitting.html">
            IFU Cube Line Maps
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks//issues/new?title=Issue%20on%20page%20%2Fnotebooks/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#introduction">
           Introduction
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#download-notebook-01-products">
             0. Download notebook 01 products
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#get-halpha-emission-line-map">
             1.Get Halpha emission line map;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#subtract-continuum-at-each-y-position">
             Subtract continuum at each y-position:
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-halpha-emission-from-a-continuum-subtracted-spectrum">
             Extract Halpha emission from a continuum-subtracted spectrum;
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#get-hbeta-and-oiii-maps">
             2.Get Hbeta and OIII maps
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#in-the-plot-above-you-can-see-oiii-doublet-and-hbeta">
             In the plot above, you can see Oiii doublet, and Hbeta.
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#a-get-continuum">
               2a. Get continuum;
              </a>
             </li>
             <li class="toc-h4 nav-item toc-entry">
              <a class="reference internal nav-link" href="#b-fit-emissionn-with-multi-conponent-gaussian">
               2b. Fit emissionn, with multi-conponent gaussian;
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#fit-to-the-central-array-looks-good-repeat-this-along-y-axis-and-get-emission-line-maps-as-a-same-way-as-for-halpha">
             Fit to the central array looks good. Repeat this along y-axis and get emission line maps, as a same way as for Halpha
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#summary">
           Summary;
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         WFSS Spectra Part 3: Emission Line Map
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#download-notebook-01-products">
                0. Download notebook 01 products
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#get-halpha-emission-line-map">
                1.Get Halpha emission line map;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#subtract-continuum-at-each-y-position">
                Subtract continuum at each y-position:
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#extract-halpha-emission-from-a-continuum-subtracted-spectrum">
                Extract Halpha emission from a continuum-subtracted spectrum;
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#get-hbeta-and-oiii-maps">
                2.Get Hbeta and OIII maps
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#in-the-plot-above-you-can-see-oiii-doublet-and-hbeta">
                In the plot above, you can see Oiii doublet, and Hbeta.
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#a-get-continuum">
                  2a. Get continuum;
                 </a>
                </li>
                <li class="toc-h4 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#b-fit-emissionn-with-multi-conponent-gaussian">
                  2b. Fit emissionn, with multi-conponent gaussian;
                 </a>
                </li>
               </ul>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#fit-to-the-central-array-looks-good-repeat-this-along-y-axis-and-get-emission-line-maps-as-a-same-way-as-for-halpha">
                Fit to the central array looks good. Repeat this along y-axis and get emission line maps, as a same way as for Halpha
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#summary">
              Summary;
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="wfss-spectra-part-3-emission-line-map">
          <h1>
           WFSS Spectra Part 3: Emission Line Map
           <a class="headerlink" href="#wfss-spectra-part-3-emission-line-map" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           optimal extraction of grism spectra; redshift measurement; emission-line maps.  Simplified version of
           <a class="reference external" href="https://jwst-docs.stsci.edu/near-infrared-imager-and-slitless-spectrograph/niriss-example-science-programs/niriss-wfss-with-nircam-parallel-imaging-of-galaxies-in-lensing-clusters">
            JDox Science Use Case # 33
           </a>
           .
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRISS images from
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-other-tools/mirage-data-simulator">
            MIRAGE
           </a>
           , run through the
           <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/">
            JWST calibration pipeline
           </a>
           ; galaxy cluster.
           <br/>
           <strong>
            Tools:
           </strong>
           specutils, astropy, pandas, emcee, lmfit, corner, h5py.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRSpec
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScI’s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            This notebook is 4 of 4 in a set focusing on NIRISS WFSS data:
1. 1D optimal extraction since the JWST pipeline only provides a box extraction.  Optimal extraction improves S/N of spectra for faint sources.
2. Combine and normalize 1D spectra.
3. Cross correlate galaxy with template to get redshift.
4. Spatially resolved emission line map.
           </p>
           <p>
            This notebook obtains an emission line map from the 2D-cutout of NIRISS WFSS spectra. This notebook will require the 2D-cutout of NIRISS WFSS spectrum (e.g., l3_nis_f150w_G150C_s00004_cal.fits; Pipeline spec3 product).
           </p>
           <p>
            <strong>
             Note:
            </strong>
            For this example, the notebook uses only a 2D rectified spectra at one dither position, directly obtained from the current versionn of the  pipeline (Build 7.5), but one could start with spectra stacked with all dither positions too, to improve S/Ns.
           </p>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>%matplotlib inline
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import os

import numpy as np

from astropy.convolution import Gaussian2DKernel
from astropy.io import fits
from astropy.stats import gaussian_fwhm_to_sigma
from astropy.table import QTable
import astropy.units as u
from astropy.visualization import make_lupton_rgb, SqrtStretch, ImageNormalize, simple_norm
import astropy.wcs as wcs
from astropy.modeling import models
from astropy import units as u
from astropy.modeling.polynomial import Chebyshev1D

from specutils.spectra import Spectrum1D
from specutils.fitting import fit_lines
from specutils.fitting import continuum

from astropy import __version__ as astropy_version
print('astropy', astropy_version)
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>astropy 5.2
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span>import matplotlib.pyplot as plt
import matplotlib as mpl

mpl.rcParams['savefig.dpi'] = 80
mpl.rcParams['figure.dpi'] = 80
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="download-notebook-01-products">
            <h3>
             0. Download notebook 01 products
             <a class="headerlink" href="#download-notebook-01-products" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             These can be also obtained by running the notebooks.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>if not os.path.exists('./output'):
    import zipfile
    import urllib.request
    boxlink = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/output.zip'
    boxfile = './output.zip'
    urllib.request.urlretrieve(boxlink, boxfile)
    zf = zipfile.ZipFile(boxfile, 'r')
    zf.extractall()
else:
    print('Already exists')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stream highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Already exists
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Download files, if not exists yet.
if not os.path.exists('./pipeline_products'):
    import zipfile
    import urllib.request
    boxlink = 'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/NIRISS_lensing_cluster/pipeline_products.zip'
    boxfile = './pipeline_products.zip'
    urllib.request.urlretrieve(boxlink, boxfile)
    zf = zipfile.ZipFile(boxfile, 'r')
    zf.extractall()
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Which target?
DIR_OUT = './output/'
filt = 'f200w'

grism = 'G150C'
#grism = 'G150R'

id = '00004'
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="get-halpha-emission-line-map">
            <h3>
             1.Get Halpha emission line map;
             <a class="headerlink" href="#get-halpha-emission-line-map" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Open two-dimensional file;
# can be downloaded in No.01a.
DIR_DATA = './pipeline_products/'

# Zero-indexed number for dither --- the test data has two dither positions.
ndither = 0

# File
file_2d = '%sl3_nis_%s_%s_s%s_cal.fits'%(DIR_DATA, filt, grism, id)
hdu_2d = fits.open(file_2d)

# Align grism direction
#   - x-direction = Dispersion (wavelength) direction.
#   - y-direction = Cross-dispersion.
# in this notebook.
    
if grism == 'G150C':
    # If spectrum is horizontal;
    data_2d = hdu_2d[ndither*7+1].data
    dq_2d = hdu_2d[ndither*7+2].data
    err_2d = hdu_2d[ndither*7+3].data
    wave_2d = hdu_2d[ndither*7+4].data
else:
    data_2d = rotate(hdu_2d[ndither*7+1].data, 90)
    dq_2d = rotate(hdu_2d[ndither*7+2].data, 90)
    err_2d = rotate(hdu_2d[ndither*7+3].data, 90)
    wave_2d = rotate(hdu_2d[ndither*7+4].data, 90)
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(data_2d[:,:])
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f98b8a8f790&gt;
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_11_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_11_1.png"/>
             </div>
            </div>
           </section>
           <section id="subtract-continuum-at-each-y-position">
            <h3>
             Subtract continuum at each y-position:
             <a class="headerlink" href="#subtract-continuum-at-each-y-position" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             There are two options, depending on the brightness of the source;
            </p>
            <ul class="simple">
             <li>
              <p>
               1.Subtract continuum estimated at each position of cross-dispersion column. This works for a bright source.
              </p>
             </li>
             <li>
              <p>
               2.Subtract a single continuum (“master continuum”), assuming the shape is same across cross-dispersion direction as the one from a 1d extraction. This is required for a faint source.
              </p>
             </li>
            </ul>
            <p>
             Since we clearly see continuum across the source, here we demonstrate the option 1.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># At which y position do we want to see spectrum?
# as an example;
yy = 10

spec_unit = u.dimensionless_unscaled

mask_line = ((wave_2d[yy,:] &gt; 1.75) &amp; (wave_2d[yy,:] &lt; 1.97)) | ((wave_2d[yy,:] &gt; 2.08) &amp; (wave_2d[yy,:] &lt; 2.23))

obs  = Spectrum1D(spectral_axis=wave_2d[yy,:][mask_line]*u.um, flux=data_2d[yy,:][mask_line]*spec_unit)
cont = continuum.fit_generic_continuum(obs, model=Chebyshev1D(7))

plt.plot(wave_2d[yy,:], data_2d[yy,:], color='r', label='Observed at y=%d'%(yy))
plt.plot(wave_2d[yy,:][mask_line]*u.um, cont(wave_2d[yy,:][mask_line]*u.um), color='b', label='Fitted continuum')

plt.legend(loc=0)
plt.xlim(1.6, 2.3)
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre>
               </div>
              </div>
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>(1.6, 2.3)
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_13_2.png" src="../../_images/03_Spatially_resolved_emission_line_map_13_2.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>cont(wave_2d[yy,:][mask_line]*u.um).value
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>array([250.33514625, 251.34196997, 252.3399539 , 253.31373358,
       254.24980241, 255.13666809, 255.96455649, 256.72516215,
       257.41178054, 258.01904392, 258.54273027, 258.97986573,
       259.32840475, 259.58730346, 259.75633833, 259.83601505,
       259.82753631, 259.73268276, 259.55376941, 259.29355234,
       258.95516032, 258.54210389, 258.05809227, 257.50714698,
       256.89339286, 256.22107226, 255.4946214 , 254.71842986,
       253.89689648, 253.03453451, 252.13569698, 251.2046636 ,
       227.2937026 , 226.56797698, 225.86951509, 225.19837698,
       224.55451447, 223.93770343, 223.34764344, 222.78388357,
       222.24585274, 221.73279607, 221.24384862, 220.7779845 ,
       220.33396715, 219.91041011, 219.50570908, 219.11804745,
       218.74533159, 218.38522917, 218.03510699, 217.69197741,
       217.35251716, 217.01299411, 216.66924474, 216.31659529,
       215.94986731, 215.56329808, 215.15045747, 214.70424554,
       214.21679044, 213.6794031 , 213.08244929, 212.41535398,
       211.66646567, 210.82300532, 209.87088579, 208.79474276,
       207.57778338, 206.20156842, 204.64608538, 202.88950983,
       200.90816203, 198.67616835, 196.16562581, 193.34633991,
       190.18542588, 186.64758372, 182.694655  ])
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Repeat this along y-axis;
flux_cont2d = data_2d[:,:] * 0
for yy in range(len(data_2d[:,0])):

    mask_line = ((wave_2d[yy,:] &gt; 1.75) &amp; (wave_2d[yy,:] &lt; 1.97)) | ((wave_2d[yy,:] &gt; 2.08) &amp; (wave_2d[yy,:] &lt; 2.23))

    obs = Spectrum1D(spectral_axis=wave_2d[yy,:][mask_line]*u.um, flux=data_2d[yy,:][mask_line]*spec_unit)
    cont = continuum.fit_generic_continuum(obs, model=Chebyshev1D(7))

    flux_cont2d[yy,:] = cont(wave_2d[yy,:]*u.um).value
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(flux_cont2d[:,:])
plt.title('Fitted continuum')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Fitted continuum')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_16_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_16_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(data_2d[:,:] - flux_cont2d[:,:])
plt.title('Continuum subtracted spectrum')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Continuum subtracted spectrum')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_17_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_17_1.png"/>
             </div>
            </div>
           </section>
           <section id="extract-halpha-emission-from-a-continuum-subtracted-spectrum">
            <h3>
             Extract Halpha emission from a continuum-subtracted spectrum;
             <a class="headerlink" href="#extract-halpha-emission-from-a-continuum-subtracted-spectrum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Cutout Ha line map;
rsq = data_2d.shape[0]
cut_ha = np.zeros((rsq,rsq),'float32')

zin = 2.1 # From Notebook No.3, cross-correlation;
lamcen = 0.6564 * (1. + zin)

for yy in range(len(data_2d[:,0])):
    # This has to be done at each y pixel, as wavelength array can be tilted.
    index_lamcen = np.argmin(np.abs(lamcen - wave_2d[yy,:]))
    cut_ha[yy,:] = (data_2d - flux_cont2d)[yy, int(index_lamcen-rsq/2.) : int(index_lamcen+rsq/2.)]

plt.imshow(cut_ha)
plt.title('H$\\alpha$ map')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'H$\\alpha$ map')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_19_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_19_1.png"/>
             </div>
            </div>
           </section>
           <section id="get-hbeta-and-oiii-maps">
            <h3>
             2.Get Hbeta and OIII maps
             <a class="headerlink" href="#get-hbeta-and-oiii-maps" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             This is more challenging, as these lines locate close to each other. Ideally, iteration process will be preferred, but here we use Specutils’ double gaussian component fitting, in a similar way for Ha.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>filt = 'f150w'

file_2d = '%sl3_nis_%s_%s_s%s_cal.fits'%(DIR_DATA, filt, grism, id)
hdu_2d = fits.open(file_2d)

# Align grism direction
#   - x-direction = Dispersion (wavelength) direction.
#   - y-direction = Cross-dispersion.
# in this notebook.
    
if grism == 'G150C':
    # If spectrum is horizontal;
    data_2d = hdu_2d[ndither*7+1].data
    dq_2d = hdu_2d[ndither*7+2].data
    err_2d = hdu_2d[ndither*7+3].data
    wave_2d = hdu_2d[ndither*7+4].data
else:
    data_2d = rotate(hdu_2d[ndither*7+1].data, 90)
    dq_2d = rotate(hdu_2d[ndither*7+2].data, 90)
    err_2d = rotate(hdu_2d[ndither*7+3].data, 90)
    wave_2d = rotate(hdu_2d[ndither*7+4].data, 90)
    
# !! Note that the extracted spectra has flipped wavelength direction !!
plt.imshow(data_2d[:, ::-1])
plt.title('%s'%(filt))
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'f150w')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_21_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_21_1.png"/>
             </div>
            </div>
           </section>
           <section id="in-the-plot-above-you-can-see-oiii-doublet-and-hbeta">
            <h3>
             In the plot above, you can see Oiii doublet, and Hbeta.
             <a class="headerlink" href="#in-the-plot-above-you-can-see-oiii-doublet-and-hbeta" title="Permalink to this headline">
              #
             </a>
            </h3>
            <section id="a-get-continuum">
             <h4>
              2a. Get continuum;
              <a class="headerlink" href="#a-get-continuum" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>yy = 10 # as an example;

spec_unit = u.dimensionless_unscaled

mask_line = ((wave_2d[yy,:] &gt; 1.35) &amp; (wave_2d[yy,:] &lt; 1.48)) | ((wave_2d[yy,:] &gt; 1.6) &amp; (wave_2d[yy,:] &lt; 1.65))

obs = Spectrum1D(spectral_axis=wave_2d[yy,:][mask_line]*u.um, flux=data_2d[yy,:][mask_line]*spec_unit)
cont = continuum.fit_generic_continuum(obs, model=Chebyshev1D(7))

plt.plot(wave_2d[yy,:], data_2d[yy,:], color='r', label='Observed at y=%d'%(yy))
plt.plot(wave_2d[yy,:][mask_line]*u.um, cont(wave_2d[yy,:][mask_line]*u.um), color='b', label='Fitted continuum')

plt.legend(loc=0)
plt.xlim(1.2, 1.8)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output text_plain highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>(1.2, 1.8)
</pre>
                </div>
               </div>
               <img alt="../../_images/03_Spatially_resolved_emission_line_map_24_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_24_1.png"/>
              </div>
             </div>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span># Repeat this along y-axis;
flux_cont2d_150 = data_2d[:,:] * 0
for yy in range(len(data_2d[:,0])):

    mask_line = ((wave_2d[yy,:] &gt; 1.35) &amp; (wave_2d[yy,:] &lt; 1.48)) | ((wave_2d[yy,:] &gt; 1.6) &amp; (wave_2d[yy,:] &lt; 1.65))

    obs = Spectrum1D(spectral_axis=wave_2d[yy,:][mask_line]*u.um, flux=data_2d[yy,:][mask_line]*spec_unit)
    cont = continuum.fit_generic_continuum(obs, model=Chebyshev1D(7))

    flux_cont2d_150[yy,:] = cont(wave_2d[yy,:]*u.um).value

plt.imshow(flux_cont2d_150[:, ::-1])
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output text_plain highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f988c2c8fa0&gt;
</pre>
                </div>
               </div>
               <img alt="../../_images/03_Spatially_resolved_emission_line_map_25_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_25_1.png"/>
              </div>
             </div>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>line_2d = data_2d[:,:] - flux_cont2d_150[:,:]

plt.imshow(line_2d[:, ::-1])
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output text_plain highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>&lt;matplotlib.image.AxesImage at 0x7f988c01b850&gt;
</pre>
                </div>
               </div>
               <img alt="../../_images/03_Spatially_resolved_emission_line_map_26_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_26_1.png"/>
              </div>
             </div>
            </section>
            <section id="b-fit-emissionn-with-multi-conponent-gaussian">
             <h4>
              2b. Fit emissionn, with multi-conponent gaussian;
              <a class="headerlink" href="#b-fit-emissionn-with-multi-conponent-gaussian" title="Permalink to this headline">
               #
              </a>
             </h4>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>yy = 10

# Fit the spectrum
con = (1.4 &lt; wave_2d[yy,:]) &amp; (wave_2d[yy,:] &lt; 1.65)

spectrum_cut = Spectrum1D(flux=line_2d[yy,:][con]*spec_unit,
                          spectral_axis=wave_2d[yy,:][con]*u.um)

# !!! Some tweaks may be needed for initial value, to successfuully run the fit;

# For Hb
g1_init = models.Gaussian1D(amplitude=40*spec_unit, mean=1.5*u.um, stddev=0.005*u.um)

# For O3 blue
g2_init = models.Gaussian1D(amplitude=50.*spec_unit, mean=1.535*u.um, stddev=0.002*u.um)

# For O3 red
g3_init = models.Gaussian1D(amplitude=45.*spec_unit, mean=1.55*u.um, stddev=0.001*u.um)

g123_fit = fit_lines(spectrum_cut, g1_init+g2_init+g3_init, window=[0.01*u.um,0.001*u.um,0.001*u.um])
y_fit = g123_fit(wave_2d[yy,:]*u.um)

print(g123_fit)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: CompoundModel
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Expression: [0] + [1] + [2]
Components: 
    [0]: &lt;Gaussian1D(amplitude=105.67672529 , mean=1.50774443 um, stddev=0.00935698 um)&gt;

    [1]: &lt;Gaussian1D(amplitude=82.09499951 , mean=1.53395958 um, stddev=0.0064488 um)&gt;

    [2]: &lt;Gaussian1D(amplitude=186.44732716 , mean=1.54938177 um, stddev=0.0110966 um)&gt;
Parameters:
       amplitude_0           mean_0       ...       stddev_2      
                               um         ...          um         
    ------------------ ------------------ ... --------------------
    105.67672528736512 1.5077444323784523 ... 0.011096600264679632
</pre>
                </div>
               </div>
               <div class="output stderr highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
                </div>
               </div>
              </div>
             </div>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span># Plot separately?
plt.plot(wave_2d[yy,:], line_2d[yy,:], marker='.', ls='', color='r', label='Observed at y=%d'%(yy))
plt.plot(wave_2d[yy,:], y_fit, color='b', label='Fit', zorder=-2, alpha=0.4, lw=5)

y_fit1 = g123_fit[0](wave_2d[yy,:]*u.um)
plt.plot(wave_2d[yy,:], y_fit1, color='g', label='1')

y_fit1 = g123_fit[1](wave_2d[yy,:]*u.um)
plt.plot(wave_2d[yy,:], y_fit1, color='orange', label='2')

y_fit1 = g123_fit[2](wave_2d[yy,:]*u.um)
plt.plot(wave_2d[yy,:], y_fit1, color='purple', label='3')

plt.xlim(1.4, 1.6)

plt.title('Single fit peak')
plt.grid(True)
plt.legend(loc=2)
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output text_plain highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>&lt;matplotlib.legend.Legend at 0x7f988bfbd2e0&gt;
</pre>
                </div>
               </div>
               <img alt="../../_images/03_Spatially_resolved_emission_line_map_29_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_29_1.png"/>
              </div>
             </div>
             <div class="cell docutils container">
              <div class="cell_input docutils container">
               <div class="highlight-ipython3 notranslate">
                <div class="highlight">
                 <pre><span></span>print(g123_fit[0])
print(g123_fit[1])
print(g123_fit[2])
</pre>
                </div>
               </div>
              </div>
              <div class="cell_output docutils container">
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: Gaussian1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Parameters:
        amplitude             mean               stddev       
                               um                  um         
    ------------------ ------------------ --------------------
    105.67672528736512 1.5077444323784523 0.009356977079029261
</pre>
                </div>
               </div>
               <div class="output stream highlight-myst-ansi notranslate">
                <div class="highlight">
                 <pre><span></span>Model: Gaussian1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Parameters:
        amplitude            mean               stddev       
                              um                  um         
    ----------------- ------------------ --------------------
    82.09499950808333 1.5339595832025317 0.006448802572610104
Model: Gaussian1D
Inputs: ('x',)
Outputs: ('y',)
Model set size: 1
Parameters:
        amplitude             mean               stddev       
                               um                  um         
    ------------------ ------------------ --------------------
    186.44732716000823 1.5493817718594916 0.011096600264679632
</pre>
                </div>
               </div>
              </div>
             </div>
            </section>
           </section>
           <section id="fit-to-the-central-array-looks-good-repeat-this-along-y-axis-and-get-emission-line-maps-as-a-same-way-as-for-halpha">
            <h3>
             Fit to the central array looks good. Repeat this along y-axis and get emission line maps, as a same way as for Halpha
             <a class="headerlink" href="#fit-to-the-central-array-looks-good-repeat-this-along-y-axis-and-get-emission-line-maps-as-a-same-way-as-for-halpha" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span># Cutout Hb, Oiii line maps;
rsq = data_2d.shape[0]
cut_hb  = np.zeros((rsq, rsq), 'float32')
cut_o3b = np.zeros((rsq, rsq), 'float32')
cut_o3r = np.zeros((rsq, rsq), 'float32')

zin = 2.1 # Redshift estimate from Notebook No.2, cross-correlation;
lamcen_hb  = 0.4862680 * (1. + zin)
lamcen_o3b = 0.4960295 * (1. + zin)
lamcen_o3r = 0.5008240 * (1. + zin)

for yy in range(len(data_2d[:,0])):
    # Fit the spectrum
    con = (1.4 &lt; wave_2d[yy,:]) &amp; (wave_2d[yy,:] &lt; 1.65)
    spectrum_cut = Spectrum1D(flux=line_2d[yy,:][con]*spec_unit, 
                              spectral_axis=wave_2d[yy,:][con]*u.um)

    # !!! Some tweaks may be needed for initial value, to successfuully run the fit;

    # For Hb
    g1_init = models.Gaussian1D(amplitude=40*spec_unit, mean=1.5*u.um, stddev=0.005*u.um)
    # For O3 blue
    g2_init = models.Gaussian1D(amplitude=50.*spec_unit, mean=1.535*u.um, stddev=0.002*u.um)
    # For O3 red
    g3_init = models.Gaussian1D(amplitude=45.*spec_unit, mean=1.55*u.um, stddev=0.001*u.um)
    g123_fit = fit_lines(spectrum_cut, g1_init+g2_init+g3_init, window=[0.01*u.um, 0.001*u.um, 0.001*u.um])
    y_fit = g123_fit(wave_2d[yy,:]*u.um)

    # This has to be done at each y pixel, as wavelength array can be tilted.
    index_lamcen_hb = np.argmin(np.abs(lamcen_hb - wave_2d[yy,:]))
    cut_hb[yy,:] = g123_fit[0](wave_2d[yy,:]*u.um)[int(index_lamcen_hb-rsq/2.) : int(index_lamcen_hb+rsq/2.)]

    index_lamcen_o3b = np.argmin(np.abs(lamcen_o3b - wave_2d[yy,:]))
    cut_o3b[yy,:] = g123_fit[1](wave_2d[yy,:]*u.um)[int(index_lamcen_o3b-rsq/2.) : int(index_lamcen_o3b+rsq/2.)]

    index_lamcen_o3r = np.argmin(np.abs(lamcen_o3r - wave_2d[yy,:]))
    cut_o3r[yy,:] = g123_fit[2](wave_2d[yy,:]*u.um)[int(index_lamcen_o3r-rsq/2.) : int(index_lamcen_o3r+rsq/2.)]
    
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: The fit may be unsuccessful; check fit_info['message'] for more information. [astropy.modeling.fitting]
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(cut_hb)
plt.title('H$\\beta$ map')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'H$\\beta$ map')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_33_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_33_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(cut_o3b)
plt.title('Oiii 4960')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Oiii 4960')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_34_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_34_1.png"/>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span>plt.imshow(cut_o3r)
plt.title('Oiii 5008')
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Oiii 5008')
</pre>
               </div>
              </div>
              <img alt="../../_images/03_Spatially_resolved_emission_line_map_35_1.png" src="../../_images/03_Spatially_resolved_emission_line_map_35_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="summary">
           <h2>
            Summary;
            <a class="headerlink" href="#summary" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            As seen above, regions except for the very center
            <font color="red">
             do not look right.
            </font>
            This is due to failure of multi-component fit, especially for Oiii doublet.
To improve the fit, one can either;
           </p>
           <ul class="simple">
            <li>
             <p>
              fit and inspect the fit repeatedly at each y-axis until it converges,
             </p>
            </li>
            <li>
             <p>
              use MCMC for more intensive fitting, which also enables to fix the ratio of two Oiii lines by setting up a prior.
             </p>
            </li>
            <li>
             <p>
              or reduce the number of components, especially for Oiii doublet at the edge of the source position, where the lines are blended.
             </p>
            </li>
           </ul>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/NIRISS_WFSS_postpipeline"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="02_Cross_correlation_template.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            WFSS Spectra - Part 2: Cross Correlation to Determine Redshift
           </p>
          </div>
         </a>
         <a class="right-next" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            IFU Cube Fitting
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>