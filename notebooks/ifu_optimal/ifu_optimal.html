<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   IFU Optimal Spectral Extraction — STScI JDAT Notebooks
  </title>
  <script data-cfasync="false">
   document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" rel="preload"/>
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/_sphinx_javascript_frameworks_compat.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-D46G4HKJY3');
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script>
   DOCUMENTATION_OPTIONS.pagename = 'notebooks/ifu_optimal/ifu_optimal';
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../optimal_extraction/Spectral_Extraction-static.html" rel="next" title="MOS Optimal Spectral Extraction"/>
  <link href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" rel="prev" title="IFU Cube Fitting"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="en" name="docsearch:language"/>
 </head>
 <body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">
  <a class="skip-link" href="#main-content">
   Skip to main content
  </a>
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
  <label class="overlay overlay-primary" for="__primary">
  </label>
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
  <label class="overlay overlay-secondary" for="__secondary">
  </label>
  <div class="search-button__wrapper">
   <div class="search-button__overlay">
   </div>
   <div class="search-button__search-container">
    <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
     <i class="fa-solid fa-magnifying-glass">
     </i>
     <input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
     <span class="search-button__kbd-shortcut">
      <kbd class="kbd-shortcut__modifier">
       Ctrl
      </kbd>
      +
      <kbd>
       K
      </kbd>
     </span>
    </form>
   </div>
  </div>
  <nav class="bd-header navbar navbar-expand-lg bd-navbar">
  </nav>
  <div class="bd-container">
   <div class="bd-container__inner bd-page-width">
    <div class="bd-sidebar-primary bd-sidebar">
     <div class="sidebar-header-items sidebar-primary__section">
     </div>
     <div class="sidebar-primary-items__start sidebar-primary__section">
      <div class="sidebar-primary-item">
       <a class="navbar-brand logo" href="../../intro.html">
        <img alt="Logo image" class="logo__image only-light" src="../../_static/stsci_logo2.png"/>
        <script>
         document.write(`<img src="../../_static/stsci_logo2.png" class="logo__image only-dark" alt="Logo image"/>`);
        </script>
       </a>
      </div>
      <div class="sidebar-primary-item">
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item navbar-nav active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           General
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../index.html">
            Home
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../install.html">
            Installation
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/notebook_development_workflow.html">
            Notebook Development Workflow
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Development
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/submitting_notebooks.html">
            Submitting Notebooks
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/requirements.html">
            Requirements file
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/notebooks.html">
            Jupyter Notebooks
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/data_files.html">
            Data Files
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           GitHub Guidelines
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_setup.html">
            GitHub Setup
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_workflow.html">
            GitHub Workflow
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../../docs/github_pr.html">
            GitHub PR
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Cross-Instrument
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../background_estimation_imaging/Imaging_Sky_Background_Estimation.html">
            Complex 2D Background
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../rgb_imviz/imviz_rgb_carina.html">
            RGB images with Imviz
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_runpipeline.html">
            MRS Mstar - Run Pipeline
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_PointSourceDetectorBasedExtraction.html">
            MRS Detector Based Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MRS_Mstar_analysis/JWST_Mstar_dataAnalysis_analysis.html">
            MRS Mstar - Data Analysis
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRCam
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_photometry/NIRCam_multiband_photometry.html">
            Extended Aperture Photometry
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/00_Optimal_extraction.html">
            WFSS Spectra - Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/01_Combine_and_normalize_1D_spectra.html">
            WFSS Spectra - Combine and Normalize 1D Spectra
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/02_Cross_correlation_template.html">
            WFSS Spectra - Cross-Correlation Template
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRISS_WFSS_postpipeline/03_Spatially_resolved_emission_line_map.html">
            WFSS Spectra - Emission Line Map
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            IFU Optimal Spectral Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../optimal_extraction/Spectral_Extraction-static.html">
            MOS Optimal Extraction
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../mos_spectroscopy_advanced/MOSspec_advanced.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
     </div>
     <div class="sidebar-primary-items__end sidebar-primary__section">
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <main class="bd-main" id="main-content">
     <div class="sbt-scroll-pixel-helper">
     </div>
     <div class="bd-content">
      <div class="bd-article-container">
       <div class="bd-header-article">
        <div class="header-article-items header-article__inner">
         <div class="header-article-items__start">
          <div class="header-article-item">
           <label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
            <span class="fa-solid fa-bars">
            </span>
           </label>
          </div>
         </div>
         <div class="header-article-items__end">
          <div class="header-article-item">
           <div class="article-header-buttons">
            <div class="dropdown dropdown-launch-buttons">
             <button aria-expanded="false" aria-label="Launch interactive content" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fas fa-rocket">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <button class="btn btn-sm btn-launch-thebe dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
                <span class="btn__icon-container">
                 <i class="fas fa-play">
                 </i>
                </span>
                <span class="btn__text-container">
                 Live Code
                </span>
               </button>
              </li>
             </ul>
            </div>
            <div class="dropdown dropdown-source-buttons">
             <button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fab fa-github">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <a class="btn btn-sm btn-source-repository-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks" target="_blank" title="Source repository">
                <span class="btn__icon-container">
                 <i class="fab fa-github">
                 </i>
                </span>
                <span class="btn__text-container">
                 Repository
                </span>
               </a>
              </li>
              <li>
               <a class="btn btn-sm btn-source-issues-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/spacetelescope/jdat_notebooks/issues/new?title=Issue%20on%20page%20%2Fnotebooks/ifu_optimal/ifu_optimal.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
                <span class="btn__icon-container">
                 <i class="fas fa-lightbulb">
                 </i>
                </span>
                <span class="btn__text-container">
                 Open issue
                </span>
               </a>
              </li>
             </ul>
            </div>
            <div class="dropdown dropdown-download-buttons">
             <button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
              <i class="fas fa-download">
              </i>
             </button>
             <ul class="dropdown-menu">
              <li>
               <a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="../../_sources/notebooks/ifu_optimal/ifu_optimal.ipynb" target="_blank" title="Download source file">
                <span class="btn__icon-container">
                 <i class="fas fa-file">
                 </i>
                </span>
                <span class="btn__text-container">
                 .ipynb
                </span>
               </a>
              </li>
              <li>
               <button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
                <span class="btn__icon-container">
                 <i class="fas fa-file-pdf">
                 </i>
                </span>
                <span class="btn__text-container">
                 .pdf
                </span>
               </button>
              </li>
             </ul>
            </div>
            <button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
             <span class="btn__icon-container">
              <i class="fas fa-expand">
              </i>
             </span>
            </button>
            <script>
             document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
            </script>
            <script>
             document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
            </script>
            <label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
             <span class="fa-solid fa-list">
             </span>
            </label>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         IFU Optimal Spectral Extraction
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#imports">
              Imports
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#introduction">
              Introduction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#read-in-simulated-nirspec-ifu-cube">
              Read in Simulated NIRSpec IFU Cube
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#visualize-science-data-with-cubeviz">
              Visualize Science Data with Cubeviz
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#ui-instructions">
                UI Instructions:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#load-cube-into-cubeviz">
              Load Cube into Cubeviz
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#export-region-from-cubeviz">
              Export Region from Cubeviz
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer">
              Extract Subset Spectrum in Cubeviz Spectrum Viewer
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-spectrum-by-sum-over-spaxels">
              Extract Spectrum by Sum Over Spaxels
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-spectrum-in-constant-radius-circular-aperture-cylinder">
              Extract Spectrum in Constant Radius Circular Aperture (Cylinder)
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#extract-spectrum-in-linearly-expanding-circular-aperture-cone">
              Extract Spectrum in Linearly Expanding Circular Aperture (Cone)
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#plot-and-compare-non-optimal-spectral-extractions">
              Plot and Compare Non-optimal Spectral Extractions
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#webbpsf-model-psf-for-optimal-extraction">
              WebbPSF  Model PSF for Optimal Extraction
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#align-model-psf-cube-with-science-data">
              Align Model PSF Cube with Science Data
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#optimal-extraction-using-webbpsf-model">
              Optimal Extraction using WebbPSF Model
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#optimal-extraction-with-simulated-reference-star-psf">
              Optimal Extraction with (Simulated) Reference Star PSF
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <div id="searchbox">
       </div>
       <article class="bd-article" role="main">
        <section id="ifu-optimal-spectral-extraction">
         <h1>
          IFU Optimal Spectral Extraction
          <a class="headerlink" href="#ifu-optimal-spectral-extraction" title="Permalink to this heading">
           #
          </a>
         </h1>
         <p>
          <strong>
           Use case:
          </strong>
          optimal spectral extraction; method by
          <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/1986PASP...98..609H/abstract">
           Horne (1986)
          </a>
          .
          <br/>
          <strong>
           Data:
          </strong>
          JWST simulated NIRSpec IFU data; point sources.
          <br/>
          <strong>
           Tools:
          </strong>
          jwst, webbpsf, matplotlib, scipy, custom functions.
          <br/>
          <strong>
           Cross-intrument:
          </strong>
          any spectrograph.
          <br/>
          <strong>
           Documentation:
          </strong>
          This notebook is part of a STScI’s larger
          <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
           post-pipeline Data Analysis Tools Ecosystem
          </a>
          .
          <br/>
         </p>
         <section id="imports">
          <h2>
           Imports
           <a class="headerlink" href="#imports" title="Permalink to this heading">
            #
           </a>
          </h2>
          <ul class="simple">
           <li>
            <p>
             <em>
              time
             </em>
             for adding a delay in Cubeviz file upload
            </p>
           </li>
           <li>
            <p>
             <em>
              numpy
             </em>
             for array math
            </p>
           </li>
           <li>
            <p>
             <em>
              scipy
             </em>
             for gaussian smoothing
            </p>
           </li>
           <li>
            <p>
             <em>
              specutils
             </em>
             for Spectrum1D data model
            </p>
           </li>
           <li>
            <p>
             <em>
              jdaviz
             </em>
             : Cubeviz data visualization tool
            </p>
           </li>
           <li>
            <p>
             <em>
              regions
             </em>
             to read DS9 regions
            </p>
           </li>
           <li>
            <p>
             <em>
              photutils
             </em>
             to define circular apertures
            </p>
           </li>
           <li>
            <p>
             <em>
              astropy.io
             </em>
             for reading and writing FITS cubes and images
            </p>
           </li>
           <li>
            <p>
             <em>
              astropy.wcs, units, coordinates
             </em>
             for defining and reading WCS
            </p>
           </li>
           <li>
            <p>
             <em>
              astropy.stats
             </em>
             for sigma_clipping
            </p>
           </li>
           <li>
            <p>
             <em>
              astropy.utils
             </em>
             for downloading files from URLs
            </p>
           </li>
           <li>
            <p>
             <em>
              matplotlib
             </em>
             for plotting spectra and images
            </p>
           </li>
          </ul>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">import</span> <span class="nn">specutils</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>

<span class="kn">from</span> <span class="nn">jdaviz</span> <span class="kn">import</span> <span class="n">Cubeviz</span>

<span class="kn">from</span> <span class="nn">regions</span> <span class="kn">import</span> <span class="n">CircleSkyRegion</span>

<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">SkyCircularAperture</span><span class="p">,</span> <span class="n">aperture_photometry</span> 

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clip</span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="introduction">
          <h2>
           Introduction
           <a class="headerlink" href="#introduction" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           This notebook illustrates various extraction methods for a point source in JWST NIRSpec IFU data. First we
demonstrate a number of regular extraction techniques, including subset extraction with Cubeviz, simple sum over spaxels, cylindrical aperture, and conical aperture photometry. Then we compare optimal extraction using a WebbPSF model PSF to optimal extraction using a reference star PSF.
          </p>
         </section>
         <section id="read-in-simulated-nirspec-ifu-cube">
          <h2>
           Read in Simulated NIRSpec IFU Cube
           <a class="headerlink" href="#read-in-simulated-nirspec-ifu-cube" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           A faint (quasar) point source was simulated using the NIRSpec Instrument Performance Simulator (IPS), then run through the JWST Spec2 pipeline. We will use this for our science dataset.
          </p>
          <p>
           We read in the data both with fits.open and Spectrum1D.read, since the cube handling (slicing) we need to do is not implemented in specutils yet.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># NIRSpec IFU science data cube</span>
<span class="n">BoxPath</span> <span class="o">=</span> <span class="s2">"https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_optimal_extraction/"</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">BoxPath</span> <span class="o">+</span> <span class="s2">"NRS00001-faintQSO-F100LP-G140H-01_1_491_SE_2020-08-25T12h15m00_s3d.fits"</span>

<span class="c1"># Open and inspect the file and WCS</span>
<span class="c1"># Load with astropy.fits.open</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">sci</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'SCI'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'ERR'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">hdr</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    
<span class="c1"># Load with Spectrum1D    </span>
<span class="n">spec1d</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="c1"># Wavelengths</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec1d</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)</span>

<span class="c1"># Sum over spaxels</span>
<span class="n">fnu_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spec1d</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># List of cube slices for aperture photometry</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">var</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">spec1d_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec1d</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spec1d_len</span><span class="p">):</span> 
    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
    <span class="n">var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">err</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>  <span class="c1"># variance = err, not variance = err**2.  Squaring the err gives noisy results. </span>

<span class="c1"># Window data and variance (and replace NaNs)</span>
<span class="c1"># The existing JWST pipeline window is overgenerous (39x33 instead of the nominal 30x30 pixels)</span>
<span class="n">data_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)[:,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span>
<span class="n">data_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="p">)[:,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span> 
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Developer Note:
           </em>
           Can we fix or suppress this AsdfWarning?
          </p>
          <p>
           <em>
            Developer Note:
           </em>
           Is there a way to read in with only Spectrum1D to perform all of our cube operations, not using fits.open()?
          </p>
         </section>
         <section id="visualize-science-data-with-cubeviz">
          <h2>
           Visualize Science Data with Cubeviz
           <a class="headerlink" href="#visualize-science-data-with-cubeviz" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           <em>
            Developer Note:
           </em>
           Cubeviz incompatible with jupyter_client 6.1.6.  Use jupyter_client 5.3.5 instead.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">cubeviz</span> <span class="o">=</span> <span class="n">Cubeviz</span><span class="p">()</span>
<span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <section id="ui-instructions">
           <h3>
            UI Instructions:
            <a class="headerlink" href="#ui-instructions" title="Permalink to this heading">
             #
            </a>
           </h3>
           <ul class="simple">
            <li>
             <p>
              Load science datacube into Cubeviz using the next code cell below
             </p>
            </li>
            <li>
             <p>
              Go to the Hammer-and-Screwdriver icon: Gear icon: Layer in the leftmost image viewer
             </p>
            </li>
            <li>
             <p>
              In that tab, change the Linear stretch to 90 percentile to see the faint QSO target at (x,y) ~ (17, 21)
             </p>
            </li>
            <li>
             <p>
              Scrubbing through the cube also helps to locate the source
             </p>
            </li>
            <li>
             <p>
              Select a circular subset region centered on the source.
             </p>
            </li>
            <li>
             <p>
              Note that the region is pixelated and doesn’t include fractional pixels
             </p>
            </li>
            <li>
             <p>
              Change the collapse method to “Sum” in spectrum viewer: Gear icon : Viewer
             </p>
            </li>
            <li>
             <p>
              –This “Sum” method yields our subset extraction
             </p>
            </li>
            <li>
             <p>
              Change the vertical zoom to see the spectral features in the Subset spectrum
             </p>
            </li>
           </ul>
           <p>
            <em>
             Developer Notes
            </em>
            :
           </p>
           <p>
            (1) Image viewer contrast settings change when you click on the side bar to expand/contract jupyter scroll window
           </p>
           <p>
            (2) Spectrum viewer: Viewer cube collapse method should default to Sum (not Maximum)
           </p>
           <p>
            (3) Spectrum viewer y scale returns to autoscale when the region is moved, and y-zoom has to be adjusted again
           </p>
           <p>
            (4) Region selection appears away from cursor after opening hammer-and-screwdriver to change cube viewer contrast
           </p>
          </section>
         </section>
         <section id="load-cube-into-cubeviz">
          <h2>
           Load Cube into Cubeviz
           <a class="headerlink" href="#load-cube-into-cubeviz" title="Permalink to this heading">
            #
           </a>
          </h2>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Data from local directory</span>
<span class="c1"># cubeviz.app.load_data(filename)</span>

<span class="c1"># Data from url:</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">filename</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Sleep to avoid glue-jupyter timing issue</span>
<span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Developer Note:
           </em>
           Spectral cube does not yet recognize JWST NIRSpec IFU datacubes, giving the above warning
for each FITS extension.
          </p>
         </section>
         <section id="export-region-from-cubeviz">
          <h2>
           Export Region from Cubeviz
           <a class="headerlink" href="#export-region-from-cubeviz" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Export the region defined by the user in Cubeviz as an astropy CirclePixel Region, which has units of pixels.
          </p>
          <p>
           <em>
            Developer Note:
           </em>
           cubeviz.app.get_subsets_from_viewer method doesn’t work if there are more than 2 datasets selected in the spectrum viewer:
          </p>
          <p>
           #region1 = cubeviz.app.get_subsets_from_viewer(‘spectrum-viewer’)
          </p>
          <p>
           #print(region1[‘Subset1’])
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">cubeviz_data</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">data_collection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">region1</span> <span class="o">=</span> <span class="n">cubeviz_data</span><span class="o">.</span><span class="n">get_selection_definition</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">'astropy-regions'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">region1</span><span class="p">)</span>
    <span class="n">region1_exists</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"There are no regions selected in the cube viewer."</span><span class="p">)</span>
    <span class="n">region1_exists</span> <span class="o">=</span> <span class="kc">False</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="extract-subset-spectrum-in-cubeviz-spectrum-viewer">
          <h2>
           Extract Subset Spectrum in Cubeviz Spectrum Viewer
           <a class="headerlink" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Retrieve the collapsed spectrum (Subset1) of the user-defined region from the Spectrum Viewer as a Spectrum1D object.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">spectrum_subset1</span> <span class="o">=</span> <span class="n">cubeviz</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">get_data_from_viewer</span><span class="p">(</span><span class="s1">'spectrum-viewer'</span><span class="p">)[</span><span class="s1">'Subset 1'</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">spectrum_subset1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"There are no subsets selected in the spectrum viewer."</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Developer Note:
           </em>
           Can we suppress or fix this glue/core warning?
          </p>
         </section>
         <section id="extract-spectrum-by-sum-over-spaxels">
          <h2>
           Extract Spectrum by Sum Over Spaxels
           <a class="headerlink" href="#extract-spectrum-by-sum-over-spaxels" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Perform a simple numpy sum over all spaxels in the cube as a rudimentary extraction method. Also sum over wavelength to collapse the cube.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Sum over wavelength</span>
<span class="n">cube_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_win</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Plots</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">fnu_sum</span><span class="p">)</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Spaxel sums"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Wavelength (um)"</span><span class="p">)</span>  
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"SCA491 Flux Density"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Slice sums"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="extract-spectrum-in-constant-radius-circular-aperture-cylinder">
          <h2>
           Extract Spectrum in Constant Radius Circular Aperture (Cylinder)
           <a class="headerlink" href="#extract-spectrum-in-constant-radius-circular-aperture-cylinder" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           This method is appropriate for an extended source.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># IFU pixel scale</span>
<span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># arcsec/pixel</span>

<span class="c1"># CircularAperture uses xy pixels</span>
<span class="n">center_xy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">17.1</span><span class="p">,</span> <span class="mf">20.</span><span class="p">]</span>
<span class="n">r_pix</span> <span class="o">=</span> <span class="mf">5.92</span>
<span class="k">if</span> <span class="n">region1_exists</span><span class="p">:</span>
    <span class="n">center_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">region1</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">region1</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">y</span><span class="p">]</span>   
    <span class="n">r_pix</span> <span class="o">=</span> <span class="n">region1</span><span class="o">.</span><span class="n">radius</span>

<span class="n">aperture</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">center_xy</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r_pix</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">aperture</span><span class="p">)</span>

<span class="n">cylinder_sum</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">slice2d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">slice2d</span><span class="p">,</span> <span class="n">aperture</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">celestial</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'exact'</span><span class="p">)</span>
    <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">slice2d</span><span class="p">,</span> <span class="n">aperture</span><span class="p">)</span>
    <span class="n">cylinder_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Developer Note:
           </em>
           Is there a way to retrieve the coordinates (RA, Dec) of the Subset1 region, for use in a SkyCircularAperture?
          </p>
         </section>
         <section id="extract-spectrum-in-linearly-expanding-circular-aperture-cone">
          <h2>
           Extract Spectrum in Linearly Expanding Circular Aperture (Cone)
           <a class="headerlink" href="#extract-spectrum-in-linearly-expanding-circular-aperture-cone" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           This method is appropriate for a point source PSF with width proportional to wavelength
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Reference wavelength for expanding aperture</span>
<span class="n">lambda0</span> <span class="o">=</span> <span class="n">wavelength</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Reference wavelength:'</span><span class="p">,</span> <span class="n">lambda0</span><span class="p">)</span>

<span class="n">cone_sum</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="p">(</span><span class="n">slice2d</span><span class="p">,</span> <span class="n">wave</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">r_cone</span> <span class="o">=</span> <span class="n">r_pix</span> <span class="o">*</span> <span class="n">wave</span> <span class="o">/</span> <span class="n">lambda0</span>
    <span class="n">aperture_cone</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">center_xy</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r_cone</span><span class="p">)</span>
    <span class="n">phot_table</span> <span class="o">=</span> <span class="n">aperture_photometry</span><span class="p">(</span><span class="n">slice2d</span><span class="p">,</span> <span class="n">aperture_cone</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">celestial</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'exact'</span><span class="p">)</span>
    <span class="n">cone_sum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phot_table</span><span class="p">[</span><span class="s1">'aperture_sum'</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre>
             </div>
            </div>
           </div>
          </div>
         </section>
         <section id="plot-and-compare-non-optimal-spectral-extractions">
          <h2>
           Plot and Compare Non-optimal Spectral Extractions
           <a class="headerlink" href="#plot-and-compare-non-optimal-spectral-extractions" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Compare spectra extracted in cylinder, cone, Cubeviz subset.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> 

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Non-optimal spectral extractions"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Observed Wavelength (microns)"</span><span class="p">)</span>  
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Flux Density"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cylinder_sum</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Cylinder"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'b'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cone_sum</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Cone"</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'darkorange'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum_subset1</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Subset1"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"There is no Cubeviz Subset1 spectrum to plot."</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           Comparison of the (non-optimal) cylindrical, conical, and Cubeviz subset spectral extractions.
The conical extraction captures slightly more flux but is noisier than the other spectra at long wavelengths.
Red-shifted Broad H-beta and narrow [O III] lines  are visible in the quasar spectra.
          </p>
         </section>
         <section id="webbpsf-model-psf-for-optimal-extraction">
          <h2>
           WebbPSF  Model PSF for Optimal Extraction
           <a class="headerlink" href="#webbpsf-model-psf-for-optimal-extraction" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Generate PSF model cube using WebbPSF for NIRSpec IFU, or read in precomputed PSF model cube.
          </p>
          <p>
           Caution! The WebbPSF model takes about 10 hr to run.  Uncomment the following cell to do so. Otherwise, read in the precomputed WebbPSF model, which covers the full F100LP/G140H wavelength range (blue and red). For other filter/grating combinations, uncomment and run the cell below using the wavelengths from the science data set.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="sd">'''</span>
<span class="sd">#WebbPSF imports</span>
<span class="sd">%pylab inline</span>
<span class="sd">import webbpsf</span>

<span class="sd">#WebbPSF commands used to create PSF model cube</span>
<span class="sd">ns.image_mask = "IFU"  # Sets to 3x3 arcsec square mask</span>
<span class="sd">ns = webbpsf.NIRSpec()</span>
<span class="sd">wavelengths = wavelength*1.0E-6</span>
<span class="sd">psfcube = ns.calc_datacube(wavelengths, fov_pixels=30, oversample=4,  add_distortion=True)</span>
<span class="sd">psfcube.writeto("Webbpsf_ifucube.fits")</span>
<span class="sd">'''</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">BoxPath</span> <span class="o">=</span> <span class="s2">"https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_optimal_extraction/"</span>
<span class="n">psf_filename</span> <span class="o">=</span> <span class="n">BoxPath</span><span class="o">+</span><span class="s2">"Webbpsf_ifucube.fits"</span>

<span class="c1"># Load with astropy.fits.open</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psf_filename</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">psf_model</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'DET_SAMP'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">psf_hdr</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'DET_SAMP'</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>    
<span class="nb">print</span><span class="p">(</span><span class="n">psf_model</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Sum over wavelength</span>
<span class="n">psf_model_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Sum over spaxels</span>
<span class="n">psf_model_fnusum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf_model</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Developer Note:
           </em>
           The file Webbpsf_ifucube.fits is large (946.3 MB) and takes some time to load from Box.
It might behoove the user to download it to a local directory and retrieve it from there.
          </p>
         </section>
         <section id="align-model-psf-cube-with-science-data">
          <h2>
           Align Model PSF Cube with Science Data
           <a class="headerlink" href="#align-model-psf-cube-with-science-data" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Flip, smooth, and shift the model PSF cube to align with the simulated data. Trim the simulated data.
          </p>
          <p>
           <em>
            Developer Note:
           </em>
           Automate this by finding the (x,y) offset between the Model and simulated PSF peaks.  Currently the shift is determined empirically by eye.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Flip model PSF left-right.  For some unknown reason, WebbPSF is flipped with respect to the IPS simulation.</span>
<span class="n">psf_model_fliplr</span> <span class="o">=</span> <span class="n">psf_model</span><span class="p">[:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

<span class="c1"># Smooth model</span>
<span class="c1"># EMSM smoothing for G140H grating</span>
<span class="n">scalerad</span> <span class="o">=</span> <span class="mf">0.046</span>  <span class="c1"># sigma (arcsec)</span>
<span class="n">pixelscale</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">scalerad_pix</span> <span class="o">=</span> <span class="n">scalerad</span> <span class="o">/</span> <span class="n">pixelscale</span>
<span class="n">psf_model_smoothed</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">psf_model_fliplr</span><span class="p">,</span> 
                                                           <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scalerad_pix</span><span class="p">,</span> <span class="n">scalerad_pix</span><span class="p">),</span> 
                                                           <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">'reflect'</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>  
                                                           <span class="n">truncate</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

<span class="c1"># Empirically (chi-by-eye) determined shift</span>
<span class="n">shiftx</span> <span class="o">=</span> <span class="mf">1.75</span>    
<span class="n">shifty</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="c1"># Shift model PSF using linear interpolation</span>
<span class="n">psf_model_aligned</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">psf_model_smoothed</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">shiftx</span><span class="p">,</span> <span class="n">shifty</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">mode</span><span class="o">=</span><span class="s1">'constant'</span><span class="p">,</span> <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Sum over wavelength</span>
<span class="n">psf_model_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psf_model_aligned</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Scale factor for PSF subtraction</span>
<span class="n">psf_sum_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">psf_model_sum</span><span class="p">)</span>
<span class="n">psf_sum_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">psf_model_sum</span><span class="p">)</span>
<span class="n">scalefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cube_sum</span><span class="p">)</span> <span class="o">/</span> <span class="n">psf_sum_max</span>

<span class="c1"># Plots</span>
<span class="n">f</span><span class="p">,</span> <span class="p">([</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">],</span> <span class="p">[</span><span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">])</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> 

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PSF slice sum"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">psf_model_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Science Data slice sum"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span> 

<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Data / PSF Ratio"</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">/</span> <span class="n">psf_model_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PSF Model integrated flux"</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">psf_model_fnusum</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Data - PSF"</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">-</span> <span class="n">scalefactor</span> <span class="o">*</span> <span class="n">psf_model_sum</span><span class="p">)</span>

<span class="n">im6</span> <span class="o">=</span> <span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">-</span> <span class="n">scalefactor</span> <span class="o">*</span> <span class="n">psf_model_sum</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im6</span><span class="p">)</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"log abs(Data - PSF)"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Figure top row
           </em>
           : Comparison of smoothed, aligned WebbPSF PSF (left) to IPS simulation (center).
          </p>
          <p>
           <em>
            Figure bottom row
           </em>
           : Integrated WebbPSF model flux (left) decreases with wavelength as PSF expands outside of the FOV.
Differences (center, right) between the model PSF and IPS-simulated PSF will translate to inaccuracy in the optimally-extracted spectrum.
          </p>
         </section>
         <section id="optimal-extraction-using-webbpsf-model">
          <h2>
           Optimal Extraction using WebbPSF Model
           <a class="headerlink" href="#optimal-extraction-using-webbpsf-model" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           Optimal extraction (Horne 1986, PASP, 98, 609) weights the flux contributions to a spectrum by their signal-to-noise ratio (SNR). Dividing the simulated data by the model PSF gives an estimate of the total flux density spectrum in each spaxel. A weighted average of these estimates over all spaxels yields the optimally extracted spectrum over the cube. In the faint source limit, where the noise is background-dominated, optimal extraction inside a 3-sigma radius can increase the effective exposure time by a factor of 1.69 (Horne et al. 1986). In the bright source limit, where the noise is dominated by the Poisson statistics of the source, optimal extraction is formally identical to a straight sum over spaxels for a perfect PSF model.
          </p>
          <p>
           We use the WebbPSF PSF model for this first attempt at optimal extraction.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Window PSF model (and replace NaNs)</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">psf_model_aligned</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2059</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> 

<span class="c1"># Divide data by PSF model</span>
<span class="n">data_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data_win</span> <span class="o">/</span> <span class="n">profile</span><span class="p">)</span>
<span class="n">data_norm_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

<span class="c1"># Mask out bad data using 3-sigma clipping in each slice</span>
<span class="n">data_norm_clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data_norm</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">data_norm_clipped_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_norm_clipped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   
<span class="n">badvoxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_norm_clipped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">data_clean</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data_win</span>
<span class="n">data_clean</span><span class="p">[</span><span class="n">badvoxel</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Optimal extraction, using model profile weight and variance cube from the simulated data</span>
<span class="n">optimal_weight</span> <span class="o">=</span> <span class="n">profile</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">data_var</span>
<span class="n">optimal_weight_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimal_weight</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">spectrum_optimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile</span> <span class="o">*</span> <span class="n">data_clean</span> <span class="o">/</span> <span class="n">data_var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">optimal_weight_norm</span>

<span class="n">opt_scalefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cone_sum</span> <span class="o">/</span> <span class="n">spectrum_optimal</span><span class="p">))</span>  <span class="c1"># = 1.33, not ~1.0 because PSF model isn't perfect</span>

<span class="c1"># Plots</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal Extraction Comparison"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Observed Wavelength (microns)"</span><span class="p">)</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Flux Density"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">cone_sum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Conical Extraction"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum_optimal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Optimal"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           The optimally extracted spectrum is less noisy than the aperture extraction, but the flux density is low by a factor of ~1.33 because the PSF model doesn’t match the science data perfectly.
          </p>
         </section>
         <section id="optimal-extraction-with-simulated-reference-star-psf">
          <h2>
           Optimal Extraction with (Simulated) Reference Star PSF
           <a class="headerlink" href="#optimal-extraction-with-simulated-reference-star-psf" title="Permalink to this heading">
            #
           </a>
          </h2>
          <p>
           A real (or simulated in this case) IFU observation of a star may be used for the PSF model rather than WebbPSF.  We employ a NIRSpec IPS simulated PSF, which matches our data better than the WebbPSF model.  We don’t have to shift or smooth the PSF model because it was simulated at the same dither/detector position as the data. When using a real observation of a star for the PSF model, make sure it was observed at the same dither positions. It is also beneficial to reduce and extract both simulated datasets in the ‘ifualign’ detector coordinate system, so that we don’t have to rotate the PSF star to match the science data.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="n">BoxPath</span> <span class="o">=</span> <span class="s2">"https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/IFU_optimal_extraction/"</span>
<span class="n">filename_star</span> <span class="o">=</span> <span class="n">BoxPath</span> <span class="o">+</span> <span class="s2">"NRS00001-brightQSO-F100LP-G140H-01_1_491_SE_2020-08-26T12h15m00_s3d.fits"</span>

<span class="c1"># Open and inspect the file and WCS</span>
<span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename_star</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdulist</span><span class="p">:</span>
    <span class="n">sci_star</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'SCI'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">err_star</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="s1">'ERR'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">w_star</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">hdr_star</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">hdulist</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">w_star</span><span class="p">)</span>
    
<span class="c1"># Load with Spectrum1D    </span>
<span class="n">spec1d_star</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename_star</span><span class="p">)</span>

<span class="c1"># Wavelengths</span>
<span class="n">wavelength_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spec1d_star</span><span class="o">.</span><span class="n">spectral_axis</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># Window reference star to match science data (and replace NaNs)</span>
<span class="n">ref_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">sci_star</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">:])</span>

<span class="c1"># Sum over spaxels</span>
<span class="n">ref_star_fnusum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_star</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Normalize PSF star profile to unity. (The flux will still be slightly off. Please see Developer's Note below.)</span>
<span class="n">ref_star_norm</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">norm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wavelength_star</span><span class="p">)),</span> <span class="n">ref_star_fnusum</span><span class="p">):</span>
    <span class="n">ref_star_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_star</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span>
<span class="n">profile_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ref_star_norm</span><span class="p">)</span>
    
<span class="c1"># Sum over spaxels </span>
<span class="n">profile_star_fnusum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_star</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Sum over wavelength</span>
<span class="n">profile_star_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_star</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Scale factor for PSF subtraction</span>
<span class="n">profile_star_sum_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">profile_star_sum</span><span class="p">)</span>
<span class="n">star_scalefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">cube_sum</span><span class="p">)</span> <span class="o">/</span> <span class="n">profile_star_sum_max</span>

<span class="c1"># Make slight adjustment to scale factor</span>
<span class="n">star_scalefactor</span> <span class="o">=</span> <span class="mf">0.175</span>

<span class="c1"># Plots</span>
<span class="n">f</span><span class="p">,</span> <span class="p">([</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">],</span> <span class="p">[</span><span class="n">ax4</span><span class="p">,</span> <span class="n">ax5</span><span class="p">,</span> <span class="n">ax6</span><span class="p">])</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> 

<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">profile_star_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PSF Star Slice sum"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span> 
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Science Data Slice sum"</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">/</span> <span class="n">profile_star_sum</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Data/Star_PSF Ratio"</span><span class="p">)</span>

<span class="n">star_model_ratio</span> <span class="o">=</span> <span class="n">profile_star_sum</span> <span class="o">/</span> <span class="n">psf_model_sum</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">star_model_ratio</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Star PSF/WebbPSF"</span><span class="p">)</span>

<span class="n">ax5</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">-</span> <span class="n">star_scalefactor</span> <span class="o">*</span> <span class="n">profile_star_sum</span><span class="p">)</span>
<span class="n">ax5</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Data - Star PSF"</span><span class="p">)</span>

<span class="n">ax6</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">cube_sum</span> <span class="o">-</span> <span class="n">star_scalefactor</span> <span class="o">*</span> <span class="n">profile_star_sum</span><span class="p">)))</span>
<span class="n">ax6</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"log abs(Data - Star PSF)"</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           <em>
            Figure top row
           </em>
           : Comparison of PSF star and science data. Bottom left: ratio of PSF star to WebbPSF model shows
significant differences that can affect the quality of the optimal extraction.  Bottom right:
Difference of PSF star from science data shows they are well matched, with a scale factor of 0.175.
          </p>
          <p>
           <em>
            Developer Note:
           </em>
           It would be good to renormalize the PSF profile to account for the fraction of flux lost outside of the detector. Otherwise the extracted flux will be low by a factor of roughly 0.972 to 0.980.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Mask out bad data using 3-sigma clipping in each slice</span>
<span class="n">data_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data_win</span> <span class="o">/</span> <span class="n">profile_star</span><span class="p">)</span>
<span class="n">data_norm_clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span><span class="n">data_norm</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">data_norm_clipped_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_norm_clipped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>   
<span class="n">badvoxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_norm_clipped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">data_clean</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">data_win</span>
<span class="n">data_clean</span><span class="p">[</span><span class="n">badvoxel</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Optimal extraction, using model profile weight and variance cube from the simulated data</span>
<span class="n">optimal_weight</span> <span class="o">=</span> <span class="n">profile_star</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">data_var</span>
<span class="n">optimal_weight_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">optimal_weight</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">spectrum_optimal_star</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_star</span> <span class="o">*</span> <span class="n">data_clean</span> <span class="o">/</span> <span class="n">data_var</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">optimal_weight_norm</span>

<span class="c1"># Plots</span>
<span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal Extraction Comparison"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Observed Wavelength (microns)"</span><span class="p">)</span> 
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Flux Density"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">cone_sum</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Conical Extraction"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum_optimal</span> <span class="o">*</span> <span class="n">opt_scalefactor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"1.3 * Optimal with WebbPSF model"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">spectrum_optimal_star</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Optimal with ref. star"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <p>
           The optimal extraction with the perfectly matched PSF star is less noisy than that achieved with WebbPSF, and unlike the latter, doesn’t need to be rescaled.  The scaling can be off if the PSF of the reference star is not a good match to the PSF of the science data.
          </p>
          <a class="reference internal image-reference" href="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png">
           <img alt="Space Telescope Logo" src="https://raw.githubusercontent.com/spacetelescope/notebooks/master/assets/stsci_pri_combo_mark_horizonal_white_bkgd.png" style="width: 200px;"/>
          </a>
          <p>
           Notebook created by Patrick Ogle and James Davies.
          </p>
         </section>
        </section>
        <script type="text/x-thebe-config">
         {
        requestKernel: true,
        binderOptions: {
            repo: "spacetelescope/jdat_notebooks",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks/ifu_optimal"
        },
        predefinedOutput: true
    }
        </script>
        <script>
         kernelName = 'python3'
        </script>
       </article>
       <footer class="bd-footer-article">
        <div class="footer-article-items footer-article__inner">
         <div class="footer-article-item">
          <!-- Previous / next buttons -->
          <div class="prev-next-area">
           <a class="left-prev" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html" title="previous page">
            <i class="fa-solid fa-angle-left">
            </i>
            <div class="prev-next-info">
             <p class="prev-next-subtitle">
              previous
             </p>
             <p class="prev-next-title">
              IFU Cube Fitting
             </p>
            </div>
           </a>
           <a class="right-next" href="../optimal_extraction/Spectral_Extraction-static.html" title="next page">
            <div class="prev-next-info">
             <p class="prev-next-subtitle">
              next
             </p>
             <p class="prev-next-title">
              MOS Optimal Spectral Extraction
             </p>
            </div>
            <i class="fa-solid fa-angle-right">
            </i>
           </a>
          </div>
         </div>
        </div>
       </footer>
      </div>
      <div class="bd-sidebar-secondary bd-toc">
       <div class="sidebar-secondary-items sidebar-secondary__inner">
        <div class="sidebar-secondary-item">
         <div class="page-toc tocsection onthispage">
          <i class="fa-solid fa-list">
          </i>
          Contents
         </div>
         <nav class="bd-toc-nav page-toc">
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#imports">
             Imports
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#introduction">
             Introduction
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#read-in-simulated-nirspec-ifu-cube">
             Read in Simulated NIRSpec IFU Cube
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#visualize-science-data-with-cubeviz">
             Visualize Science Data with Cubeviz
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#ui-instructions">
               UI Instructions:
              </a>
             </li>
            </ul>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-cube-into-cubeviz">
             Load Cube into Cubeviz
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#export-region-from-cubeviz">
             Export Region from Cubeviz
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-subset-spectrum-in-cubeviz-spectrum-viewer">
             Extract Subset Spectrum in Cubeviz Spectrum Viewer
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-spectrum-by-sum-over-spaxels">
             Extract Spectrum by Sum Over Spaxels
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-spectrum-in-constant-radius-circular-aperture-cylinder">
             Extract Spectrum in Constant Radius Circular Aperture (Cylinder)
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#extract-spectrum-in-linearly-expanding-circular-aperture-cone">
             Extract Spectrum in Linearly Expanding Circular Aperture (Cone)
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#plot-and-compare-non-optimal-spectral-extractions">
             Plot and Compare Non-optimal Spectral Extractions
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#webbpsf-model-psf-for-optimal-extraction">
             WebbPSF  Model PSF for Optimal Extraction
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#align-model-psf-cube-with-science-data">
             Align Model PSF Cube with Science Data
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#optimal-extraction-using-webbpsf-model">
             Optimal Extraction using WebbPSF Model
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#optimal-extraction-with-simulated-reference-star-psf">
             Optimal Extraction with (Simulated) Reference Star PSF
            </a>
           </li>
          </ul>
         </nav>
        </div>
       </div>
      </div>
     </div>
     <footer class="bd-footer-content">
      <div class="bd-footer-content__inner container">
       <div class="footer-item">
        <p class="component-author">
         By STScI
        </p>
       </div>
       <div class="footer-item">
        <p class="copyright">
         © Copyright 2022.
         <br/>
        </p>
       </div>
       <div class="footer-item">
       </div>
       <div class="footer-item">
       </div>
      </div>
     </footer>
    </main>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52">
  </script>
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52">
  </script>
  <footer class="bd-footer">
  </footer>
 </body>
</html>
